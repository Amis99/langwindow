<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 마이페이지 - 언어의 창 온라인 학습관</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 */
        .sidebar {
            width: 280px;
            background: #1e40af;
            color: white;
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 30px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info p {
            font-size: 14px;
            margin: 5px 0;
        }

        .user-info .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .user-scores {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .score-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .sidebar-ranking {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .sidebar-ranking-header {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
            text-align: center;
        }

        .sidebar-ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
        }

        .sidebar-ranking-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .sidebar-ranking-value {
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .sidebar-nav {
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        .logout-btn {
            margin: 30px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            width: calc(100% - 60px);
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* 메인 콘텐츠 */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .section-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* 통계 카드 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card .stat-unit {
            font-size: 16px;
            color: #7f8c8d;
            margin-left: 5px;
        }

        /* 콘텐츠 그리드 */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .content-card .category-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .content-card h3 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .content-card .learning-count {
            font-size: 13px;
            color: #7f8c8d;
        }

        /* 학습 기록 테이블 */
        .records-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .records-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th {
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .records-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #34495e;
            font-size: 14px;
        }

        .records-table tr:last-child td {
            border-bottom: none;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        /* 콘텐츠 모달 */
        .content-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .content-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2563eb;
            color: white;
        }

        .modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .modal-close-btn {
            font-size: 32px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* 알림 메시지 */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 300px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .notification-message {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* 버튼 스타일 */
        .btn-view-detail, .btn-wrong-questions, .btn-content-ranking {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-view-detail {
            background: #2563eb;
            color: white;
        }

        .btn-view-detail:hover {
            transform: scale(1.05);
            background: #1d4ed8;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        .btn-content-ranking {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
        }

        .btn-content-ranking:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-wrong-questions {
            background: #dc2626;
            color: white;
        }

        .btn-wrong-questions:hover {
            transform: scale(1.05);
            background: #b91c1c;
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3);
        }

        /* 학습 결과 모달 */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .result-modal.active {
            display: flex;
        }

        .result-modal-content {
            background: #f5f6fa;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .result-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            border: none;
            background: rgba(0, 0, 0, 0.1);
            color: #2c3e50;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .result-modal-close:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* ==================== 랭킹 스타일 ==================== */
        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .ranking-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .ranking-tab:hover {
            color: #3498db;
            background: #f8f9fa;
        }

        .ranking-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 700;
        }

        /* 학교급 필터 */
        .school-level-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .level-filter-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-filter-btn:hover {
            border-color: #3498db;
            color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .level-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .ranking-content {
            animation: fadeIn 0.3s ease;
        }

        .ranking-period-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ranking-period-info p {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        .ranking-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 80px 1fr 150px 150px 150px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s ease;
        }

        .ranking-item:hover {
            background: #f8f9fa;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-item.my-rank {
            background: #e8f4f8;
            font-weight: 600;
        }

        .rank-badge {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .rank-badge.gold {
            color: #FFD700;
            font-size: 36px;
        }

        .rank-badge.silver {
            color: #C0C0C0;
            font-size: 34px;
        }

        .rank-badge.bronze {
            color: #CD7F32;
            font-size: 32px;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .student-school {
            font-size: 13px;
            color: #7f8c8d;
        }

        .rank-stat {
            text-align: center;
        }

        .rank-stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .rank-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .rank-stat-value.score {
            color: #3498db;
        }

        .rank-stat-value.accuracy {
            color: #27ae60;
        }

        .rank-stat-value.count {
            color: #e67e22;
        }

        .content-ranking-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-ranking-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* ==================== 인쇄 스타일 ==================== */
        @media print {
            /* 인쇄 시 사이드바, 헤더 등 숨기기 */
            .sidebar,
            .main-content > header,
            .no-print,
            .result-modal-close {
                display: none !important;
            }

            /* 모달 배경 제거 */
            .result-modal {
                position: static !important;
                background: white !important;
                overflow: visible !important;
            }

            /* 모달 컨텐츠 전체 화면으로 */
            .result-modal-content {
                max-width: 100% !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 20px !important;
            }

            /* 페이지 여백 설정 */
            @page {
                margin: 1cm;
            }

            /* 본문 여백 제거 */
            body {
                margin: 0;
                padding: 0;
            }

            /* 페이지 구분 방지 */
            .page-break-avoid {
                page-break-inside: avoid;
            }

            /* 색상 유지 */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* 버튼 숨기기 */
            button {
                display: none !important;
            }

            /* 링크 밑줄 제거 */
            a {
                text-decoration: none;
                color: inherit;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- 사이드바 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>📚 학생 마이페이지</h1>
                <div class="user-info">
                    <p class="user-name" id="userName">불러오는 중...</p>
                    <p id="userSchool">-</p>
                    <p id="userGrade">-</p>
                </div>
                <div class="user-scores">
                    <div class="score-item">
                        <span class="score-label">누적 점수</span>
                        <span class="score-value" id="totalScore">0점</span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">이번 주 점수</span>
                        <span class="score-value" id="weeklyScore">0점</span>
                    </div>
                </div>

                <!-- 주간 랭킹 -->
                <div class="sidebar-ranking">
                    <div class="sidebar-ranking-header">🏆 이번 주 랭킹</div>
                    <div class="sidebar-ranking-item">
                        <span class="sidebar-ranking-label" id="sidebarSchoolLevel">-</span>
                        <span class="sidebar-ranking-value" id="sidebarRank">-</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="showSection('overview')">
                    📊 학습 현황
                </div>
                <div class="nav-item" onclick="showSection('contents')">
                    📖 학습 콘텐츠
                </div>
                <div class="nav-item" onclick="showSection('records')">
                    📝 학습 기록
                </div>
                <div class="nav-item" onclick="showSection('ranking')">
                    🏆 랭킹
                </div>
            </nav>

            <button class="logout-btn" onclick="handleLogout()">로그아웃</button>
        </aside>

        <!-- 메인 콘텐츠 -->
        <main class="main-content">
            <!-- 학습 현황 섹션 -->
            <section id="overview" class="content-section active">
                <div class="section-header">
                    <h2>📊 학습 현황</h2>
                    <p>나의 학습 통계를 확인하세요</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card clickable" onclick="showSection('contents')">
                        <h3>총 학습 콘텐츠</h3>
                        <div>
                            <span class="stat-value" id="totalContents">0</span>
                            <span class="stat-unit">개</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>완료한 학습</h3>
                        <div>
                            <span class="stat-value" id="completedRecords">0</span>
                            <span class="stat-unit">개</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>평균 점수</h3>
                        <div>
                            <span class="stat-value" id="avgScore">0</span>
                            <span class="stat-unit">점</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>총 학습 시간</h3>
                        <div>
                            <span class="stat-value" id="totalTime">0</span>
                            <span class="stat-unit">분</span>
                        </div>
                    </div>
                </div>

                <div class="records-table">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">최근 학습 기록</h3>
                    <div id="recentRecordsContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 학습 콘텐츠 섹션 -->
            <section id="contents" class="content-section">
                <div class="section-header">
                    <h2>📖 학습 콘텐츠</h2>
                    <p>사용 가능한 학습 자료를 확인하세요</p>
                </div>

                <!-- 필터 및 정렬 컨트롤 -->
                <div class="filter-sort-controls" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <!-- 분류 필터 -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">분류</label>
                        <select id="categoryFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">전체</option>
                            <option value="문학 워크북">문학 워크북</option>
                            <option value="비문학 워크북">비문학 워크북</option>
                            <option value="문법 워크북">문법 워크북</option>
                            <option value="러셀">러셀</option>
                            <option value="소쉬르">소쉬르</option>
                        </select>
                    </div>

                    <!-- 난이도 필터 -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">난이도</label>
                        <select id="difficultyFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">전체</option>
                            <option value="기초">기초</option>
                            <option value="중급">중급</option>
                            <option value="고급">고급</option>
                            <option value="심화">심화</option>
                        </select>
                    </div>

                    <!-- 정렬 -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">정렬</label>
                        <select id="sortBy" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="recent">최신순</option>
                            <option value="popular">인기순 (학습 수)</option>
                            <option value="title">제목순</option>
                            <option value="difficulty">난이도순</option>
                        </select>
                    </div>

                    <!-- 검색 -->
                    <div style="flex: 1.5; min-width: 250px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">검색</label>
                        <input type="text" id="searchInput" placeholder="제목 검색..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                </div>

                <div id="contentsContainer">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>

            <!-- 학습 기록 섹션 -->
            <section id="records" class="content-section">
                <div class="section-header">
                    <h2>📝 학습 기록</h2>
                    <p>전체 학습 이력을 확인하세요</p>
                </div>

                <div class="records-table">
                    <div id="allRecordsContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 랭킹 섹션 -->
            <section id="ranking" class="content-section">
                <div class="section-header">
                    <h2>🏆 랭킹</h2>
                    <p>우수 학생들을 확인하세요</p>
                </div>

                <!-- 랭킹 탭 -->
                <div class="ranking-tabs">
                    <button class="ranking-tab active" onclick="showRankingTab('cumulative')">📈 누적 랭킹</button>
                    <button class="ranking-tab" onclick="showRankingTab('weekly')">📅 주간 랭킹</button>
                    <button class="ranking-tab" onclick="showRankingTab('monthly')">📆 월간 랭킹</button>
                </div>

                <!-- 학교급 필터 -->
                <div class="school-level-filter">
                    <button class="level-filter-btn active" onclick="filterBySchoolLevel('all')">전체</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('elementary')">🎒 초등부</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('middle')">📚 중등부</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('high')">🎓 고등부</button>
                </div>

                <!-- 누적 랭킹 -->
                <div id="cumulativeRanking" class="ranking-content active">
                    <div id="cumulativeRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 주간 랭킹 -->
                <div id="weeklyRanking" class="ranking-content" style="display: none;">
                    <div class="ranking-period-info">
                        <p id="weeklyPeriod"></p>
                    </div>
                    <div id="weeklyRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- 월간 랭킹 -->
                <div id="monthlyRanking" class="ranking-content" style="display: none;">
                    <div class="ranking-period-info">
                        <p id="monthlyPeriod"></p>
                    </div>
                    <div id="monthlyRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- 콘텐츠 모달 -->
    <div id="contentModal" class="content-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">학습 콘텐츠</h2>
                <button class="modal-close-btn" onclick="closeContentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="contentIframe" src="" data-content-id=""></iframe>
            </div>
        </div>
    </div>

    <!-- 알림 -->
    <div id="notification" class="notification">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-message" id="notificationMessage"></div>
    </div>

    <!-- 학습 결과 모달 -->
    <div id="learningResultModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeLearningResultModal()">&times;</button>
            <div id="learningResultContent"></div>
        </div>
    </div>

    <!-- 틀린 문제 모달 -->
    <div id="wrongQuestionsModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeWrongQuestionsModal()">&times;</button>
            <div id="wrongQuestionsContent"></div>
        </div>
    </div>

    <!-- 컨텐츠별 랭킹 모달 -->
    <div id="contentRankingModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeContentRankingModal()">&times;</button>
            <div id="contentRankingContent"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        // 인증 확인
        if (!isAuthenticated() || !isStudent()) {
            window.location.href = 'login.html';
        }

        const currentUser = getCurrentUser();

        // 사용자 정보 표시
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userSchool').textContent = currentUser.school;
        document.getElementById('userGrade').textContent = currentUser.grade;

        // 섹션 전환
        function showSection(sectionId, event = null) {
            // 모든 섹션 숨기기
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // 모든 네비게이션 아이템 비활성화
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // 선택한 섹션 표시
            document.getElementById(sectionId).classList.add('active');

            // 선택한 네비게이션 아이템 활성화
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // event가 없을 때는 sectionId로 네비게이션 아이템 찾기
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionId}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // 섹션별 데이터 로드
            if (sectionId === 'overview') {
                loadOverview();
            } else if (sectionId === 'contents') {
                loadContents();
            } else if (sectionId === 'records') {
                loadAllRecords();
            } else if (sectionId === 'ranking') {
                loadRanking();
            }
        }

        // 학습 현황 로드
        async function loadOverview() {
            try {
                const [contents, records] = await Promise.all([
                    API.getContents(),
                    API.getMyRecords()
                ]);

                // 통계 계산
                const totalContents = contents.data?.contents?.length || 0;
                const completedRecords = records.data?.records?.length || 0;

                let totalScore = 0;
                let totalMinutes = 0;
                const recordsList = records.data?.records || [];
                recordsList.forEach(record => {
                    if (record.score) totalScore += record.score;
                    if (record.timeSpent) totalMinutes += record.timeSpent;
                });

                const avgScore = completedRecords > 0 ? Math.round(totalScore / completedRecords) : 0;

                // 통계 표시
                document.getElementById('totalContents').textContent = totalContents;
                document.getElementById('completedRecords').textContent = completedRecords;
                document.getElementById('avgScore').textContent = avgScore;
                document.getElementById('totalTime').textContent = totalMinutes;

                // 프로필 점수 업데이트
                updateProfileScores(recordsList);

                // 주간 랭킹 로드
                loadSidebarWeeklyRanking();

                // 최근 학습 기록 표시 (최대 5개)
                displayRecentRecords(recordsList.slice(0, 5));

            } catch (error) {
                console.error('학습 현황 로드 실패:', error);
                document.getElementById('recentRecordsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>데이터를 불러올 수 없습니다</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 프로필 점수 업데이트
        function updateProfileScores(records) {
            // 누적 점수 계산
            let cumulativeScore = 0;
            records.forEach(record => {
                const score = record.totalScore || record.score || 0;
                cumulativeScore += score;
            });

            // 이번 주 점수 계산 (최근 7일)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            let weeklyScore = 0;
            records.forEach(record => {
                const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                if (recordDate >= oneWeekAgo) {
                    const score = record.totalScore || record.score || 0;
                    weeklyScore += score;
                }
            });

            // 표시 (소수점 첫째 자리까지)
            document.getElementById('totalScore').textContent = cumulativeScore.toFixed(1) + '점';
            document.getElementById('weeklyScore').textContent = weeklyScore.toFixed(1) + '점';
        }

        // 사이드바 주간 랭킹 로드
        async function loadSidebarWeeklyRanking() {
            try {
                const currentUser = getCurrentUser();
                const currentUserId = currentUser.userId;
                const currentUserGrade = currentUser.grade;

                // 전체 학습 기록 가져오기 (학생용 랭킹 API)
                const response = await API.getRankings();
                const allRecords = response.data?.records || [];

                // 이번 주 범위 계산 (일요일 ~ 토요일)
                const now = new Date();
                const dayOfWeek = now.getDay();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - dayOfWeek);
                weekStart.setHours(0, 0, 0, 0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);

                // 이번 주 기록만 필터링
                const weekRecords = allRecords.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= weekStart && recordDate <= weekEnd;
                });

                // 학생별 주간 점수 집계
                const studentScores = {};
                weekRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userGrade,
                            totalScore: 0
                        };
                    }
                    studentScores[userId].totalScore += score;
                });

                // 현재 사용자의 학교급 확인
                const currentSchoolLevel = getSchoolLevelFromGrade(currentUserGrade);

                // 학교급 이름 매핑
                const schoolLevelNames = {
                    'elementary': '초등부',
                    'middle': '중등부',
                    'high': '고등부',
                    'unknown': '전체'
                };

                // 같은 학교급 학생만 필터링
                let rankings = Object.values(studentScores);
                if (currentSchoolLevel !== 'unknown') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // 점수순 정렬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                // 현재 사용자의 랭킹 찾기
                const myRankIndex = rankings.findIndex(student => student.userId === currentUserId);
                const myRank = myRankIndex !== -1 ? myRankIndex + 1 : '-';

                // 사이드바에 표시
                const schoolLevelName = schoolLevelNames[currentSchoolLevel] || '전체';
                document.getElementById('sidebarSchoolLevel').textContent = schoolLevelName;

                if (myRank === '-' || rankings.length === 0) {
                    document.getElementById('sidebarRank').textContent = '순위 없음';
                } else {
                    document.getElementById('sidebarRank').textContent = `${myRank}위 / ${rankings.length}명`;
                }

            } catch (error) {
                console.error('사이드바 주간 랭킹 로드 실패:', error);
                document.getElementById('sidebarSchoolLevel').textContent = '-';
                document.getElementById('sidebarRank').textContent = '-';
            }
        }

        // 최근 학습 기록 표시
        function displayRecentRecords(records) {
            const container = document.getElementById('recentRecordsContainer');

            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>아직 학습 기록이 없습니다</h3>
                        <p>학습 콘텐츠를 시작해보세요!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>콘텐츠</th>
                            <th>학습 날짜</th>
                            <th>점수</th>
                            <th>정답률</th>
                            <th>학습 시간</th>
                            <th>상세</th>
                            <th>랭킹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => {
                            const date = record.createdAt || record.completedAt || record.endTime || new Date().toISOString();
                            const accuracy = record.accuracy || 0;
                            const score = record.totalScore || record.score || 0;
                            const timeSpent = record.timeSpent || 0;

                            return `
                            <tr style="cursor: pointer;" onclick="showLearningResultModal('${record.recordId}')">
                                <td>${record.contentTitle || record.contentId}</td>
                                <td>${new Date(date).toLocaleDateString('ko-KR')}</td>
                                <td>${getScoreBadge(score)}</td>
                                <td>${accuracy}%</td>
                                <td>${timeSpent}분</td>
                                <td><button class="btn-view-detail" onclick="event.stopPropagation(); showLearningResultModal('${record.recordId}')">보기</button></td>
                                <td><button class="btn-content-ranking" onclick="event.stopPropagation(); showContentRanking('${record.contentId}', '${record.contentTitle || record.contentId}')">🏆 랭킹</button></td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // 점수 뱃지 생성
        function getScoreBadge(score) {
            if (!score && score !== 0) return '-';

            // 소수점 첫째 자리까지 표시
            const displayScore = parseFloat(score).toFixed(1);

            let className = 'score-low';
            if (score >= 80) className = 'score-high';
            else if (score >= 60) className = 'score-medium';

            return `<span class="score-badge ${className}">${displayScore}점</span>`;
        }

        // ==================== 분류 헬퍼 함수 ====================

        // 콘텐츠로부터 분류 결정
        function getCategoryFromContent(content) {
            const filename = content.filename || content.title || '';

            // 중세국어 시리즈는 모두 문법
            if (filename.includes('중세국어의 특징')) {
                return '문법 워크북';
            }

            // 러셀 시리즈
            if (filename.includes('러셀1') || filename.includes('러셀')) {
                return '러셀';
            }

            // 소쉬르 시리즈
            if (filename.includes('소쉬르')) {
                return '소쉬르';
            }

            // 워크북 분류
            if (filename.includes('워크북')) {
                // 문학 작품명 리스트
                const literatureWorks = ['봄봄', '불꽃', '동행', '고향', '흥부전', '차마설'];
                if (literatureWorks.some(work => filename.includes(work))) {
                    return '문학 워크북';
                }
                return '비문학 워크북';
            }

            // 기타
            return content.category || '기타';
        }

        // 전역 변수: 콘텐츠 목록
        let allContents = [];
        let filteredContents = [];

        // 필터 및 정렬 적용
        function applyFiltersAndSort() {
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const difficultyFilter = document.getElementById('difficultyFilter')?.value || '';
            const sortBy = document.getElementById('sortBy')?.value || 'recent';
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            // 모든 콘텐츠로 시작
            filteredContents = [...allContents];

            // 분류 필터 적용
            if (categoryFilter) {
                filteredContents = filteredContents.filter(content => {
                    const category = getCategoryFromContent(content);
                    return category === categoryFilter;
                });
            }

            // 난이도 필터 적용
            if (difficultyFilter) {
                filteredContents = filteredContents.filter(content =>
                    content.difficulty === difficultyFilter
                );
            }

            // 검색 적용
            if (searchQuery) {
                filteredContents = filteredContents.filter(content =>
                    (content.title || '').toLowerCase().includes(searchQuery) ||
                    (content.description || '').toLowerCase().includes(searchQuery)
                );
            }

            // 정렬 적용
            switch(sortBy) {
                case 'popular':
                    filteredContents.sort((a, b) => (b.learningCount || 0) - (a.learningCount || 0));
                    break;
                case 'title':
                    filteredContents.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'ko'));
                    break;
                case 'difficulty':
                    const difficultyOrder = {'기초': 1, '중급': 2, '고급': 3, '심화': 4};
                    filteredContents.sort((a, b) =>
                        (difficultyOrder[a.difficulty] || 0) - (difficultyOrder[b.difficulty] || 0)
                    );
                    break;
                case 'recent':
                default:
                    filteredContents.sort((a, b) =>
                        new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0)
                    );
                    break;
            }

            // 콘텐츠 목록 다시 렌더링
            renderContentsList(filteredContents);
        }

        // 콘텐츠 목록 렌더링
        function renderContentsList(contents) {
            const container = document.getElementById('contentsContainer');

            if (contents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>조건에 맞는 콘텐츠가 없습니다</h3>
                        <p>다른 필터를 선택해보세요</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="content-grid">
                    ${contents.map(content => {
                        const category = getCategoryFromContent(content);
                        const learningCount = content.learningCount || 0;

                        return `
                            <div class="content-card" onclick="openContent('${content.contentId}')">
                                <span class="category-badge">${category}</span>
                                <h3>${content.title}</h3>
                                <p class="learning-count">학습 수: ${learningCount}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 콘텐츠 목록 로드
        async function loadContents() {
            const container = document.getElementById('contentsContainer');

            try {
                // 콘텐츠 목록 가져오기
                const response = await API.getContents();
                const contents = response.data.contents || [];

                if (contents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>사용 가능한 콘텐츠가 없습니다</h3>
                            <p>관리자가 콘텐츠를 업로드할 때까지 기다려주세요</p>
                        </div>
                    `;
                    return;
                }

                // 전역 변수에 저장 (learningCount는 콘텐츠 메타데이터에 포함)
                allContents = contents;
                filteredContents = [...allContents];

                // 이벤트 리스너 등록 (한 번만)
                if (!document.getElementById('categoryFilter').hasAttribute('data-listener-added')) {
                    document.getElementById('categoryFilter')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('difficultyFilter')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('sortBy')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('searchInput')?.addEventListener('input', applyFiltersAndSort);

                    // 리스너 추가 표시
                    document.getElementById('categoryFilter').setAttribute('data-listener-added', 'true');
                }

                // 초기 렌더링
                renderContentsList(filteredContents);

            } catch (error) {
                console.error('콘텐츠 로드 실패:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>콘텐츠를 불러올 수 없습니다</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 콘텐츠 열기 (iframe 모달 방식)
        async function openContent(contentId) {
            try {
                // 콘텐츠 상세 정보 가져오기
                const response = await API.getContentDetail(contentId);
                const content = response.data.content;

                if (content.filename) {
                    // 모달 제목 설정
                    document.getElementById('modalTitle').textContent = content.title || '학습 콘텐츠';

                    // iframe 설정
                    const iframe = document.getElementById('contentIframe');
                    iframe.setAttribute('data-content-id', contentId);
                    iframe.setAttribute('data-content-title', content.title || '');
                    // 캐시 방지를 위해 타임스탬프 추가
                    iframe.src = 'contents/' + content.filename + '?v=' + Date.now();

                    // 모달 표시
                    document.getElementById('contentModal').classList.add('active');
                } else {
                    showNotification('error', '오류', '콘텐츠 파일을 찾을 수 없습니다.');
                }
            } catch (error) {
                console.error('콘텐츠 로드 실패:', error);
                showNotification('error', '오류', '콘텐츠를 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 콘텐츠 모달 닫기
        function closeContentModal() {
            const modal = document.getElementById('contentModal');
            const iframe = document.getElementById('contentIframe');

            // 모달 숨기기
            modal.classList.remove('active');

            // iframe 초기화 (메모리 정리)
            setTimeout(() => {
                iframe.src = '';
                iframe.removeAttribute('data-content-id');
                iframe.removeAttribute('data-content-title');
            }, 300);
        }

        // 현재 콘텐츠 ID 가져오기
        function getCurrentContentId() {
            const iframe = document.getElementById('contentIframe');
            return iframe ? iframe.getAttribute('data-content-id') : null;
        }

        // 현재 콘텐츠 제목 가져오기
        function getCurrentContentTitle() {
            const iframe = document.getElementById('contentIframe');
            return iframe ? iframe.getAttribute('data-content-title') : '알 수 없는 콘텐츠';
        }

        // 전역 학습 기록 저장 (모달에서 사용)
        let allLearningRecords = [];

        // 전체 학습 기록 로드
        async function loadAllRecords() {
            const container = document.getElementById('allRecordsContainer');

            try {
                const response = await API.getMyRecords();
                const records = response.data?.records || [];

                // 전역 변수에 저장
                allLearningRecords = records;

                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>아직 학습 기록이 없습니다</h3>
                            <p>학습 콘텐츠를 시작해보세요!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>콘텐츠</th>
                                <th>학습 날짜</th>
                                <th>점수</th>
                                <th>정답률</th>
                                <th>진행률</th>
                                <th>학습 시간</th>
                                <th>틀린 문제</th>
                                <th>상세</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => {
                                const date = record.createdAt || record.completedAt || record.endTime || new Date().toISOString();
                                const accuracy = record.accuracy || 0;
                                const score = record.totalScore || record.score || 0;
                                const timeSpent = record.timeSpent || 0;
                                const progress = record.progress || 100;
                                const wrongCount = record.wrongQuestions ? record.wrongQuestions.length : (record.wrongAnswers || 0);

                                return `
                                <tr style="cursor: pointer;" onclick="showLearningResultModal('${record.recordId}')">
                                    <td>${record.contentTitle || record.contentId}</td>
                                    <td>${new Date(date).toLocaleString('ko-KR')}</td>
                                    <td>${getScoreBadge(score)}</td>
                                    <td>${accuracy}%</td>
                                    <td>${progress}%</td>
                                    <td>${timeSpent}분</td>
                                    <td>
                                        ${wrongCount > 0
                                            ? `<button class="btn-wrong-questions" onclick="event.stopPropagation(); showWrongQuestionsModal('${record.recordId}')">${wrongCount}개</button>`
                                            : '-'}
                                    </td>
                                    <td><button class="btn-view-detail" onclick="event.stopPropagation(); showLearningResultModal('${record.recordId}')">보기</button></td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('학습 기록 로드 실패:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>학습 기록을 불러올 수 없습니다</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // 로그아웃
        function handleLogout() {
            if (confirm('로그아웃 하시겠습니까?')) {
                clearAuth();
                window.location.href = 'login.html';
            }
        }

        // ==================== 학습 완료 데이터 수신 ====================

        // postMessage 수신 리스너
        window.addEventListener('message', async (event) => {
            console.log('=== 메시지 수신됨 ===');
            console.log('event.origin:', event.origin);
            console.log('event.data:', event.data);

            // 보안: 같은 origin인지 확인 (선택적)
            // if (event.origin !== window.location.origin) return;

            const message = event.data;

            // 학습 완료 메시지 확인 (두 가지 형식 지원)
            if (message.type === 'korean-farm-v2' && message.event === 'all-stages-complete') {
                console.log('워크북 형식 학습 완료 메시지 감지');
                // 워크북 시리즈 형식
                await handleLearningComplete(message.data);
            } else if (message.type === 'korean-farm.v2' && message.activity === 'complete') {
                console.log('러셀1 형식 학습 완료 메시지 감지');
                // 러셀1 시리즈 형식
                await handleLearningComplete(message.payload, true);
            } else {
                console.log('학습 완료 메시지가 아님 - 타입:', message.type, '이벤트:', message.event || message.activity);
            }
        });

        // 학습 완료 처리
        async function handleLearningComplete(learningData, isRussellFormat = false) {
            console.log('학습 완료 데이터 수신:', learningData);

            try {
                // 1. 현재 콘텐츠 정보
                const contentId = getCurrentContentId();
                const contentTitle = getCurrentContentTitle();

                if (!contentId) {
                    console.error('콘텐츠 ID를 찾을 수 없습니다.');
                    showNotification('error', '오류', '콘텐츠 정보를 찾을 수 없습니다.');
                    return;
                }

                // 2. 로딩 표시
                showNotification('info', '저장 중', '학습 결과를 저장하는 중입니다...');

                // 3. 데이터 형식 변환
                let recordData;
                if (isRussellFormat) {
                    // 러셀1 형식
                    const totalCorrect = learningData.totalCorrect || 0;
                    const totalWrong = learningData.totalWrong || 0;

                    // 각 스테이지별 전체 문제 수 합산
                    let totalQuestionsFromStages = 0;
                    if (learningData.stageDetails) {
                        Object.keys(learningData.stageDetails).forEach(stageKey => {
                            const stage = learningData.stageDetails[stageKey];
                            if (stage.totalQuestions) {
                                totalQuestionsFromStages += stage.totalQuestions;
                            }
                        });
                    }

                    // 전체 문제 수 결정 (스테이지별 합계 우선, 없으면 learningData에서, 없으면 정답+오답)
                    const totalQuestions = totalQuestionsFromStages > 0
                        ? totalQuestionsFromStages
                        : (learningData.totalQuestions || (totalCorrect + totalWrong));

                    const answeredQuestions = learningData.answeredQuestions || (totalCorrect + totalWrong);

                    // 진행률 계산: (푼 문제 수 / 전체 문제 수) * 100
                    const progress = totalQuestions > 0
                        ? Math.round((answeredQuestions / totalQuestions) * 100)
                        : 100;

                    console.log('진행률 계산 (Russell):', {
                        totalQuestionsFromStages,
                        totalQuestions,
                        answeredQuestions,
                        totalCorrect,
                        totalWrong,
                        progress: progress + '%'
                    });

                    recordData = {
                        contentId: contentId,
                        contentTitle: contentTitle,
                        score: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        totalScore: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        timeSpent: Math.floor((learningData.sessionTime || 0) / 60), // 초 -> 분
                        completedStages: learningData.stageDetails ? Object.keys(learningData.stageDetails) : [],
                        completedAt: new Date().toISOString(),
                        status: 'completed',
                        completed: true,
                        progress: progress,
                        accuracy: learningData.totalAccuracy || 0,
                        totalQuestions: totalQuestions,
                        correctAnswers: totalCorrect,
                        wrongAnswers: totalWrong,
                        stagesDetail: learningData.stageDetails || {},
                        wrongQuestions: extractWrongQuestions(learningData.stageDetails || {})
                    };
                } else {
                    // 워크북 형식
                    const totalCorrect = learningData.totalCorrect || 0;
                    const totalWrong = learningData.totalWrong || 0;

                    // 각 스테이지별 전체 문제 수 합산
                    let totalQuestionsFromStages = 0;
                    if (learningData.stagesDetail) {
                        Object.keys(learningData.stagesDetail).forEach(stageKey => {
                            const stage = learningData.stagesDetail[stageKey];
                            if (stage.totalQuestions) {
                                totalQuestionsFromStages += stage.totalQuestions;
                            }
                        });
                    }

                    // 전체 문제 수 결정 (스테이지별 합계 우선, 없으면 learningData에서, 없으면 정답+오답)
                    const totalQuestions = totalQuestionsFromStages > 0
                        ? totalQuestionsFromStages
                        : (learningData.totalQuestions || (totalCorrect + totalWrong));

                    const answeredQuestions = learningData.answeredQuestions || (totalCorrect + totalWrong);

                    // 진행률 계산: (푼 문제 수 / 전체 문제 수) * 100
                    const progress = totalQuestions > 0
                        ? Math.round((answeredQuestions / totalQuestions) * 100)
                        : 100;

                    console.log('진행률 계산:', {
                        totalQuestionsFromStages,
                        totalQuestions,
                        answeredQuestions,
                        totalCorrect,
                        totalWrong,
                        progress: progress + '%'
                    });

                    recordData = {
                        contentId: contentId,
                        contentTitle: contentTitle,
                        score: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        totalScore: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        timeSpent: Math.floor((learningData.totalElapsedTime || 0) / 60000), // ms -> 분
                        completedStages: learningData.stagesDetail ? Object.keys(learningData.stagesDetail) : [],
                        startTime: learningData.timestamp ? new Date(learningData.timestamp - learningData.totalElapsedTime).toISOString() : new Date().toISOString(),
                        endTime: learningData.timestamp ? new Date(learningData.timestamp).toISOString() : new Date().toISOString(),
                        duration: Math.floor((learningData.totalElapsedTime || 0) / 1000), // ms -> 초
                        status: 'completed',
                        completed: true,
                        progress: progress,
                        accuracy: learningData.totalAccuracy || 0,
                        totalQuestions: totalQuestions,
                        correctAnswers: totalCorrect,
                        wrongAnswers: totalWrong,
                        stagesDetail: learningData.stagesDetail || {},
                        wrongQuestions: extractWrongQuestions(learningData.stagesDetail || {})
                    };
                }

                console.log('저장할 데이터:', recordData);

                // 4. API 호출하여 학습 기록 저장
                const response = await API.saveLearningRecord(recordData);

                console.log('저장 응답:', response);

                // 5. 학습 수 증가 (비동기로 실행하여 UI 블로킹 방지)
                API.incrementLearningCount(contentId).catch(error => {
                    console.error('학습 수 증가 실패:', error);
                    // 학습 수 증가 실패는 사용자에게 알리지 않음 (중요하지 않은 작업)
                });

                // 6. 성공 알림
                showNotification('success', '완료!', `학습이 완료되었습니다! 점수: ${recordData.score}점 🎉`);

                // 7. 모달 닫기
                setTimeout(() => {
                    closeContentModal();
                }, 1500);

                // 8. 학습 기록 페이지로 이동
                setTimeout(() => {
                    showSection('records');
                }, 2000);

                // 9. 데이터 새로고침
                setTimeout(async () => {
                    await loadAllRecords();
                    await loadOverview();
                }, 2500);

            } catch (error) {
                console.error('학습 기록 저장 실패:', error);
                showNotification('error', '저장 실패', '학습 기록 저장에 실패했습니다: ' + error.message);
            }
        }

        // ==================== 데이터 처리 헬퍼 함수 ====================

        // 틀린 문제 추출
        function extractWrongQuestions(stagesDetail) {
            const wrongQuestions = [];

            Object.keys(stagesDetail).forEach(stageKey => {
                const stage = stagesDetail[stageKey];
                if (stage.wrongQuestions && Array.isArray(stage.wrongQuestions)) {
                    stage.wrongQuestions.forEach(wq => {
                        wrongQuestions.push({
                            stage: stageKey,
                            ...wq
                        });
                    });
                }
            });

            return wrongQuestions;
        }

        // 시간 포맷 (초 -> "00:00" 형식)
        function formatTimeFromSeconds(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ==================== UI 헬퍼 함수 ====================

        // 알림 표시
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');

            // 이전 클래스 제거
            notification.classList.remove('success', 'error', 'info', 'show');

            // 새 내용 설정
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;

            // 타입별 클래스 추가
            notification.classList.add(type, 'show');

            // 3초 후 자동 숨김 (info 타입은 숨기지 않음)
            if (type !== 'info') {
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // 알림 숨기기
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // ==================== 학습 결과 모달 ====================

        // 학습 결과 모달 표시
        function showLearningResultModal(recordId) {
            const record = allLearningRecords.find(r => r.recordId === recordId);
            if (!record) {
                showNotification('error', '오류', '학습 기록을 찾을 수 없습니다.');
                return;
            }

            const modal = document.getElementById('learningResultModal');
            const content = document.getElementById('learningResultContent');

            // 전체 통계
            const totalCorrect = record.correctAnswers || 0;
            const totalWrong = record.wrongAnswers || 0;
            const overallAccuracy = record.accuracy || 0;
            const totalScore = record.totalScore || record.score || 0;
            const timeSpent = record.timeSpent || 0;
            const duration = record.duration || 0;

            // 단계별 결과
            const stagesDetail = record.stagesDetail || record.stages || {};

            // 스테이지명 맵핑
            const stageNames = {
                stage1: '1단계: 딥리서치',
                stage2: '2단계: 어휘 학습',
                stage3: '3단계: 문장 독해',
                stage4: '4단계: OX퀴즈',
                stage5: '5단계: 서술형 문제'
            };

            // HTML 생성 (학습 페이지와 동일한 스타일)
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">🎉 학습 완료!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">${record.contentTitle}</p>
                        <p style="font-size: 14px; color: #95a5a6; margin-top: 10px;">
                            ${new Date(record.createdAt || record.completedAt || record.endTime).toLocaleString('ko-KR')}
                        </p>
                    </div>

                    <!-- 전체 학습 결과 -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">📊 전체 학습 결과</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총점</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}점</div>
                            </div>
                            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">전체 정답률</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">정답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}개</div>
                            </div>
                            <div style="background: #fef2f2; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">오답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}개</div>
                            </div>
                            <div style="background: #fffbeb; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총 소요 시간</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${timeSpent}분</div>
                            </div>
                        </div>
                    </div>

                    <!-- 단계별 결과 -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">📈 단계별 학습 결과</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // 각 단계별 결과 카드
            Object.keys(stagesDetail).forEach(stageKey => {
                const result = stagesDetail[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey] || stageKey}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답률:</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답:</span>
                                <strong>${result.correct}개</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">오답:</span>
                                <strong style="color: #e74c3c;">${result.wrong}회</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">점수:</span>
                                <strong style="color: #3498db;">${result.score ? result.score.toFixed(1) : 0}점</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <!-- 인쇄 버튼 -->
                    <div style="text-align: center; margin-top: 30px;" class="no-print">
                        <button onclick="printLearningResult()" style="background: #3498db; color: white; border: none; padding: 15px 40px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);">
                            🖨️ 결과 인쇄하기
                        </button>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            modal.classList.add('active');
        }

        // 학습 결과 모달 닫기
        function closeLearningResultModal() {
            document.getElementById('learningResultModal').classList.remove('active');
        }

        // 학습 결과 인쇄
        function printLearningResult() {
            window.print();
        }

        // 틀린 문제 모달 표시
        function showWrongQuestionsModal(recordId) {
            const record = allLearningRecords.find(r => r.recordId === recordId);
            if (!record) {
                showNotification('error', '오류', '학습 기록을 찾을 수 없습니다.');
                return;
            }

            const modal = document.getElementById('wrongQuestionsModal');
            const content = document.getElementById('wrongQuestionsContent');

            const wrongQuestions = record.wrongQuestions || [];

            if (wrongQuestions.length === 0) {
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <h2 style="font-size: 28px; color: #27ae60; margin-bottom: 15px;">🎉 완벽합니다!</h2>
                        <p style="font-size: 18px; color: #7f8c8d;">모든 문제를 맞추셨습니다!</p>
                    </div>
                `;
            } else {
                let html = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                        <h2 style="text-align: center; font-size: 28px; color: #2c3e50; margin-bottom: 10px;">❌ 틀린 문제 (${wrongQuestions.length}개)</h2>
                        <p style="text-align: center; font-size: 14px; color: #7f8c8d; margin-bottom: 30px;">${record.contentTitle}</p>
                `;

                wrongQuestions.forEach((wq, idx) => {
                    html += `
                        <div style="background: white; border: 2px solid #f093fb; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); page-break-inside: avoid;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <strong style="color: #667eea;">${wq.stage ? wq.stage.toUpperCase() : ''}</strong>
                            </div>
                            <p style="font-weight: 600; color: #495057; margin-bottom: 12px; font-size: 16px;">문제 ${idx + 1}: ${wq.question || ''}</p>
                            <p style="color: #dc3545; margin-bottom: 8px;"><strong>❌ 당신의 답:</strong> ${wq.userAnswer || '-'}</p>
                            <p style="color: #28a745;"><strong>✅ 정답:</strong> ${wq.correctAnswer || wq.answer || '-'}</p>
                            ${wq.explanation ? `<p style="margin-top: 12px; padding: 12px; background: #e7f3ff; border-left: 4px solid #3498db; border-radius: 5px;"><strong>💡 해설:</strong> ${wq.explanation}</p>` : ''}
                        </div>
                    `;
                });

                html += `
                        <!-- 인쇄 버튼 -->
                        <div style="text-align: center; margin-top: 30px;" class="no-print">
                            <button onclick="printWrongQuestions()" style="background: #e74c3c; color: white; border: none; padding: 15px 40px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                                🖨️ 틀린 문제 인쇄하기
                            </button>
                        </div>
                    </div>
                `;
                content.innerHTML = html;
            }

            modal.classList.add('active');
        }

        // 틀린 문제 모달 닫기
        function closeWrongQuestionsModal() {
            document.getElementById('wrongQuestionsModal').classList.remove('active');
        }

        // 틀린 문제 인쇄
        function printWrongQuestions() {
            window.print();
        }

        // ==================== 랭킹 관련 함수 ====================

        // 현재 선택된 학교급 필터
        let currentSchoolLevel = 'all';

        // 학년을 학교급으로 변환
        function getSchoolLevelFromGrade(grade) {
            if (!grade) return 'unknown';

            // 재수생은 고등부로 분류
            if (typeof grade === 'string') {
                const gradeStr = grade.toLowerCase();
                if (gradeStr.includes('재수') || gradeStr === '재수생') {
                    return 'high';
                }
            }

            // 숫자 추출 (예: "중1" -> 7, "고2" -> 11, "초5" -> 5)
            let gradeNum = 0;

            if (typeof grade === 'string') {
                if (grade.includes('초')) {
                    // 초1~초6
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) : 0;
                } else if (grade.includes('중')) {
                    // 중1~중3 -> 7~9
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) + 6 : 0;
                } else if (grade.includes('고')) {
                    // 고1~고3 -> 10~12
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) + 9 : 0;
                } else {
                    // "5학년" 같은 형식
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) : 0;
                }
            } else {
                gradeNum = parseInt(grade);
            }

            // 초등부: 1~6학년
            if (gradeNum >= 1 && gradeNum <= 6) return 'elementary';
            // 중등부: 중1~중3 (7~9)
            if (gradeNum >= 7 && gradeNum <= 9) return 'middle';
            // 고등부: 고1~고3 (10~12)
            if (gradeNum >= 10 && gradeNum <= 12) return 'high';

            return 'unknown';
        }

        // 학교급 필터 적용
        function filterBySchoolLevel(level) {
            currentSchoolLevel = level;

            // 버튼 활성화 상태 변경
            document.querySelectorAll('.level-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 현재 활성화된 탭의 랭킹 다시 로드
            const activeTabs = document.querySelectorAll('.ranking-tab.active');
            if (activeTabs.length > 0) {
                const activeTab = activeTabs[0].textContent;
                if (activeTab.includes('누적')) {
                    loadCumulativeRanking();
                } else if (activeTab.includes('주간')) {
                    loadWeeklyRanking();
                } else if (activeTab.includes('월간')) {
                    loadMonthlyRanking();
                }
            }
        }

        // 랭킹 로드
        async function loadRanking() {
            // 누적 랭킹 로드
            await loadCumulativeRanking();
        }

        // 랭킹 탭 전환
        function showRankingTab(tabType) {
            // 탭 버튼 활성화
            document.querySelectorAll('.ranking-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // 랭킹 컨텐츠 표시
            document.querySelectorAll('.ranking-content').forEach(content => {
                content.style.display = 'none';
            });

            if (tabType === 'cumulative') {
                document.getElementById('cumulativeRanking').style.display = 'block';
                loadCumulativeRanking();
            } else if (tabType === 'weekly') {
                document.getElementById('weeklyRanking').style.display = 'block';
                loadWeeklyRanking();
            } else if (tabType === 'monthly') {
                document.getElementById('monthlyRanking').style.display = 'block';
                loadMonthlyRanking();
            }
        }

        // 누적 랭킹 로드
        async function loadCumulativeRanking() {
            const container = document.getElementById('cumulativeRankingContainer');

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                console.log('랭킹 API 응답:', response);
                console.log('전체 레코드 수:', records.length);

                // 학생별 누적 점수 계산
                const studentScores = {};
                records.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || '알 수 없음';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // 배열로 변환
                let rankings = Object.values(studentScores);
                console.log('필터 전 학생 수:', rankings.length);
                console.log('현재 학교급 필터:', currentSchoolLevel);

                // 학교급 필터 적용
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        console.log(`학생: ${student.userName}, 학년: ${student.userGrade}, 학교급: ${schoolLevel}`);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                console.log('필터 후 학생 수:', rankings.length);

                // 점수순 정렬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">아직 랭킹 데이터가 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                // 현재 사용자 ID
                const currentUserId = getCurrentUser().userId;

                // 랭킹 HTML 생성
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) {
                        rankBadge = `<div class="rank-badge gold">🥇</div>`;
                    } else if (rank === 2) {
                        rankBadge = `<div class="rank-badge silver">🥈</div>`;
                    } else if (rank === 3) {
                        rankBadge = `<div class="rank-badge bronze">🥉</div>`;
                    }

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (나)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">총점</div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}점</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">정답률</div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">학습 수</div>
                                <div class="rank-stat-value count">${student.learningCount}회</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('랭킹 로드 실패:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">랭킹을 불러올 수 없습니다.</p>
                    </div>
                `;
            }
        }

        // 주간 랭킹 로드
        async function loadWeeklyRanking() {
            const container = document.getElementById('weeklyRankingContainer');
            const periodInfo = document.getElementById('weeklyPeriod');

            // 이번 주 시작일과 종료일 계산
            const now = new Date();
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - dayOfWeek);
            weekStart.setHours(0, 0, 0, 0);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            periodInfo.innerHTML = `${weekStart.toLocaleDateString('ko-KR')} ~ ${weekEnd.toLocaleDateString('ko-KR')}`;

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // 이번 주 기록만 필터링
                const weekRecords = records.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= weekStart && recordDate <= weekEnd;
                });

                // 학생별 점수 계산
                const studentScores = {};
                weekRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || '알 수 없음';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // 배열로 변환
                let rankings = Object.values(studentScores);

                // 학교급 필터 적용
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // 점수순 정렬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">이번 주 학습 기록이 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                // 현재 사용자 ID
                const currentUserId = getCurrentUser().userId;

                // 랭킹 HTML 생성 (누적 랭킹과 동일한 포맷)
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">🥇</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">🥈</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">🥉</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (나)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">총점</div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}점</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">정답률</div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">학습 수</div>
                                <div class="rank-stat-value count">${student.learningCount}회</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('주간 랭킹 로드 실패:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">주간 랭킹을 불러올 수 없습니다.</p>
                    </div>
                `;
            }
        }

        // 월간 랭킹 로드
        async function loadMonthlyRanking() {
            const container = document.getElementById('monthlyRankingContainer');
            const periodInfo = document.getElementById('monthlyPeriod');

            // 이번 달 시작일과 종료일 계산
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            periodInfo.innerHTML = `${monthStart.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' })}`;

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // 이번 달 기록만 필터링
                const monthRecords = records.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= monthStart && recordDate <= monthEnd;
                });

                // 학생별 점수 계산
                const studentScores = {};
                monthRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || '알 수 없음';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // 배열로 변환
                let rankings = Object.values(studentScores);

                // 학교급 필터 적용
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // 점수순 정렬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">이번 달 학습 기록이 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                // 현재 사용자 ID
                const currentUserId = getCurrentUser().userId;

                // 랭킹 HTML 생성
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">🥇</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">🥈</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">🥉</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (나)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">총점</div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}점</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">정답률</div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">학습 수</div>
                                <div class="rank-stat-value count">${student.learningCount}회</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('월간 랭킹 로드 실패:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">월간 랭킹을 불러올 수 없습니다.</p>
                    </div>
                `;
            }
        }

        // 컨텐츠별 랭킹 모달 표시
        async function showContentRanking(contentId, contentTitle) {
            const modal = document.getElementById('contentRankingModal');
            const content = document.getElementById('contentRankingContent');

            content.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // 해당 컨텐츠 기록만 필터링
                const contentRecords = records.filter(record => record.contentId === contentId);

                // 학생별 누적 점수 계산
                const studentScores = {};
                contentRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || '알 수 없음';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            bestScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].bestScore = Math.max(studentScores[userId].bestScore, score);
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // 배열로 변환하고 누적 점수순 정렬
                const rankings = Object.values(studentScores).sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    content.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <h2 style="font-size: 24px; color: #2c3e50; margin-bottom: 15px;">🏆 ${contentTitle}</h2>
                            <p style="font-size: 18px; color: #7f8c8d;">아직 이 컨텐츠의 학습 기록이 없습니다.</p>
                        </div>
                    `;
                    return;
                }

                // 현재 사용자 ID
                const currentUserId = getCurrentUser().userId;

                // 랭킹 HTML 생성
                let html = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                        <h2 style="text-align: center; font-size: 28px; color: #2c3e50; margin-bottom: 10px;">🏆 컨텐츠 랭킹</h2>
                        <p style="text-align: center; font-size: 16px; color: #7f8c8d; margin-bottom: 30px;">${contentTitle}</p>
                        <div class="ranking-table">
                `;

                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const avgScore = student.totalScore / student.learningCount;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">🥇</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">🥈</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">🥉</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (나)' : ''}</div>
                                    <div class="student-school">${student.userSchool}${student.userGrade ? ' · ' + student.userGrade : ''}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">누적 점수</div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}점</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">평균 점수</div>
                                <div class="rank-stat-value">${avgScore.toFixed(1)}점</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">학습 횟수</div>
                                <div class="rank-stat-value count">${student.learningCount}회</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;

                content.innerHTML = html;

            } catch (error) {
                console.error('컨텐츠 랭킹 로드 실패:', error);
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">랭킹을 불러올 수 없습니다.</p>
                    </div>
                `;
            }
        }

        // 컨텐츠별 랭킹 모달 닫기
        function closeContentRankingModal() {
            document.getElementById('contentRankingModal').classList.remove('active');
        }

        // ==================== 초기화 ====================

        // 페이지 로드 시 학습 현황 표시
        loadOverview();

        console.log('학습 완료 메시지 리스너 등록 완료');
    </script>
</body>
</html>
