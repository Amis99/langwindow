<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ë§ˆì´í˜ì´ì§€ - ì–¸ì–´ì˜ ì°½ ì˜¨ë¼ì¸ í•™ìŠµê´€</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 280px;
            background: #1e40af;
            color: white;
            padding: 30px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 0 30px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info p {
            font-size: 14px;
            margin: 5px 0;
        }

        .user-info .user-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .user-scores {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .score-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .score-value {
            font-size: 18px;
            font-weight: 700;
            color: #fff;
        }

        .sidebar-ranking {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .sidebar-ranking-header {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 10px;
            text-align: center;
        }

        .sidebar-ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
        }

        .sidebar-ranking-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .sidebar-ranking-value {
            font-size: 20px;
            font-weight: 700;
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .sidebar-nav {
            margin-top: 30px;
        }

        .nav-item {
            padding: 15px 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            border-left: 4px solid white;
        }

        .logout-btn {
            margin: 30px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            width: calc(100% - 60px);
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 30px;
        }

        .section-header h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .section-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        .stat-card.clickable:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-card .stat-unit {
            font-size: 16px;
            color: #7f8c8d;
            margin-left: 5px;
        }

        /* ì½˜í…ì¸  ê·¸ë¦¬ë“œ */
        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            cursor: pointer;
        }

        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .content-card .category-badge {
            display: inline-block;
            padding: 5px 12px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .content-card h3 {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .content-card .learning-count {
            font-size: 13px;
            color: #7f8c8d;
        }

        /* í•™ìŠµ ê¸°ë¡ í…Œì´ë¸” */
        .records-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }

        .records-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .records-table th {
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            font-size: 14px;
        }

        .records-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            color: #34495e;
            font-size: 14px;
        }

        .records-table tr:last-child td {
            border-bottom: none;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
        }

        .score-high {
            background: #d4edda;
            color: #155724;
        }

        .score-medium {
            background: #fff3cd;
            color: #856404;
        }

        .score-low {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-container {
            text-align: center;
            padding: 60px 20px;
        }

        /* ì½˜í…ì¸  ëª¨ë‹¬ */
        .content-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .content-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            height: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2563eb;
            color: white;
        }

        .modal-header h2 {
            font-size: 22px;
            margin: 0;
        }

        .modal-close-btn {
            font-size: 32px;
            border: none;
            background: none;
            color: white;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 300px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification.info {
            border-left: 4px solid #3498db;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .notification-message {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-view-detail, .btn-wrong-questions, .btn-content-ranking {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-view-detail {
            background: #2563eb;
            color: white;
        }

        .btn-view-detail:hover {
            transform: scale(1.05);
            background: #1d4ed8;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        .btn-content-ranking {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: 600;
        }

        .btn-content-ranking:hover {
            transform: scale(1.05);
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-wrong-questions {
            background: #dc2626;
            color: white;
        }

        .btn-wrong-questions:hover {
            transform: scale(1.05);
            background: #b91c1c;
            box-shadow: 0 4px 10px rgba(220, 38, 38, 0.3);
        }

        /* í•™ìŠµ ê²°ê³¼ ëª¨ë‹¬ */
        .result-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .result-modal.active {
            display: flex;
        }

        .result-modal-content {
            background: #f5f6fa;
            border-radius: 15px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .result-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 32px;
            border: none;
            background: rgba(0, 0, 0, 0.1);
            color: #2c3e50;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .result-modal-close:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* ==================== ë­í‚¹ ìŠ¤íƒ€ì¼ ==================== */
        .ranking-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .ranking-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .ranking-tab:hover {
            color: #3498db;
            background: #f8f9fa;
        }

        .ranking-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 700;
        }

        /* í•™êµê¸‰ í•„í„° */
        .school-level-filter {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .level-filter-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            background: white;
            font-size: 14px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-filter-btn:hover {
            border-color: #3498db;
            color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }

        .level-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .ranking-content {
            animation: fadeIn 0.3s ease;
        }

        .ranking-period-info {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ranking-period-info p {
            color: #2c3e50;
            font-weight: 600;
            margin: 0;
        }

        .ranking-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ranking-item {
            display: grid;
            grid-template-columns: 80px 1fr 150px 150px 150px;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s ease;
        }

        .ranking-item:hover {
            background: #f8f9fa;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-item.my-rank {
            background: #e8f4f8;
            font-weight: 600;
        }

        .rank-badge {
            font-size: 28px;
            font-weight: 700;
            text-align: center;
        }

        .rank-badge.gold {
            color: #FFD700;
            font-size: 36px;
        }

        .rank-badge.silver {
            color: #C0C0C0;
            font-size: 34px;
        }

        .rank-badge.bronze {
            color: #CD7F32;
            font-size: 32px;
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .student-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .student-details {
            flex: 1;
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }

        .student-school {
            font-size: 13px;
            color: #7f8c8d;
        }

        .rank-stat {
            text-align: center;
        }

        .rank-stat-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .rank-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }

        .rank-stat-value.score {
            color: #3498db;
        }

        .rank-stat-value.accuracy {
            color: #27ae60;
        }

        .rank-stat-value.count {
            color: #e67e22;
        }

        .content-ranking-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .content-ranking-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* ==================== ì¸ì‡„ ìŠ¤íƒ€ì¼ ==================== */
        @media print {
            /* ì¸ì‡„ ì‹œ ì‚¬ì´ë“œë°”, í—¤ë” ë“± ìˆ¨ê¸°ê¸° */
            .sidebar,
            .main-content > header,
            .no-print,
            .result-modal-close {
                display: none !important;
            }

            /* ëª¨ë‹¬ ë°°ê²½ ì œê±° */
            .result-modal {
                position: static !important;
                background: white !important;
                overflow: visible !important;
            }

            /* ëª¨ë‹¬ ì»¨í…ì¸  ì „ì²´ í™”ë©´ìœ¼ë¡œ */
            .result-modal-content {
                max-width: 100% !important;
                max-height: none !important;
                overflow: visible !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 20px !important;
            }

            /* í˜ì´ì§€ ì—¬ë°± ì„¤ì • */
            @page {
                margin: 1cm;
            }

            /* ë³¸ë¬¸ ì—¬ë°± ì œê±° */
            body {
                margin: 0;
                padding: 0;
            }

            /* í˜ì´ì§€ êµ¬ë¶„ ë°©ì§€ */
            .page-break-avoid {
                page-break-inside: avoid;
            }

            /* ìƒ‰ìƒ ìœ ì§€ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            /* ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
            button {
                display: none !important;
            }

            /* ë§í¬ ë°‘ì¤„ ì œê±° */
            a {
                text-decoration: none;
                color: inherit;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ“š í•™ìƒ ë§ˆì´í˜ì´ì§€</h1>
                <div class="user-info">
                    <p class="user-name" id="userName">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    <p id="userSchool">-</p>
                    <p id="userGrade">-</p>
                </div>
                <div class="user-scores">
                    <div class="score-item">
                        <span class="score-label">ëˆ„ì  ì ìˆ˜</span>
                        <span class="score-value" id="totalScore">0ì </span>
                    </div>
                    <div class="score-item">
                        <span class="score-label">ì´ë²ˆ ì£¼ ì ìˆ˜</span>
                        <span class="score-value" id="weeklyScore">0ì </span>
                    </div>
                </div>

                <!-- ì£¼ê°„ ë­í‚¹ -->
                <div class="sidebar-ranking">
                    <div class="sidebar-ranking-header">ğŸ† ì´ë²ˆ ì£¼ ë­í‚¹</div>
                    <div class="sidebar-ranking-item">
                        <span class="sidebar-ranking-label" id="sidebarSchoolLevel">-</span>
                        <span class="sidebar-ranking-value" id="sidebarRank">-</span>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item active" onclick="showSection('overview')">
                    ğŸ“Š í•™ìŠµ í˜„í™©
                </div>
                <div class="nav-item" onclick="showSection('contents')">
                    ğŸ“– í•™ìŠµ ì½˜í…ì¸ 
                </div>
                <div class="nav-item" onclick="showSection('records')">
                    ğŸ“ í•™ìŠµ ê¸°ë¡
                </div>
                <div class="nav-item" onclick="showSection('ranking')">
                    ğŸ† ë­í‚¹
                </div>
            </nav>

            <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </aside>

        <!-- ë©”ì¸ ì½˜í…ì¸  -->
        <main class="main-content">
            <!-- í•™ìŠµ í˜„í™© ì„¹ì…˜ -->
            <section id="overview" class="content-section active">
                <div class="section-header">
                    <h2>ğŸ“Š í•™ìŠµ í˜„í™©</h2>
                    <p>ë‚˜ì˜ í•™ìŠµ í†µê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card clickable" onclick="showSection('contents')">
                        <h3>ì´ í•™ìŠµ ì½˜í…ì¸ </h3>
                        <div>
                            <span class="stat-value" id="totalContents">0</span>
                            <span class="stat-unit">ê°œ</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>ì™„ë£Œí•œ í•™ìŠµ</h3>
                        <div>
                            <span class="stat-value" id="completedRecords">0</span>
                            <span class="stat-unit">ê°œ</span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>í‰ê·  ì ìˆ˜</h3>
                        <div>
                            <span class="stat-value" id="avgScore">0</span>
                            <span class="stat-unit">ì </span>
                        </div>
                    </div>
                    <div class="stat-card clickable" onclick="showSection('records')">
                        <h3>ì´ í•™ìŠµ ì‹œê°„</h3>
                        <div>
                            <span class="stat-value" id="totalTime">0</span>
                            <span class="stat-unit">ë¶„</span>
                        </div>
                    </div>
                </div>

                <div class="records-table">
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">ìµœê·¼ í•™ìŠµ ê¸°ë¡</h3>
                    <div id="recentRecordsContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- í•™ìŠµ ì½˜í…ì¸  ì„¹ì…˜ -->
            <section id="contents" class="content-section">
                <div class="section-header">
                    <h2>ğŸ“– í•™ìŠµ ì½˜í…ì¸ </h2>
                    <p>ì‚¬ìš© ê°€ëŠ¥í•œ í•™ìŠµ ìë£Œë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <!-- í•„í„° ë° ì •ë ¬ ì»¨íŠ¸ë¡¤ -->
                <div class="filter-sort-controls" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <!-- ë¶„ë¥˜ í•„í„° -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">ë¶„ë¥˜</label>
                        <select id="categoryFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">ì „ì²´</option>
                            <option value="ë¬¸í•™ ì›Œí¬ë¶">ë¬¸í•™ ì›Œí¬ë¶</option>
                            <option value="ë¹„ë¬¸í•™ ì›Œí¬ë¶">ë¹„ë¬¸í•™ ì›Œí¬ë¶</option>
                            <option value="ë¬¸ë²• ì›Œí¬ë¶">ë¬¸ë²• ì›Œí¬ë¶</option>
                            <option value="ëŸ¬ì…€">ëŸ¬ì…€</option>
                            <option value="ì†Œì‰¬ë¥´">ì†Œì‰¬ë¥´</option>
                        </select>
                    </div>

                    <!-- ë‚œì´ë„ í•„í„° -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">ë‚œì´ë„</label>
                        <select id="difficultyFilter" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">ì „ì²´</option>
                            <option value="ê¸°ì´ˆ">ê¸°ì´ˆ</option>
                            <option value="ì¤‘ê¸‰">ì¤‘ê¸‰</option>
                            <option value="ê³ ê¸‰">ê³ ê¸‰</option>
                            <option value="ì‹¬í™”">ì‹¬í™”</option>
                        </select>
                    </div>

                    <!-- ì •ë ¬ -->
                    <div style="flex: 1; min-width: 200px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">ì •ë ¬</label>
                        <select id="sortBy" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="recent">ìµœì‹ ìˆœ</option>
                            <option value="popular">ì¸ê¸°ìˆœ (í•™ìŠµ ìˆ˜)</option>
                            <option value="title">ì œëª©ìˆœ</option>
                            <option value="difficulty">ë‚œì´ë„ìˆœ</option>
                        </select>
                    </div>

                    <!-- ê²€ìƒ‰ -->
                    <div style="flex: 1.5; min-width: 250px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50;">ê²€ìƒ‰</label>
                        <input type="text" id="searchInput" placeholder="ì œëª© ê²€ìƒ‰..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                </div>

                <div id="contentsContainer">
                    <div class="loading-container">
                        <div class="spinner"></div>
                    </div>
                </div>
            </section>

            <!-- í•™ìŠµ ê¸°ë¡ ì„¹ì…˜ -->
            <section id="records" class="content-section">
                <div class="section-header">
                    <h2>ğŸ“ í•™ìŠµ ê¸°ë¡</h2>
                    <p>ì „ì²´ í•™ìŠµ ì´ë ¥ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <div class="records-table">
                    <div id="allRecordsContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ë­í‚¹ ì„¹ì…˜ -->
            <section id="ranking" class="content-section">
                <div class="section-header">
                    <h2>ğŸ† ë­í‚¹</h2>
                    <p>ìš°ìˆ˜ í•™ìƒë“¤ì„ í™•ì¸í•˜ì„¸ìš”</p>
                </div>

                <!-- ë­í‚¹ íƒ­ -->
                <div class="ranking-tabs">
                    <button class="ranking-tab active" onclick="showRankingTab('cumulative')">ğŸ“ˆ ëˆ„ì  ë­í‚¹</button>
                    <button class="ranking-tab" onclick="showRankingTab('weekly')">ğŸ“… ì£¼ê°„ ë­í‚¹</button>
                    <button class="ranking-tab" onclick="showRankingTab('monthly')">ğŸ“† ì›”ê°„ ë­í‚¹</button>
                </div>

                <!-- í•™êµê¸‰ í•„í„° -->
                <div class="school-level-filter">
                    <button class="level-filter-btn active" onclick="filterBySchoolLevel('all')">ì „ì²´</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('elementary')">ğŸ’ ì´ˆë“±ë¶€</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('middle')">ğŸ“š ì¤‘ë“±ë¶€</button>
                    <button class="level-filter-btn" onclick="filterBySchoolLevel('high')">ğŸ“ ê³ ë“±ë¶€</button>
                </div>

                <!-- ëˆ„ì  ë­í‚¹ -->
                <div id="cumulativeRanking" class="ranking-content active">
                    <div id="cumulativeRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- ì£¼ê°„ ë­í‚¹ -->
                <div id="weeklyRanking" class="ranking-content" style="display: none;">
                    <div class="ranking-period-info">
                        <p id="weeklyPeriod"></p>
                    </div>
                    <div id="weeklyRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- ì›”ê°„ ë­í‚¹ -->
                <div id="monthlyRanking" class="ranking-content" style="display: none;">
                    <div class="ranking-period-info">
                        <p id="monthlyPeriod"></p>
                    </div>
                    <div id="monthlyRankingContainer">
                        <div class="loading-container">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ì½˜í…ì¸  ëª¨ë‹¬ -->
    <div id="contentModal" class="content-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">í•™ìŠµ ì½˜í…ì¸ </h2>
                <button class="modal-close-btn" onclick="closeContentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <iframe id="contentIframe" src="" data-content-id=""></iframe>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div id="notification" class="notification">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-message" id="notificationMessage"></div>
    </div>

    <!-- í•™ìŠµ ê²°ê³¼ ëª¨ë‹¬ -->
    <div id="learningResultModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeLearningResultModal()">&times;</button>
            <div id="learningResultContent"></div>
        </div>
    </div>

    <!-- í‹€ë¦° ë¬¸ì œ ëª¨ë‹¬ -->
    <div id="wrongQuestionsModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeWrongQuestionsModal()">&times;</button>
            <div id="wrongQuestionsContent"></div>
        </div>
    </div>

    <!-- ì»¨í…ì¸ ë³„ ë­í‚¹ ëª¨ë‹¬ -->
    <div id="contentRankingModal" class="result-modal">
        <div class="result-modal-content">
            <button class="result-modal-close" onclick="closeContentRankingModal()">&times;</button>
            <div id="contentRankingContent"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        // ì¸ì¦ í™•ì¸
        if (!isAuthenticated() || !isStudent()) {
            window.location.href = 'login.html';
        }

        const currentUser = getCurrentUser();

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userSchool').textContent = currentUser.school;
        document.getElementById('userGrade').textContent = currentUser.grade;

        // ì„¹ì…˜ ì „í™˜
        function showSection(sectionId, event = null) {
            // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ë¹„í™œì„±í™”
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // ì„ íƒí•œ ì„¹ì…˜ í‘œì‹œ
            document.getElementById(sectionId).classList.add('active');

            // ì„ íƒí•œ ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ í™œì„±í™”
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // eventê°€ ì—†ì„ ë•ŒëŠ” sectionIdë¡œ ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´í…œ ì°¾ê¸°
                const navItem = document.querySelector(`.nav-item[onclick*="${sectionId}"]`);
                if (navItem) {
                    navItem.classList.add('active');
                }
            }

            // ì„¹ì…˜ë³„ ë°ì´í„° ë¡œë“œ
            if (sectionId === 'overview') {
                loadOverview();
            } else if (sectionId === 'contents') {
                loadContents();
            } else if (sectionId === 'records') {
                loadAllRecords();
            } else if (sectionId === 'ranking') {
                loadRanking();
            }
        }

        // í•™ìŠµ í˜„í™© ë¡œë“œ
        async function loadOverview() {
            try {
                const [contents, records] = await Promise.all([
                    API.getContents(),
                    API.getMyRecords()
                ]);

                // í†µê³„ ê³„ì‚°
                const totalContents = contents.data?.contents?.length || 0;
                const completedRecords = records.data?.records?.length || 0;

                let totalScore = 0;
                let totalMinutes = 0;
                const recordsList = records.data?.records || [];
                recordsList.forEach(record => {
                    if (record.score) totalScore += record.score;
                    if (record.timeSpent) totalMinutes += record.timeSpent;
                });

                const avgScore = completedRecords > 0 ? Math.round(totalScore / completedRecords) : 0;

                // í†µê³„ í‘œì‹œ
                document.getElementById('totalContents').textContent = totalContents;
                document.getElementById('completedRecords').textContent = completedRecords;
                document.getElementById('avgScore').textContent = avgScore;
                document.getElementById('totalTime').textContent = totalMinutes;

                // í”„ë¡œí•„ ì ìˆ˜ ì—…ë°ì´íŠ¸
                updateProfileScores(recordsList);

                // ì£¼ê°„ ë­í‚¹ ë¡œë“œ
                loadSidebarWeeklyRanking();

                // ìµœê·¼ í•™ìŠµ ê¸°ë¡ í‘œì‹œ (ìµœëŒ€ 5ê°œ)
                displayRecentRecords(recordsList.slice(0, 5));

            } catch (error) {
                console.error('í•™ìŠµ í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('recentRecordsContainer').innerHTML = `
                    <div class="empty-state">
                        <h3>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // í”„ë¡œí•„ ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateProfileScores(records) {
            // ëˆ„ì  ì ìˆ˜ ê³„ì‚°
            let cumulativeScore = 0;
            records.forEach(record => {
                const score = record.totalScore || record.score || 0;
                cumulativeScore += score;
            });

            // ì´ë²ˆ ì£¼ ì ìˆ˜ ê³„ì‚° (ìµœê·¼ 7ì¼)
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            let weeklyScore = 0;
            records.forEach(record => {
                const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                if (recordDate >= oneWeekAgo) {
                    const score = record.totalScore || record.score || 0;
                    weeklyScore += score;
                }
            });

            // í‘œì‹œ (ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€)
            document.getElementById('totalScore').textContent = cumulativeScore.toFixed(1) + 'ì ';
            document.getElementById('weeklyScore').textContent = weeklyScore.toFixed(1) + 'ì ';
        }

        // ì‚¬ì´ë“œë°” ì£¼ê°„ ë­í‚¹ ë¡œë“œ
        async function loadSidebarWeeklyRanking() {
            try {
                const currentUser = getCurrentUser();
                const currentUserId = currentUser.userId;
                const currentUserGrade = currentUser.grade;

                // ì „ì²´ í•™ìŠµ ê¸°ë¡ ê°€ì ¸ì˜¤ê¸° (í•™ìƒìš© ë­í‚¹ API)
                const response = await API.getRankings();
                const allRecords = response.data?.records || [];

                // ì´ë²ˆ ì£¼ ë²”ìœ„ ê³„ì‚° (ì¼ìš”ì¼ ~ í† ìš”ì¼)
                const now = new Date();
                const dayOfWeek = now.getDay();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - dayOfWeek);
                weekStart.setHours(0, 0, 0, 0);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                weekEnd.setHours(23, 59, 59, 999);

                // ì´ë²ˆ ì£¼ ê¸°ë¡ë§Œ í•„í„°ë§
                const weekRecords = allRecords.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= weekStart && recordDate <= weekEnd;
                });

                // í•™ìƒë³„ ì£¼ê°„ ì ìˆ˜ ì§‘ê³„
                const studentScores = {};
                weekRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userGrade,
                            totalScore: 0
                        };
                    }
                    studentScores[userId].totalScore += score;
                });

                // í˜„ì¬ ì‚¬ìš©ìì˜ í•™êµê¸‰ í™•ì¸
                const currentSchoolLevel = getSchoolLevelFromGrade(currentUserGrade);

                // í•™êµê¸‰ ì´ë¦„ ë§¤í•‘
                const schoolLevelNames = {
                    'elementary': 'ì´ˆë“±ë¶€',
                    'middle': 'ì¤‘ë“±ë¶€',
                    'high': 'ê³ ë“±ë¶€',
                    'unknown': 'ì „ì²´'
                };

                // ê°™ì€ í•™êµê¸‰ í•™ìƒë§Œ í•„í„°ë§
                let rankings = Object.values(studentScores);
                if (currentSchoolLevel !== 'unknown') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // ì ìˆ˜ìˆœ ì •ë ¬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                // í˜„ì¬ ì‚¬ìš©ìì˜ ë­í‚¹ ì°¾ê¸°
                const myRankIndex = rankings.findIndex(student => student.userId === currentUserId);
                const myRank = myRankIndex !== -1 ? myRankIndex + 1 : '-';

                // ì‚¬ì´ë“œë°”ì— í‘œì‹œ
                const schoolLevelName = schoolLevelNames[currentSchoolLevel] || 'ì „ì²´';
                document.getElementById('sidebarSchoolLevel').textContent = schoolLevelName;

                if (myRank === '-' || rankings.length === 0) {
                    document.getElementById('sidebarRank').textContent = 'ìˆœìœ„ ì—†ìŒ';
                } else {
                    document.getElementById('sidebarRank').textContent = `${myRank}ìœ„ / ${rankings.length}ëª…`;
                }

            } catch (error) {
                console.error('ì‚¬ì´ë“œë°” ì£¼ê°„ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('sidebarSchoolLevel').textContent = '-';
                document.getElementById('sidebarRank').textContent = '-';
            }
        }

        // ìµœê·¼ í•™ìŠµ ê¸°ë¡ í‘œì‹œ
        function displayRecentRecords(records) {
            const container = document.getElementById('recentRecordsContainer');

            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>í•™ìŠµ ì½˜í…ì¸ ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>ì½˜í…ì¸ </th>
                            <th>í•™ìŠµ ë‚ ì§œ</th>
                            <th>ì ìˆ˜</th>
                            <th>ì •ë‹µë¥ </th>
                            <th>í•™ìŠµ ì‹œê°„</th>
                            <th>ìƒì„¸</th>
                            <th>ë­í‚¹</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${records.map(record => {
                            const date = record.createdAt || record.completedAt || record.endTime || new Date().toISOString();
                            const accuracy = record.accuracy || 0;
                            const score = record.totalScore || record.score || 0;
                            const timeSpent = record.timeSpent || 0;

                            return `
                            <tr style="cursor: pointer;" onclick="showLearningResultModal('${record.recordId}')">
                                <td>${record.contentTitle || record.contentId}</td>
                                <td>${new Date(date).toLocaleDateString('ko-KR')}</td>
                                <td>${getScoreBadge(score)}</td>
                                <td>${accuracy}%</td>
                                <td>${timeSpent}ë¶„</td>
                                <td><button class="btn-view-detail" onclick="event.stopPropagation(); showLearningResultModal('${record.recordId}')">ë³´ê¸°</button></td>
                                <td><button class="btn-content-ranking" onclick="event.stopPropagation(); showContentRanking('${record.contentId}', '${record.contentTitle || record.contentId}')">ğŸ† ë­í‚¹</button></td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        // ì ìˆ˜ ë±ƒì§€ ìƒì„±
        function getScoreBadge(score) {
            if (!score && score !== 0) return '-';

            // ì†Œìˆ˜ì  ì²«ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ
            const displayScore = parseFloat(score).toFixed(1);

            let className = 'score-low';
            if (score >= 80) className = 'score-high';
            else if (score >= 60) className = 'score-medium';

            return `<span class="score-badge ${className}">${displayScore}ì </span>`;
        }

        // ==================== ë¶„ë¥˜ í—¬í¼ í•¨ìˆ˜ ====================

        // ì½˜í…ì¸ ë¡œë¶€í„° ë¶„ë¥˜ ê²°ì •
        function getCategoryFromContent(content) {
            const filename = content.filename || content.title || '';

            // ì¤‘ì„¸êµ­ì–´ ì‹œë¦¬ì¦ˆëŠ” ëª¨ë‘ ë¬¸ë²•
            if (filename.includes('ì¤‘ì„¸êµ­ì–´ì˜ íŠ¹ì§•')) {
                return 'ë¬¸ë²• ì›Œí¬ë¶';
            }

            // ëŸ¬ì…€ ì‹œë¦¬ì¦ˆ
            if (filename.includes('ëŸ¬ì…€1') || filename.includes('ëŸ¬ì…€')) {
                return 'ëŸ¬ì…€';
            }

            // ì†Œì‰¬ë¥´ ì‹œë¦¬ì¦ˆ
            if (filename.includes('ì†Œì‰¬ë¥´')) {
                return 'ì†Œì‰¬ë¥´';
            }

            // ì›Œí¬ë¶ ë¶„ë¥˜
            if (filename.includes('ì›Œí¬ë¶')) {
                // ë¬¸í•™ ì‘í’ˆëª… ë¦¬ìŠ¤íŠ¸
                const literatureWorks = ['ë´„ë´„', 'ë¶ˆê½ƒ', 'ë™í–‰', 'ê³ í–¥', 'í¥ë¶€ì „', 'ì°¨ë§ˆì„¤'];
                if (literatureWorks.some(work => filename.includes(work))) {
                    return 'ë¬¸í•™ ì›Œí¬ë¶';
                }
                return 'ë¹„ë¬¸í•™ ì›Œí¬ë¶';
            }

            // ê¸°íƒ€
            return content.category || 'ê¸°íƒ€';
        }

        // ì „ì—­ ë³€ìˆ˜: ì½˜í…ì¸  ëª©ë¡
        let allContents = [];
        let filteredContents = [];

        // í•„í„° ë° ì •ë ¬ ì ìš©
        function applyFiltersAndSort() {
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const difficultyFilter = document.getElementById('difficultyFilter')?.value || '';
            const sortBy = document.getElementById('sortBy')?.value || 'recent';
            const searchQuery = document.getElementById('searchInput')?.value.toLowerCase() || '';

            // ëª¨ë“  ì½˜í…ì¸ ë¡œ ì‹œì‘
            filteredContents = [...allContents];

            // ë¶„ë¥˜ í•„í„° ì ìš©
            if (categoryFilter) {
                filteredContents = filteredContents.filter(content => {
                    const category = getCategoryFromContent(content);
                    return category === categoryFilter;
                });
            }

            // ë‚œì´ë„ í•„í„° ì ìš©
            if (difficultyFilter) {
                filteredContents = filteredContents.filter(content =>
                    content.difficulty === difficultyFilter
                );
            }

            // ê²€ìƒ‰ ì ìš©
            if (searchQuery) {
                filteredContents = filteredContents.filter(content =>
                    (content.title || '').toLowerCase().includes(searchQuery) ||
                    (content.description || '').toLowerCase().includes(searchQuery)
                );
            }

            // ì •ë ¬ ì ìš©
            switch(sortBy) {
                case 'popular':
                    filteredContents.sort((a, b) => (b.learningCount || 0) - (a.learningCount || 0));
                    break;
                case 'title':
                    filteredContents.sort((a, b) => (a.title || '').localeCompare(b.title || '', 'ko'));
                    break;
                case 'difficulty':
                    const difficultyOrder = {'ê¸°ì´ˆ': 1, 'ì¤‘ê¸‰': 2, 'ê³ ê¸‰': 3, 'ì‹¬í™”': 4};
                    filteredContents.sort((a, b) =>
                        (difficultyOrder[a.difficulty] || 0) - (difficultyOrder[b.difficulty] || 0)
                    );
                    break;
                case 'recent':
                default:
                    filteredContents.sort((a, b) =>
                        new Date(b.uploadDate || 0) - new Date(a.uploadDate || 0)
                    );
                    break;
            }

            // ì½˜í…ì¸  ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
            renderContentsList(filteredContents);
        }

        // ì½˜í…ì¸  ëª©ë¡ ë Œë”ë§
        function renderContentsList(contents) {
            const container = document.getElementById('contentsContainer');

            if (contents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ì¡°ê±´ì— ë§ëŠ” ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>ë‹¤ë¥¸ í•„í„°ë¥¼ ì„ íƒí•´ë³´ì„¸ìš”</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="content-grid">
                    ${contents.map(content => {
                        const category = getCategoryFromContent(content);
                        const learningCount = content.learningCount || 0;

                        return `
                            <div class="content-card" onclick="openContent('${content.contentId}')">
                                <span class="category-badge">${category}</span>
                                <h3>${content.title}</h3>
                                <p class="learning-count">í•™ìŠµ ìˆ˜: ${learningCount}</p>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ì½˜í…ì¸  ëª©ë¡ ë¡œë“œ
        async function loadContents() {
            const container = document.getElementById('contentsContainer');

            try {
                // ì½˜í…ì¸  ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const response = await API.getContents();
                const contents = response.data.contents || [];

                if (contents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>ì‚¬ìš© ê°€ëŠ¥í•œ ì½˜í…ì¸ ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ê´€ë¦¬ìê°€ ì½˜í…ì¸ ë¥¼ ì—…ë¡œë“œí•  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                        </div>
                    `;
                    return;
                }

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (learningCountëŠ” ì½˜í…ì¸  ë©”íƒ€ë°ì´í„°ì— í¬í•¨)
                allContents = contents;
                filteredContents = [...allContents];

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (í•œ ë²ˆë§Œ)
                if (!document.getElementById('categoryFilter').hasAttribute('data-listener-added')) {
                    document.getElementById('categoryFilter')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('difficultyFilter')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('sortBy')?.addEventListener('change', applyFiltersAndSort);
                    document.getElementById('searchInput')?.addEventListener('input', applyFiltersAndSort);

                    // ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ í‘œì‹œ
                    document.getElementById('categoryFilter').setAttribute('data-listener-added', 'true');
                }

                // ì´ˆê¸° ë Œë”ë§
                renderContentsList(filteredContents);

            } catch (error) {
                console.error('ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ì½˜í…ì¸  ì—´ê¸° (iframe ëª¨ë‹¬ ë°©ì‹)
        async function openContent(contentId) {
            try {
                // ì½˜í…ì¸  ìƒì„¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const response = await API.getContentDetail(contentId);
                const content = response.data.content;

                if (content.filename) {
                    // ëª¨ë‹¬ ì œëª© ì„¤ì •
                    document.getElementById('modalTitle').textContent = content.title || 'í•™ìŠµ ì½˜í…ì¸ ';

                    // iframe ì„¤ì •
                    const iframe = document.getElementById('contentIframe');
                    iframe.setAttribute('data-content-id', contentId);
                    iframe.setAttribute('data-content-title', content.title || '');
                    // ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
                    iframe.src = 'contents/' + content.filename + '?v=' + Date.now();

                    // ëª¨ë‹¬ í‘œì‹œ
                    document.getElementById('contentModal').classList.add('active');
                } else {
                    showNotification('error', 'ì˜¤ë¥˜', 'ì½˜í…ì¸  íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì½˜í…ì¸  ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('error', 'ì˜¤ë¥˜', 'ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì½˜í…ì¸  ëª¨ë‹¬ ë‹«ê¸°
        function closeContentModal() {
            const modal = document.getElementById('contentModal');
            const iframe = document.getElementById('contentIframe');

            // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            modal.classList.remove('active');

            // iframe ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ ì •ë¦¬)
            setTimeout(() => {
                iframe.src = '';
                iframe.removeAttribute('data-content-id');
                iframe.removeAttribute('data-content-title');
            }, 300);
        }

        // í˜„ì¬ ì½˜í…ì¸  ID ê°€ì ¸ì˜¤ê¸°
        function getCurrentContentId() {
            const iframe = document.getElementById('contentIframe');
            return iframe ? iframe.getAttribute('data-content-id') : null;
        }

        // í˜„ì¬ ì½˜í…ì¸  ì œëª© ê°€ì ¸ì˜¤ê¸°
        function getCurrentContentTitle() {
            const iframe = document.getElementById('contentIframe');
            return iframe ? iframe.getAttribute('data-content-title') : 'ì•Œ ìˆ˜ ì—†ëŠ” ì½˜í…ì¸ ';
        }

        // ì „ì—­ í•™ìŠµ ê¸°ë¡ ì €ì¥ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
        let allLearningRecords = [];

        // ì „ì²´ í•™ìŠµ ê¸°ë¡ ë¡œë“œ
        async function loadAllRecords() {
            const container = document.getElementById('allRecordsContainer');

            try {
                const response = await API.getMyRecords();
                const records = response.data?.records || [];

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                allLearningRecords = records;

                if (records.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>í•™ìŠµ ì½˜í…ì¸ ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ì½˜í…ì¸ </th>
                                <th>í•™ìŠµ ë‚ ì§œ</th>
                                <th>ì ìˆ˜</th>
                                <th>ì •ë‹µë¥ </th>
                                <th>ì§„í–‰ë¥ </th>
                                <th>í•™ìŠµ ì‹œê°„</th>
                                <th>í‹€ë¦° ë¬¸ì œ</th>
                                <th>ìƒì„¸</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.map(record => {
                                const date = record.createdAt || record.completedAt || record.endTime || new Date().toISOString();
                                const accuracy = record.accuracy || 0;
                                const score = record.totalScore || record.score || 0;
                                const timeSpent = record.timeSpent || 0;
                                const progress = record.progress || 100;
                                const wrongCount = record.wrongQuestions ? record.wrongQuestions.length : (record.wrongAnswers || 0);

                                return `
                                <tr style="cursor: pointer;" onclick="showLearningResultModal('${record.recordId}')">
                                    <td>${record.contentTitle || record.contentId}</td>
                                    <td>${new Date(date).toLocaleString('ko-KR')}</td>
                                    <td>${getScoreBadge(score)}</td>
                                    <td>${accuracy}%</td>
                                    <td>${progress}%</td>
                                    <td>${timeSpent}ë¶„</td>
                                    <td>
                                        ${wrongCount > 0
                                            ? `<button class="btn-wrong-questions" onclick="event.stopPropagation(); showWrongQuestionsModal('${record.recordId}')">${wrongCount}ê°œ</button>`
                                            : '-'}
                                    </td>
                                    <td><button class="btn-view-detail" onclick="event.stopPropagation(); showLearningResultModal('${record.recordId}')">ë³´ê¸°</button></td>
                                </tr>
                            `;
                            }).join('')}
                        </tbody>
                    </table>
                `;

            } catch (error) {
                console.error('í•™ìŠµ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>í•™ìŠµ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function handleLogout() {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                clearAuth();
                window.location.href = 'login.html';
            }
        }

        // ==================== í•™ìŠµ ì™„ë£Œ ë°ì´í„° ìˆ˜ì‹  ====================

        // postMessage ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', async (event) => {
            console.log('=== ë©”ì‹œì§€ ìˆ˜ì‹ ë¨ ===');
            console.log('event.origin:', event.origin);
            console.log('event.data:', event.data);

            // ë³´ì•ˆ: ê°™ì€ originì¸ì§€ í™•ì¸ (ì„ íƒì )
            // if (event.origin !== window.location.origin) return;

            const message = event.data;

            // í•™ìŠµ ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸ (ë‘ ê°€ì§€ í˜•ì‹ ì§€ì›)
            if (message.type === 'korean-farm-v2' && message.event === 'all-stages-complete') {
                console.log('ì›Œí¬ë¶ í˜•ì‹ í•™ìŠµ ì™„ë£Œ ë©”ì‹œì§€ ê°ì§€');
                // ì›Œí¬ë¶ ì‹œë¦¬ì¦ˆ í˜•ì‹
                await handleLearningComplete(message.data);
            } else if (message.type === 'korean-farm.v2' && message.activity === 'complete') {
                console.log('ëŸ¬ì…€1 í˜•ì‹ í•™ìŠµ ì™„ë£Œ ë©”ì‹œì§€ ê°ì§€');
                // ëŸ¬ì…€1 ì‹œë¦¬ì¦ˆ í˜•ì‹
                await handleLearningComplete(message.payload, true);
            } else {
                console.log('í•™ìŠµ ì™„ë£Œ ë©”ì‹œì§€ê°€ ì•„ë‹˜ - íƒ€ì…:', message.type, 'ì´ë²¤íŠ¸:', message.event || message.activity);
            }
        });

        // í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
        async function handleLearningComplete(learningData, isRussellFormat = false) {
            console.log('í•™ìŠµ ì™„ë£Œ ë°ì´í„° ìˆ˜ì‹ :', learningData);

            try {
                // 1. í˜„ì¬ ì½˜í…ì¸  ì •ë³´
                const contentId = getCurrentContentId();
                const contentTitle = getCurrentContentTitle();

                if (!contentId) {
                    console.error('ì½˜í…ì¸  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    showNotification('error', 'ì˜¤ë¥˜', 'ì½˜í…ì¸  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // 2. ë¡œë”© í‘œì‹œ
                showNotification('info', 'ì €ì¥ ì¤‘', 'í•™ìŠµ ê²°ê³¼ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...');

                // 3. ë°ì´í„° í˜•ì‹ ë³€í™˜
                let recordData;
                if (isRussellFormat) {
                    // ëŸ¬ì…€1 í˜•ì‹
                    const totalCorrect = learningData.totalCorrect || 0;
                    const totalWrong = learningData.totalWrong || 0;

                    // ê° ìŠ¤í…Œì´ì§€ë³„ ì „ì²´ ë¬¸ì œ ìˆ˜ í•©ì‚°
                    let totalQuestionsFromStages = 0;
                    if (learningData.stageDetails) {
                        Object.keys(learningData.stageDetails).forEach(stageKey => {
                            const stage = learningData.stageDetails[stageKey];
                            if (stage.totalQuestions) {
                                totalQuestionsFromStages += stage.totalQuestions;
                            }
                        });
                    }

                    // ì „ì²´ ë¬¸ì œ ìˆ˜ ê²°ì • (ìŠ¤í…Œì´ì§€ë³„ í•©ê³„ ìš°ì„ , ì—†ìœ¼ë©´ learningDataì—ì„œ, ì—†ìœ¼ë©´ ì •ë‹µ+ì˜¤ë‹µ)
                    const totalQuestions = totalQuestionsFromStages > 0
                        ? totalQuestionsFromStages
                        : (learningData.totalQuestions || (totalCorrect + totalWrong));

                    const answeredQuestions = learningData.answeredQuestions || (totalCorrect + totalWrong);

                    // ì§„í–‰ë¥  ê³„ì‚°: (í‘¼ ë¬¸ì œ ìˆ˜ / ì „ì²´ ë¬¸ì œ ìˆ˜) * 100
                    const progress = totalQuestions > 0
                        ? Math.round((answeredQuestions / totalQuestions) * 100)
                        : 100;

                    console.log('ì§„í–‰ë¥  ê³„ì‚° (Russell):', {
                        totalQuestionsFromStages,
                        totalQuestions,
                        answeredQuestions,
                        totalCorrect,
                        totalWrong,
                        progress: progress + '%'
                    });

                    recordData = {
                        contentId: contentId,
                        contentTitle: contentTitle,
                        score: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        totalScore: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        timeSpent: Math.floor((learningData.sessionTime || 0) / 60), // ì´ˆ -> ë¶„
                        completedStages: learningData.stageDetails ? Object.keys(learningData.stageDetails) : [],
                        completedAt: new Date().toISOString(),
                        status: 'completed',
                        completed: true,
                        progress: progress,
                        accuracy: learningData.totalAccuracy || 0,
                        totalQuestions: totalQuestions,
                        correctAnswers: totalCorrect,
                        wrongAnswers: totalWrong,
                        stagesDetail: learningData.stageDetails || {},
                        wrongQuestions: extractWrongQuestions(learningData.stageDetails || {})
                    };
                } else {
                    // ì›Œí¬ë¶ í˜•ì‹
                    const totalCorrect = learningData.totalCorrect || 0;
                    const totalWrong = learningData.totalWrong || 0;

                    // ê° ìŠ¤í…Œì´ì§€ë³„ ì „ì²´ ë¬¸ì œ ìˆ˜ í•©ì‚°
                    let totalQuestionsFromStages = 0;
                    if (learningData.stagesDetail) {
                        Object.keys(learningData.stagesDetail).forEach(stageKey => {
                            const stage = learningData.stagesDetail[stageKey];
                            if (stage.totalQuestions) {
                                totalQuestionsFromStages += stage.totalQuestions;
                            }
                        });
                    }

                    // ì „ì²´ ë¬¸ì œ ìˆ˜ ê²°ì • (ìŠ¤í…Œì´ì§€ë³„ í•©ê³„ ìš°ì„ , ì—†ìœ¼ë©´ learningDataì—ì„œ, ì—†ìœ¼ë©´ ì •ë‹µ+ì˜¤ë‹µ)
                    const totalQuestions = totalQuestionsFromStages > 0
                        ? totalQuestionsFromStages
                        : (learningData.totalQuestions || (totalCorrect + totalWrong));

                    const answeredQuestions = learningData.answeredQuestions || (totalCorrect + totalWrong);

                    // ì§„í–‰ë¥  ê³„ì‚°: (í‘¼ ë¬¸ì œ ìˆ˜ / ì „ì²´ ë¬¸ì œ ìˆ˜) * 100
                    const progress = totalQuestions > 0
                        ? Math.round((answeredQuestions / totalQuestions) * 100)
                        : 100;

                    console.log('ì§„í–‰ë¥  ê³„ì‚°:', {
                        totalQuestionsFromStages,
                        totalQuestions,
                        answeredQuestions,
                        totalCorrect,
                        totalWrong,
                        progress: progress + '%'
                    });

                    recordData = {
                        contentId: contentId,
                        contentTitle: contentTitle,
                        score: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        totalScore: parseFloat((learningData.totalScore || 0).toFixed(1)),
                        timeSpent: Math.floor((learningData.totalElapsedTime || 0) / 60000), // ms -> ë¶„
                        completedStages: learningData.stagesDetail ? Object.keys(learningData.stagesDetail) : [],
                        startTime: learningData.timestamp ? new Date(learningData.timestamp - learningData.totalElapsedTime).toISOString() : new Date().toISOString(),
                        endTime: learningData.timestamp ? new Date(learningData.timestamp).toISOString() : new Date().toISOString(),
                        duration: Math.floor((learningData.totalElapsedTime || 0) / 1000), // ms -> ì´ˆ
                        status: 'completed',
                        completed: true,
                        progress: progress,
                        accuracy: learningData.totalAccuracy || 0,
                        totalQuestions: totalQuestions,
                        correctAnswers: totalCorrect,
                        wrongAnswers: totalWrong,
                        stagesDetail: learningData.stagesDetail || {},
                        wrongQuestions: extractWrongQuestions(learningData.stagesDetail || {})
                    };
                }

                console.log('ì €ì¥í•  ë°ì´í„°:', recordData);

                // 4. API í˜¸ì¶œí•˜ì—¬ í•™ìŠµ ê¸°ë¡ ì €ì¥
                const response = await API.saveLearningRecord(recordData);

                console.log('ì €ì¥ ì‘ë‹µ:', response);

                // 5. í•™ìŠµ ìˆ˜ ì¦ê°€ (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰í•˜ì—¬ UI ë¸”ë¡œí‚¹ ë°©ì§€)
                API.incrementLearningCount(contentId).catch(error => {
                    console.error('í•™ìŠµ ìˆ˜ ì¦ê°€ ì‹¤íŒ¨:', error);
                    // í•™ìŠµ ìˆ˜ ì¦ê°€ ì‹¤íŒ¨ëŠ” ì‚¬ìš©ìì—ê²Œ ì•Œë¦¬ì§€ ì•ŠìŒ (ì¤‘ìš”í•˜ì§€ ì•Šì€ ì‘ì—…)
                });

                // 6. ì„±ê³µ ì•Œë¦¼
                showNotification('success', 'ì™„ë£Œ!', `í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì ìˆ˜: ${recordData.score}ì  ğŸ‰`);

                // 7. ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeContentModal();
                }, 1500);

                // 8. í•™ìŠµ ê¸°ë¡ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    showSection('records');
                }, 2000);

                // 9. ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                setTimeout(async () => {
                    await loadAllRecords();
                    await loadOverview();
                }, 2500);

            } catch (error) {
                console.error('í•™ìŠµ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('error', 'ì €ì¥ ì‹¤íŒ¨', 'í•™ìŠµ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ==================== ë°ì´í„° ì²˜ë¦¬ í—¬í¼ í•¨ìˆ˜ ====================

        // í‹€ë¦° ë¬¸ì œ ì¶”ì¶œ
        function extractWrongQuestions(stagesDetail) {
            const wrongQuestions = [];

            Object.keys(stagesDetail).forEach(stageKey => {
                const stage = stagesDetail[stageKey];
                if (stage.wrongQuestions && Array.isArray(stage.wrongQuestions)) {
                    stage.wrongQuestions.forEach(wq => {
                        wrongQuestions.push({
                            stage: stageKey,
                            ...wq
                        });
                    });
                }
            });

            return wrongQuestions;
        }

        // ì‹œê°„ í¬ë§· (ì´ˆ -> "00:00" í˜•ì‹)
        function formatTimeFromSeconds(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ==================== UI í—¬í¼ í•¨ìˆ˜ ====================

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');

            // ì´ì „ í´ë˜ìŠ¤ ì œê±°
            notification.classList.remove('success', 'error', 'info', 'show');

            // ìƒˆ ë‚´ìš© ì„¤ì •
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;

            // íƒ€ì…ë³„ í´ë˜ìŠ¤ ì¶”ê°€
            notification.classList.add(type, 'show');

            // 3ì´ˆ í›„ ìë™ ìˆ¨ê¹€ (info íƒ€ì…ì€ ìˆ¨ê¸°ì§€ ì•ŠìŒ)
            if (type !== 'info') {
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // ì•Œë¦¼ ìˆ¨ê¸°ê¸°
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // ==================== í•™ìŠµ ê²°ê³¼ ëª¨ë‹¬ ====================

        // í•™ìŠµ ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        function showLearningResultModal(recordId) {
            const record = allLearningRecords.find(r => r.recordId === recordId);
            if (!record) {
                showNotification('error', 'ì˜¤ë¥˜', 'í•™ìŠµ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const modal = document.getElementById('learningResultModal');
            const content = document.getElementById('learningResultContent');

            // ì „ì²´ í†µê³„
            const totalCorrect = record.correctAnswers || 0;
            const totalWrong = record.wrongAnswers || 0;
            const overallAccuracy = record.accuracy || 0;
            const totalScore = record.totalScore || record.score || 0;
            const timeSpent = record.timeSpent || 0;
            const duration = record.duration || 0;

            // ë‹¨ê³„ë³„ ê²°ê³¼
            const stagesDetail = record.stagesDetail || record.stages || {};

            // ìŠ¤í…Œì´ì§€ëª… ë§µí•‘
            const stageNames = {
                stage1: '1ë‹¨ê³„: ë”¥ë¦¬ì„œì¹˜',
                stage2: '2ë‹¨ê³„: ì–´íœ˜ í•™ìŠµ',
                stage3: '3ë‹¨ê³„: ë¬¸ì¥ ë…í•´',
                stage4: '4ë‹¨ê³„: OXí€´ì¦ˆ',
                stage5: '5ë‹¨ê³„: ì„œìˆ í˜• ë¬¸ì œ'
            };

            // HTML ìƒì„± (í•™ìŠµ í˜ì´ì§€ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">ğŸ‰ í•™ìŠµ ì™„ë£Œ!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">${record.contentTitle}</p>
                        <p style="font-size: 14px; color: #95a5a6; margin-top: 10px;">
                            ${new Date(record.createdAt || record.completedAt || record.endTime).toLocaleString('ko-KR')}
                        </p>
                    </div>

                    <!-- ì „ì²´ í•™ìŠµ ê²°ê³¼ -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">ğŸ“Š ì „ì²´ í•™ìŠµ ê²°ê³¼</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">ì´ì </div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}ì </div>
                            </div>
                            <div style="background: #eff6ff; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">ì „ì²´ ì •ë‹µë¥ </div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">ì •ë‹µ ìˆ˜</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}ê°œ</div>
                            </div>
                            <div style="background: #fef2f2; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">ì˜¤ë‹µ ìˆ˜</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}ê°œ</div>
                            </div>
                            <div style="background: #fffbeb; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">ì´ ì†Œìš” ì‹œê°„</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${timeSpent}ë¶„</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‹¨ê³„ë³„ ê²°ê³¼ -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">ğŸ“ˆ ë‹¨ê³„ë³„ í•™ìŠµ ê²°ê³¼</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // ê° ë‹¨ê³„ë³„ ê²°ê³¼ ì¹´ë“œ
            Object.keys(stagesDetail).forEach(stageKey => {
                const result = stagesDetail[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey] || stageKey}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">ì •ë‹µë¥ :</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">ì •ë‹µ:</span>
                                <strong>${result.correct}ê°œ</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">ì˜¤ë‹µ:</span>
                                <strong style="color: #e74c3c;">${result.wrong}íšŒ</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">ì ìˆ˜:</span>
                                <strong style="color: #3498db;">${result.score ? result.score.toFixed(1) : 0}ì </strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <!-- ì¸ì‡„ ë²„íŠ¼ -->
                    <div style="text-align: center; margin-top: 30px;" class="no-print">
                        <button onclick="printLearningResult()" style="background: #3498db; color: white; border: none; padding: 15px 40px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);">
                            ğŸ–¨ï¸ ê²°ê³¼ ì¸ì‡„í•˜ê¸°
                        </button>
                    </div>
                </div>
            `;

            content.innerHTML = html;
            modal.classList.add('active');
        }

        // í•™ìŠµ ê²°ê³¼ ëª¨ë‹¬ ë‹«ê¸°
        function closeLearningResultModal() {
            document.getElementById('learningResultModal').classList.remove('active');
        }

        // í•™ìŠµ ê²°ê³¼ ì¸ì‡„
        function printLearningResult() {
            window.print();
        }

        // í‹€ë¦° ë¬¸ì œ ëª¨ë‹¬ í‘œì‹œ
        function showWrongQuestionsModal(recordId) {
            const record = allLearningRecords.find(r => r.recordId === recordId);
            if (!record) {
                showNotification('error', 'ì˜¤ë¥˜', 'í•™ìŠµ ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const modal = document.getElementById('wrongQuestionsModal');
            const content = document.getElementById('wrongQuestionsContent');

            const wrongQuestions = record.wrongQuestions || [];

            if (wrongQuestions.length === 0) {
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <h2 style="font-size: 28px; color: #27ae60; margin-bottom: 15px;">ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!</h2>
                        <p style="font-size: 18px; color: #7f8c8d;">ëª¨ë“  ë¬¸ì œë¥¼ ë§ì¶”ì…¨ìŠµë‹ˆë‹¤!</p>
                    </div>
                `;
            } else {
                let html = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                        <h2 style="text-align: center; font-size: 28px; color: #2c3e50; margin-bottom: 10px;">âŒ í‹€ë¦° ë¬¸ì œ (${wrongQuestions.length}ê°œ)</h2>
                        <p style="text-align: center; font-size: 14px; color: #7f8c8d; margin-bottom: 30px;">${record.contentTitle}</p>
                `;

                wrongQuestions.forEach((wq, idx) => {
                    html += `
                        <div style="background: white; border: 2px solid #f093fb; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); page-break-inside: avoid;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                                <strong style="color: #667eea;">${wq.stage ? wq.stage.toUpperCase() : ''}</strong>
                            </div>
                            <p style="font-weight: 600; color: #495057; margin-bottom: 12px; font-size: 16px;">ë¬¸ì œ ${idx + 1}: ${wq.question || ''}</p>
                            <p style="color: #dc3545; margin-bottom: 8px;"><strong>âŒ ë‹¹ì‹ ì˜ ë‹µ:</strong> ${wq.userAnswer || '-'}</p>
                            <p style="color: #28a745;"><strong>âœ… ì •ë‹µ:</strong> ${wq.correctAnswer || wq.answer || '-'}</p>
                            ${wq.explanation ? `<p style="margin-top: 12px; padding: 12px; background: #e7f3ff; border-left: 4px solid #3498db; border-radius: 5px;"><strong>ğŸ’¡ í•´ì„¤:</strong> ${wq.explanation}</p>` : ''}
                        </div>
                    `;
                });

                html += `
                        <!-- ì¸ì‡„ ë²„íŠ¼ -->
                        <div style="text-align: center; margin-top: 30px;" class="no-print">
                            <button onclick="printWrongQuestions()" style="background: #e74c3c; color: white; border: none; padding: 15px 40px; font-size: 16px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);">
                                ğŸ–¨ï¸ í‹€ë¦° ë¬¸ì œ ì¸ì‡„í•˜ê¸°
                            </button>
                        </div>
                    </div>
                `;
                content.innerHTML = html;
            }

            modal.classList.add('active');
        }

        // í‹€ë¦° ë¬¸ì œ ëª¨ë‹¬ ë‹«ê¸°
        function closeWrongQuestionsModal() {
            document.getElementById('wrongQuestionsModal').classList.remove('active');
        }

        // í‹€ë¦° ë¬¸ì œ ì¸ì‡„
        function printWrongQuestions() {
            window.print();
        }

        // ==================== ë­í‚¹ ê´€ë ¨ í•¨ìˆ˜ ====================

        // í˜„ì¬ ì„ íƒëœ í•™êµê¸‰ í•„í„°
        let currentSchoolLevel = 'all';

        // í•™ë…„ì„ í•™êµê¸‰ìœ¼ë¡œ ë³€í™˜
        function getSchoolLevelFromGrade(grade) {
            if (!grade) return 'unknown';

            // ì¬ìˆ˜ìƒì€ ê³ ë“±ë¶€ë¡œ ë¶„ë¥˜
            if (typeof grade === 'string') {
                const gradeStr = grade.toLowerCase();
                if (gradeStr.includes('ì¬ìˆ˜') || gradeStr === 'ì¬ìˆ˜ìƒ') {
                    return 'high';
                }
            }

            // ìˆ«ì ì¶”ì¶œ (ì˜ˆ: "ì¤‘1" -> 7, "ê³ 2" -> 11, "ì´ˆ5" -> 5)
            let gradeNum = 0;

            if (typeof grade === 'string') {
                if (grade.includes('ì´ˆ')) {
                    // ì´ˆ1~ì´ˆ6
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) : 0;
                } else if (grade.includes('ì¤‘')) {
                    // ì¤‘1~ì¤‘3 -> 7~9
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) + 6 : 0;
                } else if (grade.includes('ê³ ')) {
                    // ê³ 1~ê³ 3 -> 10~12
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) + 9 : 0;
                } else {
                    // "5í•™ë…„" ê°™ì€ í˜•ì‹
                    const match = grade.match(/\d+/);
                    gradeNum = match ? parseInt(match[0]) : 0;
                }
            } else {
                gradeNum = parseInt(grade);
            }

            // ì´ˆë“±ë¶€: 1~6í•™ë…„
            if (gradeNum >= 1 && gradeNum <= 6) return 'elementary';
            // ì¤‘ë“±ë¶€: ì¤‘1~ì¤‘3 (7~9)
            if (gradeNum >= 7 && gradeNum <= 9) return 'middle';
            // ê³ ë“±ë¶€: ê³ 1~ê³ 3 (10~12)
            if (gradeNum >= 10 && gradeNum <= 12) return 'high';

            return 'unknown';
        }

        // í•™êµê¸‰ í•„í„° ì ìš©
        function filterBySchoolLevel(level) {
            currentSchoolLevel = level;

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.level-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // í˜„ì¬ í™œì„±í™”ëœ íƒ­ì˜ ë­í‚¹ ë‹¤ì‹œ ë¡œë“œ
            const activeTabs = document.querySelectorAll('.ranking-tab.active');
            if (activeTabs.length > 0) {
                const activeTab = activeTabs[0].textContent;
                if (activeTab.includes('ëˆ„ì ')) {
                    loadCumulativeRanking();
                } else if (activeTab.includes('ì£¼ê°„')) {
                    loadWeeklyRanking();
                } else if (activeTab.includes('ì›”ê°„')) {
                    loadMonthlyRanking();
                }
            }
        }

        // ë­í‚¹ ë¡œë“œ
        async function loadRanking() {
            // ëˆ„ì  ë­í‚¹ ë¡œë“œ
            await loadCumulativeRanking();
        }

        // ë­í‚¹ íƒ­ ì „í™˜
        function showRankingTab(tabType) {
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.ranking-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // ë­í‚¹ ì»¨í…ì¸  í‘œì‹œ
            document.querySelectorAll('.ranking-content').forEach(content => {
                content.style.display = 'none';
            });

            if (tabType === 'cumulative') {
                document.getElementById('cumulativeRanking').style.display = 'block';
                loadCumulativeRanking();
            } else if (tabType === 'weekly') {
                document.getElementById('weeklyRanking').style.display = 'block';
                loadWeeklyRanking();
            } else if (tabType === 'monthly') {
                document.getElementById('monthlyRanking').style.display = 'block';
                loadMonthlyRanking();
            }
        }

        // ëˆ„ì  ë­í‚¹ ë¡œë“œ
        async function loadCumulativeRanking() {
            const container = document.getElementById('cumulativeRankingContainer');

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                console.log('ë­í‚¹ API ì‘ë‹µ:', response);
                console.log('ì „ì²´ ë ˆì½”ë“œ ìˆ˜:', records.length);

                // í•™ìƒë³„ ëˆ„ì  ì ìˆ˜ ê³„ì‚°
                const studentScores = {};
                records.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // ë°°ì—´ë¡œ ë³€í™˜
                let rankings = Object.values(studentScores);
                console.log('í•„í„° ì „ í•™ìƒ ìˆ˜:', rankings.length);
                console.log('í˜„ì¬ í•™êµê¸‰ í•„í„°:', currentSchoolLevel);

                // í•™êµê¸‰ í•„í„° ì ìš©
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        console.log(`í•™ìƒ: ${student.userName}, í•™ë…„: ${student.userGrade}, í•™êµê¸‰: ${schoolLevel}`);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                console.log('í•„í„° í›„ í•™ìƒ ìˆ˜:', rankings.length);

                // ì ìˆ˜ìˆœ ì •ë ¬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">ì•„ì§ ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                // í˜„ì¬ ì‚¬ìš©ì ID
                const currentUserId = getCurrentUser().userId;

                // ë­í‚¹ HTML ìƒì„±
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) {
                        rankBadge = `<div class="rank-badge gold">ğŸ¥‡</div>`;
                    } else if (rank === 2) {
                        rankBadge = `<div class="rank-badge silver">ğŸ¥ˆ</div>`;
                    } else if (rank === 3) {
                        rankBadge = `<div class="rank-badge bronze">ğŸ¥‰</div>`;
                    }

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (ë‚˜)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì´ì </div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}ì </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì •ë‹µë¥ </div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">í•™ìŠµ ìˆ˜</div>
                                <div class="rank-stat-value count">${student.learningCount}íšŒ</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì£¼ê°„ ë­í‚¹ ë¡œë“œ
        async function loadWeeklyRanking() {
            const container = document.getElementById('weeklyRankingContainer');
            const periodInfo = document.getElementById('weeklyPeriod');

            // ì´ë²ˆ ì£¼ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚°
            const now = new Date();
            const dayOfWeek = now.getDay();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - dayOfWeek);
            weekStart.setHours(0, 0, 0, 0);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);

            periodInfo.innerHTML = `${weekStart.toLocaleDateString('ko-KR')} ~ ${weekEnd.toLocaleDateString('ko-KR')}`;

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // ì´ë²ˆ ì£¼ ê¸°ë¡ë§Œ í•„í„°ë§
                const weekRecords = records.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= weekStart && recordDate <= weekEnd;
                });

                // í•™ìƒë³„ ì ìˆ˜ ê³„ì‚°
                const studentScores = {};
                weekRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // ë°°ì—´ë¡œ ë³€í™˜
                let rankings = Object.values(studentScores);

                // í•™êµê¸‰ í•„í„° ì ìš©
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // ì ìˆ˜ìˆœ ì •ë ¬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">ì´ë²ˆ ì£¼ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                // í˜„ì¬ ì‚¬ìš©ì ID
                const currentUserId = getCurrentUser().userId;

                // ë­í‚¹ HTML ìƒì„± (ëˆ„ì  ë­í‚¹ê³¼ ë™ì¼í•œ í¬ë§·)
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">ğŸ¥‡</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">ğŸ¥ˆ</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">ğŸ¥‰</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (ë‚˜)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì´ì </div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}ì </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì •ë‹µë¥ </div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">í•™ìŠµ ìˆ˜</div>
                                <div class="rank-stat-value count">${student.learningCount}íšŒ</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('ì£¼ê°„ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">ì£¼ê°„ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì›”ê°„ ë­í‚¹ ë¡œë“œ
        async function loadMonthlyRanking() {
            const container = document.getElementById('monthlyRankingContainer');
            const periodInfo = document.getElementById('monthlyPeriod');

            // ì´ë²ˆ ë‹¬ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ ê³„ì‚°
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

            periodInfo.innerHTML = `${monthStart.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' })}`;

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // ì´ë²ˆ ë‹¬ ê¸°ë¡ë§Œ í•„í„°ë§
                const monthRecords = records.filter(record => {
                    const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
                    return recordDate >= monthStart && recordDate <= monthEnd;
                });

                // í•™ìƒë³„ ì ìˆ˜ ê³„ì‚°
                const studentScores = {};
                monthRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // ë°°ì—´ë¡œ ë³€í™˜
                let rankings = Object.values(studentScores);

                // í•™êµê¸‰ í•„í„° ì ìš©
                if (currentSchoolLevel !== 'all') {
                    rankings = rankings.filter(student => {
                        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
                        return schoolLevel === currentSchoolLevel;
                    });
                }

                // ì ìˆ˜ìˆœ ì •ë ¬
                rankings.sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <p style="font-size: 18px; color: #7f8c8d;">ì´ë²ˆ ë‹¬ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                // í˜„ì¬ ì‚¬ìš©ì ID
                const currentUserId = getCurrentUser().userId;

                // ë­í‚¹ HTML ìƒì„±
                let html = '<div class="ranking-table">';
                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">ğŸ¥‡</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">ğŸ¥ˆ</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">ğŸ¥‰</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (ë‚˜)' : ''}</div>
                                    <div class="student-school">${student.userSchool}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì´ì </div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}ì </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ì •ë‹µë¥ </div>
                                <div class="rank-stat-value accuracy">${accuracy}%</div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">í•™ìŠµ ìˆ˜</div>
                                <div class="rank-stat-value count">${student.learningCount}íšŒ</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;

            } catch (error) {
                console.error('ì›”ê°„ ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                container.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">ì›”ê°„ ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì»¨í…ì¸ ë³„ ë­í‚¹ ëª¨ë‹¬ í‘œì‹œ
        async function showContentRanking(contentId, contentTitle) {
            const modal = document.getElementById('contentRankingModal');
            const content = document.getElementById('contentRankingContent');

            content.innerHTML = `
                <div class="loading-container">
                    <div class="spinner"></div>
                </div>
            `;
            modal.classList.add('active');

            try {
                const response = await API.getRankings();
                const records = response.data?.records || [];

                // í•´ë‹¹ ì»¨í…ì¸  ê¸°ë¡ë§Œ í•„í„°ë§
                const contentRecords = records.filter(record => record.contentId === contentId);

                // í•™ìƒë³„ ëˆ„ì  ì ìˆ˜ ê³„ì‚°
                const studentScores = {};
                contentRecords.forEach(record => {
                    const userId = record.userId || record.studentId;
                    const userName = record.userName || record.studentName || 'ì•Œ ìˆ˜ ì—†ìŒ';
                    const userSchool = record.userSchool || record.school || '';
                    const userGrade = record.userGrade || record.grade || '';
                    const score = record.totalScore || record.score || 0;

                    if (!studentScores[userId]) {
                        studentScores[userId] = {
                            userId,
                            userName,
                            userSchool,
                            userGrade,
                            totalScore: 0,
                            bestScore: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            learningCount: 0
                        };
                    }

                    studentScores[userId].totalScore += score;
                    studentScores[userId].bestScore = Math.max(studentScores[userId].bestScore, score);
                    studentScores[userId].totalCorrect += (record.correctAnswers || 0);
                    studentScores[userId].totalWrong += (record.wrongAnswers || 0);
                    studentScores[userId].learningCount++;
                });

                // ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ëˆ„ì  ì ìˆ˜ìˆœ ì •ë ¬
                const rankings = Object.values(studentScores).sort((a, b) => b.totalScore - a.totalScore);

                if (rankings.length === 0) {
                    content.innerHTML = `
                        <div style="padding: 60px; text-align: center;">
                            <h2 style="font-size: 24px; color: #2c3e50; margin-bottom: 15px;">ğŸ† ${contentTitle}</h2>
                            <p style="font-size: 18px; color: #7f8c8d;">ì•„ì§ ì´ ì»¨í…ì¸ ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }

                // í˜„ì¬ ì‚¬ìš©ì ID
                const currentUserId = getCurrentUser().userId;

                // ë­í‚¹ HTML ìƒì„±
                let html = `
                    <div style="max-width: 900px; margin: 0 auto; padding: 40px 20px;">
                        <h2 style="text-align: center; font-size: 28px; color: #2c3e50; margin-bottom: 10px;">ğŸ† ì»¨í…ì¸  ë­í‚¹</h2>
                        <p style="text-align: center; font-size: 16px; color: #7f8c8d; margin-bottom: 30px;">${contentTitle}</p>
                        <div class="ranking-table">
                `;

                rankings.forEach((student, index) => {
                    const rank = index + 1;
                    const isMe = student.userId === currentUserId;
                    const avgScore = student.totalScore / student.learningCount;
                    const accuracy = (student.totalCorrect + student.totalWrong) > 0 ?
                        Math.round((student.totalCorrect / (student.totalCorrect + student.totalWrong)) * 100) : 0;

                    let rankBadge = `<div class="rank-badge">${rank}</div>`;
                    if (rank === 1) rankBadge = `<div class="rank-badge gold">ğŸ¥‡</div>`;
                    else if (rank === 2) rankBadge = `<div class="rank-badge silver">ğŸ¥ˆ</div>`;
                    else if (rank === 3) rankBadge = `<div class="rank-badge bronze">ğŸ¥‰</div>`;

                    html += `
                        <div class="ranking-item ${isMe ? 'my-rank' : ''}">
                            ${rankBadge}
                            <div class="student-info">
                                <div class="student-avatar">${student.userName.charAt(0)}</div>
                                <div class="student-details">
                                    <div class="student-name">${student.userName}${isMe ? ' (ë‚˜)' : ''}</div>
                                    <div class="student-school">${student.userSchool}${student.userGrade ? ' Â· ' + student.userGrade : ''}</div>
                                </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">ëˆ„ì  ì ìˆ˜</div>
                                <div class="rank-stat-value score">${student.totalScore.toFixed(1)}ì </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">í‰ê·  ì ìˆ˜</div>
                                <div class="rank-stat-value">${avgScore.toFixed(1)}ì </div>
                            </div>
                            <div class="rank-stat">
                                <div class="rank-stat-label">í•™ìŠµ íšŸìˆ˜</div>
                                <div class="rank-stat-value count">${student.learningCount}íšŒ</div>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;

                content.innerHTML = html;

            } catch (error) {
                console.error('ì»¨í…ì¸  ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨:', error);
                content.innerHTML = `
                    <div style="padding: 60px; text-align: center;">
                        <p style="font-size: 18px; color: #e74c3c;">ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // ì»¨í…ì¸ ë³„ ë­í‚¹ ëª¨ë‹¬ ë‹«ê¸°
        function closeContentRankingModal() {
            document.getElementById('contentRankingModal').classList.remove('active');
        }

        // ==================== ì´ˆê¸°í™” ====================

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í•™ìŠµ í˜„í™© í‘œì‹œ
        loadOverview();

        console.log('í•™ìŠµ ì™„ë£Œ ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ì™„ë£Œ');
    </script>
</body>
</html>
