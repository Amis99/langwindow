<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중세국어의 특징 - 어휘 파트</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stage-indicator {
            display: flex;
            gap: 10px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .stage-dot.active {
            background: #3498db;
            transform: scale(1.3);
        }

        .stage-dot.completed {
            background: #27ae60;
        }

        .question-counter {
            font-size: 18px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Timer Bar */
        .timer-container {
            width: 300px;
            height: 24px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .timer-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* Main Content */
        .main-content {
            margin-top: 100px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
            position: relative;
        }

        .passage-container {
            font-size: 18px;
            line-height: 2;
            color: #2c3e50;
            word-break: keep-all;
        }

        .passage-container h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .passage-container h3 {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .passage-container strong {
            font-weight: 700;
            color: #2c3e50;
        }

        .passage-container ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .passage-container li {
            margin: 8px 0;
            line-height: 1.8;
        }

        .passage-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .passage-container table th,
        .passage-container table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .passage-container table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* Highlight Style */
        .highlight {
            background: linear-gradient(120deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline;
            position: relative;
        }

        .highlight:hover {
            background: linear-gradient(120deg, #fdcb6e 0%, #fab1a0 100%);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(253, 203, 110, 0.5);
        }

        .highlight.answered {
            background: linear-gradient(120deg, #dfe6e9 0%, #b2bec3 100%);
            cursor: default;
        }

        .highlight.answered:hover {
            transform: none;
            box-shadow: none;
        }

        .highlight.correct {
            background: linear-gradient(120deg, #55efc4 0%, #00b894 100%);
        }

        .highlight.incorrect {
            background: linear-gradient(120deg, #fab1a0 0%, #ff7675 100%);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: fixed;
            cursor: move;
            transition: opacity 0.3s ease;
        }

        .modal-content.dragging {
            opacity: 0.95;
            user-select: none;
        }

        .modal-content.correct-feedback {
            border: 3px solid #00b894;
            animation: correctPulse 0.6s ease;
        }

        .modal-content.incorrect-feedback {
            border: 3px solid #ff7675;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 184, 148, 0.6); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-button {
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: 'Noto Serif KR', serif;
        }

        .option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Result Screen */
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 100px;
        }

        .result-screen.active {
            display: block;
        }

        body:has(.result-screen.active) .timer-container {
            display: none !important;
        }

        .result-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-button.primary {
            background: #3498db;
            color: white;
        }

        .result-button.primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .result-button.secondary {
            background: #95a5a6;
            color: white;
        }

        .result-button.secondary:hover {
            background: #7f8c8d;
        }

        /* OX Learning Styles (Stage 2) */
        .ox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .ox-question-card {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .question-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .ox-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .ox-option-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ox-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: scale(1.05);
        }

        .ox-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .ox-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .ox-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Multiple Choice Styles (Stage 3) */
        .mcq-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .mcq-question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .mcq-question-text {
            font-size: 20px;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mcq-option-button {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mcq-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .mcq-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .mcq-option-button .option-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            flex-shrink: 0;
        }

        .mcq-option-button .option-text {
            flex: 1;
            color: #2c3e50;
        }

        .mcq-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
        }

        .mcq-option-button.correct .option-number {
            background: #27ae60;
        }

        .mcq-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .mcq-option-button.incorrect .option-number {
            background: #f44336;
        }

        /* Feedback Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Wrong Questions Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: fixed;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 10px 0;
        }

        .wrong-question-item {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .wrong-question-item h4 {
            color: #dc3545;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .wrong-question-item p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .wrong-question-item .question-text {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .wrong-question-item .user-answer {
            color: #dc3545;
            background: #fff5f5;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .wrong-question-item .correct-answer {
            color: #28a745;
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .explanation-text {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 16px;
            color: #856404;
            text-align: center;
            line-height: 1.6;
        }

        .question-explanation {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            color: #856404;
            margin-top: 10px;
        }

        .question-explanation strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .title {
                font-size: 20px;
            }

            .subtitle {
                font-size: 12px;
            }

            .progress-info {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .question-counter {
                font-size: 14px;
            }

            .timer-container {
                width: 200px;
                height: 18px;
            }

            .stage-dot {
                width: 10px;
                height: 10px;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            .option-button {
                padding: 12px 15px;
                font-size: 14px;
            }

            .ox-question-card {
                padding: 20px;
            }

            .question-text {
                font-size: 18px;
                margin-bottom: 20px;
            }

            .ox-option-button {
                padding: 20px 15px;
                font-size: 24px;
            }

            .mcq-question-card {
                padding: 20px;
            }

            .mcq-question-text {
                font-size: 16px;
                line-height: 1.6;
            }

            .mcq-option-button {
                padding: 12px 15px;
                font-size: 14px;
                gap: 12px;
            }

            .mcq-option-button .option-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        /* Mobile Phone Size */
        @media (max-width: 480px) {
            .header {
                padding: 10px;
                gap: 8px;
            }

            .header-left {
                gap: 3px;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
            }

            .subtitle {
                font-size: 11px;
            }

            .progress-info {
                gap: 8px;
            }

            .question-counter {
                font-size: 12px;
                font-weight: 400;
            }

            .timer-container {
                width: 150px;
                height: 14px;
            }

            .stage-indicator {
                gap: 6px;
            }

            .stage-dot {
                width: 8px;
                height: 8px;
            }

            .stage-dot.active {
                transform: scale(1.2);
            }

            .main-content {
                margin-top: 80px;
                padding: 20px;
            }

            .passage-container {
                font-size: 16px;
                line-height: 1.8;
            }
        }
    </style>

    <!-- html-to-image CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="title">중세국어의 특징 - 어휘 파트</div>
                <div class="subtitle" id="stage-subtitle">1단계: 딥리서치</div>
            </div>
            <div class="progress-info">
                <div class="stage-indicator">
                    <div class="stage-dot active"></div>
                    <div class="stage-dot"></div>
                    <div class="stage-dot"></div>
                </div>
                <div class="question-counter">
                    문제: <span id="current-question">0</span> / <span id="total-questions">0</span>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="passage-container" id="passage-container"></div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-content" id="modal-content">
                <div class="modal-header" id="modal-header"></div>
                <div class="modal-options" id="modal-options"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen" id="result-screen">
            <h2 class="result-title" id="result-title">1단계 학습 완료!</h2>
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-value" id="progress-stat">0%</div>
                    <div class="stat-label">진행률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy-stat">0%</div>
                    <div class="stat-label">정답률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="correct-stat">0</div>
                    <div class="stat-label">맞힌 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="wrong-stat">0</div>
                    <div class="stat-label">틀린 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time-stat">0:00</div>
                    <div class="stat-label">소요 시간</div>
                </div>
            </div>
            <div class="result-buttons">
                <button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>
                <button class="result-button primary" onclick="nextStage()">다음 단계로</button>
            </div>
        </div>
    </div>

    <script>
        // 모달 드래그 관련 변수
        let isDragging = false;
        let dragStartX, dragStartY;
        let modalStartX, modalStartY;
        let dragListenersAdded = false;

        // 현재 단계
        let currentStage = 1;

        // 전체 학습 결과 저장소 (레거시)
        const allStageResults = {
            stage1: null,
            stage2: null,
            stage3: null
        };

        // 새로운 stageResults 객체 (틀린 문제 포함)
        const stageResults = {
            stage1: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage2: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage3: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] }
        };

        // Stage 2와 Stage 3의 wrongQuestions 추적용 배열
        let stage2WrongQuestions = [];
        let stage3WrongQuestions = [];

        // 전역 시작 시간
        let globalStartTime = Date.now();

        // Stage 1: 딥리서치 - 2-choice 질문 데이터
        // ============================================
        // Stage 1: 딥리서치 - 2지선다 하이라이트 문제
        // ============================================
        // 설명: 학습 콘텐츠 내에 하이라이트로 표시된 빈칸 문제
        // 형식: { id: 번호, context: "문맥", correctAnswer: "정답", wrongAnswer: "오답" }
        // - id: 문제 고유 번호
        // - context: 하이라이트가 나타날 문맥 (이 텍스트 다음에 하이라이트가 표시됨)
        // - correctAnswer: 정답 텍스트
        // - wrongAnswer: 오답 텍스트

        const STAGE1_QUESTIONS = [
            { id: 1, context: "현대 국어에 없는", correctAnswer: "고유어", wrongAnswer: "외래어" },
            { id: 2, context: "예) 뫼", correctAnswer: "산", wrongAnswer: "강" },
            { id: 3, context: "ᄀᆞᄅᆞᆷ", correctAnswer: "강", wrongAnswer: "산" },
            { id: 4, context: "미르", correctAnswer: "용", wrongAnswer: "말" },
            { id: 5, context: "즈믄", correctAnswer: "천", wrongAnswer: "만" },
            { id: 6, context: "가 지속적으로 증가하였음", correctAnswer: "한자어", wrongAnswer: "고유어" },
            { id: 7, context: "중국어가 귀화하기도 하고,", correctAnswer: "몽골어, 여진어", wrongAnswer: "영어, 프랑스어" },
            { id: 8, context: "말ᄊᆞᆷ:", correctAnswer: "모든 말 → 높임의 말", wrongAnswer: "높임의 말 → 모든 말" },
            { id: 9, context: "놈:", correctAnswer: "일반 사람 → 사람을 낮추는 말", wrongAnswer: "사람을 낮추는 말 → 일반 사람" },
            { id: 10, context: "겨집:", correctAnswer: "일반 여자 → 여자의 낮춤말", wrongAnswer: "여자의 낮춤말 → 일반 여자" },
            { id: 11, context: "얼굴:", correctAnswer: "몸 형체 → 얼굴 부분", wrongAnswer: "얼굴 부분 → 몸 형체" },
            { id: 12, context: "바가지:", correctAnswer: "박으로 만든 것 > 다양한 재료로 만든 것", wrongAnswer: "다양한 재료로 만든 것 > 박으로 만든 것" },
            { id: 13, context: "지갑:", correctAnswer: "종이로 만든 것 > 가죽 등으로 만든 것", wrongAnswer: "가죽 등으로 만든 것 > 종이로 만든 것" },
            { id: 14, context: "어리다:", correctAnswer: "어리석다 → 나이가 적다", wrongAnswer: "나이가 적다 → 어리석다" },
            { id: 15, context: "어엿브다:", correctAnswer: "가엾다 → 예쁘다", wrongAnswer: "예쁘다 → 가엾다" },
            { id: 16, context: "'많다'는 뜻:", correctAnswer: "하다", wrongAnswer: "ᄒᆞ다" },
            { id: 17, context: "노미 하니라", correctAnswer: "많다", wrongAnswer: "하다" },
            { id: 18, context: "여름 하ᄂᆞ니", correctAnswer: "많으니", wrongAnswer: "하니" },
            { id: 19, context: "'행동하다'는 뜻:", correctAnswer: "ᄒᆞ다", wrongAnswer: "하다" },
            { id: 20, context: "예) 몯", correctAnswer: "못하다", wrongAnswer: "많다" },
            { id: 21, context: "아니", correctAnswer: "아니하여서", wrongAnswer: "아니므로" },
            { id: 22, context: "⇒ 현대 국어의 '하다'는 '", correctAnswer: "ᄒᆞ다", wrongAnswer: "하다" },
            { id: 23, context: "'ㅎ' 종성 체언 뜻:", correctAnswer: "ㅎ", wrongAnswer: "ㄱ" },
            { id: 24, context: "① 'ㅎ' 종성 체언이", correctAnswer: "단독으로 쓰일 때", wrongAnswer: "모음 조사를 만날 때" },
            { id: 25, context: "예) ᄯᅡ 지 地", correctAnswer: "땅", wrongAnswer: "흙" },
            { id: 26, context: "② 'ㅎ' 종성 체언이", correctAnswer: "관형격 조사 'ㅅ'과 결합할 때", wrongAnswer: "주격 조사 '이'와 결합할 때" },
            { id: 27, context: "예) 다ᄅᆞᆫ ᄯᅡᆺ 風俗은", correctAnswer: "땅의", wrongAnswer: "나라의" },
            { id: 28, context: "③ 'ㅎ' 종성 체언 뒤에", correctAnswer: "자음으로 시작하는 말이 올 때", wrongAnswer: "모음으로 시작하는 말이 올 때" },
            { id: 29, context: "예) 머리털", correctAnswer: "머리털", wrongAnswer: "머리와 털" },
            { id: 30, context: "① 'ㅎ' 종성 체언 뒤에", correctAnswer: "모음으로 시작하는 조사가 올 때", wrongAnswer: "관형격 조사 'ㅅ'이 올 때" },
            { id: 31, context: "예) ᄯᅡ히(ᄯᅡㅎ+이) 즐어늘", correctAnswer: "땅이", wrongAnswer: "땅에" },
            { id: 32, context: "나라ᄒᆞᆯ(나라ㅎ+ᄋᆞᆯ) 아ᅀᆞ 맛디고", correctAnswer: "나라를", wrongAnswer: "나라의" },
            { id: 33, context: "② 'ㅎ' 종성 체언이", correctAnswer: "'ㄱ', 'ㄷ'으로 시작하는 말과 만날 때", wrongAnswer: "'ㅁ', 'ㄴ'으로 시작하는 말과 만날 때" },
            { id: 34, context: "예) ᄯᅡ토(ᄯᅡㅎ+도) 뮈더니", correctAnswer: "땅도", wrongAnswer: "땅만" },
            { id: 35, context: "안콰(안ㅎ+과) 밧", correctAnswer: "안과 밖", wrongAnswer: "안의 밖" },
            { id: 36, context: "변천:", correctAnswer: "근대 국어에", wrongAnswer: "현대 국어에" },
            { id: 37, context: "⇒ 현대 국어에", correctAnswer: "일부 남아 있음", wrongAnswer: "전혀 남아 있지 않음" },
            { id: 38, context: "예) 머리ㅎ + 가락 >", correctAnswer: "머리카락", wrongAnswer: "머리띠" },
            { id: 39, context: "살ㅎ + 고기 >", correctAnswer: "살코기", wrongAnswer: "살점" },
            { id: 40, context: "암ㅎ + 닭 ->", correctAnswer: "암탉", wrongAnswer: "암닭" },
            { id: 41, context: "수ㅎ + 병아리 ->", correctAnswer: "수평아리", wrongAnswer: "수병아리" },
            { id: 42, context: "'ㄱ' 곡용 체언 뜻:", correctAnswer: "ㄱ", wrongAnswer: "ㅎ" },
            { id: 43, context: "① 'ㄱ' 곡용 체언이", correctAnswer: "단독으로 쓰일 때", wrongAnswer: "모음 조사를 만날 때" },
            { id: 44, context: "예) 나모", correctAnswer: "나무", wrongAnswer: "돌" },
            { id: 45, context: "구무", correctAnswer: "구멍", wrongAnswer: "구름" },
            { id: 46, context: "② 'ㄱ' 곡용 체언이 조사", correctAnswer: "'와'나 '도'와 결합할 때", wrongAnswer: "'이'나 '을'과 결합할 때" },
            { id: 47, context: "예) 나모와", correctAnswer: "나무와", wrongAnswer: "나무도" },
            { id: 48, context: "구무도", correctAnswer: "구멍도", wrongAnswer: "구멍에" },
            { id: 49, context: "① 'ㄱ' 곡용 체언 뒤에", correctAnswer: "모음으로 시작하는 조사가 올 때", wrongAnswer: "'과'나 '도'가 올 때" },
            { id: 50, context: "예) 남기(남ㄱ+ㅣ)", correctAnswer: "나무가", wrongAnswer: "나무의" },
            { id: 51, context: "남ᄀᆞᆯ(남ㄱ+ᄋᆞᆯ)", correctAnswer: "나무를", wrongAnswer: "나무로" },
            { id: 52, context: "남ᄀᆞᆫ(남ㄱ+ᄋᆞᆫ)", correctAnswer: "나무는", wrongAnswer: "나무와" },
            { id: 53, context: "변천:", correctAnswer: "근대 국어에", wrongAnswer: "현대 국어에" }
        ];

        // ============================================
        // Stage 2: OX 퀴즈
        // ============================================
        // 설명: O/X로 답하는 퀴즈 형식
        // 형식: { id: 번호, text: "문제 내용", answer: "O" 또는 "X", explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 문법 지원: **볼드**, <u>밑줄</u> 등)
        // - answer: 정답 ("O" 또는 "X")
        // - explanation: 정오답 해설 (마크다운 문법 지원)

        const STAGE2_QUESTIONS = [
            { id: 1, text: "중세 국어 '어리다'는 '어리석다'라는 의미였으나, 현대 국어에서는 '나이가 적다'는 의미로 바뀌었다.", answer: "O", explanation: "이는 의미가 완전히 다른 뜻으로 변한 '의미의 이동'에 해당하는 대표적인 예입니다." },
            { id: 2, text: "'ㅎ' 종성 체언은 모음으로 시작하는 조사와 결합할 때 'ㅎ' 소리가 드러났다. (예: 나라ㅎ + ᄋᆞᆯ → 나라ᄒᆞᆯ)", answer: "O", explanation: "'ㅎ'은 단독으로 쓰이거나 자음 앞에서는 나타나지 않았지만, '나라ᄒᆞᆯ', 'ᄯᅡ히'처럼 뒤에 모음으로 시작하는 조사가 오면 이어적히면서 소리가 났습니다." },
            { id: 3, text: "'말ᄊᆞᆷ'은 본래 '모든 말'을 의미했으나, 점차 '높임의 말'로 의미가 축소되었다.", answer: "O", explanation: "원래는 일반적인 '말' 전체를 가리켰으나, 시간이 지나면서 그 쓰임이 줄어들어 현재는 '선생님 말씀'처럼 높임의 대상에게만 사용됩니다." },
            { id: 4, text: "중세 국어의 '하다'는 '많다'라는 의미로, 'ᄒᆞ다'는 '행동하다(do)'라는 의미로 구별하여 사용했다.", answer: "O", explanation: "두 단어는 형태와 의미가 명확히 다른 별개의 단어였습니다. 현대 국어의 '하다'는 'ᄒᆞ다'에서 변한 것입니다." },
            { id: 5, text: "'ㄱ' 곡용 체언인 '나모(나무)'는 주격 조사 'ㅣ'와 결합하면 '남기'의 형태로 나타났다.", answer: "O", explanation: "'나모'와 같은 단어는 모음 조사를 만나면 숨어있던 'ㄱ'이 덧생기는 특징이 있었습니다. 따라서 '남ㄱ+ㅣ'의 형태로 결합하여 '남기'가 되었습니다." },
            { id: 6, text: "'어엿브다'는 '가엾다, 불쌍하다'는 뜻에서 '예쁘다'는 뜻으로 의미가 이동했다.", answer: "O", explanation: "'어리다'와 마찬가지로, 원래의 의미와 현대의 의미가 완전히 달라진 '의미의 이동' 사례입니다." },
            { id: 7, text: "'ㅎ' 종성 체언이 'ㄱ, ㄷ'으로 시작하는 말과 만나면 '안콰(안ㅎ+과)', 'ᄯᅡ토(ᄯᅡㅎ+도)'처럼 거센소리로 축약되었다.", answer: "O", explanation: "앞말의 'ㅎ'과 뒷말의 예사소리가 합쳐져 하나의 거센소리로 바뀌는 '거센소리되기' 음운 규칙이 적용된 결과입니다." },
            { id: 8, text: "현대 국어 '암탉', '수평아리', '살코기' 등은 'ㅎ' 종성 체언의 흔적이 남아있는 단어들이다.", answer: "O", explanation: "각각 '암ㅎ+닭', '수ㅎ+병아리', '살ㅎ+고기'의 형태로 결합하면서 'ㅎ'이 뒷말의 첫소리를 거센소리로 바꾼 흔적이 현대 국어에 남아있습니다." },
            { id: 9, text: "중세 국어에는 '뫼(산)', '즈믄(천)'처럼 지금은 잘 쓰이지 않는 고유어가 많이 존재했다.", answer: "O", explanation: "한자어가 증가하면서 점차 사라졌지만, 15세기 문헌에는 아름다운 고유어 어휘가 풍부하게 나타납니다." },
            { id: 10, text: "'바가지'는 원래 '박으로 만든 그릇'만을 의미했으나, 지금은 플라스틱 등 다양한 재료로 만든 그릇까지 의미가 확대되었다.", answer: "O", explanation: "단어가 가리키는 대상의 범위나 종류가 원래보다 더 넓어진 경우로, '의미의 확대'에 해당합니다." },
            { id: 11, text: "'ㄱ' 곡용 체언은 단독으로 쓰이거나 조사 '와', '도'와 결합할 때는 'ㄱ'이 나타나지 않았다.", answer: "O", explanation: "'ㄱ'은 항상 나타나는 것이 아니라, '남기(나무가)'처럼 뒤에 모음으로 시작하는 조사가 올 때만 덧생기는 특징이 있었습니다." },
            { id: 12, text: "'놈'은 중세 국어에서 '일반 사람'을 뜻하는 평범한 단어였으나, 현대 국어에서는 '사람을 낮추어 부르는 말'로 의미가 축소되었다.", answer: "O", explanation: "원래는 가치 판단이 없는 중립적인 단어였으나, 점차 부정적인 어감을 가지게 되면서 의미의 범위와 가치가 축소되었습니다." },
            { id: 13, text: "'ㅎ' 종성 체언은 단독으로 쓰일 때 'ㅎ'이 표기되거나 발음되지 않았다. (예: ᄯᅡ)", answer: "O", explanation: "'ㅎ'은 특정 환경(모음 조사 앞, ㄱ/ㄷ 앞)에서만 나타나는 특이한 받침으로, 단독으로 쓰일 때는 실현되지 않았습니다." },
            { id: 14, text: "'지갑'은 본래 '종이로 만든 것'을 의미했으나, 현재는 가죽 등 다양한 재료로 만든 것까지 포함하도록 의미가 확대되었다.", answer: "O", explanation: "'바가지'와 마찬가지로, 단어가 가리키는 대상의 범위가 넓어진 '의미의 확대' 사례입니다." },
            { id: 15, text: "'ㄱ' 곡용 체언과 'ㅎ' 종성 체언은 모두 근대 국어 시기에 사라졌다.", answer: "O", explanation: "두 가지 특이한 체언 활용(곡용)은 중세 국어의 특징적인 모습이었으나, 근대 국어로 넘어오면서 점차 일반적인 형태로 바뀌어 사라지게 되었습니다." },
            { id: 16, text: "'어리다'의 의미 변화는 의미의 범위가 줄어든 '의미 축소'에 해당한다.", answer: "X", explanation: "'어리석다'와 '나이가 적다'는 의미의 범위 문제가 아니라 뜻이 완전히 달라진 것이므로 '의미 이동'에 해당합니다." },
            { id: 17, text: "중세 국어의 'ᄒᆞ다'는 '많다'는 의미를 가졌다.", answer: "X", explanation: "'ᄒᆞ다'는 '행동하다(do)'는 의미였고, '많다'는 의미를 가진 단어는 '하다'였습니다." },
            { id: 18, text: "'ㅎ' 종성 체언은 'ㄱ' 곡용 체언이라고도 불린다.", answer: "X", explanation: "'ㅎ' 종성 체언은 받침 'ㅎ'이 나타나는 체언이고, 'ㄱ' 곡용 체언은 받침 'ㄱ'이 덧생기는 체언으로, 서로 다른 종류의 단어입니다." },
            { id: 19, text: "'겨집'은 원래 '여자를 낮추어 부르는 말'이었으나, 현대에 와서 '일반 여자'를 뜻하게 되었다.", answer: "X", explanation: "의미 변화의 방향이 반대입니다. 원래 '일반 여자'를 뜻하던 중립적인 단어가 현대에 와서 낮춤말로 의미가 축소되었습니다." },
            { id: 20, text: "'ㄱ' 곡용 체언인 '나모'는 관형격 조사 'ㅅ'과 결합하면 '남ㄱ'이 나타났다.", answer: "X", explanation: "'ㄱ'은 뒤에 모음으로 시작하는 조사가 올 때 나타납니다. 'ㅅ'은 자음이므로 'ㄱ'이 나타나지 않습니다." },
            { id: 21, text: "'얼굴'의 의미 변화는 단어가 가리키는 대상이 넓어진 '의미 확대'의 예이다.", answer: "X", explanation: "'몸 전체 형체'에서 '안면'이라는 일부로 의미의 범위가 좁아졌으므로 '의미 축소'에 해당합니다." },
            { id: 22, text: "현대 국어의 '하다'는 중세 국어의 '하다(많다)'에서 온 말이다.", answer: "X", explanation: "현대 국어의 '하다'는 중세 국어의 'ᄒᆞ다(행동하다)'의 아래아(ㆍ)가 'ㅏ'로 변하여 이어진 말입니다." },
            { id: 23, text: "'ㅎ' 종성 체언은 현대 국어에서 완전히 사라져 그 흔적을 찾을 수 없다.", answer: "X", explanation: "'암탉(암ㅎ+닭)', '머리카락(머리ㅎ+가락)' 등 거센소리되기 형태로 그 흔적이 일부 남아있습니다." },
            { id: 24, text: "'어엿브다'는 '예쁘다'에서 '가엾다'로 의미가 이동했다.", answer: "X", explanation: "의미 이동의 방향이 반대입니다. 중세 국어에서 '가엾다'는 의미였던 것이 현대 국어에서 '예쁘다'로 의미가 바뀌었습니다." },
            { id: 25, text: "'ㄱ' 곡용 체언은 뒤에 자음으로 시작하는 조사가 올 때 'ㄱ'이 나타났다.", answer: "X", explanation: "'ㄱ'은 자음이 아닌 모음으로 시작하는 조사가 올 때 나타났습니다. (예: 남기 < 남ㄱ+ㅣ)" },
            { id: 26, text: "중세 국어 시기에는 한자어의 사용이 점차 줄어들었다.", answer: "X", explanation: "중세 국어 시기에는 한자 문화의 영향으로 한자어의 수가 지속적으로 증가했습니다." },
            { id: 27, text: "'ㅎ' 종성 체언이 모음 조사와 결합할 때는 'ㅎ'이 생략되었다.", answer: "X", explanation: "'ㅎ'이 생략되는 것이 아니라, 'ᄯᅡ히(ᄯᅡㅎ+이)'처럼 'ㅎ'이 나타나 이어적혔습니다." },
            { id: 28, text: "'놈'의 의미 변화는 '의미 이동'에 해당한다.", answer: "X", explanation: "'일반 사람'이라는 넓은 의미에서 '남자를 낮잡아 이르는 말'이라는 좁은 의미로 범위가 줄어들었으므로 '의미 축소'에 해당합니다." },
            { id: 29, text: "'ㄱ' 곡용 체언은 현대 국어에서도 특수한 형태로 일부 남아 있다.", answer: "X", explanation: "'ㄱ' 곡용이라는 활용 방식은 근대 국어 시기에 완전히 사라졌으며, 현대 국어에는 그 흔적이 남아 있지 않습니다." },
            { id: 30, text: "중세 국어에는 몽골어, 여진어와 같은 외래어가 전혀 존재하지 않았다.", answer: "X", explanation: "당시 주변 국가들과의 교류를 통해 몽골어, 여진어 등 다양한 언어에서 온 외래어가 존재했습니다." }
        ];

        // ============================================
        // Stage 3: 객관식 (Multiple Choice)
        // ============================================
        // 설명: 6개 선택지 중 4개를 무작위로 선택하여 출제하는 객관식 문제
        // 형식: { id: 번호, text: "문제", options: ["선택지1", ... "선택지6"], correct: 정답인덱스, explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 지원)
        // - options: 6개의 선택지 배열 (실제 출제 시 4개 무작위 선택)
        // - correct: 정답의 인덱스 (0부터 시작, 즉 0=①, 1=②, 2=③, 3=④, 4=⑤, 5=⑥)
        // - explanation: 정오답 해설 (마크다운 지원, <u>밑줄</u> 가능)

        const STAGE3_QUESTIONS = [
            {
                id: 1,
                text: "다음 중 의미 변화의 양상이 나머지 넷과 다른 하나는?",
                options: [
                    "말ᄊᆞᆷ (모든 말 → 높임의 말)",
                    "놈 (일반 사람 → 낮춤말)",
                    "어리다 (어리석다 → 나이가 적다)",
                    "겨집 (일반 여자 → 낮춤말)",
                    "얼굴 (몸 형체 → 안면)",
                    "지갑 (종이 지갑 → 모든 지갑)"
                ],
                correct: 2,
                explanation: "①, ②, ④, ⑤는 모두 의미가 좁아지는 '의미 축소'에 해당합니다. ③ '어리다'는 '어리석다'에서 '나이가 적다'로 의미가 완전히 바뀐 '의미 이동'입니다. ⑥ '지갑'은 의미가 넓어진 '의미 확대'입니다."
            },
            {
                id: 2,
                text: "'하다'와 'ᄒᆞ다'에 대한 설명으로 옳은 것은?",
                options: [
                    "'하다'는 '행동하다', 'ᄒᆞ다'는 '많다'는 뜻이었다.",
                    "두 단어는 의미 차이 없이 혼용되었다.",
                    "현대 국어의 '하다'는 중세 국어의 '하다'가 이어진 것이다.",
                    "'노미 하니라'는 '사람이 행동한다'는 의미이다.",
                    "현대 국어의 '공부하다'는 중세 국어의 '공부ᄒᆞ다'에 가깝다.",
                    "'ᄒᆞ다'의 아래아(ㆍ)는 16세기에 'ㅡ'로 변했다."
                ],
                correct: 4,
                explanation: "현대 국어의 '공부하다'는 '공부를 하다(do)'라는 의미이므로, 중세 국어의 'ᄒᆞ다(행동하다)'의 계승으로 보는 것이 맞습니다. ① 의미 설명 반대, ③ 현대의 '하다'는 'ᄒᆞ다'에서 유래, ④ '사람이 많다'는 의미입니다."
            },
            {
                id: 3,
                text: "다음 중 'ㅎ' 종성 체언에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "'나라ㅎ', '길ㅎ'처럼 받침에 'ㅎ'을 가진 체언이다.",
                    "단독으로 쓰일 때는 'ㅎ'이 나타나지 않았다.",
                    "뒤에 모음 조사가 오면 'ㅎ'이 연음되었다. (예: ᄯᅡ히)",
                    "뒤에 'ㄱ, ㄷ'이 오면 거센소리가 되었다. (예: 안콰)",
                    "현대 국어 '암탉'에서 그 흔적을 찾을 수 있다.",
                    "'ㄱ' 곡용 체언이라고도 불린다."
                ],
                correct: 5,
                explanation: "'ㅎ' 종성 체언과 'ㄱ' 곡용 체언은 받침이 나타나는 환경과 종류가 다른 별개의 유형입니다. 따라서 'ㄱ' 곡용 체언이라고 부를 수 없습니다."
            },
            {
                id: 4,
                text: "다음 단어들의 공통적인 특징으로 가장 적절한 것은?\n\n나모, 구무",
                options: [
                    "'ㅎ' 종성 체언이다.",
                    "모음으로 시작하는 조사와 결합하면 'ㄱ'이 덧생긴다.",
                    "의미가 축소된 단어이다.",
                    "몽골어에서 온 외래어이다.",
                    "현대 국어에서는 사라진 단어이다.",
                    "모음 조화가 파괴된 단어이다."
                ],
                correct: 1,
                explanation: "'나모(나무)'와 '구무(구멍)'는 대표적인 'ㄱ' 곡용 체언으로, 뒤에 '이, 을, 은' 등 모음으로 시작하는 조사가 오면 '남기, 남글, 남근', '구무기, 구무글, 구무근'처럼 'ㄱ'이 덧생기는 공통점이 있습니다."
            },
            {
                id: 5,
                text: "<보기>의 ㉠~㉢에 들어갈 의미 변화의 유형을 바르게 짝지은 것은?\n\n<보기>\n∙ ㉠: 놈 (일반 사람 → 낮춤말)\n∙ ㉡: 바가지 (박 그릇 → 모든 그릇)\n∙ ㉢: 어엿브다 (가엾다 → 예쁘다)",
                options: [
                    "㉠ 축소, ㉡ 확대, ㉢ 이동",
                    "㉠ 확대, ㉡ 축소, ㉢ 이동",
                    "㉠ 이동, ㉡ 축소, ㉢ 확대",
                    "㉠ 축소, ㉡ 이동, ㉢ 확대",
                    "㉠ 확대, ㉡ 이동, ㉢ 축소",
                    "㉠ 이동, ㉡ 확대, ㉢ 축소"
                ],
                correct: 0,
                explanation: "㉠ '놈'은 '일반 사람'에서 '낮춤말'로 의미가 좁아졌으므로 '축소', ㉡ '바가지'는 '박 그릇'에서 '모든 그릇'으로 넓어졌으므로 '확대', ㉢ '어엿브다'는 '가엾다'에서 '예쁘다'로 완전히 바뀌었으므로 '이동'입니다."
            },
            {
                id: 6,
                text: "밑줄 친 단어와 동일한 유형의 체언이 아닌 것은?\n\n<u>나라ᄒᆞᆯ</u> 아ᅀᆞ 맛디고",
                options: [
                    "길ㅎ",
                    "ᄯᅡㅎ",
                    "나모",
                    "안ㅎ",
                    "내ㅎ",
                    "머리ㅎ"
                ],
                correct: 2,
                explanation: "밑줄 친 '나라ᄒᆞᆯ'은 '나라ㅎ'이라는 'ㅎ' 종성 체언입니다. ①, ②, ④, ⑤, ⑥은 모두 'ㅎ' 종성 체언이지만, ③ '나모'는 'ㄱ' 곡용 체언으로 유형이 다릅니다."
            },
            {
                id: 7,
                text: "다음 중 'ㅎ' 종성 체언의 'ㅎ'이 나타나지 않는 환경은?",
                options: [
                    "나라ㅎ + 이",
                    "ᄯᅡㅎ + 도",
                    "안ㅎ + 과",
                    "길ㅎ + ㅅ",
                    "내ㅎ + ᄋᆞᆫ",
                    "머리ㅎ + 에"
                ],
                correct: 3,
                explanation: "관형격 조사 'ㅅ'은 자음이므로, 'ㅎ' 종성 체언 뒤에 'ㅅ'이 올 경우 '긼 네거리예'처럼 'ㅎ'이 나타나지 않고 생략됩니다. ①, ②, ③, ⑤, ⑥은 모두 'ㅎ'이 나타나는 환경입니다."
            },
            {
                id: 8,
                text: "'ㄱ' 곡용 체언의 'ㄱ'이 나타나는 환경으로 옳은 것은?",
                options: [
                    "나모 + 와",
                    "구무 + 도",
                    "녀느 + ㅣ",
                    "나모 (단독)",
                    "구무 + ㅅ",
                    "녀느 + 과"
                ],
                correct: 2,
                explanation: "'ㄱ' 곡용 체언은 '녀느(남)'처럼 뒤에 모음으로 시작하는 조사 'ㅣ'가 올 때 숨어있던 'ㄱ'이 덧생깁니다. ①, ②, ④는 'ㄱ'이 나타나지 않는 환경입니다."
            },
            {
                id: 9,
                text: "다음 중 현대 국어에 그 흔적이 남아있는 중세 국어의 어휘 현상은?",
                options: [
                    "'하다'와 'ᄒᆞ다'의 의미 구분",
                    "'ㄱ' 곡용 체언의 활용",
                    "'ㅎ' 종성 체언의 활용",
                    "'즐믄(천)'과 같은 고유 수사",
                    "'어리다'의 중세적 의미",
                    "'전ᄎᆞ(까닭)'의 사용"
                ],
                correct: 2,
                explanation: "'ㅎ' 종성 체언의 활용 방식 자체는 사라졌지만, '암탉', '살코기' 등 거센소리되기 형태로 현대 국어 단어에 그 흔적이 남아있습니다. 나머지는 모두 사라진 현상입니다."
            },
            {
                id: 10,
                text: "<보기>와 같은 방식으로 결합하는 단어는?\n\n살ㅎ + 고기 → 살코기",
                options: [
                    "ᄯᅡㅎ + 도",
                    "나라ㅎ + 이",
                    "암ㅎ + 닭",
                    "나모 + ㅣ",
                    "구무 + 와",
                    "길ㅎ + ㅅ"
                ],
                correct: 2,
                explanation: "<보기>는 'ㅎ' 종성 체언이 뒤따르는 예사소리 'ㄱ'을 거센소리 'ㅋ'으로 바꾼 예입니다. ③ '암ㅎ+닭'이 '암탉'으로 변하는 것도 동일한 원리(ㅎ+ㄷ→ㅌ)입니다."
            },
            {
                id: 11,
                text: "다음 중 의미의 변화 방향이 적절하게 설명된 것은?",
                options: [
                    "놈: 부정적 의미 → 중립적 의미",
                    "바가지: 좁은 의미 → 넓은 의미",
                    "어리다: 긍정적 의미 → 부정적 의미",
                    "얼굴: 부분 → 전체",
                    "겨집: 높임말 → 보통말",
                    "어엿브다: 긍정적 의미 → 중립적 의미"
                ],
                correct: 1,
                explanation: "'바가지'는 '박으로 만든 그릇'이라는 좁은 의미에서 '다양한 재료로 만든 그릇'이라는 넓은 의미로 확대되었습니다. 나머지는 방향이 틀리거나 잘못된 설명입니다."
            },
            {
                id: 12,
                text: "'ㅎ' 종성 체언과 'ㄱ' 곡용 체언에 대한 설명으로 옳은 것은?",
                options: [
                    "두 유형 모두 현대 국어에 남아있다.",
                    "두 유형 모두 단독으로 쓰일 때 숨어있던 받침이 나타났다.",
                    "'ㅎ' 종성 체언은 거센소리되기를, 'ㄱ' 곡용 체언은 된소리되기를 일으켰다.",
                    "'ㅎ' 종성 체언은 'ㅎ'이 항상 나타났고, 'ㄱ' 곡용 체언은 'ㄱ'이 항상 나타났다.",
                    "두 유형 모두 체언이 조사와 결합할 때 형태가 변하는 현상과 관련 있다.",
                    "'길'은 'ㅎ' 종성 체언, '불'은 'ㄱ' 곡용 체언의 예이다."
                ],
                correct: 4,
                explanation: "두 유형 모두 체언이 단독으로 쓰일 때와 조사와 결합할 때 형태가 달라지는 현상과 관련이 깊습니다. ① 'ㄱ' 곡용은 사라짐, ② 단독일 때 나타나지 않음, ③ 거센소리되기는 'ㅎ' 종성 체언만 해당, ④ 항상 나타나지 않음, ⑥ '길'은 'ㅎ' 종성 체언, '불'은 일반 체언입니다."
            },
            {
                id: 13,
                text: "밑줄 친 부분의 원래 형태와 결합 환경이 바르게 짝지어진 것은?\n\n<u>남기</u> 픈 ᄇᆞᄅᆞ매",
                options: [
                    "나모 + 자음 조사",
                    "남ㄱ + 자음 조사",
                    "나모 + 모음 조사",
                    "남ㄱ + 모음 조사",
                    "나모 (단독형)",
                    "남ㄱ + 관형격 'ㅅ'"
                ],
                correct: 3,
                explanation: "'남기'는 'ㄱ' 곡용 체언 '나모'의 어간 형태인 '남ㄱ'에 모음으로 시작하는 주격 조사 'ㅣ'가 결합한 것입니다. 'ㄱ'은 모음 조사 앞에서 나타납니다."
            },
            {
                id: 14,
                text: "다음 중 단어의 의미가 '이동'한 사례로만 묶인 것은?",
                options: [
                    "놈, 겨집",
                    "바가지, 지갑",
                    "어리다, 어엿브다",
                    "말ᄊᆞᆷ, 얼굴",
                    "놈, 어리다",
                    "바가지, 어엿브다"
                ],
                correct: 2,
                explanation: "'어리다(어리석다→나이가 적다)'와 '어엿브다(가엾다→예쁘다)'는 원래의 의미와 전혀 다른 새로운 의미로 바뀐 '의미 이동'의 대표적인 사례입니다."
            },
            {
                id: 15,
                text: "'머리ㅎ + 가락 → 머리카락'의 변화에 대한 설명으로 가장 적절한 것은?",
                options: [
                    "'ㅎ' 종성 체언의 'ㅎ'이 탈락했다.",
                    "'ㅎ' 종성 체언의 'ㅎ'이 뒤의 'ㄱ'과 합쳐져 'ㅋ'이 되었다.",
                    "'ㄱ' 곡용 체언의 'ㄱ'이 나타나 'ㅎ'과 합쳐졌다.",
                    "'ㅎ' 종성 체언과 관련 없는 단순한 음운 축약이다.",
                    "'머리'와 '가락' 사이에 'ㅎ'이 첨가되었다.",
                    "'가락'의 'ㄱ'이 이유 없이 거센소리로 바뀌었다."
                ],
                correct: 1,
                explanation: "'ㅎ' 종성 체언인 '머리ㅎ'의 받침 'ㅎ'과 뒤따르는 단어 '가락'의 첫소리 'ㄱ'이 합쳐져 하나의 거센소리 'ㅋ'으로 축약된 것입니다. 이는 'ㅎ' 종성 체언의 특징적인 음운 변화입니다."
            }
        ];

        // 타이머 관련 변수
        let timerInterval;
        let currentTime = 300; // 5분 (300초)
        const maxTime = 300;

        // 현재 학습 상태
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let startTime;
        let answeredQuestions = new Set();

        // 셔플된 문제 배열 (Stage 2 & 3용)
        let shuffledStage2Questions = [];
        let shuffledStage3Questions = [];

        // Fisher-Yates 셔플 알고리즘
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 모달 드래그 설정 (한 번만 실행)
        function setupModalDrag() {
            if (dragListenersAdded) return;
            
            const modal = document.getElementById('modal-content');

            modal.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            modal.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
            
            dragListenersAdded = true;
        }

        function startDrag(e) {
            const modal = document.getElementById('modal-content');
            if (e.target.closest('.option-button')) return;

            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchstart') {
                e.preventDefault();
            }

            isDragging = true;
            modal.classList.add('dragging');

            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;

            const rect = modal.getBoundingClientRect();
            modalStartX = rect.left;
            modalStartY = rect.top;
        }

        function drag(e) {
            if (!isDragging) return;
            
            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchmove') {
                e.preventDefault();
            }

            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;

            const modal = document.getElementById('modal-content');
            modal.style.left = (modalStartX + deltaX) + 'px';
            modal.style.top = (modalStartY + deltaY) + 'px';
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            document.getElementById('modal-content').classList.remove('dragging');
        }

        // 타이머 시작
        function startTimer() {
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerBar();

                if (currentTime <= 0) {
                    endStage();
                }
            }, 1000);
        }

        // 타이머 바 업데이트
        function updateTimerBar() {
            const percentage = (currentTime / maxTime) * 100;
            document.getElementById('timer-bar').style.width = percentage + '%';
        }

        // 시간 더하기/빼기
        function addTime(seconds) {
            currentTime = Math.min(currentTime + seconds, maxTime);
            updateTimerBar();
        }

        function subtractTime(seconds) {
            currentTime = Math.max(currentTime - seconds, 0);
            updateTimerBar();
        }

        // Markdown to HTML 변환
        function convertMarkdownToHTML(text) {
            // 테이블 처리
            let html = text.replace(/\|(.+)\|/g, (match) => {
                const cells = match.split('|').filter(c => c.trim());
                const isHeader = text.indexOf(match) !== -1 && text.split(match)[1].indexOf('|---') !== -1;
                const tag = isHeader ? 'th' : 'td';
                return '<tr>' + cells.map(cell => `<${tag}>${cell.trim()}</${tag}>`).join('') + '</tr>';
            });

            // 테이블 구조 감싸기
            html = html.replace(/(<tr>.*<\/tr>\n)+/g, (match) => {
                return '<table>' + match + '</table>';
            });

            // 헤딩 변환
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // 볼드 변환
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // 밑줄 변환 (<u> 태그 지원)
            html = html.replace(/<u>(.+?)<\/u>/g, '<u>$1</u>');

            // 리스트 변환
            html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                return '<ul>' + match + '</ul>';
            });

            // 줄바꿈 변환
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Stage 1: 딥리서치 - 2-choice 질문이 있는 HTML 생성
        // ============================================
        // Stage 1 학습 콘텐츠 생성 함수
        // ============================================
        // 설명: Stage 1에서 표시할 학습 콘텐츠를 생성합니다.
        // rawContent 내에서 <span class="highlight" data-question-id="번호">__________</span> 형식으로
        // STAGE1_QUESTIONS의 문제가 하이라이트로 표시됩니다.
        // - data-question-id: STAGE1_QUESTIONS 배열의 id와 일치해야 함
        // - 마크다운 문법 지원 (## 제목, **볼드**, 리스트 등)

        function generateStage1Content() {
            // ============================================
            // rawContent: Stage 1에 표시할 학습 콘텐츠
            // ============================================
            // 마크다운 문법 지원: ### 제목, **볼드**, <ul><li> 리스트, <table> 테이블 등
            // 하이라이트 문제 삽입: <span class="highlight" data-question-id="번호">__________</span>
            // - data-question-id는 STAGE1_QUESTIONS의 id와 반드시 일치해야 함
            // - context 속성은 어느 위치에서 하이라이트가 나타날지 결정함

            const rawContent = `<h2><strong>❸ 어휘</strong></h2>

<h3><strong>중세 국어 어휘의 특징</strong></h3>

<p>현대 국어에 없는 <span class="highlight" data-question-id="1">__________</span> 가 많이 쓰였음<br>
예) 뫼<span class="highlight" data-question-id="2">__________</span>, ᄀᆞᄅᆞᆷ<span class="highlight" data-question-id="3">__________</span>, 미르<span class="highlight" data-question-id="4">__________</span>, 즈믄<span class="highlight" data-question-id="5">__________</span><br>
<span class="highlight" data-question-id="6">__________</span> 가 지속적으로 증가하였음<br>
중국어가 귀화하기도 하고, <span class="highlight" data-question-id="7">__________</span> 등의 외래어 존재하였음</p>

<h3><strong>의미의 변화</strong></h3>

<h4><strong>의미의 축소</strong></h4>
<p><span class="highlight" data-question-id="8">__________</span><br>
<span class="highlight" data-question-id="9">__________</span><br>
<span class="highlight" data-question-id="10">__________</span><br>
<span class="highlight" data-question-id="11">__________</span></p>

<h4><strong>의미의 확대</strong></h4>
<p><span class="highlight" data-question-id="12">__________</span><br>
<span class="highlight" data-question-id="13">__________</span></p>

<h4><strong>의미의 이동</strong></h4>
<p><span class="highlight" data-question-id="14">__________</span><br>
<span class="highlight" data-question-id="15">__________</span></p>

<h4><strong>사라진 단어</strong></h4>
<p>전ᄎᆞ[까닭], ᄉᆞᄆᆞᆾ다[통하다], 하다[많다], 남진[남편], 뮈다[움직이다]</p>

<h3><strong>'하다'와 'ᄒᆞ다'의 구별</strong></h3>

<p><span class="highlight" data-question-id="16">__________</span>: '많다'는 뜻<br>
예) 노미 하니라 [사람이 <span class="highlight" data-question-id="17">__________</span>], 여름 하ᄂᆞ니 [열매가 <span class="highlight" data-question-id="18">__________</span>]</p>

<p><span class="highlight" data-question-id="19">__________</span>: '행동하다'는 뜻<br>
예) 몯<span class="highlight" data-question-id="20">__________</span>, 아니<span class="highlight" data-question-id="21">__________</span></p>

<p><strong>변천</strong><br>
⇒ 현대 국어의 '하다'는 '<span class="highlight" data-question-id="22">__________</span>'가 'ㆍ>ㅏ'의 음운 변화를 겪은 것</p>

<h3><strong>'ㅎ' 종성 체언</strong></h3>

<p><strong>뜻</strong> : '<span class="highlight" data-question-id="23">__________</span>' 종성을 포함하고 있는 체언</p>

<p><strong>환경</strong></p>

<p><strong>'ㅎ' 생략</strong><br>
① 'ㅎ' 종성 체언이 <span class="highlight" data-question-id="24">__________</span><br>
예) ᄯᅡ 지 地 [<span class="highlight" data-question-id="25">__________</span> 지]</p>

<p>② 'ㅎ' 종성 체언이 <span class="highlight" data-question-id="26">__________</span><br>
예) 다ᄅᆞᆫ ᄯᅡᆺ 風俗은 [다른 <span class="highlight" data-question-id="27">__________</span> 풍속은]</p>

<p>③ 'ㅎ' 종성 체언 뒤에 <span class="highlight" data-question-id="28">__________</span><br>
예) <span class="highlight" data-question-id="29">__________</span></p>

<p><strong>'ㅎ' 나타남</strong><br>
① 'ㅎ' 종성 체언 뒤에 <span class="highlight" data-question-id="30">__________</span><br>
예) ᄯᅡ히(ᄯᅡㅎ+이) 즐어늘 [<span class="highlight" data-question-id="31">__________</span> 질거늘], 나라ᄒᆞᆯ(나라ㅎ+ᄋᆞᆯ) 아ᅀᆞ 맛디고 [<span class="highlight" data-question-id="32">__________</span> 아우에게 맡기고]</p>

<p>② 'ㅎ' 종성 체언이 <span class="highlight" data-question-id="33">__________</span> (거센소리되기)<br>
예) ᄯᅡ토(ᄯᅡㅎ+도) 뮈더니 [<span class="highlight" data-question-id="34">__________</span> 움직이더니], 안콰(안ㅎ+과) 밧 [<span class="highlight" data-question-id="35">__________</span>]</p>

<p><strong>변천</strong> : <span class="highlight" data-question-id="36">__________</span> 사라짐<br>
⇒ 현대 국어에 <span class="highlight" data-question-id="37">__________</span><br>
예) 머리ㅎ + 가락 > <span class="highlight" data-question-id="38">__________</span>, 살ㅎ + 고기 > <span class="highlight" data-question-id="39">__________</span>, 암ㅎ + 닭 -> <span class="highlight" data-question-id="40">__________</span>, 수ㅎ + 병아리 -> <span class="highlight" data-question-id="41">__________</span></p>

<h3><strong>'ㄱ' 곡용 체언</strong></h3>

<p><strong>뜻</strong> : '<span class="highlight" data-question-id="42">__________</span>'이 덧생기는 체언</p>

<p><strong>환경</strong></p>

<p><strong>'ㄱ' 생략</strong><br>
① 'ㄱ' 곡용 체언이 <span class="highlight" data-question-id="43">__________</span><br>
예) 나모 [<span class="highlight" data-question-id="44">__________</span>], 구무 [<span class="highlight" data-question-id="45">__________</span>]</p>

<p>② 'ㄱ' 곡용 체언이 조사 <span class="highlight" data-question-id="46">__________</span><br>
예) 나모와 [<span class="highlight" data-question-id="47">__________</span>], 구무도 [<span class="highlight" data-question-id="48">__________</span>]</p>

<p><strong>'ㄱ' 나타남</strong><br>
① 'ㄱ' 곡용 체언 뒤에 <span class="highlight" data-question-id="49">__________</span><br>
예) 남기(남ㄱ+ㅣ) [<span class="highlight" data-question-id="50">__________</span>], 남ᄀᆞᆯ(남ㄱ+ᄋᆞᆯ) [<span class="highlight" data-question-id="51">__________</span>], 남ᄀᆞᆫ(남ㄱ+ᄋᆞᆫ) [<span class="highlight" data-question-id="52">__________</span>]</p>

<p><strong>변천</strong>: <span class="highlight" data-question-id="53">__________</span> 사라짐</p>
`;

            return rawContent;
        }

        // Stage 1: 딥리서치 초기화
        function initStage1() {
            currentStage = 1;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            answeredQuestions.clear();
            currentTime = 300;
            startTime = Date.now();

            // UI 업데이트
            document.querySelector('.title').textContent = '중세국어의 특징 - 어휘 파트';
            document.getElementById('stage-subtitle').textContent = '1단계: 딥리서치';
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();
            document.getElementById('total-questions').textContent = STAGE1_QUESTIONS.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('active');
            });

            // 지문 표시
            const passageHTML = generateStage1Content();
            document.getElementById('passage-container').innerHTML = passageHTML;

            // 하이라이트 클릭 이벤트 추가
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(highlight => {
                highlight.addEventListener('click', function() {
                    const questionId = parseInt(this.getAttribute('data-question-id'));
                    if (!answeredQuestions.has(questionId)) {
                        showQuestion(questionId, this);
                    }
                });
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            startTimer();
        }

        // 질문 모달 표시
        function showQuestion(questionId, highlightElement) {
            const question = STAGE1_QUESTIONS.find(q => q.id === questionId);
            if (!question) return;

            const modalOverlay = document.getElementById('modal-overlay');
            const modalHeader = document.getElementById('modal-header');
            const modalOptions = document.getElementById('modal-options');
            const modalContent = document.getElementById('modal-content');

            // 모달 초기화
            modalContent.classList.remove('correct-feedback', 'incorrect-feedback');

            // 질문 헤더
            modalHeader.textContent = question.context;

            // 선지 셔플
            const options = shuffleArray([
                { text: question.correctAnswer, isCorrect: true },
                { text: question.wrongAnswer, isCorrect: false }
            ]);

            // 선지 버튼 생성
            modalOptions.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => checkAnswer(questionId, option.isCorrect, button, highlightElement);
                modalOptions.appendChild(button);
            });

            // 모달 표시
            modalOverlay.classList.add('active');

            // 모달 위치 설정 (하이라이트 근처에 배치하되 화면 밖으로 나가지 않도록)
            const highlightRect = highlightElement.getBoundingClientRect();
            const modalWidth = 500; // max-width
            const modalHeight = 300; // 대략적인 높이

            // 하이라이트 오른쪽에 배치 시도
            let left = highlightRect.right + 20;
            let top = highlightRect.top;

            // 오른쪽 공간이 부족하면 왼쪽에 배치
            if (left + modalWidth > window.innerWidth) {
                left = highlightRect.left - modalWidth - 20;
            }

            // 왼쪽도 공간이 부족하면 중앙에 배치
            if (left < 0) {
                left = (window.innerWidth - modalWidth) / 2;
            }

            // 위쪽으로 벗어나지 않도록
            if (top < 20) {
                top = 20;
            }

            // 아래쪽으로 벗어나지 않도록
            if (top + modalHeight > window.innerHeight) {
                top = window.innerHeight - modalHeight - 20;
            }

            modalContent.style.left = left + 'px';
            modalContent.style.top = top + 'px';

            // 모달 드래그 설정 (한 번만 실행)
            setupModalDrag();
        }

        // 답변 체크
        function checkAnswer(questionId, isCorrect, button, highlightElement) {
            const buttons = document.querySelectorAll('.option-button');
            const modalContent = document.getElementById('modal-content');

            // 버튼 비활성화
            buttons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.classList.add('correct');
                modalContent.classList.add('correct-feedback');
                highlightElement.classList.add('correct', 'answered');
                highlightElement.textContent = button.textContent;
                correctCount++;
                addTime(10);
            } else {
                button.classList.add('incorrect');
                modalContent.classList.add('incorrect-feedback');
                highlightElement.classList.add('incorrect', 'answered');

                // 정답 표시
                const correctButton = Array.from(buttons).find(btn => !btn.classList.contains('incorrect'));
                if (correctButton) {
                    correctButton.classList.add('correct');
                    highlightElement.textContent = correctButton.textContent;
                }

                wrongCount++;
                subtractTime(40);
            }

            // 답변한 질문 추가
            answeredQuestions.add(questionId);
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();

            // 모달 닫기
            setTimeout(() => {
                document.getElementById('modal-overlay').classList.remove('active');

                // 모든 질문 완료 확인
                if (answeredQuestions.size === STAGE1_QUESTIONS.length) {
                    setTimeout(() => endStage(), 500);
                }
            }, 1500);
        }

        // Stage 2: OX 학습 초기화
        function initStage2() {
            clearInterval(timerInterval);

            currentStage = 2;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage2WrongQuestions = [];

            // OX 문제 셔플 (매번 새로운 순서로)
            shuffledStage2Questions = shuffleArray(STAGE2_QUESTIONS);

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '2단계: OX 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage2Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('completed');
                if (index === 1) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showOXQuestion();
            startTimer();
        }

        // OX 문제 표시
        function showOXQuestion() {
            const question = shuffledStage2Questions[currentQuestionIndex];

            document.getElementById('passage-container').innerHTML = `
                <div class="ox-container">
                    <div class="ox-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage2Questions.length}</div>
                        <div class="question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="ox-options">
                            <button class="ox-option-button" onclick="checkOXAnswer('O')">O</button>
                            <button class="ox-option-button" onclick="checkOXAnswer('X')">X</button>
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="ox-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // OX 답변 체크
        function checkOXAnswer(answer) {
            const question = shuffledStage2Questions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.ox-option-button');
            const isCorrect = answer === question.answer;

            buttons.forEach(button => {
                button.disabled = true;
                if (button.textContent === answer) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(15);

                // 틀린 문제 저장
                stage2WrongQuestions.push({
                    question: question.text,
                    userAnswer: answer,
                    correctAnswer: question.answer,
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('ox-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage2Questions.length) {
                    endStage();
                } else {
                    showOXQuestion();
                }
            }, 2000);
        }

        // Stage 3: 객관식 학습 초기화
        function initStage3() {
            clearInterval(timerInterval);

            currentStage = 3;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage3WrongQuestions = [];

            // 객관식 문제 셔플 (매번 새로운 순서로)
            shuffledStage3Questions = shuffleArray(STAGE3_QUESTIONS);

            // 각 문제에 대해 4지선다 미리 생성
            shuffledStage3Questions.forEach(q => {
                q.selectedOptions = generate4Options(q.options, q.correct);
            });

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '3단계: 객관식 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage3Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < 2) dot.classList.add('completed');
                if (index === 2) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showMCQQuestion();
            startTimer();
        }

        // 6지선다에서 4지선다 생성 (정답 포함)
        function generate4Options(allOptions, correctIndex) {
            const correctOption = allOptions[correctIndex];
            const otherOptions = allOptions.filter((_, i) => i !== correctIndex);

            // 오답 중에서 3개 랜덤 선택
            const shuffledOthers = shuffleArray(otherOptions);
            const selected3Others = shuffledOthers.slice(0, 3);

            // 정답과 3개 오답을 합쳐서 셔플
            const final4Options = shuffleArray([correctOption, ...selected3Others]);

            // 새로운 정답 인덱스 찾기
            const newCorrectIndex = final4Options.indexOf(correctOption);

            return {
                options: final4Options,
                correctIndex: newCorrectIndex
            };
        }

        // 객관식 문제 표시
        function showMCQQuestion() {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;

            const optionsHTML = options.map((opt, index) => `
                <button class="mcq-option-button" onclick="checkMCQAnswer(${index})">
                    <span class="option-number">${index + 1}</span>
                    <span class="option-text">${convertMarkdownToHTML(opt)}</span>
                </button>
            `).join('');

            document.getElementById('passage-container').innerHTML = `
                <div class="mcq-container">
                    <div class="mcq-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage3Questions.length}</div>
                        <div class="mcq-question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="mcq-options">
                            ${optionsHTML}
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="mcq-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // 객관식 답변 체크
        function checkMCQAnswer(selectedIndex) {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;
            const buttons = document.querySelectorAll('.mcq-option-button');
            const isCorrect = selectedIndex === correctIndex;

            buttons.forEach((button, index) => {
                button.disabled = true;
                if (index === selectedIndex) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (index === correctIndex && !isCorrect) {
                    button.classList.add('correct');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(20);

                // 틀린 문제 저장
                stage3WrongQuestions.push({
                    question: question.text,
                    userAnswer: options[selectedIndex],
                    correctAnswer: options[correctIndex],
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('mcq-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage3Questions.length) {
                    endStage();
                } else {
                    showMCQQuestion();
                }
            }, 2000);
        }

        // 단계 종료
        function endStage() {
            clearInterval(timerInterval);

            const endTime = Date.now();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;

            let totalQuestions = 0;
            if (currentStage === 1) {
                totalQuestions = STAGE1_QUESTIONS.length;
            } else if (currentStage === 2) {
                totalQuestions = shuffledStage2Questions.length;
            } else if (currentStage === 3) {
                totalQuestions = shuffledStage3Questions.length;
            }

            const accuracy = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 100;
            const score = (accuracy / 100) * 10; // 10점 만점으로 환산

            // 결과 저장 (레거시)
            allStageResults[`stage${currentStage}`] = {
                totalQuestions,
                correctCount,
                wrongCount,
                accuracy,
                totalTime
            };

            // 새로운 stageResults에 저장 (틀린 문제 포함)
            const wrongQuestionsArray = currentStage === 2 ? stage2WrongQuestions :
                                       currentStage === 3 ? stage3WrongQuestions : [];

            stageResults[`stage${currentStage}`] = {
                correct: correctCount,
                wrong: wrongCount,
                score: score,
                elapsedTime: totalTime,
                wrongQuestions: wrongQuestionsArray
            };

            // 결과 화면 표시
            document.getElementById('result-title').textContent = `${currentStage}단계 학습 완료!`;
            document.getElementById('progress-stat').textContent = '100%';
            document.getElementById('accuracy-stat').textContent = accuracy + '%';
            document.getElementById('correct-stat').textContent = correctCount;
            document.getElementById('wrong-stat').textContent = wrongCount;
            document.getElementById('time-stat').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // 버튼 업데이트
            const resultButtons = document.querySelector('.result-buttons');
            let buttonsHTML = '<button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>';

            // Stage 2와 Stage 3의 경우 틀린 문제 보기 버튼 추가
            if (currentStage === 2 && stage2WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage2()">틀린 문제 보기 (${stage2WrongQuestions.length}문제)</button>`;
            } else if (currentStage === 3 && stage3WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage3()">틀린 문제 보기 (${stage3WrongQuestions.length}문제)</button>`;
            }

            // 다음 단계 버튼 (Stage 3이면 "전체 결과 보기")
            if (currentStage === 3) {
                buttonsHTML += '<button class="result-button primary" onclick="showFinalResults()">전체 결과 보기</button>';
            } else {
                buttonsHTML += '<button class="result-button primary" onclick="nextStage()">다음 단계로</button>';
            }

            resultButtons.innerHTML = buttonsHTML;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('result-screen').classList.add('active');
        }

        // 다시 학습하기
        function restartStage() {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('result-screen').classList.remove('active');

            if (currentStage === 1) {
                initStage1();
            } else if (currentStage === 2) {
                initStage2();
            } else if (currentStage === 3) {
                initStage3();
            }
        }

        // 다음 단계로
        function nextStage() {
            document.getElementById('main-content').style.display = 'block';

            if (currentStage === 1) {
                initStage2();
            } else if (currentStage === 2) {
                initStage3();
            } else if (currentStage === 3) {
                // 모든 단계 완료
                alert('모든 학습을 완료했습니다!');
                initStage1();
            }
        }

        // Stage 2 틀린 문제 보기
        function showWrongQuestionsStage2() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage2')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage2" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>2단계: OX - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage2()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage2"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage2');
            content.innerHTML = stage2WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage2').classList.add('active');
        }

        // Stage 2 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage2() {
            document.getElementById('wrong-questions-modal-stage2').classList.remove('active');
        }

        // Stage 3 틀린 문제 보기
        function showWrongQuestionsStage3() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage3')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage3" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>3단계: 객관식 - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage3()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage3"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage3');
            content.innerHTML = stage3WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage3').classList.add('active');
        }

        // Stage 3 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage3() {
            document.getElementById('wrong-questions-modal-stage3').classList.remove('active');
        }

        // 시간 포맷팅 함수
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 전체 결과 보기
        function showFinalResults() {
            // 기존 타이머 정리
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // 결과 화면과 메인 컨텐츠 숨기기
            document.getElementById('result-screen').classList.remove('active');

            // 전체 결과 계산
            const totalCorrect = stageResults.stage1.correct + stageResults.stage2.correct + stageResults.stage3.correct;
            const totalWrong = stageResults.stage1.wrong + stageResults.stage2.wrong + stageResults.stage3.wrong;
            const overallAccuracy = (totalCorrect + totalWrong) > 0 ?
                                   Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;
            const totalScore = stageResults.stage1.score + stageResults.stage2.score + stageResults.stage3.score;
            const totalElapsedTime = stageResults.stage1.elapsedTime + stageResults.stage2.elapsedTime + stageResults.stage3.elapsedTime;

            // 스테이지명 맵핑
            const stageNames = {
                stage1: '1단계: 딥리서치',
                stage2: '2단계: OX 학습',
                stage3: '3단계: 객관식 학습'
            };

            // HTML 생성
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">🎉 학습 완료!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">모든 학습 단계를 완료했습니다.</p>
                    </div>

                    <!-- 전체 학습 결과 -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">📊 전체 학습 결과</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총점</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}점</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #7f8c8d;">/ 30.0점</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">전체 정답률</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">정답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">오답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총 소요 시간</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${formatTime(totalElapsedTime)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 단계별 결과 -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">📈 단계별 학습 결과</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // 각 단계별 결과 카드
            ['stage1', 'stage2', 'stage3'].forEach(stageKey => {
                const result = stageResults[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey]}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답률:</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답:</span>
                                <strong>${result.correct}개</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">오답:</span>
                                <strong style="color: #e74c3c;">${result.wrong}회</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">점수:</span>
                                <strong style="color: #3498db;">${result.score.toFixed(1)}점</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">소요 시간:</span>
                                <strong>${formatTime(result.elapsedTime)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
        </div>

        <!-- 틀린 문제 상세 정보 -->
        <h2 style="margin-top: 50px; margin-bottom: 25px; color: #2c3e50; font-size: 24px; font-weight: 600;">❌ 틀린 문제 상세</h2>
`;

            // Stage 2와 Stage 3의 틀린 문제 표시
            let hasWrongQuestions = false;

            // Stage 2 틀린 문제
            if (stageResults.stage2.wrongQuestions && stageResults.stage2.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #856404; margin-bottom: 20px; font-size: 20px;">📝 2단계: OX - 틀린 문제</h3>
`;
                stageResults.stage2.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // Stage 3 틀린 문제
            if (stageResults.stage3.wrongQuestions && stageResults.stage3.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #721c24; margin-bottom: 20px; font-size: 20px;">🔤 3단계: 객관식 - 틀린 문제</h3>
`;
                stageResults.stage3.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // 틀린 문제가 없는 경우
            if (!hasWrongQuestions) {
                html += `
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 12px; padding: 25px; text-align: center;">
            <p style="color: #155724; font-size: 18px; font-weight: 600;">🎉 완벽합니다! 모든 문제를 맞추셨습니다!</p>
        </div>
`;
            }

            html += `
        <!-- 액션 버튼 -->
        <div style="text-align: center; margin-top: 50px; padding-bottom: 50px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveFinalResultsAsImage()" style="
                background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 211, 153, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 211, 153, 0.4)';">
                📷 이미지로 저장
            </button>
            <button onclick="location.reload()" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.4)';">
                🔄 처음부터 다시하기
            </button>
        </div>
    </div>
`;

            // HTML 설정 및 표시
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('main-content').style.display = 'block';

            // 부모 프로그램으로 데이터 전송
            sendFinalDataToParent(totalCorrect, totalWrong, totalScore, overallAccuracy, totalElapsedTime);
        }

        // 부모 프로그램으로 최종 데이터 전송
        function sendFinalDataToParent(totalCorrect, totalWrong, totalScore, overallAccuracy, totalElapsedTime) {
            console.log('=== sendFinalDataToParent 호출됨 ===');
            console.log('iframe으로 로드됨:', window.self !== window.top);
            console.log('window.parent 존재:', !!window.parent);
            console.log('window.parent !== window:', window.parent !== window);

            if (window.parent && window.parent !== window) {
                const answeredQuestions = totalCorrect + totalWrong;

                // 각 스테이지별 전체 문제 수 정보 추가
                const stagesDetailWithTotal = {
                    stage1: {
                        ...stageResults.stage1,
                        totalQuestions: STAGE1_QUESTIONS.length
                    },
                    stage2: {
                        ...stageResults.stage2,
                        totalQuestions: STAGE2_QUESTIONS.length
                    },
                    stage3: {
                        ...stageResults.stage3,
                        totalQuestions: STAGE3_QUESTIONS.length
                    }
                };

                // 전체 문제 수 = 각 스테이지의 전체 문제 수 합계
                const totalAllQuestions = STAGE1_QUESTIONS.length + STAGE2_QUESTIONS.length + STAGE3_QUESTIONS.length;

                // 진행률 = (푼 문제 수 / 전체 문제 수) * 100
                const progress = totalAllQuestions > 0 ? Math.round((answeredQuestions / totalAllQuestions) * 100) : 100;

                const messageData = {
                    type: 'korean-farm-v2',
                    event: 'all-stages-complete',
                    data: {
                        totalStages: 3,
                        totalCorrect: totalCorrect,
                        totalWrong: totalWrong,
                        totalAccuracy: overallAccuracy,
                        totalScore: totalScore,
                        totalElapsedTime: totalElapsedTime * 1000, // 초를 밀리초로 변환
                        stagesDetail: stagesDetailWithTotal,
                        totalQuestions: totalAllQuestions, // 전체 문제 수
                        answeredQuestions: answeredQuestions, // 푼 문제 수
                        correctAnswers: totalCorrect,
                        wrongAnswers: totalWrong,
                        progress: progress, // 진행률
                        timestamp: Date.now()
                    }
                };

                console.log('부모로 전송할 데이터:', messageData);
                console.log('전체 문제 수:', totalAllQuestions, '/ 푼 문제 수:', answeredQuestions, '/ 진행률:', progress + '%');
                window.parent.postMessage(messageData, '*');
                console.log('postMessage 전송 완료');
            } else {
                console.log('부모 윈도우가 없거나 같은 윈도우입니다. 데이터를 전송하지 않습니다.');
            }
        }

        // 최종 결과 페이지 이미지 저장
        function saveFinalResultsAsImage() {
            if (typeof htmlToImage === 'undefined') {
                alert('이미지 라이브러리가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const mainContent = document.getElementById('main-content');

            // 저장 버튼들 임시 숨김
            const buttons = mainContent.querySelectorAll('button');
            const buttonStates = Array.from(buttons).map(btn => btn.style.display);
            buttons.forEach(btn => btn.style.display = 'none');

            // 약간의 딜레이 후 캡처
            setTimeout(() => {
                htmlToImage.toBlob(mainContent, {
                    backgroundColor: '#f5f7fa',
                    pixelRatio: 2,
                    cacheBust: true
                }).then(blob => {
                    // 버튼 다시 표시
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);

                    // 이미지 다운로드
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `중세국어_어휘_최종결과_${timestamp}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }).catch(err => {
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);
                    console.error('이미지 저장 실패:', err);
                    alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
                });
            }, 100);
        }

        // 페이지 로드 시 모달 드래그 설정 초기화
        window.onload = function() {
            // 모달 드래그 설정을 페이지 로드 시 한 번만 실행
            setupModalDrag();
            initStage1();
        };
    </script>
</body>
</html>