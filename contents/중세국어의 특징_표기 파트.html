<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중세 국어 표기 파트 학습</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stage-indicator {
            display: flex;
            gap: 10px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .stage-dot.active {
            background: #3498db;
            transform: scale(1.3);
        }

        .stage-dot.completed {
            background: #27ae60;
        }

        .question-counter {
            font-size: 18px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Timer Bar */
        .timer-container {
            width: 300px;
            height: 24px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .timer-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* Main Content */
        .main-content {
            margin-top: 100px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
            position: relative;
        }

        .passage-container {
            font-size: 18px;
            line-height: 2;
            color: #2c3e50;
            word-break: keep-all;
        }

        .passage-container h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .passage-container h3 {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .passage-container strong {
            font-weight: 700;
            color: #2c3e50;
        }

        .passage-container ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .passage-container li {
            margin: 8px 0;
            line-height: 1.8;
        }

        .passage-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .passage-container table th,
        .passage-container table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .passage-container table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* Highlight Style */
        .highlight {
            background: linear-gradient(120deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline;
            position: relative;
        }

        .highlight:hover {
            background: linear-gradient(120deg, #fdcb6e 0%, #fab1a0 100%);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(253, 203, 110, 0.5);
        }

        .highlight.answered {
            background: linear-gradient(120deg, #dfe6e9 0%, #b2bec3 100%);
            cursor: default;
        }

        .highlight.answered:hover {
            transform: none;
            box-shadow: none;
        }

        .highlight.correct {
            background: linear-gradient(120deg, #55efc4 0%, #00b894 100%);
        }

        .highlight.incorrect {
            background: linear-gradient(120deg, #fab1a0 0%, #ff7675 100%);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: fixed;
            cursor: move;
            transition: opacity 0.3s ease;
        }

        .modal-content.dragging {
            opacity: 0.95;
            user-select: none;
        }

        .modal-content.correct-feedback {
            border: 3px solid #00b894;
            animation: correctPulse 0.6s ease;
        }

        .modal-content.incorrect-feedback {
            border: 3px solid #ff7675;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 184, 148, 0.6); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-button {
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: 'Noto Serif KR', serif;
        }

        .option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Result Screen */
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 100px;
        }

        .result-screen.active {
            display: block;
        }

        body:has(.result-screen.active) .timer-container {
            display: none !important;
        }

        .result-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-button.primary {
            background: #3498db;
            color: white;
        }

        .result-button.primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .result-button.secondary {
            background: #95a5a6;
            color: white;
        }

        .result-button.secondary:hover {
            background: #7f8c8d;
        }

        /* OX Learning Styles (Stage 2) */
        .ox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .ox-question-card {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .question-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .ox-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .ox-option-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ox-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: scale(1.05);
        }

        .ox-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .ox-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .ox-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Multiple Choice Styles (Stage 3) */
        .mcq-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .mcq-question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .mcq-question-text {
            font-size: 20px;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mcq-option-button {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mcq-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .mcq-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .mcq-option-button .option-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            flex-shrink: 0;
        }

        .mcq-option-button .option-text {
            flex: 1;
            color: #2c3e50;
        }

        .mcq-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
        }

        .mcq-option-button.correct .option-number {
            background: #27ae60;
        }

        .mcq-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .mcq-option-button.incorrect .option-number {
            background: #f44336;
        }

        /* Feedback Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Wrong Questions Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: fixed;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 10px 0;
        }

        .wrong-question-item {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .wrong-question-item h4 {
            color: #dc3545;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .wrong-question-item p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .wrong-question-item .question-text {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .wrong-question-item .user-answer {
            color: #dc3545;
            background: #fff5f5;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .wrong-question-item .correct-answer {
            color: #28a745;
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .explanation-text {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 16px;
            color: #856404;
            text-align: center;
            line-height: 1.6;
        }

        .question-explanation {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            color: #856404;
            margin-top: 10px;
        }

        .question-explanation strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .title {
                font-size: 20px;
            }

            .subtitle {
                font-size: 12px;
            }

            .progress-info {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .question-counter {
                font-size: 14px;
            }

            .timer-container {
                width: 200px;
                height: 18px;
            }

            .stage-dot {
                width: 10px;
                height: 10px;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            .option-button {
                padding: 12px 15px;
                font-size: 14px;
            }

            .ox-question-card {
                padding: 20px;
            }

            .question-text {
                font-size: 18px;
                margin-bottom: 20px;
            }

            .ox-option-button {
                padding: 20px 15px;
                font-size: 24px;
            }

            .mcq-question-card {
                padding: 20px;
            }

            .mcq-question-text {
                font-size: 16px;
                line-height: 1.6;
            }

            .mcq-option-button {
                padding: 12px 15px;
                font-size: 14px;
                gap: 12px;
            }

            .mcq-option-button .option-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        /* Mobile Phone Size */
        @media (max-width: 480px) {
            .header {
                padding: 10px;
                gap: 8px;
            }

            .header-left {
                gap: 3px;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
            }

            .subtitle {
                font-size: 11px;
            }

            .progress-info {
                gap: 8px;
            }

            .question-counter {
                font-size: 12px;
                font-weight: 400;
            }

            .timer-container {
                width: 150px;
                height: 14px;
            }

            .stage-indicator {
                gap: 6px;
            }

            .stage-dot {
                width: 8px;
                height: 8px;
            }

            .stage-dot.active {
                transform: scale(1.2);
            }

            .main-content {
                margin-top: 80px;
                padding: 20px;
            }

            .passage-container {
                font-size: 16px;
                line-height: 1.8;
            }
        }
    </style>

    <!-- html-to-image CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="title">문법 개념 학습 템플릿</div>
                <div class="subtitle" id="stage-subtitle">1단계: 딥리서치</div>
            </div>
            <div class="progress-info">
                <div class="stage-indicator">
                    <div class="stage-dot active"></div>
                    <div class="stage-dot"></div>
                    <div class="stage-dot"></div>
                </div>
                <div class="question-counter">
                    문제: <span id="current-question">0</span> / <span id="total-questions">0</span>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="passage-container" id="passage-container"></div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-content" id="modal-content">
                <div class="modal-header" id="modal-header"></div>
                <div class="modal-options" id="modal-options"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen" id="result-screen">
            <h2 class="result-title" id="result-title">1단계 학습 완료!</h2>
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-value" id="progress-stat">0%</div>
                    <div class="stat-label">진행률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy-stat">0%</div>
                    <div class="stat-label">정답률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="correct-stat">0</div>
                    <div class="stat-label">맞힌 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="wrong-stat">0</div>
                    <div class="stat-label">틀린 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time-stat">0:00</div>
                    <div class="stat-label">소요 시간</div>
                </div>
            </div>
            <div class="result-buttons">
                <button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>
                <button class="result-button primary" onclick="nextStage()">다음 단계로</button>
            </div>
        </div>
    </div>

    <script>
        // 모달 드래그 관련 변수
        let isDragging = false;
        let dragStartX, dragStartY;
        let modalStartX, modalStartY;
        let dragListenersAdded = false;

        // 현재 단계
        let currentStage = 1;

        // 전체 학습 결과 저장소 (레거시)
        const allStageResults = {
            stage1: null,
            stage2: null,
            stage3: null
        };

        // 새로운 stageResults 객체 (틀린 문제 포함)
        const stageResults = {
            stage1: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage2: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage3: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] }
        };

        // Stage 2와 Stage 3의 wrongQuestions 추적용 배열
        let stage2WrongQuestions = [];
        let stage3WrongQuestions = [];

        // 전역 시작 시간
        let globalStartTime = Date.now();

        // Stage 1: 딥리서치 - 2-choice 질문 데이터
        // ============================================
        // Stage 1: 딥리서치 - 2지선다 하이라이트 문제
        // ============================================
        // 설명: 학습 콘텐츠 내에 하이라이트로 표시된 빈칸 문제
        // 형식: { id: 번호, context: "문맥", correctAnswer: "정답", wrongAnswer: "오답" }
        // - id: 문제 고유 번호
        // - context: 하이라이트가 나타날 문맥 (이 텍스트 다음에 하이라이트가 표시됨)
        // - correctAnswer: 정답 텍스트
        // - wrongAnswer: 오답 텍스트

        const STAGE1_QUESTIONS = [
            { id: 1, context: "받침 표기는", correctAnswer: "8종성법", wrongAnswer: "7종성법" },
            { id: 2, context: "이 원칙", correctAnswer: "이어적기, 끊어적기", wrongAnswer: "이어적기, 거듭적기" },
            { id: 3, context: "병존", correctAnswer: "세로쓰기", wrongAnswer: "가로쓰기" },
            { id: 4, context: "한자음 표기", correctAnswer: "동국정운식 한자음 표기", wrongAnswer: "현실적 한자음 표기" },
            { id: 5, context: "표기 ->", correctAnswer: "현실적 한자음 표기", wrongAnswer: "동국정운식 한자음 표기" },
            { id: 6, context: "뜻: 종성은", correctAnswer: "초성을 다시 사용함", wrongAnswer: "새로 글자를 만듦" },
            { id: 7, context: "활용:", correctAnswer: "훈민정음 창제 당시", wrongAnswer: "15세기" },
            { id: 8, context: "뜻: 받침으로 대표음", correctAnswer: "8종성만으로 표기함", wrongAnswer: "모든 자음을 표기함" },
            { id: 9, context: "활용:", correctAnswer: "15세기에 주로 사용", wrongAnswer: "근대 국어에 사용" },
            { id: 10, context: "사용", correctAnswer: "ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅅ,ㆁ", wrongAnswer: "ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ" },
            { id: 11, context: "8종성법을", correctAnswer: "지킨 예", wrongAnswer: "지키지 않은 예" },
            { id: 12, context: "8종성법을", correctAnswer: "지키지 않은 예", wrongAnswer: "지킨 예" },
            { id: 13, context: "뜻: 받침으로 대표음", correctAnswer: "7종성만으로 표기함", wrongAnswer: "8종성만으로 표기함" },
            { id: 14, context: "활용:", correctAnswer: "근대 국어에 사용", wrongAnswer: "15세기에 사용" },
            { id: 15, context: "('ㄷ'이 아니라 'ㅅ' 종성)", correctAnswer: "ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ", wrongAnswer: "ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅅ,ㆁ" },
            { id: 16, context: "뜻: 소리대로 적되,", correctAnswer: "어법에 맞도록 함을 원칙", wrongAnswer: "소리나는 대로 적음을 원칙" },
            { id: 17, context: "발음은 소리대로", correctAnswer: "7종성", wrongAnswer: "8종성" },
            { id: 18, context: "활용:", correctAnswer: "현대 국어에 사용", wrongAnswer: "중세 국어에 사용" },
            { id: 19, context: "('ㅅ'이 아니라 'ㄷ'종성)", correctAnswer: "ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅇ", wrongAnswer: "ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ" },
            { id: 20, context: "뜻: 글자를 표기할 때", correctAnswer: "소리 나는 대로 적는 법", wrongAnswer: "형태소의 모습을 밝혀 적는 법" },
            { id: 21, context: "활용:", correctAnswer: "15세기에", wrongAnswer: "근대 국어에" },
            { id: 22, context: "뜻:", correctAnswer: "형태소의 모습을 밝혀 적는 법", wrongAnswer: "소리 나는 대로 적는 법" },
            { id: 23, context: "활용:", correctAnswer: "근대 국어에서", wrongAnswer: "15세기에서" },
            { id: 24, context: "뜻:", correctAnswer: "이어적기와 끊어적기를 중복하여 적는 법", wrongAnswer: "이어적기만 반복하는 법" },
            { id: 25, context: "활용: 이어적기와 끊어적기의", correctAnswer: "과도기적 현상", wrongAnswer: "완성형" },
            { id: 26, context: "으로 근대 국어에 나타남", correctAnswer: "이어적기(연철) > 거듭적기(중철) > 끊어적기(분철)", wrongAnswer: "끊어적기(분철) > 거듭적기(중철) > 이어적기(연철)" },
            { id: 27, context: "뜻:", correctAnswer: "중국 발음에 가깝게 이상적 한자음", wrongAnswer: "당시의 현실적 한자음" },
            { id: 28, context: "中", correctAnswer: "듕國·귁", wrongAnswer: "중국" },
            { id: 29, context: "[중국], 訓·훈民민正·졍音", correctAnswer: "ᅙᅳᆷ", wrongAnswer: "음" },
            { id: 30, context: "[훈민정음] 世", correctAnswer: "솅", wrongAnswer: "세" },
            { id: 31, context: "宗조ᇰ御", correctAnswer: "엉", wrongAnswer: "어" },
            { id: 32, context: "製", correctAnswer: "졩", wrongAnswer: "제" },
            { id: 33, context: "[세종어제], 文문字", correctAnswer: "ᄍᆞᆼ", wrongAnswer: "자" },
            { id: 34, context: "[문자] 점차", correctAnswer: "현실적 한자음", wrongAnswer: "이상적 한자음" },
            { id: 35, context: "예) 孔", correctAnswer: "공子ᄌᆡ", wrongAnswer: "공자" }
        ];

        // ============================================
        // Stage 2: OX 퀴즈
        // ============================================
        // 설명: O/X로 답하는 퀴즈 형식
        // 형식: { id: 번호, text: "문제 내용", answer: "O" 또는 "X", explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 문법 지원: **볼드**, <u>밑줄</u> 등)
        // - answer: 정답 ("O" 또는 "X")
        // - explanation: 정오답 해설 (마크다운 문법 지원)

        const STAGE2_QUESTIONS = [
            { id: 1, text: "'이어적기(연철)'는 '말ᄊᆞ미'처럼 받침 있는 체언 뒤에 모음 조사가 올 때 소리 나는 대로 이어 적는 방식이다.", answer: "O", explanation: "이어적기는 앞 음절의 종성을 뒷 음절의 초성으로 옮겨서 소리 나는 그대로 표기하는 방법으로, 15세기에 보편적으로 사용되었습니다." },
            { id: 2, text: "'8종성법'은 받침으로 'ㄱ, ㄴ, ㄷ, ㄹ, ㅁ, ㅂ, ㅅ, ㆁ'의 8개 자음만을 사용하던 표기 규정이다.", answer: "O", explanation: "15세기 문헌에서는 대부분의 받침을 이 8개의 자음 중 하나로 표기하는 8종성법을 따랐습니다." },
            { id: 3, text: "'동국정운식 한자음 표기'는 중국 원음에 가깝게 표기하려 한 이상적인 한자음 표기법이었다.", answer: "O", explanation: "당시 우리나라의 현실적인 한자음이 아닌, 중국의 발음에 더 가깝다고 생각되는 이상적인 소리를 표기하고자 한 인위적인 표기법이었습니다." },
            { id: 4, text: "'거듭적기(중철)'는 '님믈'처럼 이어적기에서 끊어적기로 넘어가는 과도기적 표기 방식이다.", answer: "O", explanation: "앞 음절의 받침을 표기하면서 동시에 뒷 음절의 첫소리로도 옮겨 적는 방식으로, 이어적기와 끊어적기의 특징이 모두 나타나는 과도기적 현상입니다." },
            { id: 5, text: "'종성부용초성'은 받침 글자를 새로 만들지 않고 초성 글자를 다시 사용한다는 원칙이다.", answer: "O", explanation: "훈민정음 창제 당시, 받침(종성)은 특별한 글자를 만들 필요 없이 첫소리(초성)에 쓰이는 자음들을 그대로 가져다 쓴다는 원리입니다." },
            { id: 6, text: "'ᄉᆞᄆᆞᆾ다'를 'ᄉᆞᄆᆞᆺ디'로 표기한 것은 8종성법에 따라 'ㅊ' 받침을 'ㅅ'으로 바꾼 것이다.", answer: "O", explanation: "8종성에는 'ㅊ'이 포함되지 않으므로, 'ㅊ' 받침을 8종성에 포함되는 'ㅅ'으로 바꾸어 표기한 것은 8종성법을 지킨 올바른 예시입니다." },
            { id: 7, text: "근대 국어 시기에는 소리 나는 대로 적는 이어적기보다 형태소의 원형을 밝혀 적는 '끊어적기(분철)'가 주로 사용되었다.", answer: "O", explanation: "15세기에는 이어적기가 우세했지만, 근대 국어로 오면서 단어의 원래 형태를 분명히 알 수 있도록 끊어 적는 방식이 보편화되었습니다." },
            { id: 8, text: "'世솅宗조ᇰ'처럼 실제로는 받침이 없는 한자음에 'ㅇ'과 같은 받침을 형식적으로 넣어 표기하는 것을 '형식적 종성 표기'라고 한다.", answer: "O", explanation: "이는 동국정운식 표기의 특징 중 하나로, 한자음의 음절 구조를 중국어처럼 초성-중성-종성으로 맞추기 위해 음가 없는 받침을 넣은 것입니다." },
            { id: 9, text: "현대 국어의 표기법은 발음은 음절의 끝소리 규칙(7종성)을 따르지만, 표기는 단어의 원래 형태를 밝히는 이원화된 방식이다.", answer: "O", explanation: "우리는 '꽃'이라고 원래 형태를 밝혀 적지만(어법), 발음은 [꼳]으로 합니다(소리). 이처럼 표기와 발음의 원리가 다른 이원화된 표기법을 사용합니다." },
            { id: 10, text: "'7종성법'은 근대 국어에서 사용되었으며, 8종성법의 'ㄷ' 받침이 'ㅅ'으로 바뀐 것이 특징이다.", answer: "O", explanation: "근대 국어 시기에는 받침 'ㄷ'과 'ㅅ'의 발음 구분이 모호해지면서 'ㅅ'으로 통일하여 표기하는 7종성법(ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ)이 나타났습니다." },
            { id: 11, text: "중세 국어 표기는 8종성법을 원칙으로 하면서도 이어적기와 끊어적기가 함께 나타나는 특징이 있었다.", answer: "O", explanation: "15세기 문헌은 8종성법과 이어적기가 대세였지만, '듕귁에'처럼 일부 끊어적기 용례도 발견되는 등 여러 표기법이 공존했습니다." },
            { id: 12, text: "표기법의 변천 순서는 '이어적기 → 거듭적기 → 끊어적기' 순으로 진행되었다.", answer: "O", explanation: "소리 중심의 이어적기에서 의미 중심의 끊어적기로 변화하는 과정에서, 두 가지 특징을 모두 가진 거듭적기가 과도기적으로 나타났습니다." },
            { id: 13, text: "훈민정음 창제 당시에는 '곶', '갗'처럼 8종성에 포함되지 않는 'ㅈ, ㅊ' 등도 받침으로 사용할 수 있었다.", answer: "O", explanation: "이는 모든 초성 글자를 받침으로 쓸 수 있다는 '종성부용초성' 원칙에 따른 표기이며, 8종성법이 일반화되기 전의 모습입니다." },
            { id: 14, text: "'옷시[옷이]'는 받침 'ㅅ'을 앞 음절과 뒷 음절에 모두 표기한 거듭적기의 예이다.", answer: "O", explanation: "앞 음절의 형태('옷')를 밝히면서 동시에 뒷 음절에 이어적기('시')도 한 중복된 표기 방식으로, 거듭적기의 특징을 잘 보여줍니다." },
            { id: 15, text: "'中듕國·귁'이라는 표기는 당시의 현실적인 발음이 아닌 이상적인 한자음을 반영한 동국정운식 표기이다.", answer: "O", explanation: "당시 사람들은 '중국'에 가깝게 발음했지만, 중국 원음에 더 가깝다고 여겨지는 '듕귁'이라는 이상적인 소리를 인위적으로 표기한 것입니다." },
            { id: 16, text: "15세기 국어 표기의 원칙은 7종성법이었다.", answer: "X", explanation: "15세기의 받침 표기 원칙은 7종성법이 아니라 'ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅅ,ㆁ'을 사용하는 8종성법이었습니다. 7종성법은 근대 국어 시기에 나타났습니다." },
            { id: 17, text: "'끊어적기(분철)'는 소리 나는 대로 이어서 적는 표기법이다.", answer: "X", explanation: "소리 나는 대로 적는 것은 '이어적기(연철)'입니다. 끊어적기는 '먹어'처럼 의미를 가진 각 부분(형태소)의 원형을 밝혀서 적는 방식입니다." },
            { id: 18, text: "동국정운식 한자음 표기는 당시 사람들의 실제 한자 발음을 그대로 옮겨 적은 것이다.", answer: "X", explanation: "동국정운식 표기는 실제 발음(현실음)이 아닌, 중국 원음에 가깝다고 생각한 인위적이고 이상적인 소리를 표기한 것입니다." },
            { id: 19, text: "'거듭적기(중철)'는 끊어적기가 정착된 이후에 나타난 표기법이다.", answer: "X", explanation: "거듭적기는 이어적기에서 끊어적기로 변화하는 과정 중에 나타난 과도기적 현상이며, 끊어적기보다 앞선 시기에 나타났습니다." },
            { id: 20, text: "'8종성법'은 훈민정음 창제 당시부터 사용된 최초의 받침 표기 원칙이다.", answer: "X", explanation: "훈민정음 창제 당시의 원칙은 모든 초성 글자를 받침으로 쓸 수 있다는 '종성부용초성'이었습니다. 8종성법은 그 이후 15세기에 주로 사용된 규정입니다." },
            { id: 21, text: "'곶'이라고 'ㅈ' 받침을 그대로 쓴 것은 8종성법을 충실히 지킨 예이다.", answer: "X", explanation: "8종성에는 'ㅈ'이 포함되지 않으므로, 8종성법을 따랐다면 '곳'이라고 'ㅅ' 받침으로 표기해야 합니다. 따라서 '곶'은 8종성법을 지키지 않은 예입니다." },
            { id: 22, text: "현대 국어는 받침을 표기할 때 8종성법의 원칙을 따른다.", answer: "X", explanation: "현대 국어는 '부엌, 밖, 낯'처럼 8종성에 없는 'ㅋ, ㄲ, ㅊ' 등 모든 자음을 받침으로 표기하므로, 표기 원칙은 8종성법이 아니라 종성부용초성에 가깝습니다." },
            { id: 23, text: "'사ᄅᆞ미(사람+이)'는 형태소의 원형을 밝혀 적은 끊어적기의 예이다.", answer: "X", explanation: "'사람'의 받침 'ㅁ'이 뒷말의 첫소리로 이어져 '사ᄅᆞ미'로 표기되었으므로, 이는 소리 나는 대로 적은 이어적기의 예입니다." },
            { id: 24, text: "'7종성법'은 'ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅇ'의 7개 자음을 받침으로 사용했다.", answer: "X", explanation: "7종성법의 7개 자음은 'ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ'입니다. 'ㄷ'이 아니라 'ㅅ'을 대표음으로 사용한 것이 8종성법과의 중요한 차이점입니다." },
            { id: 25, text: "표기법은 '끊어적기 → 거듭적기 → 이어적기' 순서로 변천했다.", answer: "X", explanation: "변천 순서가 반대입니다. 소리 중심의 '이어적기'에서 의미 중심의 '끊어적기'로 변화하는 과정에서 과도기적 형태인 '거듭적기'가 나타났습니다." },
            { id: 26, text: "'동국정운식 표기'는 근대 국어 시기에 나타나기 시작했다.", answer: "X", explanation: "동국정운식 표기는 훈민정음 창제 직후인 15세기 초반 문헌에 집중적으로 나타나며, 이후 점차 현실적인 한자음 표기로 바뀌었습니다." },
            { id: 27, text: "'님믈'은 이어적기와 끊어적기 중 이어적기만 두 번 반복한 표기이다.", answer: "X", explanation: "'님믈'은 앞 글자의 받침 'ㅁ'을 표기(끊어적기 요소)하면서, 뒷 글자의 첫소리로도 'ㅁ'을 표기(이어적기 요소)한 거듭적기의 예입니다." },
            { id: 28, text: "'종성부용초성'은 받침으로 8개의 대표음만 사용한다는 원칙이다.", answer: "X", explanation: "받침으로 8개의 대표음만 사용한다는 원칙은 '8종성법'입니다. '종성부용초성'은 모든 초성 글자를 받침으로 쓸 수 있다는 원칙입니다." },
            { id: 29, text: "'듕귁에'와 '달아'는 모두 15세기 문헌에 나타나는 이어적기의 대표적인 예이다.", answer: "X", explanation: "'듕귁에(중국에)'와 '달아(달라)'는 각각의 형태소('듕귁', '에' / '달-', '-아')를 밝혀 적었으므로 이어적기가 아닌 끊어적기의 예입니다." },
            { id: 30, text: "현대 국어에서 음절 끝소리 규칙의 대표음은 'ㄱ,ㄴ,ㄹ,ㅁ,ㅂ,ㅅ,ㅇ'의 7개이다.", answer: "X", explanation: "현대 국어의 음절 끝소리 규칙(발음) 대표음 7개는 'ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅇ'입니다. 'ㅅ'이 아니라 'ㄷ'이 대표음입니다." }
        ];

        // ============================================
        // Stage 3: 객관식 (Multiple Choice)
        // ============================================
        // 설명: 6개 선택지 중 4개를 무작위로 선택하여 출제하는 객관식 문제
        // 형식: { id: 번호, text: "문제", options: ["선택지1", ... "선택지6"], correct: 정답인덱스, explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 지원)
        // - options: 6개의 선택지 배열 (실제 출제 시 4개 무작위 선택)
        // - correct: 정답의 인덱스 (0부터 시작, 즉 0=①, 1=②, 2=③, 3=④, 4=⑤, 5=⑥)
        // - explanation: 정오답 해설 (마크다운 지원, <u>밑줄</u> 가능)

        const STAGE3_QUESTIONS = [
            {
                id: 1,
                text: "다음 <보기>의 표기법에 대한 설명으로 가장 적절한 것은?\n\n말ᄊᆞ미, 사ᄅᆞ미, ᄠᅳ들",
                options: [
                    "형태소의 원형을 밝혀 적는 끊어적기이다.",
                    "소리 나는 대로 이어 적는 이어적기이다.",
                    "이어적기와 끊어적기를 중복한 거듭적기이다.",
                    "7종성법의 원리에 따라 표기되었다.",
                    "동국정운식 한자음 표기의 예시이다.",
                    "근대 국어에서 주로 나타나는 표기 방식이다."
                ],
                correct: 1,
                explanation: "'말씀이', '사람이', '뜻을'이라는 말을 소리 나는 대로 '말ᄊᆞ미, 사ᄅᆞ미, ᄠᅳ들'로 표기한 것은 앞 음절의 받침을 뒷 음절의 첫소리로 넘겨 적는 이어적기(연철)의 전형적인 예입니다."
            },
            {
                id: 2,
                text: "다음 중 15세기의 받침 표기 원칙이었던 '8종성법'에 포함되지 않는 자음은?",
                options: [
                    "ㄱ",
                    "ㄴ",
                    "ㄷ",
                    "ㄹ",
                    "ㅈ",
                    "ㆁ"
                ],
                correct: 4,
                explanation: "15세기의 8종성법은 'ㄱ, ㄴ, ㄷ, ㄹ, ㅁ, ㅂ, ㅅ, ㆁ'의 8개 자음만을 받침으로 사용했습니다. 'ㅈ'은 이 8개에 포함되지 않으므로, 8종성법에 따르면 'ㅅ'으로 바꾸어 표기해야 했습니다."
            },
            {
                id: 3,
                text: "<보기>의 ㉠, ㉡에 들어갈 표기법의 명칭을 바르게 짝지은 것은?\n\n<보기>\n∙ 15세기: 니믈 ( ㉠ )\n∙ 근대 국어(과도기): 님믈\n∙ 근대 국어(정착기): 님을 ( ㉡ )",
                options: [
                    "㉠ 이어적기 / ㉡ 끊어적기",
                    "㉠ 끊어적기 / ㉡ 이어적기",
                    "㉠ 거듭적기 / ㉡ 이어적기",
                    "㉠ 이어적기 / ㉡ 거듭적기",
                    "㉠ 끊어적기 / ㉡ 거듭적기",
                    "㉠ 거듭적기 / ㉡ 끊어적기"
                ],
                correct: 0,
                explanation: "15세기에는 '니믈'처럼 소리 나는 대로 이어 적다가(㉠ 이어적기), 근대 국어로 오면서 '님을'처럼 형태를 밝혀 끊어 적는(㉡ 끊어적기) 방식으로 변화했습니다. '님믈'은 그 중간의 과도기적 형태(거듭적기)입니다."
            },
            {
                id: 4,
                text: "'동국정운식 한자음 표기'의 특징으로 적절하지 않은 것은?",
                options: [
                    "중국 원음에 가까운 이상적인 한자음을 표기했다.",
                    "'中'을 '듕'으로 표기한 것이 그 예이다.",
                    "받침이 없는 한자음에 형식적인 종성을 넣기도 했다.",
                    "'世'를 '솅'으로 표기한 것이 그 예이다.",
                    "15세기 당시 사람들의 현실적인 발음을 그대로 반영했다.",
                    "훈민정음 창제 직후의 문헌에서 주로 발견된다."
                ],
                correct: 4,
                explanation: "동국정운식 표기는 당시 사람들의 현실적인 발음과는 거리가 있는, 중국 원음에 가깝다고 여겨지는 이상적인 소리를 인위적으로 표기한 것입니다. 따라서 현실 발음을 반영했다는 설명은 틀렸습니다."
            },
            {
                id: 5,
                text: "다음 중 받침 표기 규정(종성법)의 역사적 변천 순서가 바르게 된 것은?",
                options: [
                    "8종성법 → 7종성법 → 종성부용초성",
                    "8종성법 → 종성부용초성 → 7종성법",
                    "종성부용초성 → 7종성법 → 8종성법",
                    "종성부용초성 → 8종성법 → 7종성법",
                    "7종성법 → 8종성법 → 종성부용초성",
                    "7종성법 → 종성부용초성 → 8종성법"
                ],
                correct: 3,
                explanation: "훈민정음 창제 당시에는 모든 초성을 받침으로 쓸 수 있다는 '종성부용초성' 원칙이 있었고, 이후 15세기에는 8개의 자음만 쓰는 '8종성법'이 일반화되었으며, 근대 국어 시기에는 'ㄷ'이 'ㅅ'으로 바뀐 '7종성법'이 나타났습니다."
            },
            {
                id: 6,
                text: "<보기>의 표기법이 나타나는 시기에 대한 설명으로 가장 적절한 것은?\n\n옷시 [옷이], 먹글 [먹을], 놉피 [높이]",
                options: [
                    "훈민정음 창제 직후에 나타났다.",
                    "15세기 중반에 가장 널리 쓰였다.",
                    "이어적기에서 끊어적기로 넘어가는 과도기에 나타났다.",
                    "끊어적기가 완전히 정착된 현대 국어의 표기법이다.",
                    "동국정운식 표기가 성행하던 시기에 나타났다.",
                    "표기법의 변천 과정 중 가장 마지막 단계에 해당한다."
                ],
                correct: 2,
                explanation: "'옷시', '먹글'처럼 받침을 앞 음절과 뒷 음절에 모두 표기하는 거듭적기(중철)는, 소리 중심의 이어적기에서 의미 중심의 끊어적기로 표기법이 변화하던 과도기적 시기(근대 국어)에 나타난 현상입니다."
            },
            {
                id: 7,
                text: "다음 중 '8종성법'을 지키지 않은 표기는?",
                options: [
                    "ᄉᆞᄆᆞᆺ디",
                    "곶",
                    "몯",
                    "밥",
                    "손",
                    "강"
                ],
                correct: 1,
                explanation: "8종성법은 'ㄱ,ㄴ,ㄷ,ㄹ,ㅁ,ㅂ,ㅅ,ㆁ' 8개 자음만 받침으로 사용합니다. '곶'의 받침 'ㅈ'은 이 8개에 포함되지 않으므로, 8종성법을 지키지 않은 표기입니다. 8종성법을 따랐다면 '곳'으로 표기해야 합니다."
            },
            {
                id: 8,
                text: "현대 국어의 표기 원리(이원화 표기)에 대한 설명으로 옳은 것은?",
                options: [
                    "표기와 발음 모두 7종성법을 따른다.",
                    "표기는 8종성법을, 발음은 7종성법을 따른다.",
                    "표기는 어법에 맞도록, 발음은 소리 나는 대로 한다.",
                    "표기와 발음 모두 소리 나는 대로 적는다.",
                    "표기는 소리 나는 대로, 발음은 어법에 맞도록 한다.",
                    "표기와 발음 모두 종성부용초성의 원리를 따른다."
                ],
                correct: 2,
                explanation: "현대 국어는 '꽃'처럼 단어의 원래 형태(어법)를 밝혀 표기하고, 발음은 [꼳]처럼 대표음으로 소리 내는 원리를 따릅니다. 이를 이원화 표기라고 합니다."
            },
            {
                id: 9,
                text: "밑줄 친 한자어 표기가 나머지와 이질적인 하나는?",
                options: [
                    "<u>中</u>듕<u>國</u>귁",
                    "<u>訓</u>훈<u>民</u>민<u>正</u>졍<u>音</u>ᅙᅳᆷ",
                    "<u>孔</u>공<u>子</u>ᄌᆡ",
                    "<u>世</u>솅<u>宗</u>조ᇰ",
                    "<u>御</u>엉<u>製</u>졩",
                    "<u>文</u>문<u>字</u>ᄍᆞᆼ"
                ],
                correct: 2,
                explanation: "①, ②, ④, ⑤, ⑥은 모두 중국 원음을 표방하거나 형식적 종성을 사용한 동국정운식 한자음 표기입니다. 반면 ③ '孔공子ᄌᆡ'는 동국정운식 표기에서 벗어나 당시의 현실적인 한자음으로 표기한 예입니다."
            },
            {
                id: 10,
                text: "<보기>에 대한 설명으로 적절하지 않은 것은?\n\n(가) ᄠᅳ들 (끊어적기: ᄠᅳᆮ을)\n(나) 님을 (이어적기: 니믈)",
                options: [
                    "(가)는 소리 나는 대로 적은 것이다.",
                    "(나)는 형태소의 원형을 밝혀 적은 것이다.",
                    "(가)는 15세기에, (나)는 근대 국어에 주로 쓰인 표기법이다.",
                    "(가)에서 (나)로 변화하는 중간에 '님믈'과 같은 형태가 나타났다.",
                    "표기법의 변천 과정은 (가) → (나)의 방향으로 진행되었다.",
                    "(가)는 형태 정보를, (나)는 음운 정보를 파악하기에 더 용이하다."
                ],
                correct: 5,
                explanation: "(가) 'ᄠᅳ들'은 소리 나는 대로 적은 이어적기이며, (나) '님을'은 형태를 밝혀 적은 끊어적기입니다. 따라서 소리 정보를 파악하기 용이한 것은 (가)이고, '님'과 '을'이라는 형태 정보를 파악하기 용이한 것은 (나)입니다. 설명이 반대로 되었습니다."
            }
        ];

        // 타이머 관련 변수
        let timerInterval;
        let currentTime = 300; // 5분 (300초)
        const maxTime = 300;

        // 현재 학습 상태
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let startTime;
        let answeredQuestions = new Set();

        // 셔플된 문제 배열 (Stage 2 & 3용)
        let shuffledStage2Questions = [];
        let shuffledStage3Questions = [];

        // Fisher-Yates 셔플 알고리즘
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 모달 드래그 설정 (한 번만 실행)
        function setupModalDrag() {
            if (dragListenersAdded) return;
            
            const modal = document.getElementById('modal-content');

            modal.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            modal.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
            
            dragListenersAdded = true;
        }

        function startDrag(e) {
            const modal = document.getElementById('modal-content');
            if (e.target.closest('.option-button')) return;

            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchstart') {
                e.preventDefault();
            }

            isDragging = true;
            modal.classList.add('dragging');

            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;

            const rect = modal.getBoundingClientRect();
            modalStartX = rect.left;
            modalStartY = rect.top;
        }

        function drag(e) {
            if (!isDragging) return;
            
            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchmove') {
                e.preventDefault();
            }

            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;

            const modal = document.getElementById('modal-content');
            modal.style.left = (modalStartX + deltaX) + 'px';
            modal.style.top = (modalStartY + deltaY) + 'px';
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            document.getElementById('modal-content').classList.remove('dragging');
        }

        // 타이머 시작
        function startTimer() {
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerBar();

                if (currentTime <= 0) {
                    endStage();
                }
            }, 1000);
        }

        // 타이머 바 업데이트
        function updateTimerBar() {
            const percentage = (currentTime / maxTime) * 100;
            document.getElementById('timer-bar').style.width = percentage + '%';
        }

        // 시간 더하기/빼기
        function addTime(seconds) {
            currentTime = Math.min(currentTime + seconds, maxTime);
            updateTimerBar();
        }

        function subtractTime(seconds) {
            currentTime = Math.max(currentTime - seconds, 0);
            updateTimerBar();
        }

        // Markdown to HTML 변환
        function convertMarkdownToHTML(text) {
            // 테이블 처리
            let html = text.replace(/\|(.+)\|/g, (match) => {
                const cells = match.split('|').filter(c => c.trim());
                const isHeader = text.indexOf(match) !== -1 && text.split(match)[1].indexOf('|---') !== -1;
                const tag = isHeader ? 'th' : 'td';
                return '<tr>' + cells.map(cell => `<${tag}>${cell.trim()}</${tag}>`).join('') + '</tr>';
            });

            // 테이블 구조 감싸기
            html = html.replace(/(<tr>.*<\/tr>\n)+/g, (match) => {
                return '<table>' + match + '</table>';
            });

            // 헤딩 변환
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // 볼드 변환
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // 밑줄 변환 (<u> 태그 지원)
            html = html.replace(/<u>(.+?)<\/u>/g, '<u>$1</u>');

            // 리스트 변환
            html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                return '<ul>' + match + '</ul>';
            });

            // 줄바꿈 변환
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Stage 1: 딥리서치 - 2-choice 질문이 있는 HTML 생성
        // ============================================
        // Stage 1 학습 콘텐츠 생성 함수
        // ============================================
        // 설명: Stage 1에서 표시할 학습 콘텐츠를 생성합니다.
        // rawContent 내에서 <span class="highlight" data-question-id="번호">__________</span> 형식으로
        // STAGE1_QUESTIONS의 문제가 하이라이트로 표시됩니다.
        // - data-question-id: STAGE1_QUESTIONS 배열의 id와 일치해야 함
        // - 마크다운 문법 지원 (## 제목, **볼드**, 리스트 등)

        function generateStage1Content() {
            // ============================================
            // rawContent: Stage 1에 표시할 학습 콘텐츠
            // ============================================
            // 마크다운 문법 지원: ### 제목, **볼드**, <ul><li> 리스트, <table> 테이블 등
            // 하이라이트 문제 삽입: <span class="highlight" data-question-id="번호">__________</span>
            // - data-question-id는 STAGE1_QUESTIONS의 id와 반드시 일치해야 함
            // - context 속성은 어느 위치에서 하이라이트가 나타날지 결정함

            const rawContent = `### <strong>중세 국어의 이해: 선택하며 학습하기 (표기편)</strong>

<strong>❹ 표기</strong>

<strong>중세 국어 표기의 특징</strong>
<ul>
<li>받침 표기는 <span class="highlight" data-question-id="1">__________</span> 이 원칙</li>
<li><span class="highlight" data-question-id="2">__________</span> 병존</li>
<li><span class="highlight" data-question-id="3">__________</span></li>
<li><span class="highlight" data-question-id="4">__________</span> → <span class="highlight" data-question-id="5">__________</span></li>
</ul>

<strong>종성법</strong>

<strong>종성부용초성</strong>
<ul>
<li>뜻: 종성은 <span class="highlight" data-question-id="6">__________</span></li>
<li>활용: <span class="highlight" data-question-id="7">__________</span> 사용</li>
<li>ㄱ,ㅋ,ㆁ,ㄴ,ㄷ,ㅌ,ㄹ,ㅁ,ㅂ,ㅍ,ㅅ,ㅈ,ㅊ,ㅿ,ㅇ,ㆆ,ㅎ</li>
<li>예) 곶 [꽃], 갗 [가죽]</li>
</ul>

<strong>8종성법</strong>
<ul>
<li>뜻: 받침으로 대표음 <span class="highlight" data-question-id="8">__________</span></li>
<li>활용: <span class="highlight" data-question-id="9">__________</span></li>
<li><span class="highlight" data-question-id="10">__________</span> 사용</li>
<li>참고)
    <ul style="margin-left: 20px;">
    <li>8종성법을 <span class="highlight" data-question-id="11">__________</span> 'ᄉᆞᄆᆞᆺ디'<br/>'ᄉᆞᄆᆞᆾ디(ㅊ)'를 'ᄉᆞᄆᆞᆺ디(ㅅ)'로 표기했으므로</li>
    <li>8종성법을 <span class="highlight" data-question-id="12">__________</span> '곶'<br/>'곶(ㅈ)'을 '곳(ㅅ)'으로 표기하지 않았으므로</li>
    </ul>
</li>
</ul>

<strong>7종성법</strong>
<ul>
<li>뜻: 받침으로 대표음 <span class="highlight" data-question-id="13">__________</span></li>
<li>활용: <span class="highlight" data-question-id="14">__________</span></li>
<li><span class="highlight" data-question-id="15">__________</span> ('ㄷ'이 아니라 'ㅅ' 종성)</li>
<li>예) 벋 > 벗, 붇 > 붓, ᄠᅳᆮ > 뜻</li>
</ul>

<strong>이원화 표기</strong>
<ul>
<li>뜻: 소리대로 적되, <span class="highlight" data-question-id="16">__________</span></li>
<li>발음은 소리대로 <span class="highlight" data-question-id="17">__________</span> (음절의 끝소리 적용)으로, 표기는 종성부용초성에 따라 형태 밝힘</li>
<li>활용: <span class="highlight" data-question-id="18">__________</span></li>
<li><span class="highlight" data-question-id="19">__________</span> ('ㅅ'이 아니라 'ㄷ'종성)</li>
<li>예) 꽃이, 꽃만, 꽃도, 찾다</li>
</ul>

<strong>표기법의 종류</strong>

<strong>이어적기(연철)</strong>
<ul>
<li>뜻: 글자를 표기할 때 <span class="highlight" data-question-id="20">__________</span></li>
<li>활용: <span class="highlight" data-question-id="21">__________</span> 이어적기가 일반적</li>
<li>예) 말ᄊᆞ미, 사ᄅᆞ미, 니믈, ᄠᅳ들</li>
</ul>

<strong>끊어적기(분철)</strong>
<ul>
<li>뜻: <span class="highlight" data-question-id="22">__________</span></li>
<li>활용: <span class="highlight" data-question-id="23">__________</span> 주로 끊어 적음, 15세기에도 끊어적기는 있었음.</li>
<li>예) ᄀᆞᆯᄋᆞ샤ᄃ, 얼굴이며, ᄆᆞᄎᆞᆷ이니라, 님을(근대 국어)</li>
</ul>

<strong>거듭적기(중철)</strong>
<ul>
<li>뜻: <span class="highlight" data-question-id="24">__________</span></li>
<li>활용: 이어적기와 끊어적기의 <span class="highlight" data-question-id="25">__________</span> 으로 근대 국어에 나타남</li>
<li>예) 옷시 [옷이], 먹글 [먹을], 놉피 [높이], 님믈 [님을]</li>
</ul>

<strong>표기법의 변천</strong>
<ul>
<li><span class="highlight" data-question-id="26">__________</span></li>
<li>예) 니믈 > 님믈 > 님을</li>
</ul>

<strong>동국정운식 한자음 표기</strong>

<ul>
<li>뜻: <span class="highlight" data-question-id="27">__________</span> 이나 형식적 종성을 적는 표기</li>
</ul>

<strong>활용</strong>

<strong>이상적 한자음</strong>
<ul>
<li>中<span class="highlight" data-question-id="28">__________</span> [중국], 訓·훈民민正·졍音<span class="highlight" data-question-id="29">__________</span> [훈민정음]</li>
</ul>

<strong>형식적 종성 표기</strong>
<ul>
<li>世<span class="highlight" data-question-id="30">__________</span>宗조ᇰ御<span class="highlight" data-question-id="31">__________</span>製<span class="highlight" data-question-id="32">__________</span>[세종어제], 文문字<span class="highlight" data-question-id="33">__________</span>[문자]</li>
</ul>

<strong>변천</strong>
<ul>
<li>점차 <span class="highlight" data-question-id="34">__________</span> 에 맞게 표기</li>
<li>예) 孔<span class="highlight" data-question-id="35">__________</span>[공자가], 曾증子ᄌᆞ [증자]</li>
</ul>
`;

            return rawContent;
        }

        // Stage 1: 딥리서치 초기화
        function initStage1() {
            currentStage = 1;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            answeredQuestions.clear();
            currentTime = 300;
            startTime = Date.now();

            // UI 업데이트
            document.querySelector('.title').textContent = '중세 국어 표기 파트';
            document.getElementById('stage-subtitle').textContent = '1단계: 딥리서치';
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();
            document.getElementById('total-questions').textContent = STAGE1_QUESTIONS.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('active');
            });

            // 지문 표시
            const passageHTML = generateStage1Content();
            document.getElementById('passage-container').innerHTML = passageHTML;

            // 하이라이트 클릭 이벤트 추가
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(highlight => {
                highlight.addEventListener('click', function() {
                    const questionId = parseInt(this.getAttribute('data-question-id'));
                    if (!answeredQuestions.has(questionId)) {
                        showQuestion(questionId, this);
                    }
                });
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            startTimer();
        }

        // 질문 모달 표시
        function showQuestion(questionId, highlightElement) {
            const question = STAGE1_QUESTIONS.find(q => q.id === questionId);
            if (!question) return;

            const modalOverlay = document.getElementById('modal-overlay');
            const modalHeader = document.getElementById('modal-header');
            const modalOptions = document.getElementById('modal-options');
            const modalContent = document.getElementById('modal-content');

            // 모달 초기화
            modalContent.classList.remove('correct-feedback', 'incorrect-feedback');

            // 질문 헤더
            modalHeader.textContent = question.context;

            // 선지 셔플
            const options = shuffleArray([
                { text: question.correctAnswer, isCorrect: true },
                { text: question.wrongAnswer, isCorrect: false }
            ]);

            // 선지 버튼 생성
            modalOptions.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => checkAnswer(questionId, option.isCorrect, button, highlightElement);
                modalOptions.appendChild(button);
            });

            // 모달 표시
            modalOverlay.classList.add('active');

            // 모달 위치 설정 (하이라이트 근처에 배치하되 화면 밖으로 나가지 않도록)
            const highlightRect = highlightElement.getBoundingClientRect();
            const modalWidth = 500; // max-width
            const modalHeight = 300; // 대략적인 높이

            // 하이라이트 오른쪽에 배치 시도
            let left = highlightRect.right + 20;
            let top = highlightRect.top;

            // 오른쪽 공간이 부족하면 왼쪽에 배치
            if (left + modalWidth > window.innerWidth) {
                left = highlightRect.left - modalWidth - 20;
            }

            // 왼쪽도 공간이 부족하면 중앙에 배치
            if (left < 0) {
                left = (window.innerWidth - modalWidth) / 2;
            }

            // 위쪽으로 벗어나지 않도록
            if (top < 20) {
                top = 20;
            }

            // 아래쪽으로 벗어나지 않도록
            if (top + modalHeight > window.innerHeight) {
                top = window.innerHeight - modalHeight - 20;
            }

            modalContent.style.left = left + 'px';
            modalContent.style.top = top + 'px';

            // 모달 드래그 설정 (한 번만 실행)
            setupModalDrag();
        }

        // 답변 체크
        function checkAnswer(questionId, isCorrect, button, highlightElement) {
            const buttons = document.querySelectorAll('.option-button');
            const modalContent = document.getElementById('modal-content');

            // 버튼 비활성화
            buttons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.classList.add('correct');
                modalContent.classList.add('correct-feedback');
                highlightElement.classList.add('correct', 'answered');
                highlightElement.textContent = button.textContent;
                correctCount++;
                addTime(10);
            } else {
                button.classList.add('incorrect');
                modalContent.classList.add('incorrect-feedback');
                highlightElement.classList.add('incorrect', 'answered');

                // 정답 표시
                const correctButton = Array.from(buttons).find(btn => !btn.classList.contains('incorrect'));
                if (correctButton) {
                    correctButton.classList.add('correct');
                    highlightElement.textContent = correctButton.textContent;
                }

                wrongCount++;
                subtractTime(40);
            }

            // 답변한 질문 추가
            answeredQuestions.add(questionId);
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();

            // 모달 닫기
            setTimeout(() => {
                document.getElementById('modal-overlay').classList.remove('active');

                // 모든 질문 완료 확인
                if (answeredQuestions.size === STAGE1_QUESTIONS.length) {
                    setTimeout(() => endStage(), 500);
                }
            }, 1500);
        }

        // Stage 2: OX 학습 초기화
        function initStage2() {
            clearInterval(timerInterval);

            currentStage = 2;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage2WrongQuestions = [];

            // OX 문제 셔플 (매번 새로운 순서로)
            shuffledStage2Questions = shuffleArray(STAGE2_QUESTIONS);

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '2단계: OX 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage2Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('completed');
                if (index === 1) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showOXQuestion();
            startTimer();
        }

        // OX 문제 표시
        function showOXQuestion() {
            const question = shuffledStage2Questions[currentQuestionIndex];

            document.getElementById('passage-container').innerHTML = `
                <div class="ox-container">
                    <div class="ox-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage2Questions.length}</div>
                        <div class="question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="ox-options">
                            <button class="ox-option-button" onclick="checkOXAnswer('O')">O</button>
                            <button class="ox-option-button" onclick="checkOXAnswer('X')">X</button>
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="ox-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // OX 답변 체크
        function checkOXAnswer(answer) {
            const question = shuffledStage2Questions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.ox-option-button');
            const isCorrect = answer === question.answer;

            buttons.forEach(button => {
                button.disabled = true;
                if (button.textContent === answer) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(15);

                // 틀린 문제 저장
                stage2WrongQuestions.push({
                    question: question.text,
                    userAnswer: answer,
                    correctAnswer: question.answer,
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('ox-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage2Questions.length) {
                    endStage();
                } else {
                    showOXQuestion();
                }
            }, 2000);
        }

        // Stage 3: 객관식 학습 초기화
        function initStage3() {
            clearInterval(timerInterval);

            currentStage = 3;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage3WrongQuestions = [];

            // 객관식 문제 셔플 (매번 새로운 순서로)
            shuffledStage3Questions = shuffleArray(STAGE3_QUESTIONS);

            // 각 문제에 대해 4지선다 미리 생성
            shuffledStage3Questions.forEach(q => {
                q.selectedOptions = generate4Options(q.options, q.correct);
            });

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '3단계: 객관식 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage3Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < 2) dot.classList.add('completed');
                if (index === 2) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showMCQQuestion();
            startTimer();
        }

        // 6지선다에서 4지선다 생성 (정답 포함)
        function generate4Options(allOptions, correctIndex) {
            const correctOption = allOptions[correctIndex];
            const otherOptions = allOptions.filter((_, i) => i !== correctIndex);

            // 오답 중에서 3개 랜덤 선택
            const shuffledOthers = shuffleArray(otherOptions);
            const selected3Others = shuffledOthers.slice(0, 3);

            // 정답과 3개 오답을 합쳐서 셔플
            const final4Options = shuffleArray([correctOption, ...selected3Others]);

            // 새로운 정답 인덱스 찾기
            const newCorrectIndex = final4Options.indexOf(correctOption);

            return {
                options: final4Options,
                correctIndex: newCorrectIndex
            };
        }

        // 객관식 문제 표시
        function showMCQQuestion() {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;

            const optionsHTML = options.map((opt, index) => `
                <button class="mcq-option-button" onclick="checkMCQAnswer(${index})">
                    <span class="option-number">${index + 1}</span>
                    <span class="option-text">${convertMarkdownToHTML(opt)}</span>
                </button>
            `).join('');

            document.getElementById('passage-container').innerHTML = `
                <div class="mcq-container">
                    <div class="mcq-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage3Questions.length}</div>
                        <div class="mcq-question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="mcq-options">
                            ${optionsHTML}
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="mcq-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // 객관식 답변 체크
        function checkMCQAnswer(selectedIndex) {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;
            const buttons = document.querySelectorAll('.mcq-option-button');
            const isCorrect = selectedIndex === correctIndex;

            buttons.forEach((button, index) => {
                button.disabled = true;
                if (index === selectedIndex) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (index === correctIndex && !isCorrect) {
                    button.classList.add('correct');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(20);

                // 틀린 문제 저장
                stage3WrongQuestions.push({
                    question: question.text,
                    userAnswer: options[selectedIndex],
                    correctAnswer: options[correctIndex],
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('mcq-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage3Questions.length) {
                    endStage();
                } else {
                    showMCQQuestion();
                }
            }, 2000);
        }

        // 단계 종료
        function endStage() {
            clearInterval(timerInterval);

            const endTime = Date.now();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;

            let totalQuestions = 0;
            if (currentStage === 1) {
                totalQuestions = STAGE1_QUESTIONS.length;
            } else if (currentStage === 2) {
                totalQuestions = shuffledStage2Questions.length;
            } else if (currentStage === 3) {
                totalQuestions = shuffledStage3Questions.length;
            }

            const accuracy = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 100;
            const score = (accuracy / 100) * 10; // 10점 만점으로 환산

            // 결과 저장 (레거시)
            allStageResults[`stage${currentStage}`] = {
                totalQuestions,
                correctCount,
                wrongCount,
                accuracy,
                totalTime
            };

            // 새로운 stageResults에 저장 (틀린 문제 포함)
            const wrongQuestionsArray = currentStage === 2 ? stage2WrongQuestions :
                                       currentStage === 3 ? stage3WrongQuestions : [];

            stageResults[`stage${currentStage}`] = {
                correct: correctCount,
                wrong: wrongCount,
                score: score,
                elapsedTime: totalTime,
                wrongQuestions: wrongQuestionsArray
            };

            // 결과 화면 표시
            document.getElementById('result-title').textContent = `${currentStage}단계 학습 완료!`;
            document.getElementById('progress-stat').textContent = '100%';
            document.getElementById('accuracy-stat').textContent = accuracy + '%';
            document.getElementById('correct-stat').textContent = correctCount;
            document.getElementById('wrong-stat').textContent = wrongCount;
            document.getElementById('time-stat').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // 버튼 업데이트
            const resultButtons = document.querySelector('.result-buttons');
            let buttonsHTML = '<button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>';

            // Stage 2와 Stage 3의 경우 틀린 문제 보기 버튼 추가
            if (currentStage === 2 && stage2WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage2()">틀린 문제 보기 (${stage2WrongQuestions.length}문제)</button>`;
            } else if (currentStage === 3 && stage3WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage3()">틀린 문제 보기 (${stage3WrongQuestions.length}문제)</button>`;
            }

            // 다음 단계 버튼 (Stage 3이면 "전체 결과 보기")
            if (currentStage === 3) {
                buttonsHTML += '<button class="result-button primary" onclick="showFinalResults()">전체 결과 보기</button>';
            } else {
                buttonsHTML += '<button class="result-button primary" onclick="nextStage()">다음 단계로</button>';
            }

            resultButtons.innerHTML = buttonsHTML;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('result-screen').classList.add('active');
        }

        // 다시 학습하기
        function restartStage() {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('result-screen').classList.remove('active');

            if (currentStage === 1) {
                initStage1();
            } else if (currentStage === 2) {
                initStage2();
            } else if (currentStage === 3) {
                initStage3();
            }
        }

        // 다음 단계로
        function nextStage() {
            document.getElementById('main-content').style.display = 'block';

            if (currentStage === 1) {
                initStage2();
            } else if (currentStage === 2) {
                initStage3();
            } else if (currentStage === 3) {
                // 모든 단계 완료
                alert('모든 학습을 완료했습니다!');
                initStage1();
            }
        }

        // Stage 2 틀린 문제 보기
        function showWrongQuestionsStage2() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage2')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage2" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>2단계: OX - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage2()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage2"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage2');
            content.innerHTML = stage2WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage2').classList.add('active');
        }

        // Stage 2 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage2() {
            document.getElementById('wrong-questions-modal-stage2').classList.remove('active');
        }

        // Stage 3 틀린 문제 보기
        function showWrongQuestionsStage3() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage3')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage3" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>3단계: 객관식 - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage3()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage3"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage3');
            content.innerHTML = stage3WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage3').classList.add('active');
        }

        // Stage 3 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage3() {
            document.getElementById('wrong-questions-modal-stage3').classList.remove('active');
        }

        // 시간 포맷팅 함수
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 전체 결과 보기
        function showFinalResults() {
            // 기존 타이머 정리
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // 결과 화면과 메인 컨텐츠 숨기기
            document.getElementById('result-screen').classList.remove('active');

            // 전체 결과 계산
            const totalCorrect = stageResults.stage1.correct + stageResults.stage2.correct + stageResults.stage3.correct;
            const totalWrong = stageResults.stage1.wrong + stageResults.stage2.wrong + stageResults.stage3.wrong;
            const overallAccuracy = (totalCorrect + totalWrong) > 0 ?
                                   Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;
            const totalScore = stageResults.stage1.score + stageResults.stage2.score + stageResults.stage3.score;
            const totalElapsedTime = stageResults.stage1.elapsedTime + stageResults.stage2.elapsedTime + stageResults.stage3.elapsedTime;

            // 스테이지명 맵핑
            const stageNames = {
                stage1: '1단계: 딥리서치',
                stage2: '2단계: OX 학습',
                stage3: '3단계: 객관식 학습'
            };

            // HTML 생성
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">🎉 학습 완료!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">모든 학습 단계를 완료했습니다.</p>
                    </div>

                    <!-- 전체 학습 결과 -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">📊 전체 학습 결과</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총점</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}점</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #7f8c8d;">/ 30.0점</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">전체 정답률</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">정답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">오답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총 소요 시간</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${formatTime(totalElapsedTime)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 단계별 결과 -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">📈 단계별 학습 결과</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // 각 단계별 결과 카드
            ['stage1', 'stage2', 'stage3'].forEach(stageKey => {
                const result = stageResults[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey]}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답률:</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답:</span>
                                <strong>${result.correct}개</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">오답:</span>
                                <strong style="color: #e74c3c;">${result.wrong}회</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">점수:</span>
                                <strong style="color: #3498db;">${result.score.toFixed(1)}점</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">소요 시간:</span>
                                <strong>${formatTime(result.elapsedTime)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
        </div>

        <!-- 틀린 문제 상세 정보 -->
        <h2 style="margin-top: 50px; margin-bottom: 25px; color: #2c3e50; font-size: 24px; font-weight: 600;">❌ 틀린 문제 상세</h2>
`;

            // Stage 2와 Stage 3의 틀린 문제 표시
            let hasWrongQuestions = false;

            // Stage 2 틀린 문제
            if (stageResults.stage2.wrongQuestions && stageResults.stage2.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #856404; margin-bottom: 20px; font-size: 20px;">📝 2단계: OX - 틀린 문제</h3>
`;
                stageResults.stage2.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // Stage 3 틀린 문제
            if (stageResults.stage3.wrongQuestions && stageResults.stage3.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #721c24; margin-bottom: 20px; font-size: 20px;">🔤 3단계: 객관식 - 틀린 문제</h3>
`;
                stageResults.stage3.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // 틀린 문제가 없는 경우
            if (!hasWrongQuestions) {
                html += `
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 12px; padding: 25px; text-align: center;">
            <p style="color: #155724; font-size: 18px; font-weight: 600;">🎉 완벽합니다! 모든 문제를 맞추셨습니다!</p>
        </div>
`;
            }

            html += `
        <!-- 액션 버튼 -->
        <div style="text-align: center; margin-top: 50px; padding-bottom: 50px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveFinalResultsAsImage()" style="
                background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 211, 153, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 211, 153, 0.4)';">
                📷 이미지로 저장
            </button>
            <button onclick="location.reload()" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.4)';">
                🔄 처음부터 다시하기
            </button>
        </div>
    </div>
`;

            // HTML 설정 및 표시
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('main-content').style.display = 'block';
        }

        // 최종 결과 페이지 이미지 저장
        function saveFinalResultsAsImage() {
            if (typeof htmlToImage === 'undefined') {
                alert('이미지 라이브러리가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const mainContent = document.getElementById('main-content');

            // 저장 버튼들 임시 숨김
            const buttons = mainContent.querySelectorAll('button');
            const buttonStates = Array.from(buttons).map(btn => btn.style.display);
            buttons.forEach(btn => btn.style.display = 'none');

            // 약간의 딜레이 후 캡처
            setTimeout(() => {
                htmlToImage.toBlob(mainContent, {
                    backgroundColor: '#f5f7fa',
                    pixelRatio: 2,
                    cacheBust: true
                }).then(blob => {
                    // 버튼 다시 표시
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);

                    // 이미지 다운로드
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `중세국어_표기_최종결과_${timestamp}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }).catch(err => {
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);
                    console.error('이미지 저장 실패:', err);
                    alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
                });
            }, 100);
        }

        // 페이지 로드 시 모달 드래그 설정 초기화
        window.onload = function() {
            // 모달 드래그 설정을 페이지 로드 시 한 번만 실행
            setupModalDrag();
            initStage1();
        };
    </script>

    <!-- 학습 완료 시스템 -->
    <script src="../js/config.js"></script>
    <script src="../js/learning-complete.js"></script>
</body>
</html>