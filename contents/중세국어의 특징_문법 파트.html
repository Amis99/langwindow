<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중세국어의 특징 - 문법 파트</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stage-indicator {
            display: flex;
            gap: 10px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .stage-dot.active {
            background: #3498db;
            transform: scale(1.3);
        }

        .stage-dot.completed {
            background: #27ae60;
        }

        .question-counter {
            font-size: 18px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Timer Bar */
        .timer-container {
            width: 300px;
            height: 24px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .timer-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* Main Content */
        .main-content {
            margin-top: 100px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
            position: relative;
        }

        .passage-container {
            font-size: 18px;
            line-height: 2;
            color: #2c3e50;
            word-break: keep-all;
        }

        .passage-container h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .passage-container h3 {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .passage-container strong {
            font-weight: 700;
            color: #2c3e50;
        }

        .passage-container ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .passage-container li {
            margin: 8px 0;
            line-height: 1.8;
        }

        .passage-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .passage-container table th,
        .passage-container table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .passage-container table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* Highlight Style */
        .highlight {
            background: linear-gradient(120deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline;
            position: relative;
        }

        .highlight:hover {
            background: linear-gradient(120deg, #fdcb6e 0%, #fab1a0 100%);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(253, 203, 110, 0.5);
        }

        .highlight.answered {
            background: linear-gradient(120deg, #dfe6e9 0%, #b2bec3 100%);
            cursor: default;
        }

        .highlight.answered:hover {
            transform: none;
            box-shadow: none;
        }

        .highlight.correct {
            background: linear-gradient(120deg, #55efc4 0%, #00b894 100%);
        }

        .highlight.incorrect {
            background: linear-gradient(120deg, #fab1a0 0%, #ff7675 100%);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: fixed;
            cursor: move;
            transition: opacity 0.3s ease;
        }

        .modal-content.dragging {
            opacity: 0.95;
            user-select: none;
        }

        .modal-content.correct-feedback {
            border: 3px solid #00b894;
            animation: correctPulse 0.6s ease;
        }

        .modal-content.incorrect-feedback {
            border: 3px solid #ff7675;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 184, 148, 0.6); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-button {
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: 'Noto Serif KR', serif;
        }

        .option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Result Screen */
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 100px;
        }

        .result-screen.active {
            display: block;
        }

        body:has(.result-screen.active) .timer-container {
            display: none !important;
        }

        .result-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-button.primary {
            background: #3498db;
            color: white;
        }

        .result-button.primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .result-button.secondary {
            background: #95a5a6;
            color: white;
        }

        .result-button.secondary:hover {
            background: #7f8c8d;
        }

        /* OX Learning Styles (Stage 2) */
        .ox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .ox-question-card {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .question-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .ox-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .ox-option-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ox-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: scale(1.05);
        }

        .ox-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .ox-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .ox-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Multiple Choice Styles (Stage 3) */
        .mcq-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .mcq-question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .mcq-question-text {
            font-size: 20px;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mcq-option-button {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mcq-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .mcq-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .mcq-option-button .option-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            flex-shrink: 0;
        }

        .mcq-option-button .option-text {
            flex: 1;
            color: #2c3e50;
        }

        .mcq-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
        }

        .mcq-option-button.correct .option-number {
            background: #27ae60;
        }

        .mcq-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .mcq-option-button.incorrect .option-number {
            background: #f44336;
        }

        /* Feedback Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Wrong Questions Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: fixed;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 10px 0;
        }

        .wrong-question-item {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .wrong-question-item h4 {
            color: #dc3545;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .wrong-question-item p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .wrong-question-item .question-text {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .wrong-question-item .user-answer {
            color: #dc3545;
            background: #fff5f5;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .wrong-question-item .correct-answer {
            color: #28a745;
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .explanation-text {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 16px;
            color: #856404;
            text-align: center;
            line-height: 1.6;
        }

        .question-explanation {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            color: #856404;
            margin-top: 10px;
        }

        .question-explanation strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .title {
                font-size: 20px;
            }

            .subtitle {
                font-size: 12px;
            }

            .progress-info {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .question-counter {
                font-size: 14px;
            }

            .timer-container {
                width: 200px;
                height: 18px;
            }

            .stage-dot {
                width: 10px;
                height: 10px;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            .option-button {
                padding: 12px 15px;
                font-size: 14px;
            }

            .ox-question-card {
                padding: 20px;
            }

            .question-text {
                font-size: 18px;
                margin-bottom: 20px;
            }

            .ox-option-button {
                padding: 20px 15px;
                font-size: 24px;
            }

            .mcq-question-card {
                padding: 20px;
            }

            .mcq-question-text {
                font-size: 16px;
                line-height: 1.6;
            }

            .mcq-option-button {
                padding: 12px 15px;
                font-size: 14px;
                gap: 12px;
            }

            .mcq-option-button .option-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        /* Mobile Phone Size */
        @media (max-width: 480px) {
            .header {
                padding: 10px;
                gap: 8px;
            }

            .header-left {
                gap: 3px;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
            }

            .subtitle {
                font-size: 11px;
            }

            .progress-info {
                gap: 8px;
            }

            .question-counter {
                font-size: 12px;
                font-weight: 400;
            }

            .timer-container {
                width: 150px;
                height: 14px;
            }

            .stage-indicator {
                gap: 6px;
            }

            .stage-dot {
                width: 8px;
                height: 8px;
            }

            .stage-dot.active {
                transform: scale(1.2);
            }

            .main-content {
                margin-top: 80px;
                padding: 20px;
            }

            .passage-container {
                font-size: 16px;
                line-height: 1.8;
            }
        }
    </style>

    <!-- html-to-image CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="title">중세국어의 특징 - 문법 파트</div>
                <div class="subtitle" id="stage-subtitle">1단계: 딥리서치</div>
            </div>
            <div class="progress-info">
                <div class="stage-indicator">
                    <div class="stage-dot active"></div>
                    <div class="stage-dot"></div>
                    <div class="stage-dot"></div>
                </div>
                <div class="question-counter">
                    문제: <span id="current-question">0</span> / <span id="total-questions">0</span>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="passage-container" id="passage-container"></div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-content" id="modal-content">
                <div class="modal-header" id="modal-header"></div>
                <div class="modal-options" id="modal-options"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen" id="result-screen">
            <h2 class="result-title" id="result-title">1단계 학습 완료!</h2>
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-value" id="progress-stat">0%</div>
                    <div class="stat-label">진행률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy-stat">0%</div>
                    <div class="stat-label">정답률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="correct-stat">0</div>
                    <div class="stat-label">맞힌 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="wrong-stat">0</div>
                    <div class="stat-label">틀린 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time-stat">0:00</div>
                    <div class="stat-label">소요 시간</div>
                </div>
            </div>
            <div class="result-buttons">
                <button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>
                <button class="result-button primary" onclick="nextStage()">다음 단계로</button>
            </div>
        </div>
    </div>

    <script>
        // 모달 드래그 관련 변수
        let isDragging = false;
        let dragStartX, dragStartY;
        let modalStartX, modalStartY;
        let dragListenersAdded = false;

        // 현재 단계
        let currentStage = 1;

        // 전체 학습 결과 저장소 (레거시)
        const allStageResults = {
            stage1: null,
            stage2: null,
            stage3: null
        };

        // 새로운 stageResults 객체 (틀린 문제 포함)
        const stageResults = {
            stage1: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage2: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage3: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] }
        };

        // Stage 2와 Stage 3의 wrongQuestions 추적용 배열
        let stage2WrongQuestions = [];
        let stage3WrongQuestions = [];

        // 전역 시작 시간
        let globalStartTime = Date.now();

        // Stage 1: 딥리서치 - 2-choice 질문 데이터
        // ============================================
        // Stage 1: 딥리서치 - 2지선다 하이라이트 문제
        // ============================================
        // 설명: 학습 콘텐츠 내에 하이라이트로 표시된 빈칸 문제
        // 형식: { id: 번호, context: "문맥", correctAnswer: "정답", wrongAnswer: "오답" }
        // - id: 문제 고유 번호
        // - context: 하이라이트가 나타날 문맥 (이 텍스트 다음에 하이라이트가 표시됨)
        // - correctAnswer: 정답 텍스트
        // - wrongAnswer: 오답 텍스트

        const STAGE1_QUESTIONS = [
            { id: 1, context: "주격조사", correctAnswer: "이/ㅣ/Ø", wrongAnswer: "이/가" },
            { id: 2, context: "명사형 어미", correctAnswer: "-옴/-움", wrongAnswer: "-기" },
            { id: 3, context: "", correctAnswer: "높임 선어말 어미", wrongAnswer: "피동 선어말 어미" },
            { id: 4, context: "종류:", correctAnswer: "이/ㅣ/Ø", wrongAnswer: "이/가" },
            { id: 5, context: "자음 받침 +", correctAnswer: "이", wrongAnswer: "ㅣ" },
            { id: 6, context: "'ㅣ' 이외 모음 뒤 +", correctAnswer: "ㅣ", wrongAnswer: "이" },
            { id: 7, context: "'ㅣ' 모음 뒤 +", correctAnswer: "Ø(영형태)", wrongAnswer: "ㅣ" },
            { id: 8, context: "⇒ 근대 국어에서 모음 뒤 주격 조사 'ㅣ' 대신", correctAnswer: "가", wrongAnswer: "이" },
            { id: 9, context: "종류:", correctAnswer: "ᄋᆞᆯ/을, ᄅᆞᆯ/를", wrongAnswer: "ᄋᆞᆯ/를" },
            { id: 10, context: "자음 받침 +", correctAnswer: "ᄋᆞᆯ(양성)/을(음성)", wrongAnswer: "ᄅᆞᆯ(양성)/를(음성)" },
            { id: 11, context: "모음 뒤 +", correctAnswer: "ᄅᆞᆯ(양성)/를(음성)", wrongAnswer: "ᄋᆞᆯ(양성)/을(음성)" },
            { id: 12, context: "⇒ 현대 국어에서", correctAnswer: "자음/모음 받침", wrongAnswer: "모음 조화" },
            { id: 13, context: "종류:", correctAnswer: "ᄋᆡ/의, ㅅ, ㅣ", wrongAnswer: "ᄋᆡ/의, 가" },
            { id: 14, context: "유정물 +", correctAnswer: "ᄋᆡ(양성모음)/의(음성모음)", wrongAnswer: "ㅅ" },
            { id: 15, context: "높임의 대상 +", correctAnswer: "ㅅ", wrongAnswer: "의" },
            { id: 16, context: "무정물 +", correctAnswer: "ㅅ", wrongAnswer: "ᄋᆡ" },
            { id: 17, context: "유정물 모음 뒤 +", correctAnswer: "ㅣ", wrongAnswer: "ㅅ" },
            { id: 18, context: "관형격 조사", correctAnswer: "ㅅ", wrongAnswer: "ㅣ" },
            { id: 19, context: "양성모음 뒤 +", correctAnswer: "애", wrongAnswer: "에" },
            { id: 20, context: "음성모음 뒤 +", correctAnswer: "에", wrongAnswer: "애" },
            { id: 21, context: "'ㅣ' 모음 뒤 +", correctAnswer: "예", wrongAnswer: "에" },
            { id: 22, context: "체언 +", correctAnswer: "ㅣ", wrongAnswer: "에" },
            { id: 23, context: "높임 대상 +", correctAnswer: "ㅅ긔(ᄭᅴ)", wrongAnswer: "애" },
            { id: 24, context: "아주 낮춤:", correctAnswer: "아/야", wrongAnswer: "하" },
            { id: 25, context: "아주 높임:", correctAnswer: "하", wrongAnswer: "아/야" },
            { id: 26, context: "근대 국어 시기에", correctAnswer: "하", wrongAnswer: "아/야" },
            { id: 27, context: "종류:", correctAnswer: "-옴/-움", wrongAnswer: "-기" },
            { id: 28, context: "양성모음 +", correctAnswer: "–옴", wrongAnswer: "–움" },
            { id: 29, context: "음성모음 +", correctAnswer: "–움", wrongAnswer: "–옴" },
            { id: 30, context: "", correctAnswer: "근대 국어", wrongAnswer: "중세 국어" },
            { id: 31, context: "'비르소미오'는", correctAnswer: "모음 조화의 혼란", wrongAnswer: "엄격한 적용" },
            { id: 32, context: "종류:", correctAnswer: "-시-/-샤-", wrongAnswer: "-ᄉᆞᆸ-/-ᄌᆞᆸ-" },
            { id: 33, context: "뒤 자음일 때 +", correctAnswer: "-시-", wrongAnswer: "-샤-" },
            { id: 34, context: "뒤 모음일 때 +", correctAnswer: "-샤-", wrongAnswer: "-시-" },
            { id: 35, context: "", correctAnswer: "-샤-", wrongAnswer: "-시-" },
            { id: 36, context: "종류:", correctAnswer: "-ᄉᆞᆸ-/-ᄌᆞᆸ-/-ᅀᆞᆸ-", wrongAnswer: "-시-/-샤-" },
            { id: 37, context: "+ -ᄉᆞᆸ-", correctAnswer: "ㄱ, ㅂ, ㅅ, ㅎ 받침", wrongAnswer: "ㄷ, ㅌ, ㅈ, ㅊ 받침" },
            { id: 38, context: "+ -ᄌᆞᆸ-", correctAnswer: "ㄷ, ㅌ, ㅈ, ㅊ 받침", wrongAnswer: "모음, ㄴ, ㅁ, ㄹ 받침" },
            { id: 39, context: "+ -ᅀᆞᆸ-", correctAnswer: "모음, ㄴ, ㅁ, ㄹ 받침", wrongAnswer: "ㄱ, ㅂ, ㅅ, ㅎ 받침" },
            { id: 40, context: "", correctAnswer: "근대 국어", wrongAnswer: "현대 국어" },
            { id: 41, context: "종류:", correctAnswer: "-ᅌᅵ-/-ᅌᅵᆺ-", wrongAnswer: "-오-/-우-" },
            { id: 42, context: "평서문 +", correctAnswer: "-ᅌᅵ-", wrongAnswer: "-ᅌᅵᆺ-" },
            { id: 43, context: "의문문 +", correctAnswer: "-ᅌᅵᆺ-", wrongAnswer: "-ᅌᅵ-" },
            { id: 44, context: "⇒ 현대 국어에는", correctAnswer: "선어말 어미를 사용하지 않고", wrongAnswer: "'-시-'를 사용하여" },
            { id: 45, context: "설명 의문문: 의문사에 대한 설명을 요구.", correctAnswer: "의문사 있음", wrongAnswer: "의문사 없음" },
            { id: 46, context: "판정 의문문: '예/아니오' 판정을 요구.", correctAnswer: "의문사 없음", wrongAnswer: "의문사 있음" },
            { id: 47, context: "설명 의문문", correctAnswer: "오 계열", wrongAnswer: "아 계열" },
            { id: 48, context: "판정 의문문", correctAnswer: "아 계열", wrongAnswer: "오 계열" }
        ];

        // ============================================
        // Stage 2: OX 퀴즈
        // ============================================
        // 설명: O/X로 답하는 퀴즈 형식
        // 형식: { id: 번호, text: "문제 내용", answer: "O" 또는 "X", explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 문법 지원: **볼드**, <u>밑줄</u> 등)
        // - answer: 정답 ("O" 또는 "X")
        // - explanation: 정오답 해설 (마크다운 문법 지원)

        const STAGE2_QUESTIONS = [
            { id: 1, text: "중세 국어의 주격 조사는 앞말의 음운 환경에 따라 '이', 'ㅣ', 영형태(Ø)의 세 가지 형태로 나타났다.", answer: "O", explanation: "자음 뒤에서는 '이'(말ᄊᆞᆷ+이), 'ㅣ' 모음을 제외한 모음 뒤에서는 'ㅣ'(부텨+ㅣ), 'ㅣ' 모음 뒤에서는 아무것도 붙지 않는 영형태(불휘+Ø)로 실현되었습니다." },
            { id: 2, text: "객체 높임 선어말 어미 '-ᄌᆞᆸ-'은 '듣다'와 같이 'ㄷ' 받침으로 끝나는 용언 어간 뒤에 나타났다.", answer: "O", explanation: "객체 높임 선어말 어미는 앞 음절의 받침에 따라 형태가 달랐는데, 'ㄷ, ㅌ, ㅈ, ㅊ' 받침 뒤에서는 '-ᄌᆞᆸ-'이 사용되었습니다. (예: 듣ᄌᆞᆸ고)" },
            { id: 3, text: "판정 의문문은 '예/아니오'의 대답을 요구하는 의문문으로, 의문사가 없다.", answer: "O", explanation: "'밥 먹었니?'처럼 '예'나 '아니오'로 대답할 수 있는 의문문을 판정 의문문이라고 합니다. '누구', '언제'와 같은 의문사가 없는 것이 특징입니다." },
            { id: 4, text: "높임의 대상을 나타내는 유정물 명사 뒤에는 관형격 조사 'ᄋᆡ/의'가 사용되었다.", answer: "O", explanation: "일반적인 유정물 명사가 뒷말을 꾸며줄 때, 앞말의 모음이 양성이면 'ᄋᆡ'(ᄂᆞᆷ+ᄋᆡ), 음성이면 '의'(거붑+의)를 사용하여 소유나 관계를 나타냈습니다." },
            { id: 5, text: "명사형 어미는 어간의 모음이 양성이면 '-옴', 음성이면 '-움'이 결합하는 것이 원칙이었다.", answer: "O", explanation: "이는 모음 조화를 따른 것으로, 어간의 모음 성격에 맞춰 어미의 형태가 결정되었습니다. (예: 앉(양성)+옴 → 안좀 / ᄡᅳ(음성)+움 → ᄡᅮᆷ)" },
            { id: 6, text: "현대 국어와 달리 중세 국어에는 객체를 높이기 위한 선어말 어미(-ᄉᆞᆸ-/-ᄌᆞᆸ-/-ᅀᆞᆸ-)가 존재했다.", answer: "O", explanation: "현대 국어에서는 '드리다, 뵙다' 등 특수 어휘로 객체를 높이지만, 중세 국어에서는 용언 어간에 '-ᄉᆞᆸ-/-ᄌᆞᆸ-/-ᅀᆞᆸ-'이라는 특별한 어미를 붙여 목적어나 부사어를 높였습니다." },
            { id: 7, text: "주어가 2인칭일 때 설명 의문문은 종결 어미 '-ㄴ다'를 사용했다. (예: 네 엇뎨 안다)", answer: "O", explanation: "주어가 '너(네)'일 경우에는, 설명 의문문과 판정 의문문을 구분하지 않고 모두 '-ㄴ다'라는 독특한 종결 어미를 사용했습니다." },
            { id: 8, text: "호격 조사 '하'는 '님금하'처럼 아주 높여야 할 대상에게 사용하는 격 조사였다.", answer: "O", explanation: "누군가를 부를 때 쓰는 호격 조사는 높임의 등급이 나뉘어 있었는데, '하'는 임금이나 부처와 같이 가장 높은 대상에게 사용되었습니다." },
            { id: 9, text: "선어말 어미 '-샤-'는 주체 높임의 기능을 하며, 뒤에 모음으로 시작하는 어미가 올 때 나타났다.", answer: "O", explanation: "주체 높임 선어말 어미 '-시-'는 뒤에 모음으로 시작하는 어미(-아, -오 등)를 만나면 그 형태가 '-샤-'로 바뀌었습니다. (예: 니르- + -시- + -오ᄃᆡ → 니ᄅᆞ샤ᄃᆡ)" },
            { id: 10, text: "부사격 조사 '-에'는 '듕귁에'처럼 앞말의 모음이 음성 모음일 때 사용되었다.", answer: "O", explanation: "부사격 조사 역시 모음 조화의 영향을 받아, 앞 체언의 모음이 'ㅜ, ㅡ, ㅓ' 등 음성 모음일 경우 '-에'가 결합했습니다." },
            { id: 11, text: "관형격 조사 'ㅅ'은 현대 국어의 사이시옷 형태로 그 흔적이 남아 있다.", answer: "O", explanation: "중세 국어에서 '나라의'를 '나랏'으로 표현하던 관형격 조사 'ㅅ'의 기능과 형태가 현대 국어의 '나뭇잎', '냇가' 등에 쓰이는 사이시옷에 이어지고 있습니다." },
            { id: 12, text: "상대 높임 선어말 어미 '-ᅌᅵᆺ-'은 의문문에 사용하여 듣는 이를 높였다.", answer: "O", explanation: "듣는 상대방을 높일 때, 평서문에서는 '-ᅌᅵ-'를, \"믿으시나이까?\"와 같은 의문문에서는 '-ᅌᅵᆺ-'을 사용하여 문장의 종류에 따라 형태를 달리했습니다." },
            { id: 13, text: "목적격 조사는 앞말의 모음이 양성이냐 음성이냐에 따라 'ᄋᆞᆯ/을' 또는 'ᄅᆞᆯ/를'로 구분하여 사용했다.", answer: "O", explanation: "목적격 조사는 받침 유무(ᄋᆞᆯ/을 vs ᄅᆞᆯ/를)뿐만 아니라 모음 조화('ᄋᆞᆯ/ᄅᆞᆯ' vs '을/를')까지 고려하여 형태를 결정하는 복잡한 체계를 가졌습니다." },
            { id: 14, text: "'ㅣ' 모음으로 끝나는 체언 뒤에는 주격 조사가 붙지 않았다(영형태). (예: 불휘)", answer: "O", explanation: "'뿌리가'를 뜻하는 '불휘'처럼 'ㅣ' 모음으로 끝나는 단어 뒤에서는 주격 조사를 따로 붙이지 않고 그 자체로 주어의 자격을 나타냈습니다." },
            { id: 15, text: "부사격 조사 중 '-ㅅ긔'는 '부모ㅅ긔'처럼 높임의 대상에게 사용되었다.", answer: "O", explanation: "현대 국어의 '-께'에 해당하는 조사로, '부모님께'처럼 높여야 할 대상에게 어떤 행동이 미침을 나타낼 때 사용되었습니다." },
            { id: 16, text: "중세 국어의 주격 조사 '가'는 자음으로 끝나는 체언 뒤에 붙어 사용되었다.", answer: "X", explanation: "중세 국어 시기에는 주격 조사 '가'가 아예 존재하지 않았습니다. '가'는 근대 국어 시기에 나타나기 시작했습니다." },
            { id: 17, text: "주체 높임 선어말 어미 '-시-'는 뒤에 자음으로 시작하는 어미가 올 때 '-샤-'로 바뀌었다.", answer: "X", explanation: "'-샤-'로 바뀌는 조건은 뒤에 자음이 아닌 모음으로 시작하는 어미가 올 때입니다. 자음 앞에서는 '-시-' 형태가 그대로 유지됩니다. (예: ᄒᆞ시고)" },
            { id: 18, text: "설명 의문문은 '아' 계열의 종결 어미를 사용하여 표현하였다.", answer: "X", explanation: "설명 의문문('누구', '무엇' 등 의문사가 있는 문장)은 '-고, -뇨'와 같은 '오' 계열의 어미를 사용했습니다. '아' 계열(-가, -녀)은 판정 의문문에 사용되었습니다." },
            { id: 19, text: "관형격 조사 'ㅅ'은 높임의 대상인 유정물에만 사용되고 무정물에는 사용되지 않았다.", answer: "X", explanation: "관형격 조사 'ㅅ'은 '大王ㅅ(대왕의)'처럼 높임의 유정물뿐만 아니라 '나랏(나라의)'처럼 무정물 명사 뒤에도 널리 사용되었습니다." },
            { id: 20, text: "현대 국어의 객체 높임법은 중세 국어와 마찬가지로 선어말 어미를 통해 실현된다.", answer: "X", explanation: "중세 국어의 객체 높임 선어말 어미(-ᄉᆞᆸ-/-ᄌᆞᆸ-/-ᅀᆞᆸ-)는 사라졌고, 현대 국어에서는 '드리다, 뵙다, 여쭈다'와 같은 특수한 어휘를 사용하여 객체를 높입니다." },
            { id: 21, text: "명사형 어미 '-기'는 중세 국어 시기부터 '-옴/-움'보다 활발하게 사용되었다.", answer: "X", explanation: "명사형 어미 '-기'는 근대 국어에 들어서 활발하게 사용되기 시작했으며, 중세 국어 시기에는 '-옴/-움'이 주로 사용되었습니다." },
            { id: 22, text: "호격 조사 '아/야'는 예사 낮춤의 의미로만 사용되었다.", answer: "X", explanation: "'아/야'는 아주 낮춤의 의미로도 쓰였지만, '관세음아'처럼 예사 높임의 등급에서도 사용될 수 있었습니다." },
            { id: 23, text: "상대 높임법은 평서문과 의문문에 동일하게 선어말 어미 '-ᅌᅵ-'를 사용했다.", answer: "X", explanation: "문장의 종류에 따라 형태가 달랐습니다. 평서문에서는 '-ᅌᅵ-'를, 의문문에서는 '-ᅌᅵᆺ-'을 사용하여 구분했습니다." },
            { id: 24, text: "목적격 조사는 현대 국어와 같이 앞말이 자음으로 끝나면 '을', 모음으로 끝나면 '를'만 사용했다.", answer: "X", explanation: "현대 국어와 달리 모음 조화의 영향까지 받아서, 양성 모음 뒤에서는 'ᄋᆞᆯ/ᄅᆞᆯ', 음성 모음 뒤에서는 '을/를'을 구분하여 사용했습니다." },
            { id: 25, text: "'공ᄌᆡ(공ᄌᆞ+ㅣ)'는 'ㅣ'모음으로 끝난 체언에 주격 조사 'ㅣ'가 결합한 형태이다.", answer: "X", explanation: "'공ᄌᆞ'는 'ㅣ' 모음이 아닌 'ㆍ(아래아)' 모음으로 끝난 체언입니다. 따라서 'ㅣ' 이외의 모음 뒤에 주격 조사 'ㅣ'가 결합한 경우에 해당합니다." },
            { id: 26, text: "부사격 조사는 현대 국어와 동일하게 장소나 시간을 나타내는 기능만 하였다.", answer: "X", explanation: "장소나 시간 외에도 '고서ᇰ이 同符ᄒᆞ시니(옛 성인과 같으시니)'에서처럼 비교의 의미를 나타내거나, 도구, 원인 등 다양한 의미로 사용되었습니다." },
            { id: 27, text: "객체 높임 선어말 어미 '-ᄉᆞᆸ-'은 모음으로 끝나는 어간 뒤에 나타났다.", answer: "X", explanation: "'-ᄉᆞᆸ-'은 '돕-'과 같이 'ㄱ, ㅂ, ㅅ, ㅎ' 받침으로 끝나는 어간 뒤에 나타났습니다. 모음으로 끝나는 어간 뒤에는 '-ᅀᆞᆸ-'이 사용되었습니다." },
            { id: 28, text: "판정 의문문에서 주어가 2인칭일 때, 종결 어미는 '-고'를 사용하였다.", answer: "X", explanation: "주어가 2인칭일 때는 판정/설명 의문문을 구분하지 않고 모두 '-ㄴ다'를 사용했습니다. '-고'는 주어가 1, 3인칭일 때 설명 의문문에 쓰였습니다." },
            { id: 29, text: "관형격 조사 'ㅣ'는 자음으로 끝나는 유정물 체언 뒤에 사용되었다.", answer: "X", explanation: "관형격 조사 'ㅣ'는 '저(그 사람)'가 '제'로 되는 것처럼 모음으로 끝나는 유정물 체언 뒤에 사용되었습니다." },
            { id: 30, text: "'비르소미오'는 '-옴'이 사용되었으므로 모음 조화를 엄격하게 지킨 표기이다.", answer: "X", explanation: "어간 '비릇-'의 모음 'ㅡ'는 음성 모음이므로 원칙대로라면 '-움'이 와야 합니다. 양성 모음 어미인 '-옴'이 왔으므로, 이는 모음 조화가 지켜지지 않은 혼란기의 예시입니다." }
        ];

        // ============================================
        // Stage 3: 객관식 (Multiple Choice)
        // ============================================
        // 설명: 6개 선택지 중 4개를 무작위로 선택하여 출제하는 객관식 문제
        // 형식: { id: 번호, text: "문제", options: ["선택지1", ... "선택지6"], correct: 정답인덱스, explanation: "해설" }
        // - id: 문제 고유 번호
        // - text: 문제 텍스트 (마크다운 지원)
        // - options: 6개의 선택지 배열 (실제 출제 시 4개 무작위 선택)
        // - correct: 정답의 인덱스 (0부터 시작, 즉 0=①, 1=②, 2=③, 3=④, 4=⑤, 5=⑥)
        // - explanation: 정오답 해설 (마크다운 지원, <u>밑줄</u> 가능)

        const STAGE3_QUESTIONS = [
            {
                id: 1,
                text: "다음 <보기>의 ㉠~㉢에 들어갈 주격 조사의 형태가 바르게 짝지어진 것은?\n\n<보기>\n\n∙ 자음 받침 + ㉠ (예: 말ᄊᆞᆷ+㉠ → 말ᄊᆞ미)\n∙ 'ㅣ' 이외 모음 + ㉡ (예: 부텨+㉡ → 부톄)\n∙ 'ㅣ' 모음 + ㉢ (예: 불휘+㉢ → 불휘)",
                options: [
                    "㉠ 이 | ㉡ ㅣ | ㉢ Ø (생략)",
                    "㉠ 이 | ㉡ ㅣ | ㉢ 이",
                    "㉠ ㅣ | ㉡ 이 | ㉢ Ø (생략)",
                    "㉠ ㅣ | ㉡ 이 | ㉢ 가",
                    "㉠ 가 | ㉡ ㅣ | ㉢ 이",
                    "㉠ 이 | ㉡ 가 | ㉢ Ø (생략)"
                ],
                correct: 0,
                explanation: "자료의 '주격 조사' 항목에 따르면 자음 뒤에는 '이', 'ㅣ' 이외 모음 뒤에는 'ㅣ', 'ㅣ' 모음 뒤에는 생략(Ø, 영형태)되므로, 각 조건과 형태가 바르게 연결된 것은 ①입니다."
            },
            {
                id: 2,
                text: "다음 중 관형격 조사 'ㅅ'의 쓰임에 해당하는 예로만 묶인 것은?\n\n<보기>\n\n가. 부텻 마ᄅᆞᆯ (부텨+ㅅ)\n나. 나랏 말ᄊᆞ미 (나라+ㅅ)\n다. ᄂᆞᄆᆡ ᄠᅳᆮ (ᄂᆞᆷ+ᄋᆡ)\n라. 제 ᄠᅳ들 (저+ㅣ)",
                options: [
                    "가, 나",
                    "가, 다",
                    "나, 다",
                    "나, 라",
                    "다, 라",
                    "가, 라"
                ],
                correct: 0,
                explanation: "관형격 조사 'ㅅ'은 높임의 대상인 유정물(가. 부텻)이나 무정물(나. 나랏) 뒤에 사용되었습니다. '다'는 일반 유정물 뒤에 쓰인 'ᄋᆡ'이고, '라'는 'ㅣ'가 결합한 경우입니다."
            },
            {
                id: 3,
                text: "<보기>의 문장에 나타난 높임 표현에 대한 설명으로 적절하지 않은 것은?\n\n<보기>\n\n부텨 <u>니라샤ᄆᆞᆯ</u> <u>듣ᄌᆞᆸ고</u>",
                options: [
                    "'부텨'는 높임의 대상이다.",
                    "'<u>니라샤ᄆᆞᆯ</u>'의 '-샤-'는 주체('부텨')를 높인다.",
                    "'<u>듣ᄌᆞᆸ고</u>'의 '-ᄌᆞᆸ-'은 객체('부텨 니라샤ᄆᆞᆯ')를 높인다.",
                    "'-샤-'는 뒤에 모음 어미가 오기 때문에 나타난 형태이다.",
                    "'-ᄌᆞᆸ-'은 앞말의 받침이 'ㄷ'이기 때문에 나타난 형태이다.",
                    "이 문장의 화자는 '부텨'보다 높은 사람이다."
                ],
                correct: 5,
                explanation: "주체 높임 선어말 어미 '-샤-'와 객체 높임 선어말 어미 '-ᄌᆞᆸ-'을 사용하여 '부텨'를 높이고 있으므로, 이 문장의 화자는 '부텨'보다 지위가 낮은 사람임을 알 수 있습니다."
            },
            {
                id: 4,
                text: "다음 중 설명 의문문에 해당하는 문장은?",
                options: [
                    "이 ᄯᆞ리 너희 죵가",
                    "져므며 늘구미 잇ᄂᆞ녀",
                    "이ᄂᆞᆫ 賞상가 罰벌아",
                    "네 모르던다",
                    "므슴 마ᄅᆞᆯ 니ᄅᆞᄂᆞ뇨",
                    "그듸ᄂᆞᆫ 보디 아니ᄒᆞᄂᆞᆫ다"
                ],
                correct: 4,
                explanation: "'므슴(무슨)'이라는 의문사가 포함되어 구체적인 설명을 요구하므로 설명 의문문입니다. 나머지 문장들은 모두 의문사 없이 '예/아니오'로 대답할 수 있는 판정 의문문입니다."
            },
            {
                id: 5,
                text: "명사형 어미 '-옴/-움'에 대한 설명으로 옳은 것은?",
                options: [
                    "어간의 모음 종류와 상관없이 자유롭게 사용되었다.",
                    "현대 국어의 명사형 어미 '-기'와 기능이 완전히 동일하다.",
                    "'ᄡᅮ메(ᄡᅳ-+-움+에)'는 음성 모음 어간에 '-움'이 결합한 예이다.",
                    "'홈(ᄒᆞ-+-옴)'은 음성 모음 어간에 '-옴'이 결합한 예이다.",
                    "근대 국어 시기에도 '-기'보다 우세하게 사용되었다.",
                    "'비르소미오'는 모음 조화가 완벽하게 지켜진 예이다."
                ],
                correct: 2,
                explanation: "어간 'ᄡᅳ-'의 모음 'ㅡ'는 음성 모음이므로, 모음 조화에 따라 음성 모음 어미인 '-움'이 결합한 것은 올바른 예시입니다. ① 모음 조화에 따라 구분, ④ 'ᄒᆞ다'의 'ㆍ'는 양성 모음, ⑤ '-기'는 근대 국어 시기에 활발, ⑥ '비르소미오'는 모음 조화가 지켜지지 않은 예입니다."
            },
            {
                id: 6,
                text: "다음 문장의 ( ) 안에 들어갈 적절한 격 조사는?\n\n내 ᄯᆞᆯ 勝鬘(승만)이 聰明(총명)ᄒᆞ니 부텨 ( ) 보ᅀᆞᄫᆞ면",
                options: [
                    "목적격 조사: 를",
                    "주격 조사: ㅣ",
                    "관형격 조사: ㅅ",
                    "부사격 조사: 에",
                    "목적격 조사: 을",
                    "주격 조사: 이"
                ],
                correct: 0,
                explanation: "문맥상 '내 딸 승만이 (부처를) 뵈면'으로 해석되므로, '부텨'를 목적어로 만드는 목적격 조사가 필요합니다. '부텨'의 마지막 모음 'ㅕ'는 'ㅣ' 계열의 이중모음이지만 양성적 성격을 가지므로, 모음 조화에 따라 양성 모음 조사인 'ᄅᆞᆯ'이 결합하는 것이 자연스럽습니다."
            },
            {
                id: 7,
                text: "중세 국어의 객체 높임법에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "목적어나 부사어가 지시하는 대상을 높이는 방법이다.",
                    "선어말 어미 '-ᄉᆞᆸ-/-ᄌᆞᆸ-/-ᅀᆞᆸ-'을 사용하여 실현했다.",
                    "어간의 끝소리가 'ㄱ, ㅂ, ㅅ, ㅎ'일 때 '-ᄉᆞᆸ-'을 사용했다.",
                    "어간의 끝소리가 모음이나 'ㄴ, ㅁ, ㄹ'일 때 '-ᄌᆞᆸ-'을 사용했다.",
                    "현대 국어에서는 '드리다, 뵙다, 여쭈다' 등 특수 어휘로 실현된다.",
                    "선어말 어미 뒤에 모음이 오면 'ㅸ'이 나타나기도 했다. (예: 듣ᄌᆞᄫᆞ며)"
                ],
                correct: 3,
                explanation: "어간의 끝소리가 모음이나 'ㄴ, ㅁ, ㄹ'일 때는 '-ᅀᆞᆸ-'을 사용했습니다. '-ᄌᆞᆸ-'은 어간 끝소리가 'ㄷ, ㅌ, ㅈ, ㅊ'일 때 사용되었습니다."
            },
            {
                id: 8,
                text: "다음 중 주어가 2인칭일 때 사용되는 의문문 종결 어미는?",
                options: [
                    "-고/-가",
                    "-뇨/-녀",
                    "-오/-아",
                    "-ㄴ다",
                    "-ᅌᅵᆺ고/-ᅌᅵᆺ가",
                    "-도다"
                ],
                correct: 3,
                explanation: "주어가 2인칭('너')일 경우에는 설명 의문문과 판정 의문문을 구분하지 않고 모두 '-ㄴ다'라는 독특한 종결 어미를 사용했습니다."
            },
            {
                id: 9,
                text: "다음 <보기>에 대한 탐구 내용으로 적절하지 않은 것은?\n\n<보기>\n\n(가) 사ᄅᆞᄆᆞᆯ (사ᄅᆞᆷ + ᄋᆞᆯ)\n(나) ᄠᅳ들 (ᄠᅳᆮ + 을)\n(다) 天下텬하ᄅᆞᆯ (天下텬하 + ᄅᆞᆯ)\n(라) 너를 (너 + 를)",
                options: [
                    "(가)와 (나)는 체언이 자음으로 끝난 경우이다.",
                    "(다)와 (라)는 체언이 모음으로 끝난 경우이다.",
                    "(가)와 (다)는 앞 체언의 모음이 양성 모음인 경우이다.",
                    "(나)와 (라)는 앞 체언의 모음이 음성 모음인 경우이다.",
                    "(가)~(라)는 모두 목적격 조사가 결합한 예이다.",
                    "(가)~(라)의 조사 형태는 현대 국어에서도 그대로 사용된다."
                ],
                correct: 5,
                explanation: "중세 국어의 목적격 조사는 모음 조화에 따라 'ᄋᆞᆯ/을/ᄅᆞᆯ/를'의 4가지 형태로 실현되었으나, 현대 국어에서는 모음 조화가 약화되어 앞말의 받침 유무에 따라 '을/를' 두 가지 형태로만 사용됩니다. 따라서 조사 형태가 그대로 사용된다는 설명은 틀렸습니다."
            },
            {
                id: 10,
                text: "다음 밑줄 친 부분의 문법적 기능이 다른 하나는?",
                options: [
                    "불휘 기픈 <u>남ᄀᆞᆫ</u>",
                    "<u>나랏</u> 말ᄊᆞ미",
                    "<u>大王대왕ㅅ</u> 말ᄊᆞ미ᅀᅡ",
                    "<u>사ᄉᆞᄆᆡ</u> 드ᇰ",
                    "<u>부텻</u> 마ᄅᆞᆯ",
                    "<u>다ᄉᆞᆺ</u> <u>술윗</u> 글워ᄅᆞᆯ"
                ],
                correct: 0,
                explanation: "① '남ᄀᆞᆫ'은 '나무'를 의미하는 체언 '남ㄱ'에 보조사 'ᄋᆞᆫ'이 결합한 형태입니다. 반면, ②~⑥은 모두 앞의 명사(체언)에 붙어 뒷말을 꾸미게 하는 관형격 조사('ㅅ', 'ᄋᆡ', 'ㅣ')가 사용된 예입니다."
            },
            {
                id: 11,
                text: "다음 중 상대 높임법에 대한 설명으로 옳은 것은?",
                options: [
                    "선어말 어미 '-시-/-샤-'를 통해 실현되었다.",
                    "평서문에서는 '-ᅌᅵᆺ-', 의문문에서는 '-ᅌᅵ-'를 사용했다.",
                    "현대 국어의 '하십시오체, 하오체' 등급과 유사한 기능을 했다.",
                    "주어를 높이기 위한 문법 요소이다.",
                    "목적어를 높이기 위한 문법 요소이다.",
                    "근대 국어 시기에 '-샤-'가 소멸하면서 함께 사라졌다."
                ],
                correct: 2,
                explanation: "상대 높임법은 듣는 이, 즉 청자를 높이거나 낮추는 방법입니다. 이는 현대 국어에서 청자에 대한 높임의 등급을 나누는 '하십시오체, 하오체' 등의 체계와 기능적으로 유사합니다."
            },
            {
                id: 12,
                text: "다음 문장에 쓰인 부사격 조사의 종류와 환경이 바르게 연결된 것은?",
                options: [
                    "ᄇᆞᄅᆞ매: 양성모음 뒤 + 에",
                    "듕귁에: 음성모음 뒤 + 애",
                    "서리예: 'ㅣ'모음 뒤 + 예",
                    "고서ᇰ이: 자음 뒤 + ㅣ",
                    "父부母모ㅅ긔: 높임 대상 + 긔",
                    "나조ᄒᆡ: 양성모음 뒤 + 의"
                ],
                correct: 2,
                explanation: "'서리'는 'ㅣ' 모음으로 끝나는 체언이므로, 뒤에 부사격 조사 '예'가 결합한 것은 올바른 예시입니다. ① ᄇᆞᄅᆞᆷ(양성) + 애, ② 듕귁(음성) + 에, ④는 비교 부사격, ⑤ 높임대상 + ㅅ긔가 맞습니다."
            },
            {
                id: 13,
                text: "다음 문장에서 주체 높임이 실현된 표현을 모두 찾은 것은?\n\n<보기>\n\n耶輸ㅣ <u>니르샤ᄃᆡ</u> 如來 太子ㅅ 時節에 나ᄅᆞᆯ 겨집 <u>사ᄆᆞ시니</u> 내 太子ᄅᆞᆯ <u>셤기ᅀᆞᄫᅩᄃᆡ</u>… 世間 <u>ᄇᆞ리시고</u>-",
                options: [
                    "니르샤ᄃᆡ, 사ᄆᆞ시니, 셤기ᅀᆞᄫᅩᄃᆡ",
                    "니르샤ᄃᆡ, 사ᄆᆞ시니, ᄇᆞ리시고",
                    "사ᄆᆞ시니, 셤기ᅀᆞᄫᅩᄃᆡ, ᄇᆞ리시고",
                    "니르샤ᄃᆡ, 셤기ᅀᆞᄫᅩᄃᆡ",
                    "사ᄆᆞ시니, ᄇᆞ리시고",
                    "셤기ᅀᆞᄫᅩᄃᆡ, ᄇᆞ리시고"
                ],
                correct: 1,
                explanation: "주체 높임은 선어말 어미 '-시-/-샤-'를 통해 실현됩니다. 따라서 문장에서 주어를 높이는 표현은 '(야수가) 니르샤ᄃᆡ', '(여래가) 사ᄆᆞ시니', '(여래가) ᄇᆞ리시고' 입니다. '셤기ᅀᆞᄫᅩᄃᆡ'는 객체('太子')를 높이는 표현입니다."
            },
            {
                id: 14,
                text: "<보기>의 ㉠과 ㉡에 들어갈 의문문의 종류를 바르게 짝지은 것은?\n\n<보기>\n\n∙ 므슴 마ᄅᆞᆯ 니ᄅᆞᄂᆞ뇨 → ( ㉠ ) 의문문\n∙ 져므며 늘구미 잇ᄂᆞ녀 → ( ㉡ ) 의문문",
                options: [
                    "㉠ 설명 | ㉡ 판정",
                    "㉠ 판정 | ㉡ 설명",
                    "㉠ 수사 | ㉡ 감탄",
                    "㉠ 감탄 | ㉡ 수사",
                    "㉠ 선택 | ㉡ 부정",
                    "㉠ 부정 | ㉡ 선택"
                ],
                correct: 0,
                explanation: "첫 번째 문장은 '므슴(무슨)'이라는 의문사가 있어 구체적인 설명을 요구하므로 '설명 의문문'입니다. 두 번째 문장은 의문사 없이 '예/아니오'로 답할 수 있으므로 '판정 의문문'입니다."
            },
            {
                id: 15,
                text: "중세 국어의 격조사에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "주격 조사로 '이/ㅣ/Ø'가 있었고 '가'는 없었다.",
                    "목적격 조사는 모음 조화에 따라 'ᄋᆞᆯ/을', 'ᄅᆞᆯ/를'로 나타났다.",
                    "관형격 조사는 대상의 유정/무정, 높임 여부에 따라 'ᄋᆡ/의, ㅅ' 등을 사용했다.",
                    "부사격 조사는 처소, 도구, 비교 등 다양한 의미를 나타냈다.",
                    "호격 조사는 현대 국어와 달리 높임의 등급을 구별하지 않았다.",
                    "보격 조사는 주격 조사의 형태와 동일했다."
                ],
                correct: 4,
                explanation: "호격 조사는 '아/야'(아주 낮춤 또는 예사 높임), '이여/ㅣ여'(예사 높임), '하'(아주 높임) 등으로 듣는 사람에 대한 높임의 등급을 구별하여 사용했습니다. 따라서 높임 등급을 구별하지 않았다는 설명은 틀렸습니다."
            },
            {
                id: 16,
                text: "다음 문장의 ( )에 들어갈 가장 적절한 조사는?\n\n불휘 기픈 남ᄀᆞᆫ ( ) 아니 뮐ᄊᆡ",
                options: [
                    "이 (주격)",
                    "ㅣ (주격)",
                    "ᄋᆞᆯ (목적격)",
                    "애 (부사격)",
                    "ㅅ (관형격)",
                    "Ø (주격, 생략)"
                ],
                correct: 3,
                explanation: "'뿌리 깊은 나무는 (바람에) 아니 흔들리므로'라는 의미가 되어야 자연스럽습니다. 처소(장소)를 나타내는 부사격 조사가 필요하며, 앞말 'ᄇᆞᄅᆞᆷ'이 양성 모음이므로 부사격 조사 '애'가 결합하여 'ᄇᆞᄅᆞ매'가 됩니다."
            },
            {
                id: 17,
                text: "<보기>에 나타난 선어말 어미 '-ᅀᆞᆸ-'의 실현 환경으로 옳은 것은?\n\n<보기>\n\n스승니믈 보ᅀᆞᆸ고져 (보- + -ᅀᆞᆸ- + -고져)",
                options: [
                    "어간 끝소리가 'ㄱ, ㅂ, ㅅ, ㅎ'인 경우",
                    "어간 끝소리가 'ㄷ, ㅌ, ㅈ, ㅊ'인 경우",
                    "어간 끝소리가 모음, 'ㄴ', 'ㅁ', 'ㄹ'인 경우",
                    "어간 뒤에 모음으로 시작하는 어미가 오는 경우",
                    "어간 뒤에 자음으로 시작하는 어미가 오는 경우",
                    "주어가 1인칭인 경우"
                ],
                correct: 2,
                explanation: "객체 높임 선어말 어미 '-ᅀᆞᆸ-'은 앞 어간의 끝소리가 '보-'처럼 모음으로 끝나거나, '알-'처럼 'ㄴ, ㅁ, ㄹ' 받침으로 끝날 때 사용되었습니다."
            },
            {
                id: 18,
                text: "근대 국어 시기에 나타난 문법적 변화로 적절하지 않은 것은?",
                options: [
                    "주격 조사 '가'가 사용되기 시작했다.",
                    "목적격 조사가 '을/를'로 단순화되었다.",
                    "관형격 조사 'ㅅ'이 소멸하고 '의'만 남게 되었다.",
                    "호격 조사 '하'가 소멸되었다.",
                    "객체 높임 선어말 어미가 점차 쓰이지 않게 되었다.",
                    "명사형 어미 '-옴/-움'이 '-기'보다 활발하게 사용되었다."
                ],
                correct: 5,
                explanation: "근대 국어 시기에는 '-옴/-움'의 쓰임이 줄고, 명사형 어미 '-기'가 더 활발하게 사용되었습니다. 따라서 '-옴/-움'이 '-기'보다 활발하게 사용되었다는 설명은 틀렸습니다."
            },
            {
                id: 19,
                text: "다음 중 'ㅣ' 모음 뒤에 주격 조사가 생략(영형태)된 예가 아닌 것은?",
                options: [
                    "불휘 기픈 남ᄀᆞᆫ",
                    "내(나+ㅣ) 해 위ᄒᆞ야",
                    "엄니 오실 날",
                    "공ᄌᆡ 니ᄅᆞ샤ᄃᆡ",
                    "다리 아프다",
                    "이리 오너라"
                ],
                correct: 1,
                explanation: "'내'는 대명사 '나'에 주격 조사 'ㅣ'가 직접 결합하여 만들어진 형태이지, 'ㅣ' 모음 뒤에 조사가 생략된 경우가 아닙니다. ①, ③, ⑤, ⑥은 각각 '뿌리, 어머니, 다리, 이리'라는 'ㅣ' 계열 모음으로 끝나는 말 뒤에 주격 조사가 생략된 예로 볼 수 있습니다. ④ '공ᄌᆡ'는 '공ᄌᆞ+ㅣ'의 결합입니다. (수정: ④ 또한 'ㅣ' 이외의 모음 뒤에 'ㅣ'가 결합한 경우이므로, 가장 명확히 아닌 것은 ②입니다.)"
            },
            {
                id: 20,
                text: "<보기>의 두 문장에 대한 설명으로 가장 적절한 것은?\n\n<보기>\n\n(가) 네 엇뎨 안다\n(나) 네 모르던다",
                options: [
                    "(가)는 판정 의문문, (나)는 설명 의문문이다.",
                    "(가), (나) 모두 주어가 1인칭일 때의 표현이다.",
                    "(가)는 '예/아니오'의 대답을, (나)는 설명을 요구한다.",
                    "(가)의 '엇뎨'는 의문사가 아니며, (나)에는 의문사가 있다.",
                    "(가)는 설명, (나)는 판정 의문문이며 모두 주어가 2인칭이다.",
                    "(가)와 (나)는 현대 국어에서 동일한 종결 어미로 표현된다."
                ],
                correct: 4,
                explanation: "두 문장 모두 주어가 2인칭 '네'입니다. (가)는 의문사 '엇뎨(어찌)'가 있으므로 설명을 요구하는 설명 의문문이고, (나)는 의문사가 없으므로 '예/아니오'의 대답을 요구하는 판정 의문문입니다."
            }
        ];

        // 타이머 관련 변수
        let timerInterval;
        let currentTime = 300; // 5분 (300초)
        const maxTime = 300;

        // 현재 학습 상태
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let startTime;
        let answeredQuestions = new Set();

        // 셔플된 문제 배열 (Stage 2 & 3용)
        let shuffledStage2Questions = [];
        let shuffledStage3Questions = [];

        // Fisher-Yates 셔플 알고리즘
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 모달 드래그 설정 (한 번만 실행)
        function setupModalDrag() {
            if (dragListenersAdded) return;
            
            const modal = document.getElementById('modal-content');

            modal.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            modal.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
            
            dragListenersAdded = true;
        }

        function startDrag(e) {
            const modal = document.getElementById('modal-content');
            if (e.target.closest('.option-button')) return;

            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchstart') {
                e.preventDefault();
            }

            isDragging = true;
            modal.classList.add('dragging');

            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;

            const rect = modal.getBoundingClientRect();
            modalStartX = rect.left;
            modalStartY = rect.top;
        }

        function drag(e) {
            if (!isDragging) return;
            
            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchmove') {
                e.preventDefault();
            }

            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;

            const modal = document.getElementById('modal-content');
            modal.style.left = (modalStartX + deltaX) + 'px';
            modal.style.top = (modalStartY + deltaY) + 'px';
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            document.getElementById('modal-content').classList.remove('dragging');
        }

        // 타이머 시작
        function startTimer() {
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerBar();

                if (currentTime <= 0) {
                    endStage();
                }
            }, 1000);
        }

        // 타이머 바 업데이트
        function updateTimerBar() {
            const percentage = (currentTime / maxTime) * 100;
            document.getElementById('timer-bar').style.width = percentage + '%';
        }

        // 시간 더하기/빼기
        function addTime(seconds) {
            currentTime = Math.min(currentTime + seconds, maxTime);
            updateTimerBar();
        }

        function subtractTime(seconds) {
            currentTime = Math.max(currentTime - seconds, 0);
            updateTimerBar();
        }

        // Markdown to HTML 변환
        function convertMarkdownToHTML(text) {
            // 테이블 처리
            let html = text.replace(/\|(.+)\|/g, (match) => {
                const cells = match.split('|').filter(c => c.trim());
                const isHeader = text.indexOf(match) !== -1 && text.split(match)[1].indexOf('|---') !== -1;
                const tag = isHeader ? 'th' : 'td';
                return '<tr>' + cells.map(cell => `<${tag}>${cell.trim()}</${tag}>`).join('') + '</tr>';
            });

            // 테이블 구조 감싸기
            html = html.replace(/(<tr>.*<\/tr>\n)+/g, (match) => {
                return '<table>' + match + '</table>';
            });

            // 헤딩 변환
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // 볼드 변환
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // 밑줄 변환 (<u> 태그 지원)
            html = html.replace(/<u>(.+?)<\/u>/g, '<u>$1</u>');

            // 리스트 변환
            html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                return '<ul>' + match + '</ul>';
            });

            // 줄바꿈 변환
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Stage 1: 딥리서치 - 2-choice 질문이 있는 HTML 생성
        // ============================================
        // Stage 1 학습 콘텐츠 생성 함수
        // ============================================
        // 설명: Stage 1에서 표시할 학습 콘텐츠를 생성합니다.
        // rawContent 내에서 <span class="highlight" data-question-id="번호">__________</span> 형식으로
        // STAGE1_QUESTIONS의 문제가 하이라이트로 표시됩니다.
        // - data-question-id: STAGE1_QUESTIONS 배열의 id와 일치해야 함
        // - 마크다운 문법 지원 (## 제목, **볼드**, 리스트 등)

        function generateStage1Content() {
            // ============================================
            // rawContent: Stage 1에 표시할 학습 콘텐츠
            // ============================================
            // 마크다운 문법 지원: ### 제목, **볼드**, <ul><li> 리스트, <table> 테이블 등
            // 하이라이트 문제 삽입: <span class="highlight" data-question-id="번호">__________</span>
            // - data-question-id는 STAGE1_QUESTIONS의 id와 반드시 일치해야 함
            // - context 속성은 어느 위치에서 하이라이트가 나타날지 결정함

            const rawContent = `<h3><strong>중세 국어 문법의 특징</strong></h3>

<p>주격조사 <span class="highlight" data-question-id="1">__________</span><br>
명사형 어미 <span class="highlight" data-question-id="2">__________</span></p>

<p><span class="highlight" data-question-id="3">__________</span>가 다양하게 발달함</p>

<table>
<tr><th></th><th>현대 국어</th><th>중세 국어</th></tr>
<tr><td>주격</td><td>이/가</td><td>이/ㅣ/Ø</td></tr>
<tr><td>목적격</td><td>을/를</td><td>ᄋᆞᆯ/을/ᄅᆞᆯ/를</td></tr>
<tr><td>보격</td><td>이/가</td><td>이/ㅣ/Ø</td></tr>
<tr><td>서술격</td><td>이다</td><td>이다</td></tr>
<tr><td>관형격</td><td>의</td><td>ᄋᆡ/의, ㅅ, ㅣ</td></tr>
<tr><td>부사격</td><td>에, 에게 등</td><td>애/에/예, ㅣ, ㅅ긔, ᄋᆡ/의 등</td></tr>
<tr><td>호격</td><td>아/야</td><td>아/야, 이여, 하</td></tr>
</table>

<h2><strong>주격 조사</strong></h2>

<p>종류: <span class="highlight" data-question-id="4">__________</span> <em>('가'가 없었음을 꼭 기억★)</em></p>

<p><strong>환경</strong><br>
자음 받침 + <span class="highlight" data-question-id="5">__________</span><br>
말ᄊᆞ미(말ᄊᆞᆷ+이) [말이]</p>

<p>'ㅣ' 이외 모음 뒤 + <span class="highlight" data-question-id="6">__________</span><br>
배(바+ㅣ) [배가], 내(나+ㅣ) [내가]</p>

<p>'ㅣ' 모음 뒤 + <span class="highlight" data-question-id="7">__________</span><br>
불휘(불휘+Ø) [뿌리가]</p>

<p><strong>변천</strong><br>
⇒ 근대 국어에서 모음 뒤 주격 조사 'ㅣ' 대신 <span class="highlight" data-question-id="8">__________</span>를 사용하기 시작함</p>

<hr>

<h2><strong>목적격 조사</strong></h2>

<p>종류: <span class="highlight" data-question-id="9">__________</span></p>

<p><strong>환경</strong><br>
자음 받침 + <span class="highlight" data-question-id="10">__________</span><br>
예) 사ᄅᆞᄆᆞᆯ(사ᄅᆞᆷ+ᄋᆞᆯ) [사람을], ᄠᅳ들(ᄠᅳᆮ+을) [뜻을]</p>

<p>모음 뒤 + <span class="highlight" data-question-id="11">__________</span><br>
예) 天下텬하ᄅᆞᆯ(天下텬하+ᄅᆞᆯ), 너를(너+를)</p>

<p><strong>변천</strong><br>
⇒ 현대 국어에서 <span class="highlight" data-question-id="12">__________</span>에 따라 '을/를'로 단순화</p>

<hr>

<h2><strong>관형격 조사</strong></h2>

<p>종류: <span class="highlight" data-question-id="13">__________</span></p>

<p><strong>환경</strong><br>
유정물 + <span class="highlight" data-question-id="14">__________</span><br>
ᄂᆞᄆᆡ(ᄂᆞᆷ+ᄋᆡ) ᄠᅳᆮ [남의 뜻]</p>

<p>높임의 대상 + <span class="highlight" data-question-id="15">__________</span><br>
大王대왕ㅅ 말ᄊᆞ미ᅀᅡ</p>

<p>무정물 + <span class="highlight" data-question-id="16">__________</span><br>
나랏 말ᄊᆞ미</p>

<p>유정물 모음 뒤 + <span class="highlight" data-question-id="17">__________</span><br>
제(저+ㅣ) ᄠᅳ들</p>

<p><strong>변천</strong><br>
관형격 조사 <span class="highlight" data-question-id="18">__________</span>은 사이시옷의 형태로 남아 있음</p>

<hr>

<h2><strong>부사격 조사</strong></h2>

<p><strong>환경</strong><br>
양성모음 뒤 + <span class="highlight" data-question-id="19">__________</span><br>
예) ᄇᆞᄅᆞ매(ᄇᆞᄅᆞᆷ+애)</p>

<p>음성모음 뒤 + <span class="highlight" data-question-id="20">__________</span><br>
예) ᄡᅮ메(ᄡᅳ-+-움+에)</p>

<p>'ㅣ' 모음 뒤 + <span class="highlight" data-question-id="21">__________</span><br>
예) 서리예(서리+예)</p>

<p>체언 + <span class="highlight" data-question-id="22">__________</span><br>
고서ᇰ<strong>이</strong>(고서ᇰ+이) 同符ᄒᆞ시니</p>

<p>높임 대상 + <span class="highlight" data-question-id="23">__________</span><br>
예) 父母ㅅ긔(부모께)</p>

<hr>

<h2><strong>호격 조사</strong></h2>

<p>아주 낮춤: <span class="highlight" data-question-id="24">__________</span><br>
아주 높임: <span class="highlight" data-question-id="25">__________</span></p>

<p><strong>변천</strong><br>
근대 국어 시기에 <span class="highlight" data-question-id="26">__________</span> 소멸</p>

<hr>

<h2><strong>명사형 어미</strong></h2>

<p>종류: <span class="highlight" data-question-id="27">__________</span></p>

<p><strong>환경</strong><br>
양성모음 + <span class="highlight" data-question-id="28">__________</span><br>
음성모음 + <span class="highlight" data-question-id="29">__________</span></p>

<p><strong>변천</strong><br>
① <span class="highlight" data-question-id="30">__________</span>에서 '-기'가 활발히 사용됨<br>
② '비르소미오'는 <span class="highlight" data-question-id="31">__________</span></p>

<hr>

<h2><strong>주체 높임</strong></h2>

<p>종류: <span class="highlight" data-question-id="32">__________</span></p>

<p><strong>환경</strong><br>
뒤 자음일 때 + <span class="highlight" data-question-id="33">__________</span><br>
뒤 모음일 때 + <span class="highlight" data-question-id="34">__________</span></p>

<p><strong>변천</strong><br>
<span class="highlight" data-question-id="35">__________</span>는 쓰지 않음</p>

<hr>

<h2><strong>객체 높임</strong></h2>

<p>종류: <span class="highlight" data-question-id="36">__________</span></p>

<p><strong>환경</strong><br>
<span class="highlight" data-question-id="37">__________</span> + -ᄉᆞᆸ-<br>
<span class="highlight" data-question-id="38">__________</span> + -ᄌᆞᆸ-<br>
<span class="highlight" data-question-id="39">__________</span> + -ᅀᆞᆸ-</p>

<p><strong>변천</strong><br>
<span class="highlight" data-question-id="40">__________</span>에서 점차 쓰이지 않음</p>

<hr>

<h2><strong>상대 높임</strong></h2>

<p>종류: <span class="highlight" data-question-id="41">__________</span></p>

<p><strong>환경</strong><br>
평서문 + <span class="highlight" data-question-id="42">__________</span><br>
의문문 + <span class="highlight" data-question-id="43">__________</span></p>

<p><strong>변천</strong><br>
⇒ 현대 국어에는 <span class="highlight" data-question-id="44">__________</span> 높임의 등급으로 상대를 높임</p>

<hr>

<h2><strong>의문문</strong></h2>

<p>설명 의문문: 의문사에 대한 설명을 요구. <span class="highlight" data-question-id="45">__________</span><br>
판정 의문문: '예/아니오' 판정을 요구. <span class="highlight" data-question-id="46">__________</span></p>

<p><strong>구분</strong><br>
설명 의문문 (<span class="highlight" data-question-id="47">__________</span>)<br>
판정 의문문 (<span class="highlight" data-question-id="48">__________</span>)</p>

<p><strong>변천</strong><br>
경상도에는 '-오/-아'의 구분이 남아 있음</p>
`;

            return rawContent;
        }

        // Stage 1: 딥리서치 초기화
        function initStage1() {
            currentStage = 1;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            answeredQuestions.clear();
            currentTime = 300;
            startTime = Date.now();

            // UI 업데이트
            document.querySelector('.title').textContent = '중세국어의 특징 - 문법 파트';
            document.getElementById('stage-subtitle').textContent = '1단계: 딥리서치';
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();
            document.getElementById('total-questions').textContent = STAGE1_QUESTIONS.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('active');
            });

            // 지문 표시
            const passageHTML = generateStage1Content();
            document.getElementById('passage-container').innerHTML = passageHTML;

            // 하이라이트 클릭 이벤트 추가
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(highlight => {
                highlight.addEventListener('click', function() {
                    const questionId = parseInt(this.getAttribute('data-question-id'));
                    if (!answeredQuestions.has(questionId)) {
                        showQuestion(questionId, this);
                    }
                });
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            // 학습 완료 버튼 추가
            if (typeof addCompleteLearningButton === 'function') {
                setTimeout(() => addCompleteLearningButton(), 500);
            }
            startTimer();
        }

        // 질문 모달 표시
        function showQuestion(questionId, highlightElement) {
            const question = STAGE1_QUESTIONS.find(q => q.id === questionId);
            if (!question) return;

            const modalOverlay = document.getElementById('modal-overlay');
            const modalHeader = document.getElementById('modal-header');
            const modalOptions = document.getElementById('modal-options');
            const modalContent = document.getElementById('modal-content');

            // 모달 초기화
            modalContent.classList.remove('correct-feedback', 'incorrect-feedback');

            // 질문 헤더
            modalHeader.textContent = question.context;

            // 선지 셔플
            const options = shuffleArray([
                { text: question.correctAnswer, isCorrect: true },
                { text: question.wrongAnswer, isCorrect: false }
            ]);

            // 선지 버튼 생성
            modalOptions.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => checkAnswer(questionId, option.isCorrect, button, highlightElement);
                modalOptions.appendChild(button);
            });

            // 모달 표시
            modalOverlay.classList.add('active');

            // 모달 위치 설정 (하이라이트 근처에 배치하되 화면 밖으로 나가지 않도록)
            const highlightRect = highlightElement.getBoundingClientRect();
            const modalWidth = 500; // max-width
            const modalHeight = 300; // 대략적인 높이

            // 하이라이트 오른쪽에 배치 시도
            let left = highlightRect.right + 20;
            let top = highlightRect.top;

            // 오른쪽 공간이 부족하면 왼쪽에 배치
            if (left + modalWidth > window.innerWidth) {
                left = highlightRect.left - modalWidth - 20;
            }

            // 왼쪽도 공간이 부족하면 중앙에 배치
            if (left < 0) {
                left = (window.innerWidth - modalWidth) / 2;
            }

            // 위쪽으로 벗어나지 않도록
            if (top < 20) {
                top = 20;
            }

            // 아래쪽으로 벗어나지 않도록
            if (top + modalHeight > window.innerHeight) {
                top = window.innerHeight - modalHeight - 20;
            }

            modalContent.style.left = left + 'px';
            modalContent.style.top = top + 'px';

            // 모달 드래그 설정 (한 번만 실행)
            setupModalDrag();
        }

        // 답변 체크
        function checkAnswer(questionId, isCorrect, button, highlightElement) {
            const buttons = document.querySelectorAll('.option-button');
            const modalContent = document.getElementById('modal-content');

            // 버튼 비활성화
            buttons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.classList.add('correct');
                modalContent.classList.add('correct-feedback');
                highlightElement.classList.add('correct', 'answered');
                highlightElement.textContent = button.textContent;
                correctCount++;
                addTime(10);
            } else {
                button.classList.add('incorrect');
                modalContent.classList.add('incorrect-feedback');
                highlightElement.classList.add('incorrect', 'answered');

                // 정답 표시
                const correctButton = Array.from(buttons).find(btn => !btn.classList.contains('incorrect'));
                if (correctButton) {
                    correctButton.classList.add('correct');
                    highlightElement.textContent = correctButton.textContent;
                }

                wrongCount++;
                subtractTime(40);
            }

            // 답변한 질문 추가
            answeredQuestions.add(questionId);
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();

            // 모달 닫기
            setTimeout(() => {
                document.getElementById('modal-overlay').classList.remove('active');

                // 모든 질문 완료 확인
                if (answeredQuestions.size === STAGE1_QUESTIONS.length) {
                    setTimeout(() => endStage(), 500);
                }
            }, 1500);
        }

        // Stage 2: OX 학습 초기화
        function initStage2() {
            clearInterval(timerInterval);

            currentStage = 2;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage2WrongQuestions = [];

            // OX 문제 셔플 (매번 새로운 순서로)
            shuffledStage2Questions = shuffleArray(STAGE2_QUESTIONS);

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '2단계: OX 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage2Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('completed');
                if (index === 1) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showOXQuestion();
            startTimer();
        }

        // OX 문제 표시
        function showOXQuestion() {
            const question = shuffledStage2Questions[currentQuestionIndex];

            document.getElementById('passage-container').innerHTML = `
                <div class="ox-container">
                    <div class="ox-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage2Questions.length}</div>
                        <div class="question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="ox-options">
                            <button class="ox-option-button" onclick="checkOXAnswer('O')">O</button>
                            <button class="ox-option-button" onclick="checkOXAnswer('X')">X</button>
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="ox-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // OX 답변 체크
        function checkOXAnswer(answer) {
            const question = shuffledStage2Questions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.ox-option-button');
            const isCorrect = answer === question.answer;

            buttons.forEach(button => {
                button.disabled = true;
                if (button.textContent === answer) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(15);

                // 틀린 문제 저장
                stage2WrongQuestions.push({
                    question: question.text,
                    userAnswer: answer,
                    correctAnswer: question.answer,
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('ox-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage2Questions.length) {
                    endStage();
                } else {
                    showOXQuestion();
                }
            }, 2000);
        }

        // Stage 3: 객관식 학습 초기화
        function initStage3() {
            clearInterval(timerInterval);

            currentStage = 3;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage3WrongQuestions = [];

            // 객관식 문제 셔플 (매번 새로운 순서로)
            shuffledStage3Questions = shuffleArray(STAGE3_QUESTIONS);

            // 각 문제에 대해 4지선다 미리 생성
            shuffledStage3Questions.forEach(q => {
                q.selectedOptions = generate4Options(q.options, q.correct);
            });

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '3단계: 객관식 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage3Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < 2) dot.classList.add('completed');
                if (index === 2) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showMCQQuestion();
            startTimer();
        }

        // 6지선다에서 4지선다 생성 (정답 포함)
        function generate4Options(allOptions, correctIndex) {
            const correctOption = allOptions[correctIndex];
            const otherOptions = allOptions.filter((_, i) => i !== correctIndex);

            // 오답 중에서 3개 랜덤 선택
            const shuffledOthers = shuffleArray(otherOptions);
            const selected3Others = shuffledOthers.slice(0, 3);

            // 정답 위치를 0, 1, 2, 3 중 랜덤하게 선택
            const targetCorrectPosition = Math.floor(Math.random() * 4);

            // 4개 선지 배열 생성 (정답을 랜덤 위치에 배치)
            const final4Options = [];
            let wrongIndex = 0;

            for (let i = 0; i < 4; i++) {
                if (i === targetCorrectPosition) {
                    final4Options.push(correctOption);
                } else {
                    final4Options.push(selected3Others[wrongIndex]);
                    wrongIndex++;
                }
            }

            return {
                options: final4Options,
                correctIndex: targetCorrectPosition
            };
        }

        // 객관식 문제 표시
        function showMCQQuestion() {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;

            const optionsHTML = options.map((opt, index) => `
                <button class="mcq-option-button" onclick="checkMCQAnswer(${index})">
                    <span class="option-number">${index + 1}</span>
                    <span class="option-text">${convertMarkdownToHTML(opt)}</span>
                </button>
            `).join('');

            document.getElementById('passage-container').innerHTML = `
                <div class="mcq-container">
                    <div class="mcq-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage3Questions.length}</div>
                        <div class="mcq-question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="mcq-options">
                            ${optionsHTML}
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="mcq-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // 객관식 답변 체크
        function checkMCQAnswer(selectedIndex) {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;
            const buttons = document.querySelectorAll('.mcq-option-button');
            const isCorrect = selectedIndex === correctIndex;

            buttons.forEach((button, index) => {
                button.disabled = true;
                if (index === selectedIndex) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (index === correctIndex && !isCorrect) {
                    button.classList.add('correct');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(20);

                // 틀린 문제 저장
                stage3WrongQuestions.push({
                    question: question.text,
                    userAnswer: options[selectedIndex],
                    correctAnswer: options[correctIndex],
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('mcq-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage3Questions.length) {
                    endStage();
                } else {
                    showMCQQuestion();
                }
            }, 2000);
        }

        // 단계 종료
        function endStage() {
            clearInterval(timerInterval);

            const endTime = Date.now();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;

            let totalQuestions = 0;
            if (currentStage === 1) {
                totalQuestions = STAGE1_QUESTIONS.length;
            } else if (currentStage === 2) {
                totalQuestions = shuffledStage2Questions.length;
            } else if (currentStage === 3) {
                totalQuestions = shuffledStage3Questions.length;
            }

            const accuracy = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 100;
            const score = (accuracy / 100) * 10; // 10점 만점으로 환산

            // 결과 저장 (레거시)
            allStageResults[`stage${currentStage}`] = {
                totalQuestions,
                correctCount,
                wrongCount,
                accuracy,
                totalTime
            };

            // 새로운 stageResults에 저장 (틀린 문제 포함)
            const wrongQuestionsArray = currentStage === 2 ? stage2WrongQuestions :
                                       currentStage === 3 ? stage3WrongQuestions : [];

            stageResults[`stage${currentStage}`] = {
                correct: correctCount,
                wrong: wrongCount,
                score: score,
                elapsedTime: totalTime,
                wrongQuestions: wrongQuestionsArray
            };

            // 결과 화면 표시
            document.getElementById('result-title').textContent = `${currentStage}단계 학습 완료!`;
            document.getElementById('progress-stat').textContent = '100%';
            document.getElementById('accuracy-stat').textContent = accuracy + '%';
            document.getElementById('correct-stat').textContent = correctCount;
            document.getElementById('wrong-stat').textContent = wrongCount;
            document.getElementById('time-stat').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // 버튼 업데이트
            const resultButtons = document.querySelector('.result-buttons');
            let buttonsHTML = '<button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>';

            // Stage 2와 Stage 3의 경우 틀린 문제 보기 버튼 추가
            if (currentStage === 2 && stage2WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage2()">틀린 문제 보기 (${stage2WrongQuestions.length}문제)</button>`;
            } else if (currentStage === 3 && stage3WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage3()">틀린 문제 보기 (${stage3WrongQuestions.length}문제)</button>`;
            }

            // 다음 단계 버튼 (Stage 3이면 "전체 결과 보기")
            if (currentStage === 3) {
                buttonsHTML += '<button class="result-button primary" onclick="showFinalResults()">전체 결과 보기</button>';
            } else {
                buttonsHTML += '<button class="result-button primary" onclick="nextStage()">다음 단계로</button>';
            }

            resultButtons.innerHTML = buttonsHTML;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('result-screen').classList.add('active');
        }

        // 다시 학습하기
        function restartStage() {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('result-screen').classList.remove('active');

            if (currentStage === 1) {
                initStage1();
            } else if (currentStage === 2) {
                initStage2();
            } else if (currentStage === 3) {
                initStage3();
            }
        }

        // 다음 단계로
        function nextStage() {
            document.getElementById('main-content').style.display = 'block';

            if (currentStage === 1) {
                initStage2();
            } else if (currentStage === 2) {
                initStage3();
            } else if (currentStage === 3) {
                // 모든 단계 완료
                alert('모든 학습을 완료했습니다!');
                initStage1();
            }
        }

        // Stage 2 틀린 문제 보기
        function showWrongQuestionsStage2() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage2')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage2" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>2단계: OX - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage2()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage2"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage2');
            content.innerHTML = stage2WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage2').classList.add('active');
        }

        // Stage 2 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage2() {
            document.getElementById('wrong-questions-modal-stage2').classList.remove('active');
        }

        // Stage 3 틀린 문제 보기
        function showWrongQuestionsStage3() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage3')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage3" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>3단계: 객관식 - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage3()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage3"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage3');
            content.innerHTML = stage3WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage3').classList.add('active');
        }

        // Stage 3 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage3() {
            document.getElementById('wrong-questions-modal-stage3').classList.remove('active');
        }

        // 시간 포맷팅 함수
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 전체 결과 보기
        function showFinalResults() {
        // 학습 완료 시스템을 위한 데이터 export
        window.learningResultData = {
            totalStages: totalStages || 5,
            totalCorrect: totalCorrect || 0,
            totalWrong: totalWrong || 0,
            totalAccuracy: totalAccuracy || 0,
            totalScore: totalScore || 0,
            totalElapsedTime: totalElapsedTime || (Date.now() - globalStartTime),
            stagesDetail: stageResults || {}
        };
        console.log('학습 데이터 export:', window.learningResultData);

            // 기존 타이머 정리
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // 결과 화면과 메인 컨텐츠 숨기기
            document.getElementById('result-screen').classList.remove('active');

            // 전체 결과 계산
            const totalCorrect = stageResults.stage1.correct + stageResults.stage2.correct + stageResults.stage3.correct;
            const totalWrong = stageResults.stage1.wrong + stageResults.stage2.wrong + stageResults.stage3.wrong;
            const overallAccuracy = (totalCorrect + totalWrong) > 0 ?
                                   Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;
            const totalScore = stageResults.stage1.score + stageResults.stage2.score + stageResults.stage3.score;
            const totalElapsedTime = stageResults.stage1.elapsedTime + stageResults.stage2.elapsedTime + stageResults.stage3.elapsedTime;

            // 스테이지명 맵핑
            const stageNames = {
                stage1: '1단계: 딥리서치',
                stage2: '2단계: OX 학습',
                stage3: '3단계: 객관식 학습'
            };

            // HTML 생성
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">🎉 학습 완료!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">모든 학습 단계를 완료했습니다.</p>
                    </div>

                    <!-- 전체 학습 결과 -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">📊 전체 학습 결과</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총점</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}점</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #7f8c8d;">/ 30.0점</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">전체 정답률</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">정답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">오답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총 소요 시간</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${formatTime(totalElapsedTime)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 단계별 결과 -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">📈 단계별 학습 결과</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // 각 단계별 결과 카드
            ['stage1', 'stage2', 'stage3'].forEach(stageKey => {
                const result = stageResults[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey]}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답률:</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답:</span>
                                <strong>${result.correct}개</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">오답:</span>
                                <strong style="color: #e74c3c;">${result.wrong}회</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">점수:</span>
                                <strong style="color: #3498db;">${result.score.toFixed(1)}점</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">소요 시간:</span>
                                <strong>${formatTime(result.elapsedTime)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
        </div>

        <!-- 틀린 문제 상세 정보 -->
        <h2 style="margin-top: 50px; margin-bottom: 25px; color: #2c3e50; font-size: 24px; font-weight: 600;">❌ 틀린 문제 상세</h2>
`;

            // Stage 2와 Stage 3의 틀린 문제 표시
            let hasWrongQuestions = false;

            // Stage 2 틀린 문제
            if (stageResults.stage2.wrongQuestions && stageResults.stage2.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #856404; margin-bottom: 20px; font-size: 20px;">📝 2단계: OX - 틀린 문제</h3>
`;
                stageResults.stage2.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // Stage 3 틀린 문제
            if (stageResults.stage3.wrongQuestions && stageResults.stage3.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #721c24; margin-bottom: 20px; font-size: 20px;">🔤 3단계: 객관식 - 틀린 문제</h3>
`;
                stageResults.stage3.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // 틀린 문제가 없는 경우
            if (!hasWrongQuestions) {
                html += `
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 12px; padding: 25px; text-align: center;">
            <p style="color: #155724; font-size: 18px; font-weight: 600;">🎉 완벽합니다! 모든 문제를 맞추셨습니다!</p>
        </div>
`;
            }

            html += `
        <!-- 액션 버튼 -->
        <div style="text-align: center; margin-top: 50px; padding-bottom: 50px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveFinalResultsAsImage()" style="
                background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 211, 153, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 211, 153, 0.4)';">
                📷 이미지로 저장
            </button>
            <button onclick="location.reload()" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.4)';">
                🔄 처음부터 다시하기
            </button>
        </div>
    </div>
`;

            // HTML 설정 및 표시
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('main-content').style.display = 'block';
        }

        // 최종 결과 페이지 이미지 저장
        function saveFinalResultsAsImage() {
            if (typeof htmlToImage === 'undefined') {
                alert('이미지 라이브러리가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const mainContent = document.getElementById('main-content');

            // 저장 버튼들 임시 숨김
            const buttons = mainContent.querySelectorAll('button');
            const buttonStates = Array.from(buttons).map(btn => btn.style.display);
            buttons.forEach(btn => btn.style.display = 'none');

            // 약간의 딜레이 후 캡처
            setTimeout(() => {
                htmlToImage.toBlob(mainContent, {
                    backgroundColor: '#f5f7fa',
                    pixelRatio: 2,
                    cacheBust: true
                }).then(blob => {
                    // 버튼 다시 표시
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);

                    // 이미지 다운로드
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `중세국어_문법_최종결과_${timestamp}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }).catch(err => {
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);
                    console.error('이미지 저장 실패:', err);
                    alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
                });
            }, 100);
        }

        // 페이지 로드 시 모달 드래그 설정 초기화
        window.onload = function() {
            // 모달 드래그 설정을 페이지 로드 시 한 번만 실행
            setupModalDrag();
            initStage1();
        };
    </script>

    <!-- 학습 완료 시스템 -->
    <script src="../js/config.js"></script>
    <script src="../js/learning-complete.js"></script>
</body>
</html>