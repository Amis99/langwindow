<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>중세 국어 음운 파트</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;500;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
        }

        .header-left {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .stage-indicator {
            display: flex;
            gap: 10px;
        }

        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.3s ease;
        }

        .stage-dot.active {
            background: #3498db;
            transform: scale(1.3);
        }

        .stage-dot.completed {
            background: #27ae60;
        }

        .question-counter {
            font-size: 18px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Timer Bar */
        .timer-container {
            width: 300px;
            height: 24px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 12px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }

        .timer-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* Main Content */
        .main-content {
            margin-top: 100px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 600px;
            position: relative;
        }

        .passage-container {
            font-size: 18px;
            line-height: 2;
            color: #2c3e50;
            word-break: keep-all;
        }

        .passage-container h2 {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .passage-container h3 {
            font-size: 20px;
            font-weight: 600;
            color: #34495e;
            margin: 25px 0 15px 0;
        }

        .passage-container strong {
            font-weight: 700;
            color: #2c3e50;
        }

        .passage-container ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        .passage-container li {
            margin: 8px 0;
            line-height: 1.8;
        }

        .passage-container table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }

        .passage-container table th,
        .passage-container table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        .passage-container table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        /* Highlight Style */
        .highlight {
            background: linear-gradient(120deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline;
            position: relative;
        }

        .highlight:hover {
            background: linear-gradient(120deg, #fdcb6e 0%, #fab1a0 100%);
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(253, 203, 110, 0.5);
        }

        .highlight.answered {
            background: linear-gradient(120deg, #dfe6e9 0%, #b2bec3 100%);
            cursor: default;
        }

        .highlight.answered:hover {
            transform: none;
            box-shadow: none;
        }

        .highlight.correct {
            background: linear-gradient(120deg, #55efc4 0%, #00b894 100%);
        }

        .highlight.incorrect {
            background: linear-gradient(120deg, #fab1a0 0%, #ff7675 100%);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: fixed;
            cursor: move;
            transition: opacity 0.3s ease;
        }

        .modal-content.dragging {
            opacity: 0.95;
            user-select: none;
        }

        .modal-content.correct-feedback {
            border: 3px solid #00b894;
            animation: correctPulse 0.6s ease;
        }

        .modal-content.incorrect-feedback {
            border: 3px solid #ff7675;
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(0, 184, 148, 0.6); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-button {
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-family: 'Noto Serif KR', serif;
        }

        .option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Result Screen */
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 100px;
        }

        .result-screen.active {
            display: block;
        }

        body:has(.result-screen.active) .timer-container {
            display: none !important;
        }

        .result-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-box {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #3498db;
        }

        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .result-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .result-button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .result-button.primary {
            background: #3498db;
            color: white;
        }

        .result-button.primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .result-button.secondary {
            background: #95a5a6;
            color: white;
        }

        .result-button.secondary:hover {
            background: #7f8c8d;
        }

        /* OX Learning Styles (Stage 2) */
        .ox-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }

        .ox-question-card {
            width: 100%;
            max-width: 800px;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .question-number {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 30px;
            line-height: 1.4;
        }

        .ox-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .ox-option-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 30px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ox-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: scale(1.05);
        }

        .ox-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .ox-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
            animation: correctPulse 0.6s ease;
        }

        .ox-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: incorrectShake 0.5s ease;
        }

        /* Multiple Choice Styles (Stage 3) */
        .mcq-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .mcq-question-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .mcq-question-text {
            font-size: 20px;
            line-height: 1.8;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .mcq-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mcq-option-button {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mcq-option-button:hover:not(:disabled) {
            background: #e9ecef;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .mcq-option-button:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .mcq-option-button .option-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            font-weight: 600;
            flex-shrink: 0;
        }

        .mcq-option-button .option-text {
            flex: 1;
            color: #2c3e50;
        }

        .mcq-option-button.correct {
            background: #d4edda;
            border-color: #27ae60;
        }

        .mcq-option-button.correct .option-number {
            background: #27ae60;
        }

        .mcq-option-button.incorrect {
            background: #f8d7da;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .mcq-option-button.incorrect .option-number {
            background: #f44336;
        }

        /* Feedback Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Wrong Questions Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: fixed;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            font-size: 24px;
            color: #2c3e50;
            margin: 0;
        }

        .close-modal-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-modal-btn:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 10px 0;
        }

        .wrong-question-item {
            background: #f8f9fa;
            border-left: 4px solid #dc3545;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        .wrong-question-item h4 {
            color: #dc3545;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .wrong-question-item p {
            margin: 8px 0;
            line-height: 1.6;
        }

        .wrong-question-item .question-text {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .wrong-question-item .user-answer {
            color: #dc3545;
            background: #fff5f5;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .wrong-question-item .correct-answer {
            color: #28a745;
            background: #f0fff4;
            padding: 8px 12px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px 0;
        }

        .explanation-text {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 16px;
            color: #856404;
            text-align: center;
            line-height: 1.6;
        }

        .question-explanation {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px;
            color: #856404;
            margin-top: 10px;
        }

        .question-explanation strong {
            display: block;
            margin-bottom: 5px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .title {
                font-size: 20px;
            }

            .subtitle {
                font-size: 12px;
            }

            .progress-info {
                width: 100%;
                justify-content: space-between;
                gap: 10px;
            }

            .question-counter {
                font-size: 14px;
            }

            .timer-container {
                width: 200px;
                height: 18px;
            }

            .stage-dot {
                width: 10px;
                height: 10px;
            }

            .modal-content {
                padding: 20px;
                max-width: 90%;
            }

            .option-button {
                padding: 12px 15px;
                font-size: 14px;
            }

            .ox-question-card {
                padding: 20px;
            }

            .question-text {
                font-size: 18px;
                margin-bottom: 20px;
            }

            .ox-option-button {
                padding: 20px 15px;
                font-size: 24px;
            }

            .mcq-question-card {
                padding: 20px;
            }

            .mcq-question-text {
                font-size: 16px;
                line-height: 1.6;
            }

            .mcq-option-button {
                padding: 12px 15px;
                font-size: 14px;
                gap: 12px;
            }

            .mcq-option-button .option-number {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        /* Mobile Phone Size */
        @media (max-width: 480px) {
            .header {
                padding: 10px;
                gap: 8px;
            }

            .header-left {
                gap: 3px;
            }

            .title {
                font-size: 16px;
                font-weight: 600;
            }

            .subtitle {
                font-size: 11px;
            }

            .progress-info {
                gap: 8px;
            }

            .question-counter {
                font-size: 12px;
                font-weight: 400;
            }

            .timer-container {
                width: 150px;
                height: 14px;
            }

            .stage-indicator {
                gap: 6px;
            }

            .stage-dot {
                width: 8px;
                height: 8px;
            }

            .stage-dot.active {
                transform: scale(1.2);
            }

            .main-content {
                margin-top: 80px;
                padding: 20px;
            }

            .passage-container {
                font-size: 16px;
                line-height: 1.8;
            }
        }
    </style>

    <!-- html-to-image CDN -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="title">중세 국어 음운 파트</div>
                <div class="subtitle" id="stage-subtitle">1단계: 딥리서치</div>
            </div>
            <div class="progress-info">
                <div class="stage-indicator">
                    <div class="stage-dot active"></div>
                    <div class="stage-dot"></div>
                    <div class="stage-dot"></div>
                </div>
                <div class="question-counter">
                    문제: <span id="current-question">0</span> / <span id="total-questions">0</span>
                </div>
                <div class="timer-container">
                    <div class="timer-bar" id="timer-bar"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="passage-container" id="passage-container"></div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay" id="modal-overlay">
            <div class="modal-content" id="modal-content">
                <div class="modal-header" id="modal-header"></div>
                <div class="modal-options" id="modal-options"></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div class="result-screen" id="result-screen">
            <h2 class="result-title" id="result-title">1단계 학습 완료!</h2>
            <div class="result-stats">
                <div class="stat-box">
                    <div class="stat-value" id="progress-stat">0%</div>
                    <div class="stat-label">진행률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="accuracy-stat">0%</div>
                    <div class="stat-label">정답률</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="correct-stat">0</div>
                    <div class="stat-label">맞힌 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="wrong-stat">0</div>
                    <div class="stat-label">틀린 문제</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="time-stat">0:00</div>
                    <div class="stat-label">소요 시간</div>
                </div>
            </div>
            <div class="result-buttons">
                <button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>
                <button class="result-button primary" onclick="nextStage()">다음 단계로</button>
            </div>
        </div>
    </div>

    <script>
        // 모달 드래그 관련 변수
        let isDragging = false;
        let dragStartX, dragStartY;
        let modalStartX, modalStartY;
        let dragListenersAdded = false;

        // 현재 단계
        let currentStage = 1;

        // 전체 학습 결과 저장소 (레거시)
        const allStageResults = {
            stage1: null,
            stage2: null,
            stage3: null
        };

        // 새로운 stageResults 객체 (틀린 문제 포함)
        const stageResults = {
            stage1: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage2: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] },
            stage3: { correct: 0, wrong: 0, score: 0, elapsedTime: 0, wrongQuestions: [] }
        };

        // Stage 2와 Stage 3의 wrongQuestions 추적용 배열
        let stage2WrongQuestions = [];
        let stage3WrongQuestions = [];

        // 전역 시작 시간
        let globalStartTime = Date.now();

        // Stage 1: 딥리서치 - 2-choice 질문 데이터
        const STAGE1_QUESTIONS = [
            { id: 1, context: "자음", correctAnswer: "ㅿ, ㆁ, ㆆ", wrongAnswer: "ㆆ, ㅿ, ㅸ" },
            { id: 2, context: "모음", correctAnswer: "ㆍ", wrongAnswer: "ㅔ" },
            { id: 3, context: "평성, 거성, 상성의 성조를", correctAnswer: "방점", wrongAnswer: "반점" },
            { id: 4, context: "존재", correctAnswer: "어두 자음군", wrongAnswer: "어말 자음군" },
            { id: 5, context: "현상 잘 지킴", correctAnswer: "모음 조화", wrongAnswer: "자음 동화" },
            { id: 6, context: "초성자와 중성자의 기본자는", correctAnswer: "상형", wrongAnswer: "가획" },
            { id: 7, context: "초성자 17자는 기본자에 획을 더하거나", correctAnswer: "가획", wrongAnswer: "이체" },
            { id: 8, context: "모양을 달리하는", correctAnswer: "이체", wrongAnswer: "병서" },
            { id: 9, context: "중성자 11자는 기본자를", correctAnswer: "한 번 또는 두 번 합하여", wrongAnswer: "발음 기관에 따라" },
            { id: 10, context: "초성자로 사용하였다", correctAnswer: "병서, 연서", wrongAnswer: "상형, 가획" },
            { id: 11, context: "병서 :", correctAnswer: "옆으로", wrongAnswer: "아래로" },
            { id: 12, context: "연서 :", correctAnswer: "아래로", wrongAnswer: "옆으로" },
            { id: 13, context: "어금닛소리 이체자", correctAnswer: "ㆁ", wrongAnswer: "ㄹ" },
            { id: 14, context: "혓소리 이체자", correctAnswer: "ㄹ", wrongAnswer: "ㅿ" },
            { id: 15, context: "잇소리 이체자", correctAnswer: "ㅿ", wrongAnswer: "ㅇ" },
            { id: 16, context: "재출자", correctAnswer: "ㅛ, ㅑ, ㅠ, ㅕ", wrongAnswer: "ㅚ, ㅐ, ㅟ, ㅔ" },
            { id: 17, context: "종성에는", correctAnswer: "초성 글자를 다시 쓴다", wrongAnswer: "새로운 글자를 만든다" },
            { id: 18, context: "반치음(ㅿ) 분류:", correctAnswer: "잇소리", wrongAnswer: "혓소리" },
            { id: 19, context: "반치음(ㅿ) 음가: 'ㅅ'의", correctAnswer: "울림소리 [z]", wrongAnswer: "안울림소리 [s]" },
            { id: 20, context: "반치음(ㅿ) 변천:", correctAnswer: "16세기 중반", wrongAnswer: "17세기 중반" },
            { id: 21, context: "한ᅀᅮᆷ >", correctAnswer: "한숨", wrongAnswer: "한음" },
            { id: 22, context: "'ㅿ'이 소실되면서 현대", correctAnswer: "ㅅ' 불규칙활용", wrongAnswer: "'ㅂ' 불규칙활용" },
            { id: 23, context: "순경음비읍(ㅸ) 분류:", correctAnswer: "연서(이어쓰기)", wrongAnswer: "병서(나란히쓰기)" },
            { id: 24, context: "순경음비읍(ㅸ) 음가: 'ㅂ'의", correctAnswer: "울림소리 [β]", wrongAnswer: "된소리 [p']" },
            { id: 25, context: "① ㅸ + ㅏ/ㅓ >", correctAnswer: "반모음 ㅗ/ㅜ[w]", wrongAnswer: "단모음 ㅗ/ㅜ" },
            { id: 26, context: "② ㅸ + ㅡ/ㅣ ->", correctAnswer: "단모음 ㅗ/ㅜ", wrongAnswer: "반모음 ㅗ/ㅜ[w]" },
            { id: 27, context: "'ㅸ'이 소실되면서 현대", correctAnswer: "ㅂ' 불규칙활용", wrongAnswer: "'ㅅ' 불규칙활용" },
            { id: 28, context: "옛이응(ㆁ) 음가:", correctAnswer: "음가 있음 [ŋ]", wrongAnswer: "음가 없음" },
            { id: 29, context: "옛이응(ㆁ) 활용:", correctAnswer: "받침에 쓰임", wrongAnswer: "첫소리에 쓰임" },
            { id: 30, context: "이응(ㅇ) 음가:", correctAnswer: "음가 없음", wrongAnswer: "음가 있음 [ŋ]" },
            { id: 31, context: "아래아(ㆍ) 분류: 기본자(", correctAnswer: "하늘", wrongAnswer: "땅" },
            { id: 32, context: "아래아(ㆍ) 음가: 'ㅏ'와", correctAnswer: "ㅗ'", wrongAnswer: "'ㅜ'" },
            { id: 33, context: "아래아 변천 - 둘째 음절의 'ㆍ'가 'ㅡ'로 변함:", correctAnswer: "16세기", wrongAnswer: "18세기" },
            { id: 34, context: "아래아 변천 - 첫째 음절의 'ㆍ'가 'ㅏ'로 변함:", correctAnswer: "18세기", wrongAnswer: "16세기" },
            { id: 35, context: "표기 상실로 모음 조화가 흔들림:", correctAnswer: "1933년", wrongAnswer: "1905년" },
            { id: 36, context: "방점 역할:", correctAnswer: "성조(음의 높낮이)", wrongAnswer: "음장(소리의 길이)" },
            { id: 37, context: "방점 방법: 글자", correctAnswer: "왼쪽", wrongAnswer: "오른쪽" },
            { id: 38, context: "평성: 방점", correctAnswer: "없음", wrongAnswer: "하나" },
            { id: 39, context: "거성: 방점", correctAnswer: "하나", wrongAnswer: "둘" },
            { id: 40, context: "상성: 방점", correctAnswer: "둘", wrongAnswer: "없음" },
            { id: 41, context: "방점 소멸:", correctAnswer: "16세기 말", wrongAnswer: "17세기 말" },
            { id: 42, context: "은 현대에 긴소리로 변함", correctAnswer: "상성", wrongAnswer: "거성" },
            { id: 43, context: "어두자음군 뜻 :", correctAnswer: "첫소리(어두)", wrongAnswer: "끝소리(어말)" },
            { id: 44, context: "어두자음군 발음:", correctAnswer: "자음 모두 발음함", wrongAnswer: "뒤의 자음만 발음함" },
            { id: 45, context: "어두자음군 변천 :", correctAnswer: "17세기 후", wrongAnswer: "18세기 후" },
            { id: 46, context: "현대 국어에 흔적이 남아 있음 예)", correctAnswer: "조ᄡᆞᆯ[좁쌀]", wrongAnswer: "머리빗" },
            { id: 47, context: "'ㅣ'는", correctAnswer: "중성모음", wrongAnswer: "양성모음" },
            { id: 48, context: "모음 조화 변천 - 모음 조화 파괴가 보임:", correctAnswer: "17세기 초", wrongAnswer: "18세기 초" },
            { id: 49, context: "ㄷ:", correctAnswer: "혓소리", wrongAnswer: "잇소리" },
            { id: 50, context: "ㅅ:", correctAnswer: "잇소리", wrongAnswer: "혓소리" },
            { id: 51, context: "각자병서", correctAnswer: "ㄲ, ㄸ, ㅃ, ㅆ, ㅉ 등", wrongAnswer: "ㅳ, ㅶ, ㅵ 등" },
            { id: 52, context: "각자병서는", correctAnswer: "첫소리", wrongAnswer: "끝소리" },
            { id: 53, context: "합용병서", correctAnswer: "ㅳ, ㅶ, ㅵ, ㅲ 등", wrongAnswer: "ㄲ, ㄸ, ㅃ, ㅆ 등" },
            { id: 54, context: "'ㅂ'계, 'ㅄ'계는", correctAnswer: "17세기", wrongAnswer: "1933년" },
            { id: 55, context: "'ㅅ'계는", correctAnswer: "1933년", wrongAnswer: "17세기" }
        ];

        // Stage 2: OX 학습 데이터
        const STAGE2_QUESTIONS = [
            { id: 1, text: "옛이응(ㆁ)은 [ŋ] 음가를 가지고 주로 종성에 쓰였고, 이응(ㅇ)은 음가 없이 초성의 빈자리를 채웠다.", answer: "O", explanation: "중세 국어에서는 두 'ㅇ'을 구분했습니다. 'ㆁ(옛이응)'은 '셰조ᇰ'의 받침처럼 [ŋ] 소릿값을 가졌지만, 'ㅇ'은 '엉'의 첫소리처럼 소리 없이 모음의 빈자리를 채우는 기호였습니다." },
            { id: 2, text: "'반치음(ㅿ)'은 'ㅅ'의 울림소리([z])로 추정되며, 16세기 중반에 소실되었다.", answer: "O", explanation: "'ㅿ'은 'ㅅ'과 발음 위치는 비슷하지만 성대가 울리는 유성음([z])이었을 것으로 봅니다. 이 소리는 16세기 중반이 되면 점차 사라지게 됩니다." },
            { id: 3, text: "'서르', '구무'와 같은 단어는 하나의 체언 내에서 모음 조화가 지켜진 예이다.", answer: "O", explanation: "'서르'는 음성 모음 'ㅓ, ㅡ'끼리, '구무'는 음성 모음 'ㅜ, ㅜ'끼리 어울려 단어를 이루고 있습니다. 이처럼 한 단어 안에서도 양성 모음은 양성끼리, 음성 모음은 음성끼리 짝을 맞추는 모음 조화가 잘 지켜졌습니다." },
            { id: 4, text: "1933년 한글맞춤법통일안에서 'ㅅ'계 합용병서가 폐지되었다.", answer: "O", explanation: "어두자음군에 쓰이던 'ㅂ'계, 'ㅄ'계 합용병서는 17세기에 된소리로 바뀌며 먼저 사라졌고, 된소리 표기에 쓰이던 'ㅅ'계 합용병서(예: ᄭ, ᄯ)는 1933년 한글맞춤법통일안에서 된소리 부호(ㄲ, ㄸ 등)로 표기가 정리되면서 폐지되었습니다." },
            { id: 5, text: "중세 국어에서는 '몯[못하다]'의 'ㄷ' 받침과 '못[연못]'의 'ㅅ' 받침이 소리상으로 구별되었다.", answer: "O", explanation: "현대 국어에서는 받침 'ㄷ'과 'ㅅ' 모두 [ㄷ]으로 발음되지만, 중세 국어에서는 '몯'과 '못'처럼 'ㄷ' 받침과 'ㅅ' 받침을 표기와 발음에서 모두 다르게 인식하고 사용했습니다." },
            { id: 6, text: "'아ᅀᆞ'가 '아우'로 변하는 과정에는 'ㅿ'의 소실과 원순모음화가 관여했다.", answer: "O", explanation: "'아ᅀᆞ'에서 'ㅿ'이 사라져 '아ᄋᆞ'가 되고, 모음 '으'로 변했다가('아으'), 입술을 둥글게 하는 원순모음화의 영향을 받아 최종적으로 '아우'가 되었습니다." },
            { id: 7, text: "어두자음군은 17세기 이후 된소리로 바뀌었으며, '조ᄡᆞᆯ'이 '좁쌀'로 변한 것에서 그 흔적을 찾을 수 있다.", answer: "O", explanation: "'ᄡᆞᆯ'의 첫소리 'ㅄ'이 17세기 이후 된소리 'ㅆ'으로 바뀌면서 발음이 변했습니다. '좁쌀'의 [좁쌀] 발음은 '조(米)'와 'ᄡᆞᆯ(米)'이 합쳐진 단어에서 어두자음군의 흔적이 남아있는 예입니다." },
            { id: 8, text: "'ᄫ + ㅡ'는 단모음 'ㅜ'로 변했다. (예: ᄫᅳ > 우)", answer: "O", explanation: "순경음 비읍(ㅸ)은 뒤에 모음 'ㅡ'나 'ㅣ'가 오면 입술을 둥글게 하는 단모음 'ㅜ'나 'ㅗ'로 변하는 특징이 있었습니다." },
            { id: 9, text: "각자병서는 15세기 후반까지 초성 위치에서만 사용되었다.", answer: "O", explanation: "'ㄲ, ㄸ, ㅃ' 등 같은 자음을 나란히 쓴 각자병서는 된소리를 표기하기 위해 단어의 첫머리, 즉 초성에만 사용되다가 15세기 후반에 잠시 쓰이지 않게 되었습니다." },
            { id: 10, text: "모음 조화의 파괴 현상은 17세기 초부터 나타나기 시작했다.", answer: "O", explanation: "15세기에는 매우 엄격하게 지켜지던 모음 조화가 17세기에 접어들면서부터 점차 흔들리는 모습이 문헌에 나타나기 시작했습니다." },
            { id: 11, text: "'한ᅀᅮᆷ'이 '한숨'으로 변한 것은 'ㅿ'이 'ㅅ'으로 강화된 예이다.", answer: "O", explanation: "'ㅿ'은 사라지기도 했지만, '한ᅀᅮᆷ'의 경우처럼 울림소리였던 'ㅿ'이 안울림소리인 'ㅅ'으로 바뀌어 '한숨'이 되는, 즉 소리가 더 강해지는 변화를 겪기도 했습니다." },
            { id: 12, text: "'거성'은 방점을 하나 찍는 높은 소리였다.", answer: "O", explanation: "성조 중 '거성'은 글자 왼쪽에 점을 하나 찍어 표시했으며, 억양이 높은 소리임을 나타냈습니다." },
            { id: 13, text: "'ㅅ'계 합용병서(예: ᄯᅥᆨ)는 된소리로 발음되었다.", answer: "O", explanation: "'ㅺ, ㅼ, ㅽ' 등 'ㅅ'을 앞에 쓴 합용병서는 'ㅂ'계 어두자음군과 달리, [ㄲ], [ㄸ], [ㅃ]와 같은 된소리를 표기하는 데 사용되었습니다." },
            { id: 14, text: "'ᄫ + ㅏ'는 반모음 [w]로 변했다. (예: ᄫᅡ > 와)", answer: "O", explanation: "순경음 비읍(ㅸ)은 뒤에 모음 'ㅏ'나 'ㅓ'가 오면 현대 국어의 '와, 워'처럼 입술을 오므렸다 펴는 반모음 [w] 소리로 변했습니다." },
            { id: 15, text: "중세 국어의 음운 특징으로는 'ㅿ, ㆁ, ㆆ, ㆍ'의 존재, 성조, 어두자음군, 모음 조화 등이 있다.", answer: "O", explanation: "이 네 가지는 현대 국어와 중세 국어의 음운을 구분 짓는 가장 대표적인 특징들입니다." },
            { id: 16, text: "훈민정음의 초성자 기본자(ㄱ, ㄴ, ㅁ, ㅅ, ㅇ)와 중성자 기본자(ㆍ, ㅡ, ㅣ)는 모두 발음 기관의 모양을 본떠 만들었다.", answer: "X", explanation: "초성자 기본자(ㄱ, ㄴ, ㅁ, ㅅ, ㅇ)는 혀, 입술 등 발음 기관을 본떴지만, 중성자 기본자(ㆍ, ㅡ, ㅣ)는 하늘, 땅, 사람의 모양을 본뜬 것이므로 설명이 틀렸습니다." },
            { id: 17, text: "현대 국어의 'ㅂ' 불규칙 활용은 중세 국어의 'ㅿ(반치음)'이 소실되면서 나타난 현상이다.", answer: "X", explanation: "'ㅂ' 불규칙 활용(예: 덥다→더워)은 'ㅿ'이 아닌 'ㅸ(순경음 비읍)'이 '더ᄫㅓ'처럼 쓰이다가 사라지면서 그 흔적이 남은 것입니다." },
            { id: 18, text: "순경음 비읍(ㅸ)은 'ㅂ'을 옆으로 나란히 쓰는 병서(竝書)의 방식으로 만든 글자이다.", answer: "X", explanation: "순경음 비읍(ㅸ)은 'ㅂ' 아래에 'ㅇ'을 이어 쓰는 연서(連書) 방식으로 만들었습니다. 병서는 'ㄲ'이나 'ㅄ'처럼 옆으로 나란히 쓰는 방식입니다." },
            { id: 19, text: "아래아(ㆍ)는 16세기에 첫째 음절에서 'ㅏ'로 먼저 변하고, 18세기에 둘째 음절 이하에서 'ㅡ'로 변했다.", answer: "X", explanation: "변화의 시기와 순서가 반대입니다. 16세기에 둘째 음절 이하에서 'ㅡ'로 먼저 변했고(예: ᄆᆞᅀᆞᆷ→ᄆᆞ음), 이후 18세기에 첫째 음절에서 'ㅏ'로 변했습니다(예: ᄆᆞ음→마음)." },
            { id: 20, text: "합용병서는 'ㄲ, ㄸ, ㅆ'처럼 같은 자음을 나란히 쓰는 방식이다.", answer: "X", explanation: "'ㄲ, ㄸ, ㅆ'처럼 같은 자음을 나란히 쓴 것은 각자병서입니다. 합용병서는 'ㅳ, ㅄ'처럼 서로 다른 자음을 합쳐서 쓰는 방식입니다." },
            { id: 21, text: "'듣ᄌᆞᄫᆞ니'의 'ᄫ'은 모음 'ㅣ' 앞에서 탈락하여 '이'로 변한 경우이다.", answer: "X", explanation: "'듣ᄌᆞᄫᆞ니'는 객체 높임 선어말 어미 '-ᄌᆞᆸ-' 뒤에 모음 어미가 연결되면서 'ㅸ'이 나타난 활용형입니다. 모음 'ㅣ' 앞에서 'ㅸ'이 탈락한 예는 '수ᄫᅵ'가 '수이'로 변한 경우입니다." },
            { id: 22, text: "성조 중 '평성'은 방점을 하나 찍고 높은 소리를 나타냈다.", answer: "X", explanation: "평성은 방점이 없었고 소리의 높이가 낮은 소리였습니다. 방점을 하나 찍는 높은 소리는 거성입니다." },
            { id: 23, text: "중성자 'ㅛ, ㅑ, ㅠ, ㅕ'는 기본자를 한 번 합하여 만든 초출자(初出字)이다.", answer: "X", explanation: "이 글자들은 초출자(ㅗ, ㅏ, ㅜ, ㅓ)에 기본자 'ㆍ'를 한 번 더 결합하여 만든, 즉 기본자를 두 번 합한 재출자(再出字)입니다." },
            { id: 24, text: "'ㆆ(여린히읗)'은 목구멍소리의 기본자인 'ㅇ'의 모양을 달리한 이체자이다.", answer: "X", explanation: "'ㆆ'은 기본자 'ㅇ'에 획을 더하여 소리의 세기를 나타낸 가획자입니다. 이체자는 모양을 달리하여 만든 글자(예: ㄴ→ㄹ)입니다." },
            { id: 25, text: "훈민정음 창제 당시 스물여덟 자에는 'ㅸ(순경음 비읍)'이 포함되어 있었다.", answer: "X", explanation: "훈민정음 28자는 초성 17자와 중성 11자를 의미합니다. 'ㅸ'은 이 기본 자모를 운용하는 방식(연서)을 통해 만들어진 글자이므로 28자에 포함되지 않습니다." },
            { id: 26, text: "성조를 나타내는 방점 중 점이 하나인 '상성'은 낮았다가 높아지는 소리였으며, 현대 국어의 긴소리로 흔적이 남아있다.", answer: "X", explanation: "상성은 점이 두 개였습니다. 점이 하나인 것은 높은 소리인 거성입니다." },
            { id: 27, text: "어두자음군 'ᄡᆞᆯ'은 당시 뒤의 자음인 'ㅅ'만 된소리로 발음했을 것으로 추정된다.", answer: "X", explanation: "중세 국어 시기에는 된소리로 발음하지 않고, 'ㅂ'과 'ㅅ' 두 자음의 소리를 모두 내어 발음했을 것으로 추정합니다." },
            { id: 28, text: "중세 국어의 모음 'ㅣ'는 양성 모음과만 어울릴 수 있는 중성 모음이었다.", answer: "X", explanation: "중성 모음 'ㅣ'는 양성 모음, 음성 모음 양쪽 모두와 자유롭게 어울릴 수 있었습니다." },
            { id: 29, text: "'ㅋ'은 'ㄱ'에 획을 더한 이체자이고, 'ㄹ'은 'ㄴ'의 모양을 달리한 가획자이다.", answer: "X", explanation: "설명이 반대로 되었습니다. 'ㅋ'은 획을 더했으므로 가획자이고, 'ㄹ'은 모양을 달리했으므로 이체자입니다." },
            { id: 30, text: "'종성부용초성' 원칙에 따라 종성은 중성 글자를 다시 사용하였다.", answer: "X", explanation: "'종성부용초성(終聲復用初聲)'은 종성(받침)은 초성(첫소리) 글자를 다시 사용한다는 의미입니다. 중성 글자와는 관련이 없습니다." }
        ];

        // Stage 3: 객관식 학습 데이터 (6지선다를 4지선다로 변환)
        const STAGE3_QUESTIONS = [
            {
                id: 1,
                text: "훈민정음 제자 원리에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "초성자 기본자 'ㄱ, ㄴ, ㅁ, ㅅ, ㅇ'은 발음 기관을 본떠 만들었다.",
                    "중성자 기본자 'ㆍ, ㅡ, ㅣ'는 하늘, 땅, 사람의 모양을 본떠 만들었다.",
                    "'ㅋ, ㄷ, ㅌ, ㅂ, ㅍ' 등은 기본자에 획을 더하여 만들었다.",
                    "'ㆁ, ㄹ, ㅿ' 등은 기본자의 모양을 달리하여 만들었다.",
                    "'ㅛ, ㅑ, ㅠ, ㅕ' 등은 기본자를 한 번 합하여 만들었다.",
                    "종성 글자는 따로 만들지 않고 초성 글자를 다시 사용하였다."
                ],
                correct: 4,
                explanation: "'ㅛ, ㅑ, ㅠ, ㅕ'는 기본자를 한 번 합하여 만든 초출자(ㅗ, ㅏ, ㅜ, ㅓ)에 기본자 'ㆍ'를 한 번 더 합하여 만든, 즉 기본자를 '두 번' 합한 재출자(再出字)입니다."
            },
            {
                id: 2,
                text: "'아래아(ㆍ)'의 변천 과정에 대한 설명으로 가장 적절한 것은?",
                options: [
                    "'ㅏ'와 'ㅜ'의 중간음 [ʊ]으로 추정된다.",
                    "16세기에 첫째 음절에서 'ㅏ'로 먼저 변했다.",
                    "18세기에 둘째 음절 이하에서 'ㅡ'로 변했다.",
                    "'ᄆᆞᅀᆞᆷ'은 '마음'으로 변하기 전에 'ᄆᆞ음'의 단계를 거쳤다.",
                    "17세기 초에 표기가 상실되면서 모음 조화가 흔들렸다.",
                    "현대 국어의 단모음 'ㅓ'로 완전히 합쳐졌다."
                ],
                correct: 3,
                explanation: "자료의 변천 예시에 따르면 'ᄆᆞᅀᆞᆷ(15c) > ᄆᆞᄋᆞᆷ(16c) > ᄆᆞ음(16c) > 마음(18c)'의 순서로 변화했습니다. 따라서 '마음'이 되기 전 'ᄆᆞ음'의 단계를 거쳤다는 설명이 맞습니다. ① 'ㅏ'와 'ㅗ'의 중간음, ②,③ 순서 오류, ⑤ 1933년 표기 상실입니다."
            },
            {
                id: 3,
                text: "다음은 '순경음 비읍(ㅸ)'의 변화 양상을 정리한 것이다. 각 유형에 해당하는 예시가 바르게 짝지어진 것은?\n\n[보기]\n가. ᄫ + ㅏ/ㅓ → 반모음 'ㅗ/ㅜ[w]'로 변화\n나. ᄫ + ㅡ/ㅣ(ㆍ) → 단모음 'ㅗ/ㅜ'로 변화\n다. ᄫ + ㅣ → '이'로 변화 (탈락)",
                options: [
                    "가: 더ᄫㅓ > 더워, 나: 셔ᄫᆞᆯ > 서울, 다: 수ᄫᅵ > 수이",
                    "가: 셔ᄫᆞᆯ > 서울, 나: 더ᄫㅓ > 더워, 다: 수ᄫᅵ > 수이",
                    "가: 더ᄫㅓ > 더워, 나: 수ᄫᅵ > 수이, 다: 셔ᄫᆞᆯ > 서울",
                    "가: 수ᄫᅵ > 수이, 나: 더ᄫㅓ > 더워, 다: 셔ᄫᆞᆯ > 서울",
                    "가: 셔ᄫᆞᆯ > 서울, 나: 수ᄫᅵ > 수이, 다: 더ᄫㅓ > 더워",
                    "가: 수ᄫᅵ > 수이, 나: 셔ᄫᆞᆯ > 서울, 다: 더ᄫㅓ > 더워"
                ],
                correct: 0,
                explanation: "'가'의 예시는 '더ᄫㅓ>더워', '나'의 예시는 '셔ᄫᆞᆯ>서울', '다'의 예시는 '수ᄫᅵ>수이'로, 자료에 제시된 변천 규칙과 예시가 정확히 일치합니다."
            },
            {
                id: 4,
                text: "다음 중 '반치음(ㅿ)'에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "잇소리의 이체자로, 훈민정음 스물여덟 자에 포함되었다.",
                    "'ㅅ'의 울림소리인 [z] 음가를 가졌을 것으로 추정된다.",
                    "16세기 중반에 소실되었으며, 'ᄆᆞᅀᆞᆷ'이 '마음'으로 변하는 데 영향을 주었다.",
                    "소실 과정에서 'ㅅ'으로 강화되기도 하고(예: 한ᅀᅮᆷ > 한숨), 탈락하기도 했다(예: ᄉᆞᅀᅵ > 사이).",
                    "현대 국어 'ㅅ' 불규칙 활용(예: 긋다, 긋+어→그어)의 기원이 되었다.",
                    "현대 국어 'ㅂ' 불규칙 활용(예: 돕다, 돕+아→도와)의 기원이 되었다."
                ],
                correct: 5,
                explanation: "현대 국어 'ㅂ' 불규칙 활용의 기원이 된 것은 'ㅿ(반치음)'이 아니라 'ㅸ(순경음 비읍)'의 소실입니다. 나머지 설명은 모두 자료의 내용과 일치합니다."
            },
            {
                id: 5,
                text: "다음 중 방점과 성조에 대한 설명으로 가장 적절한 것은?",
                options: [
                    "방점은 글자의 오른쪽에 찍어 소리의 길이를 표시했다.",
                    "'평성'은 방점이 없으며, 낮았다가 높아지는 소리였다.",
                    "'거성'은 방점이 하나이며, 높은 소리였다.",
                    "'상성'은 방점이 둘이며, 낮은 소리였다.",
                    "성조는 18세기 말에 소멸되었으며, 현대 국어에는 아무런 흔적도 남아있지 않다.",
                    "':말'은 상성이므로 [말]로 짧게, '·눈'은 거성이므로 [눈:]으로 길게 발음했다."
                ],
                correct: 2,
                explanation: "'거성'은 방점이 하나이며, 높은 소리였습니다. ① 오른->왼쪽, 소리의 높낮이 ② 낮았다가 높아지는 소리는 상성 ④ 낮은 소리는 평성 ⑥ ':말'은 상성이므로 길게 [말:], '눈'은 평성이므로 짧게 [눈]으로 발음했을 것입니다."
            },
            {
                id: 6,
                text: "'옛이응(ㆁ)'과 '이응(ㅇ)'에 대한 설명으로 옳은 것을 <보기>에서 모두 고른 것은?\n\n[보기]\n가. ㆁ은 어금닛소리의 이체자, ㅇ은 목구멍소리의 기본자이다.\n나. ㆁ은 음가 없는 소리, ㅇ은 [ŋ] 음가를 가진 소리이다.\n다. ㆁ은 주로 초성에, ㅇ은 주로 종성에 사용되었다.\n라. 두 글자 모두 훈민정음 스물여덟 자에 포함되었다.\n마. 현대 국어에서는 ㆁ의 형태가 ㅇ으로 변하여 종성에서 그 기능을 이어가고 있다.",
                options: [
                    "가, 나, 다",
                    "가, 나, 라",
                    "가, 라, 마",
                    "나, 다, 라",
                    "나, 다, 마",
                    "다, 라, 마"
                ],
                correct: 2,
                explanation: "'가'는 정확한 설명입니다. '라'는 정확한 설명입니다. '마'는 'ㆁ'이 [ŋ] 발음으로 현대 국어 종성 'ㅇ'에 계승되었으므로 맞는 설명입니다. '나'와 '다'는 ㆁ과 ㅇ의 설명이 서로 바뀌었습니다."
            },
            {
                id: 7,
                text: "중세 국어의 어두자음군에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "단어의 첫소리에 둘 이상의 자음이 오는 것을 말한다.",
                    "'ᄠᅳᆮ'의 경우, 당시 사람들은 'ㅂ'과 'ㄷ'을 모두 발음했을 것으로 추정된다.",
                    "'ㅂ'계(ㅳ, ㅄ, ㅶ)와 'ㅄ'계(ㅴ, ㅵ) 등이 존재했다.",
                    "17세기 이후 된소리로 바뀌었으며, 현대 국어에는 그 흔적이 전혀 남아있지 않다.",
                    "'ㅅ'계 합용병서(예: ᄭᅮᆷ)는 어두자음군이 아닌 된소리로 발음되었다.",
                    "합용병서의 일종으로 볼 수 있다."
                ],
                correct: 3,
                explanation: "어두자음군의 흔적은 '좁쌀(←조ᄡᆞᆯ)'과 같은 단어에 남아있습니다. 따라서 흔적이 전혀 남아있지 않다는 설명은 틀렸습니다."
            },
            {
                id: 8,
                text: "다음 중 모음 조화 현상에 대한 설명으로 가장 적절한 것은?",
                options: [
                    "음성 모음 'ㅡ, ㅓ, ㅜ'는 양성 모음 'ㆍ, ㅏ, ㅗ'와 어울리는 현상이다.",
                    "'나모', 'ᄇᆞᄅᆞᆷ' 등은 체언 내부에서 모음 조화가 지켜진 예이다.",
                    "'ᄠᅳ들(ᄠᅳᆮ+을)'은 양성 모음 체언에 음성 모음 조사가 결합하여 모음 조화가 파괴된 예이다.",
                    "중성 모음 'ㅣ'는 양성 모음하고만 자유롭게 결합할 수 있었다.",
                    "19세기 말에 들어서야 모음 조화가 파괴되기 시작했다.",
                    "현대 국어 '깡충깡충'은 중세 국어 'ᄀᆞᆼ츙ᄀᆞᆼ츙'에 비해 모음 조화가 잘 지켜지고 있다."
                ],
                correct: 1,
                explanation: "'나모', 'ᄇᆞᄅᆞᆷ'은 각각 양성 모음끼리 어울려 하나의 단어를 이룬 예시입니다. ① 서로 어울리지 않는 현상, ③ 'ᄠᅳ들'은 음성모음 체언에 음성모음 조사가 결합하여 모음 조화가 지켜진 예, ④ 'ㅣ'는 양성/음성 모두와 결합, ⑤ 17세기 초부터 파괴되기 시작했습니다."
            },
            {
                id: 9,
                text: "다음 중 병서(竝書)에 대한 설명으로 옳은 것은?",
                options: [
                    "'ㄲ, ㄸ, ㅃ, ㅆ, ㅉ'은 서로 다른 자음을 합쳐 쓴 합용병서이다.",
                    "'ㅳ, ㅶ, ㅵ, ㅺ' 등은 같은 자음을 나란히 쓴 각자병서이다.",
                    "각자병서는 15세기 후반에 폐지되었다가 1933년 한글맞춤법통일안에서 부활했다.",
                    "합용병서는 초성에만 나타나고 15세기 후반에 쓰이지 않게 되었다.",
                    "'ㅂ'계 합용병서는 된소리로 발음되고, 'ㅅ'계 합용병서는 각 자음을 모두 발음했다.",
                    "'말ᄊᆞ미'의 'ㅆ'은 합용병서, 'ᄠᅳ들'의 'ㅼ'은 각자병서이다."
                ],
                correct: 2,
                explanation: "각자병서(ㄲ, ㄸ 등)는 15세기 후반에 쓰이지 않다가, 1933년 한글맞춤법통일안에서 된소리 표기를 위해 부활했습니다. ①,② 각자병서와 합용병서 설명이 반대, ④ 합용병서는 종성에도 쓰임, ⑥ 'ㅆ'은 각자병서, 'ㅼ'은 합용병서입니다."
            },
            {
                id: 10,
                text: "다음 밑줄 친 단어에서 중세 국어의 음운 특징을 발견하기 어려운 것은?",
                options: [
                    "<u>ᄠᅳ들</u> 시러",
                    "나랏 <u>:말ᄊᆞ·미</u>",
                    "<u>ᄉᆞᄆᆞᆺ·디</u> 아니ᄒᆞᆯᄊᆡ",
                    "내 이를 어엿비 <u>너겨</u>",
                    "<u>수ᄫᅵ</u> 니겨",
                    "듕·귁·에 <u>달·아</u>"
                ],
                correct: 3,
                explanation: "'너겨'에는 이어적기, 구개음화 미적용 등의 특징은 있으나, 해당 선택지 중에서 중세 국어의 두드러진 음운 특징(사라진 자모음, 어두자음군, 성조 등)을 직접적으로 찾기는 어렵습니다. ① 어두자음군, ② 관형격 'ㅅ', 방점, ③ 8종성법('ㅊ'→'ㅅ'), ⑤ 순경음 비읍, ⑥ 동국정운식 표기(옛이응) 등 명확한 특징이 나타납니다."
            },
            {
                id: 11,
                text: "다음 중 초성자의 제자 원리가 나머지 넷과 다른 하나는?",
                options: [
                    "ㅋ",
                    "ㅌ",
                    "ㅍ",
                    "ㅊ",
                    "ㄹ",
                    "ㅎ"
                ],
                correct: 4,
                explanation: "'ㄹ'은 혓소리 기본자 'ㄴ'의 모양을 달리한 이체자(異體字)입니다. 나머지 ①, ②, ③, ④, ⑥은 모두 기본자에 획을 더한 가획자(加劃字)입니다."
            },
            {
                id: 12,
                text: "'아ᅀᆞ > 아ᄋᆞ > 아으 > 아우'의 변화 과정에 포함되지 않은 음운 변동은?",
                options: [
                    "'ㅿ'의 소실",
                    "모음 조화 파괴",
                    "원순모음화",
                    "거센소리되기",
                    "'ㅇ'의 음가 없음",
                    "반모음화의 전 단계"
                ],
                correct: 3,
                explanation: "제시된 변화 과정에는 'ㅿ' 소실, 모음조화 파괴('으'와 '우'의 결합), 원순모음화('으'가 '우'로 변함) 등이 포함되지만, 거센소리되기(예사소리+ㅎ→거센소리) 현상은 나타나지 않습니다."
            },
            {
                id: 13,
                text: "다음의 ㉠, ㉡에 해당하는 예시를 바르게 짝지은 것은?\n\n[보기]\n중세 국어의 합용병서는 계열에 따라 발음이 달랐다.\n㉠ 'ㅂ'계, 'ㅄ'계: 어두에 오면 각 자음을 모두 발음\n㉡ 'ㅅ'계: 된소리로 발음",
                options: [
                    "㉠: ᄭᅮᆷ, ㉡: ᄠᅳᆮ",
                    "㉠: ᄯᅥᆨ, ㉡: ᄡᅮᆷ",
                    "㉠: ᄡᆞᆯ, ㉡: ᄢᅮᆯ",
                    "㉠: ᄣᅢ, ㉡: ᄲᅳ리다",
                    "㉠: ᄠᅳᆮ, ㉡: ᄭᅮᆷ",
                    "㉠: ᄲᅳ리다, ㉡: ᄡᆞᆯ"
                ],
                correct: 4,
                explanation: "㉠ 'ㅂ'계 어두자음군의 예시는 'ᄠᅳᆮ'이며, ㉡ 'ㅅ'계 합용병서(된소리)의 예시는 'ᄭᅮᆷ'입니다. 자료의 예시와 정확히 일치합니다."
            },
            {
                id: 14,
                text: "다음 중 사라진 글자(ㅿ, ㅸ, ㆁ, ㆆ, ㆍ)에 대한 설명으로 적절하지 않은 것은?",
                options: [
                    "ㅿ: [z] 음가로 추정되며, 소실 후 현대 국어 'ㅅ' 불규칙 활용의 원인이 됨",
                    "ㅸ: [β] 음가로 추정되며, 소실 후 현대 국어 'ㅂ' 불규칙 활용의 원인이 됨",
                    "ㆁ: [ŋ] 음가로 추정되며, 현대 국어에서는 'ㅇ' 받침 소리로 이어짐",
                    "ㆆ: 된소리 부호나 사잇소리 기능을 했을 것으로 추정됨",
                    "ㆍ: [ʌ] 음가로 추정되며, 소실 후 현대 국어 단모음 'ㅡ' 또는 'ㅏ'로 변함",
                    "ㅸ: 연서의 방식으로 만들어졌으며, 소실 후 반모음 'ㅣ[j]'로 변하기도 함"
                ],
                correct: 5,
                explanation: "순경음 비읍 'ㅸ'은 소실 후 주로 반모음 'ㅗ/ㅜ[w]'나 단모음 'ㅗ/ㅜ'로 변했습니다. 반모음 'ㅣ[j]'와는 관련이 없습니다."
            },
            {
                id: 15,
                text: "중세 국어의 모음 조화 양상으로 적절하지 않은 것은?",
                options: [
                    "양성 모음은 양성 모음끼리, 음성 모음은 음성 모음끼리 어울렸다.",
                    "양성 모음에는 'ㆍ, ㅏ, ㅗ'가, 음성 모음에는 'ㅡ, ㅓ, ㅜ'가 있었다.",
                    "체언과 조사가 결합할 때도 지켜졌다. (예: 나ᄅᆞᆯ)",
                    "어간과 어미가 결합할 때도 지켜졌다. (예: 달아)",
                    "하나의 단어 내부에서도 지켜졌다. (예: ᄆᆞᄎᆞᆷ)",
                    "중성 모음 'ㅣ'는 음성 모음과만 어울렸다."
                ],
                correct: 5,
                explanation: "중성 모음 'ㅣ'는 양성 모음, 음성 모음 모두와 자유롭게 어울렸습니다. 음성 모음과만 어울렸다는 설명은 틀렸습니다."
            },
            {
                id: 16,
                text: "다음 중 '가획(加劃)'의 원리로 만들어진 글자가 아닌 것은?",
                options: [
                    "ㄷ",
                    "ㅂ",
                    "ㅈ",
                    "ㆆ",
                    "ㆁ",
                    "ㅋ"
                ],
                correct: 4,
                explanation: "'ㆁ(옛이응)'은 어금닛소리 기본자 'ㄱ'의 모양을 달리하여 만든 이체자(異體字)입니다. 나머지는 모두 기본자에 획을 더한 가획자입니다."
            },
            {
                id: 17,
                text: "'ᄯᆞᄅᆞ미니라'에 나타나는 중세 국어의 음운 특징으로 보기 어려운 것은?",
                options: [
                    "어두자음군 사용 (ᄯ)",
                    "아래아(ㆍ) 사용 (ㄸㆍ, ᄅᆞ)",
                    "모음 조화 지킴 (ㆍ-ㆍ)",
                    "순경음 비읍 사용",
                    "이어적기 표기",
                    "옛이응 미사용"
                ],
                correct: 3,
                explanation: "'ᄯᆞᄅᆞ미니라'에는 순경음 비읍(ᄫ)이 사용되지 않았습니다."
            },
            {
                id: 18,
                text: "성조의 소멸에 대한 설명으로 가장 옳은 것은?",
                options: [
                    "15세기 말에 소멸되었다.",
                    "평성은 현대 국어의 짧은소리로 이어졌다.",
                    "거성은 현대 국어의 긴소리로 이어졌다.",
                    "상성은 현대 국어의 긴소리로 이어졌다.",
                    "모든 성조는 현대 국어에서 완전히 사라져 아무런 흔적도 남기지 않았다.",
                    "방점이 사라진 후, 소리의 길이는 성조와 무관하게 결정되었다."
                ],
                correct: 3,
                explanation: "성조는 16세기 말에 소멸되었으며, 그중 '상성'(방점 둘)이 현대 국어의 긴소리[長音]로 그 흔적을 남겼습니다. (예: :눈[눈ː], :말[말ː])"
            },
            {
                id: 19,
                text: "다음 중 자음 분류 체계가 잘못 짝지어진 것은?",
                options: [
                    "ㄱ - 어금닛소리, 기본자",
                    "ㄷ - 혓소리, 가획자",
                    "ㅂ - 입술소리, 가획자",
                    "ㅈ - 잇소리, 이체자",
                    "ㅎ - 목구멍소리, 가획자",
                    "ㄹ - 혓소리, 이체자"
                ],
                correct: 3,
                explanation: "'ㅈ'은 잇소리 기본자 'ㅅ'에 획을 더한 가획자입니다. 이체자가 아닙니다."
            },
            {
                id: 20,
                text: "다음에 제시된 음운 변천의 결과로 형성된 현대 국어의 활용형은?\n\n[보기]\n1. 덥- + -어 → 더ᄫᅥ\n2. 더ᄫㅓ → 더워",
                options: [
                    "'ㅂ' 규칙 활용",
                    "'ㅂ' 불규칙 활용",
                    "'ㅅ' 불규칙 활용",
                    "'ㄷ' 불규칙 활용",
                    "'르' 불규칙 활용",
                    "'우' 불규칙 활용"
                ],
                correct: 1,
                explanation: "'덥-'의 'ㅂ' 받침이 모음 어미 '-어' 앞에서 'ㅗ/ㅜ' 계열의 반모음 [w]로 바뀌는 현상은 현대 국어 'ㅂ' 불규칙 활용의 특징과 정확히 일치하며, 그 기원이 됩니다."
            }
        ];

        // 타이머 관련 변수
        let timerInterval;
        let currentTime = 300; // 5분 (300초)
        const maxTime = 300;

        // 현재 학습 상태
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongCount = 0;
        let startTime;
        let answeredQuestions = new Set();

        // 셔플된 문제 배열 (Stage 2 & 3용)
        let shuffledStage2Questions = [];
        let shuffledStage3Questions = [];

        // Fisher-Yates 셔플 알고리즘
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // 모달 드래그 설정 (한 번만 실행)
        function setupModalDrag() {
            if (dragListenersAdded) return;
            
            const modal = document.getElementById('modal-content');

            modal.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);

            modal.addEventListener('touchstart', startDrag, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', stopDrag);
            
            dragListenersAdded = true;
        }

        function startDrag(e) {
            const modal = document.getElementById('modal-content');
            if (e.target.closest('.option-button')) return;

            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchstart') {
                e.preventDefault();
            }

            isDragging = true;
            modal.classList.add('dragging');

            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;

            const rect = modal.getBoundingClientRect();
            modalStartX = rect.left;
            modalStartY = rect.top;
        }

        function drag(e) {
            if (!isDragging) return;
            
            // 터치 이벤트에서 기본 동작 방지
            if (e.type === 'touchmove') {
                e.preventDefault();
            }

            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;

            const modal = document.getElementById('modal-content');
            modal.style.left = (modalStartX + deltaX) + 'px';
            modal.style.top = (modalStartY + deltaY) + 'px';
        }

        function stopDrag() {
            if (!isDragging) return;
            isDragging = false;
            document.getElementById('modal-content').classList.remove('dragging');
        }

        // 타이머 시작
        function startTimer() {
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerBar();

                if (currentTime <= 0) {
                    endStage();
                }
            }, 1000);
        }

        // 타이머 바 업데이트
        function updateTimerBar() {
            const percentage = (currentTime / maxTime) * 100;
            document.getElementById('timer-bar').style.width = percentage + '%';
        }

        // 시간 더하기/빼기
        function addTime(seconds) {
            currentTime = Math.min(currentTime + seconds, maxTime);
            updateTimerBar();
        }

        function subtractTime(seconds) {
            currentTime = Math.max(currentTime - seconds, 0);
            updateTimerBar();
        }

        // Markdown to HTML 변환
        function convertMarkdownToHTML(text) {
            // 테이블 처리
            let html = text.replace(/\|(.+)\|/g, (match) => {
                const cells = match.split('|').filter(c => c.trim());
                const isHeader = text.indexOf(match) !== -1 && text.split(match)[1].indexOf('|---') !== -1;
                const tag = isHeader ? 'th' : 'td';
                return '<tr>' + cells.map(cell => `<${tag}>${cell.trim()}</${tag}>`).join('') + '</tr>';
            });

            // 테이블 구조 감싸기
            html = html.replace(/(<tr>.*<\/tr>\n)+/g, (match) => {
                return '<table>' + match + '</table>';
            });

            // 헤딩 변환
            html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');

            // 볼드 변환
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

            // 밑줄 변환 (<u> 태그 지원)
            html = html.replace(/<u>(.+?)<\/u>/g, '<u>$1</u>');

            // 리스트 변환
            html = html.replace(/^\* (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, (match) => {
                return '<ul>' + match + '</ul>';
            });

            // 줄바꿈 변환
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        // Stage 1: 딥리서치 - 2-choice 질문이 있는 HTML 생성
        function generateStage1Content() {
            const rawContent = `### <strong>중세 국어의 이해: 선택하며 학습하기 (음운편)</strong>

<strong>❶ 음운</strong>

<strong>중세 국어 음운의 특징</strong>
<ul>
<li>자음 '<span class="highlight" data-question-id="1">__________</span>', 모음 '<span class="highlight" data-question-id="2">__________</span>'가 존재</li>
<li>평성, 거성, 상성의 성조를 '<span class="highlight" data-question-id="3">__________</span>'으로 표시</li>
<li>'<span class="highlight" data-question-id="4">__________</span>' 존재</li>
<li>'<span class="highlight" data-question-id="5">__________</span>' 현상 잘 지킴</li>
</ul>

<strong>훈민정음의 제자 원리</strong>
<ul>
<li>초성자와 중성자의 기본자는 '<span class="highlight" data-question-id="6">__________</span>'의 원리로 만들었다.</li>
<li>초성자 17자는 기본자에 획을 더하거나('<span class="highlight" data-question-id="7">__________</span>') 모양을 달리하는('<span class="highlight" data-question-id="8">__________</span>') 형태로 만들었다.</li>
<li>중성자 11자는 기본자를 '<span class="highlight" data-question-id="9">__________</span>' 만들었다.</li>
<li>초성자를 옆으로나 아래로 나란히 써서 또 다른 초성자로 사용하였다.('<span class="highlight" data-question-id="10">__________</span>')
    <ul style="margin-left: 20px;">
    <li>병서 : '<span class="highlight" data-question-id="11">__________</span>' 나란히 씀 - ㅄ</li>
    <li>연서 : '<span class="highlight" data-question-id="12">__________</span>' 나란히 씀 - ㅸ</li>
    </ul>
</li>
</ul>

<strong>[초성자]</strong>

<table>
<tr><th>조음 위치에 따른 분류</th><th>기본자</th><th>가획자</th><th>이체자</th></tr>
<tr><td>어금닛소리</td><td>ㄱ</td><td>ㅋ</td><td>'<span class="highlight" data-question-id="13">__________</span>'</td></tr>
<tr><td>혓소리</td><td>ㄴ</td><td>ㄷ, ㅌ</td><td>'<span class="highlight" data-question-id="14">__________</span>'</td></tr>
<tr><td>입술소리</td><td>ㅁ</td><td>ㅂ, ㅍ</td><td></td></tr>
<tr><td>잇소리</td><td>ㅅ</td><td>ㅈ, ㅊ</td><td>'<span class="highlight" data-question-id="15">__________</span>'</td></tr>
<tr><td>목구멍소리</td><td>ㅇ</td><td>ㆆ, ㅎ</td><td></td></tr>
</table>

<strong>[중성자]</strong>

<table>
<tr><th>기본자</th><th>초출자</th><th>재출자</th></tr>
<tr><td>ㆍ, ㅡ, ㅣ</td><td>ㅗ, ㅏ, ㅜ, ㅓ</td><td>'<span class="highlight" data-question-id="16">__________</span>'</td></tr>
</table>

<strong>[종성자]</strong>
<ul>
<li>종성에는 '<span class="highlight" data-question-id="17">__________</span>'. (종성부용초성)</li>
</ul>

<strong>오늘날 쓰이지 않는 글자</strong>
: 여린히읗(ㆆ), 반치음(ㅿ), 순경음비읍(ㅸ), 옛이응(ㆁ), 아래아(ㆍ)

<strong>반치음(ㅿ)</strong>
<ul>
<li>분류: '<span class="highlight" data-question-id="18">__________</span>'의 이체자(스물여덟 자에 포함)</li>
<li>음가: 'ㅅ'의 '<span class="highlight" data-question-id="19">__________</span>'로 추정</li>
<li>활용
    <ul style="margin-left: 20px;">
    <li>예) 卜年(복년)이 ᄀᆞᇫ업스시니 [복년이 끝없으시니]</li>
    </ul>
</li>
<li>변천
    <ul style="margin-left: 20px;">
    <li>'<span class="highlight" data-question-id="20">__________</span>' 소실</li>
    <li>ᄉᆞᅀᅵ > ᄉᆞ이 > 사이</li>
    <li>'ㅅ'으로 강화
        <ul style="margin-left: 20px;">
        <li>한ᅀᅮᆷ > '<span class="highlight" data-question-id="21">__________</span>'</li>
        </ul>
    </li>
    <li>'ㅿ'이 소실되면서 현대 '<span class="highlight" data-question-id="22">__________</span>'로 변함
        <ul style="margin-left: 20px;">
        <li>(노ᄅᆞᆯ) 저ᅀᅥ(젓-+-어) > 저어</li>
        </ul>
    </li>
    </ul>
</li>
</ul>

<strong>순경음비읍(ㅸ)</strong>
<ul>
<li>분류: '<span class="highlight" data-question-id="23">__________</span>'</li>
<li>음가: 'ㅂ'의 '<span class="highlight" data-question-id="24">__________</span>'로 추정</li>
<li>활용: 'ㅂ'을 이어적기 하면 유성음인 'ㅸ'으로 됨
    <ul style="margin-left: 20px;">
    <li>쉽-+-이 > 수ᄫᅵ > 수이 > 쉬 [쉽게]</li>
    </ul>
</li>
<li>변천
    <ul style="margin-left: 20px;">
    <li>16세기 소실</li>
    <li>변화
        <ul style="margin-left: 20px;">
        <li>① ㅸ + ㅏ/ㅓ > '<span class="highlight" data-question-id="25">__________</span>'로 변화</li>
        <li>② ㅸ + ㅡ/ㅣ -> '<span class="highlight" data-question-id="26">__________</span>'로 변화</li>
        </ul>
    </li>
    <li>'ㅸ'이 소실되면서 현대 '<span class="highlight" data-question-id="27">__________</span>'으로 변함
        <ul style="margin-left: 20px;">
        <li>도ᄫᅡ(돕-+-아) > 도와</li>
        </ul>
    </li>
    </ul>
</li>
</ul>

<strong>옛이응과 이응의 구별</strong>
<ul>
<li>옛이응(ㆁ)
    <ul style="margin-left: 20px;">
    <li>분류: 어금닛소리의 이체자(스물여덟 글자에 포함)</li>
    <li>음가: '<span class="highlight" data-question-id="28">__________</span>'</li>
    <li>활용: '<span class="highlight" data-question-id="29">__________</span>'</li>
    </ul>
</li>
<li>이응(ㅇ)
    <ul style="margin-left: 20px;">
    <li>분류: 목구멍소리의 기본자(스물여덟 글자에 포함)</li>
    <li>음가: '<span class="highlight" data-question-id="30">__________</span>'</li>
    <li>활용: 음운의 빈자리를 채우는 역할</li>
    </ul>
</li>
</ul>

<strong>아래아(ㆍ)</strong>
<ul>
<li>분류: 기본자('<span class="highlight" data-question-id="31">__________</span>'의 모양을 본떠 만듦)</li>
<li>음가: 'ㅏ'와 '<span class="highlight" data-question-id="32">__________</span>의 중간음 [ʌ]로 추정</li>
<li>변천
    <ul style="margin-left: 20px;">
    <li>'<span class="highlight" data-question-id="33">__________</span>': 둘째 음절의 'ㆍ'가 'ㅡ'로 변함</li>
    <li>'<span class="highlight" data-question-id="34">__________</span>': 첫째 음절의 'ㆍ'가 'ㅏ'로 변함</li>
    <li>'<span class="highlight" data-question-id="35">__________</span>' 표기 상실로 모음 조화가 흔들림.</li>
    </ul>
</li>
</ul>

<strong>방점</strong>
<ul>
<li>역할: '<span class="highlight" data-question-id="36">__________</span>'를 표시</li>
<li>방법: 글자 '<span class="highlight" data-question-id="37">__________</span>'에 점의 개수로 표시</li>
<li>종류
    <ul style="margin-left: 20px;">
    <li>평성: 방점 '<span class="highlight" data-question-id="38">__________</span>', 낮은 소리</li>
    <li>거성: 방점 '<span class="highlight" data-question-id="39">__________</span>', 높은 소리</li>
    <li>상성: 방점 '<span class="highlight" data-question-id="40">__________</span>', 낮았다가 높아지는 소리</li>
    </ul>
</li>
<li>변천
    <ul style="margin-left: 20px;">
    <li>소멸: '<span class="highlight" data-question-id="41">__________</span>'</li>
    <li>'<span class="highlight" data-question-id="42">__________</span>'은 현대에 긴소리로 변함</li>
    </ul>
</li>
</ul>

<strong>어두자음군</strong>
<ul>
<li>뜻 : '<span class="highlight" data-question-id="43">__________</span>'에 둘 이상의 자음이 오는 것</li>
<li>발음: '<span class="highlight" data-question-id="44">__________</span>'</li>
<li>종류
    <ul style="margin-left: 20px;">
    <li>ㅂ계: ㅳ, ㅄ, ㅶ</li>
    <li>ㅄ계: ㅴ, ㅵ</li>
    </ul>
</li>
<li>변천 : '<span class="highlight" data-question-id="45">__________</span>' 된소리로 바뀜</li>
<li>현대 국어에 흔적이 남아 있음
    <ul style="margin-left: 20px;">
    <li>예) '<span class="highlight" data-question-id="46">__________</span>'</li>
    </ul>
</li>
</ul>

<strong>모음 조화</strong>
<ul>
<li>뜻: 양성모음은 양성모음끼리, 음성모음은 음성모음끼리 어울리는 현상
    <ul style="margin-left: 20px;">
    <li>양성모음: ㆍ, ㅏ, ㅗ</li>
    <li>'ㅣ'는 '<span class="highlight" data-question-id="47">__________</span>'</li>
    <li>음성모음: ㅡ, ㅓ, ㅜ</li>
    </ul>
</li>
<li>환경
    <ul style="margin-left: 20px;">
    <li>체언과 조사: 나ᄅᆞᆯ (양성+양성) / ᄠᅳ들 (음성+음성)</li>
    <li>어간과 어미: 달아(다ᄅᆞ+아) (양성+양성) / ᄡᅮ메(ᄡᅳ+움+에) (음성+음성)</li>
    </ul>
</li>
<li>변천
    <ul style="margin-left: 20px;">
    <li>'<span class="highlight" data-question-id="48">__________</span>': 모음 조화 파괴가 보임</li>
    <li>19세기 말: 모음 조화가 더욱 문란해짐</li>
    </ul>
</li>
</ul>

<strong>'ㄷ'과 'ㅅ'의 구별</strong>
<ul>
<li>ㄷ: '<span class="highlight" data-question-id="49">__________</span>'의 가획자 (예: 몯ᄒᆞ다 [못하다])</li>
<li>ㅅ: '<span class="highlight" data-question-id="50">__________</span>'의 기본자 (예: 못 [연못])</li>
</ul>

<strong>각자병서와 합용병서</strong>
<ul>
<li>각자병서
    <ul style="margin-left: 20px;">
    <li>'<span class="highlight" data-question-id="51">__________</span>'</li>
    <li>'<span class="highlight" data-question-id="52">__________</span>'에만 나타나며 15세기 후반 쓰이지 않음</li>
    </ul>
</li>
<li>합용병서
    <ul style="margin-left: 20px;">
    <li>'<span class="highlight" data-question-id="53">__________</span>'</li>
    <li>'ㅂ'계, 'ㅄ'계는 '<span class="highlight" data-question-id="54">__________</span>'에 소실, 'ㅅ'계는 '<span class="highlight" data-question-id="55">__________</span>'에 폐지</li>
    </ul>
</li>
</ul>`;

            return rawContent;
        }

        // Stage 1: 딥리서치 초기화
        function initStage1() {
            currentStage = 1;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            answeredQuestions.clear();
            currentTime = 300;
            startTime = Date.now();

            // UI 업데이트
            document.querySelector('.title').textContent = '중세 국어 음운 파트';
            document.getElementById('stage-subtitle').textContent = '1단계: 딥리서치';
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();
            document.getElementById('total-questions').textContent = STAGE1_QUESTIONS.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('active');
            });

            // 지문 표시
            const passageHTML = generateStage1Content();
            document.getElementById('passage-container').innerHTML = passageHTML;

            // 하이라이트 클릭 이벤트 추가
            const highlights = document.querySelectorAll('.highlight');
            highlights.forEach(highlight => {
                highlight.addEventListener('click', function() {
                    const questionId = parseInt(this.getAttribute('data-question-id'));
                    if (!answeredQuestions.has(questionId)) {
                        showQuestion(questionId, this);
                    }
                });
            });

            document.getElementById('result-screen').classList.remove('active');
            // 학습 완료 시스템을 위한 데이터 export
        window.learningResultData = {
            totalStages: totalStages || 5,
            totalCorrect: totalCorrect || 0,
            totalWrong: totalWrong || 0,
            totalAccuracy: totalAccuracy || 0,
            totalScore: totalScore || 0,
            totalElapsedTime: totalElapsedTime || (Date.now() - globalStartTime),
            stagesDetail: stageResults || {}
        };
        console.log('학습 데이터 export:', window.learningResultData);


            document.getElementById('main-content').style.display = 'block';
            // 학습 완료 버튼 추가
            if (typeof addCompleteLearningButton === 'function') {
                setTimeout(() => addCompleteLearningButton(), 500);
            }
            startTimer();
        }

        // 질문 모달 표시
        function showQuestion(questionId, highlightElement) {
            const question = STAGE1_QUESTIONS.find(q => q.id === questionId);
            if (!question) return;

            const modalOverlay = document.getElementById('modal-overlay');
            const modalHeader = document.getElementById('modal-header');
            const modalOptions = document.getElementById('modal-options');
            const modalContent = document.getElementById('modal-content');

            // 모달 초기화
            modalContent.classList.remove('correct-feedback', 'incorrect-feedback');

            // 질문 헤더
            modalHeader.textContent = question.context;

            // 선지 셔플
            const options = shuffleArray([
                { text: question.correctAnswer, isCorrect: true },
                { text: question.wrongAnswer, isCorrect: false }
            ]);

            // 선지 버튼 생성
            modalOptions.innerHTML = '';
            options.forEach(option => {
                const button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option.text;
                button.onclick = () => checkAnswer(questionId, option.isCorrect, button, highlightElement);
                modalOptions.appendChild(button);
            });

            // 모달 표시
            modalOverlay.classList.add('active');

            // 모달 위치 설정 (하이라이트 근처에 배치하되 화면 밖으로 나가지 않도록)
            const highlightRect = highlightElement.getBoundingClientRect();
            const modalWidth = 500; // max-width
            const modalHeight = 300; // 대략적인 높이

            // 하이라이트 오른쪽에 배치 시도
            let left = highlightRect.right + 20;
            let top = highlightRect.top;

            // 오른쪽 공간이 부족하면 왼쪽에 배치
            if (left + modalWidth > window.innerWidth) {
                left = highlightRect.left - modalWidth - 20;
            }

            // 왼쪽도 공간이 부족하면 중앙에 배치
            if (left < 0) {
                left = (window.innerWidth - modalWidth) / 2;
            }

            // 위쪽으로 벗어나지 않도록
            if (top < 20) {
                top = 20;
            }

            // 아래쪽으로 벗어나지 않도록
            if (top + modalHeight > window.innerHeight) {
                top = window.innerHeight - modalHeight - 20;
            }

            modalContent.style.left = left + 'px';
            modalContent.style.top = top + 'px';

            // 모달 드래그 설정 (한 번만 실행)
            setupModalDrag();
        }

        // 답변 체크
        function checkAnswer(questionId, isCorrect, button, highlightElement) {
            const buttons = document.querySelectorAll('.option-button');
            const modalContent = document.getElementById('modal-content');

            // 버튼 비활성화
            buttons.forEach(btn => btn.disabled = true);

            if (isCorrect) {
                button.classList.add('correct');
                modalContent.classList.add('correct-feedback');
                highlightElement.classList.add('correct', 'answered');
                highlightElement.textContent = button.textContent;
                correctCount++;
                addTime(10);
            } else {
                button.classList.add('incorrect');
                modalContent.classList.add('incorrect-feedback');
                highlightElement.classList.add('incorrect', 'answered');

                // 정답 표시
                const correctButton = Array.from(buttons).find(btn => !btn.classList.contains('incorrect'));
                if (correctButton) {
                    correctButton.classList.add('correct');
                    highlightElement.textContent = correctButton.textContent;
                }

                wrongCount++;
                subtractTime(40);
            }

            // 답변한 질문 추가
            answeredQuestions.add(questionId);
            document.getElementById('current-question').textContent = answeredQuestions.size.toString();

            // 모달 닫기
            setTimeout(() => {
                document.getElementById('modal-overlay').classList.remove('active');

                // 모든 질문 완료 확인
                if (answeredQuestions.size === STAGE1_QUESTIONS.length) {
                    setTimeout(() => endStage(), 500);
                }
            }, 1500);
        }

        // Stage 2: OX 학습 초기화
        function initStage2() {
            clearInterval(timerInterval);

            currentStage = 2;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage2WrongQuestions = [];

            // OX 문제 셔플 (매번 새로운 순서로)
            shuffledStage2Questions = shuffleArray(STAGE2_QUESTIONS);

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '2단계: OX 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage2Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('completed');
                if (index === 1) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showOXQuestion();
            startTimer();
        }

        // OX 문제 표시
        function showOXQuestion() {
            const question = shuffledStage2Questions[currentQuestionIndex];

            document.getElementById('passage-container').innerHTML = `
                <div class="ox-container">
                    <div class="ox-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage2Questions.length}</div>
                        <div class="question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="ox-options">
                            <button class="ox-option-button" onclick="checkOXAnswer('O')">O</button>
                            <button class="ox-option-button" onclick="checkOXAnswer('X')">X</button>
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="ox-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // OX 답변 체크
        function checkOXAnswer(answer) {
            const question = shuffledStage2Questions[currentQuestionIndex];
            const buttons = document.querySelectorAll('.ox-option-button');
            const isCorrect = answer === question.answer;

            buttons.forEach(button => {
                button.disabled = true;
                if (button.textContent === answer) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(15);

                // 틀린 문제 저장
                stage2WrongQuestions.push({
                    question: question.text,
                    userAnswer: answer,
                    correctAnswer: question.answer,
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('ox-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage2Questions.length) {
                    endStage();
                } else {
                    showOXQuestion();
                }
            }, 2000);
        }

        // Stage 3: 객관식 학습 초기화
        function initStage3() {
            clearInterval(timerInterval);

            currentStage = 3;
            currentQuestionIndex = 0;
            correctCount = 0;
            wrongCount = 0;
            currentTime = 300;
            startTime = Date.now();

            // 틀린 문제 배열 초기화
            stage3WrongQuestions = [];

            // 객관식 문제 셔플 (매번 새로운 순서로)
            shuffledStage3Questions = shuffleArray(STAGE3_QUESTIONS);

            // 각 문제에 대해 4지선다 미리 생성
            shuffledStage3Questions.forEach(q => {
                q.selectedOptions = generate4Options(q.options, q.correct);
            });

            // UI 업데이트
            document.getElementById('stage-subtitle').textContent = '3단계: 객관식 학습';
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = shuffledStage3Questions.length.toString();

            // 단계 인디케이터 업데이트
            const dots = document.querySelectorAll('.stage-dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index < 2) dot.classList.add('completed');
                if (index === 2) dot.classList.add('active');
            });

            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            showMCQQuestion();
            startTimer();
        }

        // 6지선다에서 4지선다 생성 (정답 포함)
        function generate4Options(allOptions, correctIndex) {
            const correctOption = allOptions[correctIndex];
            const otherOptions = allOptions.filter((_, i) => i !== correctIndex);

            // 오답 중에서 3개 랜덤 선택
            const shuffledOthers = shuffleArray(otherOptions);
            const selected3Others = shuffledOthers.slice(0, 3);

            // 정답과 3개 오답을 합쳐서 셔플
            const final4Options = shuffleArray([correctOption, ...selected3Others]);

            // 새로운 정답 인덱스 찾기
            const newCorrectIndex = final4Options.indexOf(correctOption);

            return {
                options: final4Options,
                correctIndex: newCorrectIndex
            };
        }

        // 객관식 문제 표시
        function showMCQQuestion() {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;

            const optionsHTML = options.map((opt, index) => `
                <button class="mcq-option-button" onclick="checkMCQAnswer(${index})">
                    <span class="option-number">${index + 1}</span>
                    <span class="option-text">${convertMarkdownToHTML(opt)}</span>
                </button>
            `).join('');

            document.getElementById('passage-container').innerHTML = `
                <div class="mcq-container">
                    <div class="mcq-question-card">
                        <div class="question-number">문제 ${currentQuestionIndex + 1} / ${shuffledStage3Questions.length}</div>
                        <div class="mcq-question-text">${convertMarkdownToHTML(question.text)}</div>
                        <div class="mcq-options">
                            ${optionsHTML}
                        </div>
                        ${question.explanation ? `<div class="explanation-text" id="mcq-explanation" style="display:none;">${convertMarkdownToHTML(question.explanation)}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // 객관식 답변 체크
        function checkMCQAnswer(selectedIndex) {
            const question = shuffledStage3Questions[currentQuestionIndex];
            const { options, correctIndex } = question.selectedOptions;
            const buttons = document.querySelectorAll('.mcq-option-button');
            const isCorrect = selectedIndex === correctIndex;

            buttons.forEach((button, index) => {
                button.disabled = true;
                if (index === selectedIndex) {
                    button.classList.add(isCorrect ? 'correct' : 'incorrect');
                }
                if (index === correctIndex && !isCorrect) {
                    button.classList.add('correct');
                }
            });

            if (isCorrect) {
                correctCount++;
                addTime(10);
            } else {
                wrongCount++;
                subtractTime(20);

                // 틀린 문제 저장
                stage3WrongQuestions.push({
                    question: question.text,
                    userAnswer: options[selectedIndex],
                    correctAnswer: options[correctIndex],
                    explanation: question.explanation || ''
                });

                // 설명 표시
                const explanation = document.getElementById('mcq-explanation');
                if (explanation) {
                    setTimeout(() => {
                        explanation.style.display = 'block';
                    }, 600);
                }
            }

            setTimeout(() => {
                currentQuestionIndex++;
                document.getElementById('current-question').textContent = (currentQuestionIndex + 1).toString();

                if (currentQuestionIndex >= shuffledStage3Questions.length) {
                    endStage();
                } else {
                    showMCQQuestion();
                }
            }, 2000);
        }

        // 단계 종료
        function endStage() {
            clearInterval(timerInterval);

            const endTime = Date.now();
            const totalTime = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(totalTime / 60);
            const seconds = totalTime % 60;

            let totalQuestions = 0;
            if (currentStage === 1) {
                totalQuestions = STAGE1_QUESTIONS.length;
            } else if (currentStage === 2) {
                totalQuestions = shuffledStage2Questions.length;
            } else if (currentStage === 3) {
                totalQuestions = shuffledStage3Questions.length;
            }

            const accuracy = totalQuestions > 0 ? Math.round((correctCount / totalQuestions) * 100) : 100;
            const score = (accuracy / 100) * 10; // 10점 만점으로 환산

            // 결과 저장 (레거시)
            allStageResults[`stage${currentStage}`] = {
                totalQuestions,
                correctCount,
                wrongCount,
                accuracy,
                totalTime
            };

            // 새로운 stageResults에 저장 (틀린 문제 포함)
            const wrongQuestionsArray = currentStage === 2 ? stage2WrongQuestions :
                                       currentStage === 3 ? stage3WrongQuestions : [];

            stageResults[`stage${currentStage}`] = {
                correct: correctCount,
                wrong: wrongCount,
                score: score,
                elapsedTime: totalTime,
                wrongQuestions: wrongQuestionsArray
            };

            // 결과 화면 표시
            document.getElementById('result-title').textContent = `${currentStage}단계 학습 완료!`;
            document.getElementById('progress-stat').textContent = '100%';
            document.getElementById('accuracy-stat').textContent = accuracy + '%';
            document.getElementById('correct-stat').textContent = correctCount;
            document.getElementById('wrong-stat').textContent = wrongCount;
            document.getElementById('time-stat').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            // 버튼 업데이트
            const resultButtons = document.querySelector('.result-buttons');
            let buttonsHTML = '<button class="result-button secondary" onclick="restartStage()">다시 학습하기</button>';

            // Stage 2와 Stage 3의 경우 틀린 문제 보기 버튼 추가
            if (currentStage === 2 && stage2WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage2()">틀린 문제 보기 (${stage2WrongQuestions.length}문제)</button>`;
            } else if (currentStage === 3 && stage3WrongQuestions.length > 0) {
                buttonsHTML += `<button class="result-button" style="background: #dc3545; color: white;" onclick="showWrongQuestionsStage3()">틀린 문제 보기 (${stage3WrongQuestions.length}문제)</button>`;
            }

            // 다음 단계 버튼 (Stage 3이면 "전체 결과 보기")
            if (currentStage === 3) {
                buttonsHTML += '<button class="result-button primary" onclick="showFinalResults()">전체 결과 보기</button>';
            } else {
                buttonsHTML += '<button class="result-button primary" onclick="nextStage()">다음 단계로</button>';
            }

            resultButtons.innerHTML = buttonsHTML;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('result-screen').classList.add('active');
        }

        // 다시 학습하기
        function restartStage() {
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('result-screen').classList.remove('active');

            if (currentStage === 1) {
                initStage1();
            } else if (currentStage === 2) {
                initStage2();
            } else if (currentStage === 3) {
                initStage3();
            }
        }

        // 다음 단계로
        function nextStage() {
            document.getElementById('main-content').style.display = 'block';

            if (currentStage === 1) {
                initStage2();
            } else if (currentStage === 2) {
                initStage3();
            } else if (currentStage === 3) {
                // 모든 단계 완료
                alert('모든 학습을 완료했습니다!');
                initStage1();
            }
        }

        // Stage 2 틀린 문제 보기
        function showWrongQuestionsStage2() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage2')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage2" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>2단계: OX - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage2()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage2"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage2');
            content.innerHTML = stage2WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage2').classList.add('active');
        }

        // Stage 2 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage2() {
            document.getElementById('wrong-questions-modal-stage2').classList.remove('active');
        }

        // Stage 3 틀린 문제 보기
        function showWrongQuestionsStage3() {
            // 모달이 없으면 생성
            if (!document.getElementById('wrong-questions-modal-stage3')) {
                const modalHTML = `
                    <div id="wrong-questions-modal-stage3" class="modal-overlay">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>3단계: 객관식 - 틀린 문제 목록</h3>
                                <button class="close-modal-btn" onclick="closeWrongQuestionsModalStage3()">✕</button>
                            </div>
                            <div class="modal-body" id="wrong-questions-content-stage3"></div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            // 틀린 문제 내용 표시
            const content = document.getElementById('wrong-questions-content-stage3');
            content.innerHTML = stage3WrongQuestions.map((item, index) => `
                <div class="wrong-question-item">
                    <h4>문제 ${index + 1}</h4>
                    <div class="question-text">${convertMarkdownToHTML(item.question)}</div>
                    <p><strong>당신의 답:</strong> <span class="user-answer">${convertMarkdownToHTML(item.userAnswer)}</span></p>
                    <p><strong>정답:</strong> <span class="correct-answer">${convertMarkdownToHTML(item.correctAnswer)}</span></p>
                    ${item.explanation ? `
                        <div class="question-explanation">
                            <strong>📝 해설</strong>
                            ${convertMarkdownToHTML(item.explanation)}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            document.getElementById('wrong-questions-modal-stage3').classList.add('active');
        }

        // Stage 3 틀린 문제 모달 닫기
        function closeWrongQuestionsModalStage3() {
            document.getElementById('wrong-questions-modal-stage3').classList.remove('active');
        }

        // 시간 포맷팅 함수
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // 전체 결과 보기
        function showFinalResults() {
            // 기존 타이머 정리
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            // 결과 화면과 메인 컨텐츠 숨기기
            document.getElementById('result-screen').classList.remove('active');

            // 전체 결과 계산
            const totalCorrect = stageResults.stage1.correct + stageResults.stage2.correct + stageResults.stage3.correct;
            const totalWrong = stageResults.stage1.wrong + stageResults.stage2.wrong + stageResults.stage3.wrong;
            const overallAccuracy = (totalCorrect + totalWrong) > 0 ?
                                   Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;
            const totalScore = stageResults.stage1.score + stageResults.stage2.score + stageResults.stage3.score;
            const totalElapsedTime = stageResults.stage1.elapsedTime + stageResults.stage2.elapsedTime + stageResults.stage3.elapsedTime;

            // 스테이지명 맵핑
            const stageNames = {
                stage1: '1단계: 딥리서치',
                stage2: '2단계: OX 학습',
                stage3: '3단계: 객관식 학습'
            };

            // HTML 생성
            let html = `
                <div style="max-width: 1000px; margin: 0 auto; padding: 40px 20px;">
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 36px; color: #2c3e50; margin-bottom: 10px;">🎉 학습 완료!</h1>
                        <p style="font-size: 18px; color: #7f8c8d;">모든 학습 단계를 완료했습니다.</p>
                    </div>

                    <!-- 전체 학습 결과 -->
                    <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 2px solid #3498db;">
                        <h2 style="margin-bottom: 25px; font-size: 24px; color: #2c3e50;">📊 전체 학습 결과</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총점</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${totalScore.toFixed(1)}점</div>
                                <div style="font-size: 12px; margin-top: 5px; color: #7f8c8d;">/ 30.0점</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #3498db;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">전체 정답률</div>
                                <div style="font-size: 32px; font-weight: bold; color: #2c3e50;">${overallAccuracy}%</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #22c55e;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">정답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #16a34a;">${totalCorrect}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #ef4444;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">오답 수</div>
                                <div style="font-size: 32px; font-weight: bold; color: #dc2626;">${totalWrong}개</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #eab308;">
                                <div style="font-size: 14px; margin-bottom: 10px; color: #2c3e50; font-weight: 600;">총 소요 시간</div>
                                <div style="font-size: 28px; font-weight: bold; color: #2c3e50;">${formatTime(totalElapsedTime)}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 단계별 결과 -->
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-size: 24px;">📈 단계별 학습 결과</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">
            `;

            // 각 단계별 결과 카드
            ['stage1', 'stage2', 'stage3'].forEach(stageKey => {
                const result = stageResults[stageKey];
                const stageAccuracy = (result.correct + result.wrong) > 0 ?
                    Math.round((result.correct / (result.correct + result.wrong)) * 100) : 0;

                html += `
                    <div style="background: white; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h3 style="color: #3498db; margin-bottom: 15px; font-size: 18px;">${stageNames[stageKey]}</h3>
                        <div style="line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답률:</span>
                                <strong style="color: #27ae60;">${stageAccuracy}%</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">정답:</span>
                                <strong>${result.correct}개</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">오답:</span>
                                <strong style="color: #e74c3c;">${result.wrong}회</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">점수:</span>
                                <strong style="color: #3498db;">${result.score.toFixed(1)}점</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
                                <span style="color: #7f8c8d;">소요 시간:</span>
                                <strong>${formatTime(result.elapsedTime)}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
        </div>

        <!-- 틀린 문제 상세 정보 -->
        <h2 style="margin-top: 50px; margin-bottom: 25px; color: #2c3e50; font-size: 24px; font-weight: 600;">❌ 틀린 문제 상세</h2>
`;

            // Stage 2와 Stage 3의 틀린 문제 표시
            let hasWrongQuestions = false;

            // Stage 2 틀린 문제
            if (stageResults.stage2.wrongQuestions && stageResults.stage2.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #856404; margin-bottom: 20px; font-size: 20px;">📝 2단계: OX - 틀린 문제</h3>
`;
                stageResults.stage2.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // Stage 3 틀린 문제
            if (stageResults.stage3.wrongQuestions && stageResults.stage3.wrongQuestions.length > 0) {
                hasWrongQuestions = true;
                html += `
        <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 12px; padding: 25px; margin-bottom: 25px;">
            <h3 style="color: #721c24; margin-bottom: 20px; font-size: 20px;">🔤 3단계: 객관식 - 틀린 문제</h3>
`;
                stageResults.stage3.wrongQuestions.forEach((item, idx) => {
                    html += `
            <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <p style="font-weight: 600; color: #495057; margin-bottom: 12px;">문제 ${idx + 1}: ${item.question}</p>
                <p style="color: #dc3545; margin-bottom: 8px;">❌ 당신의 답: ${item.userAnswer}</p>
                <p style="color: #28a745;">✅ 정답: ${item.correctAnswer}</p>
            </div>
`;
                });
                html += `
        </div>
`;
            }

            // 틀린 문제가 없는 경우
            if (!hasWrongQuestions) {
                html += `
        <div style="background: #d4edda; border: 2px solid #c3e6cb; border-radius: 12px; padding: 25px; text-align: center;">
            <p style="color: #155724; font-size: 18px; font-weight: 600;">🎉 완벽합니다! 모든 문제를 맞추셨습니다!</p>
        </div>
`;
            }

            html += `
        <!-- 액션 버튼 -->
        <div style="text-align: center; margin-top: 50px; padding-bottom: 50px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
            <button onclick="saveFinalResultsAsImage()" style="
                background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 211, 153, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 211, 153, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 211, 153, 0.4)';">
                📷 이미지로 저장
            </button>
            <button onclick="location.reload()" style="
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 18px 50px;
                font-size: 18px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
                transition: all 0.3s ease;
            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(52, 152, 219, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(52, 152, 219, 0.4)';">
                🔄 처음부터 다시하기
            </button>
        </div>
    </div>
`;

            // HTML 설정 및 표시
            document.getElementById('main-content').innerHTML = html;
            document.getElementById('main-content').style.display = 'block';
        }

        // 최종 결과 페이지 이미지 저장
        function saveFinalResultsAsImage() {
            if (typeof htmlToImage === 'undefined') {
                alert('이미지 라이브러리가 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
                return;
            }

            const mainContent = document.getElementById('main-content');

            // 저장 버튼들 임시 숨김
            const buttons = mainContent.querySelectorAll('button');
            const buttonStates = Array.from(buttons).map(btn => btn.style.display);
            buttons.forEach(btn => btn.style.display = 'none');

            // 약간의 딜레이 후 캡처
            setTimeout(() => {
                htmlToImage.toBlob(mainContent, {
                    backgroundColor: '#f5f7fa',
                    pixelRatio: 2,
                    cacheBust: true
                }).then(blob => {
                    // 버튼 다시 표시
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);

                    // 이미지 다운로드
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    link.download = `중세국어_음운_최종결과_${timestamp}.png`;
                    link.href = URL.createObjectURL(blob);
                    link.click();
                    URL.revokeObjectURL(link.href);
                }).catch(err => {
                    buttons.forEach((btn, idx) => btn.style.display = buttonStates[idx]);
                    console.error('이미지 저장 실패:', err);
                    alert('이미지 저장에 실패했습니다. 다시 시도해주세요.');
                });
            }, 100);
        }

        // 페이지 로드 시 모달 드래그 설정 초기화
        window.onload = function() {
            // 모달 드래그 설정을 페이지 로드 시 한 번만 실행
            setupModalDrag();
            initStage1();
        };
    </script>

    <!-- 학습 완료 시스템 -->
    <script src="../js/config.js"></script>
    <script src="../js/learning-complete.js"></script>
</body>
</html>