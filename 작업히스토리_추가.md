---

## 2025-10-22: 워크북 5단계 수정, 진행률 계산 개선, 인쇄 기능, 랭킹 시스템 구현

### 📋 작업 개요
차마설 워크북 5단계 문제 개선, 전체 워크북 진행률 계산 오류 수정, 학습 기록 인쇄 기능 추가, 종합 랭킹 시스템 구현

### 🎯 목표
1. **5단계 서술형 문제 표준화**: 정답 카드 수를 4개에서 3개로 통일
2. **진행률 계산 정확도 향상**: Stage 2, 3 문제 수 누락 문제 해결
3. **인쇄 기능 추가**: 학습 결과 및 틀린 문제 인쇄 지원
4. **랭킹 시스템 구축**: 누적/주간/월간 랭킹 및 컨텐츠별 랭킹
5. **학교급별 필터링**: 초등부/중등부/고등부 분리 랭킹

---

### ✅ 1단계: 차마설 워크북 5단계 수정

#### 문제점
- Stage 4 완료 후 5단계 카드 배열 문제에서 4개의 정답 카드를 요구했으나, 실제로는 3개가 적절
- 사용자가 "4단계에서 다 못 푼 문제들이 나와"라고 보고

#### 해결책
**파일**: `contents/차마설 내신 대비 워크북.html`

**1. 모든 writingQuestions의 correctParts를 3개로 수정** (lines 3426-3564)
```javascript
// 기존: 4개의 correctParts
correctParts: [
    "노둔한 말을 탈 때는...",
    "준마를 얻으면...",
    "이 대비가...",
    "네 번째 문장"  // ❌ 제거
]

// 수정: 3개의 correctParts
correctParts: [
    "노둔한 말을 탈 때는 말이 다칠까 봐 전전긍긍하며 채찍을 대지 않는 겸손한 태도를 보였다.",
    "준마를 얻으면 의기양양하여 방자하게 채찍을 휘두르고 평지처럼 질주하는 오만한 태도로 변한다.",
    "이 대비가 만물차용설에 근거한 겸손의 주제를 부각한다."
]
```

**2. Stage 5 헤더 명확화** (line 3633)
```javascript
document.querySelector('.subtitle').textContent = '5단계: 서술형 문제 (카드 배열)';
```

**3. 정답 카드 수 안내 박스 추가** (lines 3662-3664)
```javascript
<div class="required-cards-info" style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
    ✨ 5단계 서술형 문제: ${question.correctParts.length}개의 정답 카드를 순서대로 배열하세요!
</div>
```

---

### ✅ 2단계: 전체 워크북 진행률 계산 수정

#### 문제점
사용자 보고: "진행률 계산이 이상해. 차마설은 정답 수 12개 오답수 49개인데 실제 총문제수는 100개 이상이거든."
- 진행률이 102% (61/60)로 표시됨
- Stage 2 (어휘) 38문제, Stage 3 (문장독해) 8문제가 totalQuestions 계산에서 누락됨

#### 해결책

**차마설 워크북** (lines 4638-4668):
```javascript
// ❌ 기존 (잘못된 계산)
const totalAllQuestions = learningData.questions.length + oxQuizData.length + writingQuestions.length;
// 30 + 20 + 10 = 60 (stage2 38문제, stage3 8문제 누락!)

// ✅ 수정 (정확한 계산)
const stage2Questions = vocabularyData.length * 2;  // 19 단어 × 2 (단어→뜻, 뜻→단어)
const stage3Questions = sentenceData.length;        // 8 문장독해
const totalAllQuestions = learningData.questions.length + stage2Questions + stage3Questions + oxQuizData.length + writingQuestions.length;
// 30 + 38 + 8 + 20 + 10 = 106 ✓

// stagesDetailWithTotal에도 추가
stage2: { ...stageResults.stage2, totalQuestions: stage2Questions },  // 38
stage3: { ...stageResults.stage3, totalQuestions: stage3Questions },  // 8
```

**결과**: 진행률 정확도 개선 (61/106 = 57.5%)

#### 추가 수정된 워크북 (Task Agent 사용)
1. `250902 의류건조기의 원리 워크북.html`: +63 문제 (50+13)
2. `내신 대비 워크북.html`: +9 문제 (6+3)
3. `선우휘 불꽃 내신 대비 워크북.html`: +66 문제 (58+8)
4. `전상국 동행 내신 대비 워크북.html`: +45 문제 (32+13)
5. `현진건 고향 내신 대비 워크북.html`: +87 문제 (74+13)
6. `흥부전 내신 대비 워크북.html`: +44 문제 (32+12)

**총 추가된 문제 수**: 360개 (8개 워크북 전체)

---

### ✅ 3단계: 학습 기록 인쇄 기능 추가

#### 구현 기능
**파일**: `student-dashboard.html`

**1. 인쇄 버튼 추가**

학습 결과 모달 (lines 1640-1647):
```html
<button class="print-btn" onclick="printLearningResult()">🖨️ 인쇄하기</button>
```

틀린 문제 모달 (lines 1705-1711):
```html
<button class="print-btn" onclick="printWrongQuestions()">🖨️ 인쇄하기</button>
```

**2. 인쇄 CSS 스타일** (lines 564-625)
```css
@media print {
    /* 불필요한 요소 숨기기 */
    .sidebar, .print-btn, button, .result-modal-close {
        display: none !important;
    }

    /* 모달을 전체 페이지로 확장 */
    .result-modal {
        position: static !important;
        background: white !important;
    }

    .result-modal-content {
        max-width: 100% !important;
        max-height: 100% !important;
        box-shadow: none !important;
        overflow: visible !important;
    }

    /* 페이지 구분 방지 */
    .page-break-avoid {
        page-break-inside: avoid;
    }

    /* 색상 유지 */
    * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}
```

**3. 인쇄 함수** (lines 2078-2088)
```javascript
function printLearningResult() {
    window.print();
}

function printWrongQuestions() {
    window.print();
}
```

---

### ✅ 4단계: 랭킹 시스템 구현

#### 구현 기능

**1. 랭킹 메뉴 추가** (line 661-663)
```html
<div class="nav-item" onclick="showSection('ranking')">🏆 랭킹</div>
```

**2. 랭킹 섹션 HTML** (lines 987-1034)
```html
<section id="ranking" class="content-section" style="display: none;">
    <div class="section-header">
        <h2>🏆 랭킹</h2>
        <p>우수 학생들을 확인하세요</p>
    </div>

    <!-- 랭킹 탭 -->
    <div class="ranking-tabs">
        <button class="ranking-tab active" onclick="showRankingTab('cumulative')">📈 누적 랭킹</button>
        <button class="ranking-tab" onclick="showRankingTab('weekly')">📅 주간 랭킹</button>
        <button class="ranking-tab" onclick="showRankingTab('monthly')">📆 월간 랭킹</button>
    </div>

    <!-- 학교급 필터 -->
    <div class="school-level-filter">
        <button class="level-filter-btn active" onclick="filterBySchoolLevel('all')">전체</button>
        <button class="level-filter-btn" onclick="filterBySchoolLevel('elementary')">🎒 초등부</button>
        <button class="level-filter-btn" onclick="filterBySchoolLevel('middle')">📚 중등부</button>
        <button class="level-filter-btn" onclick="filterBySchoolLevel('high')">🎓 고등부</button>
    </div>

    <!-- 랭킹 컨텐츠 -->
    <div id="cumulativeRanking" class="ranking-content active">...</div>
    <div id="weeklyRanking" class="ranking-content">...</div>
    <div id="monthlyRanking" class="ranking-content">...</div>
</section>
```

**3. 랭킹 CSS 스타일** (lines 577-640)
```css
.ranking-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    border-bottom: 2px solid #e0e0e0;
}

.ranking-tab.active {
    color: #3498db;
    border-bottom-color: #3498db;
    font-weight: 700;
}

.school-level-filter {
    display: flex;
    gap: 12px;
    margin-bottom: 25px;
    justify-content: center;
}

.level-filter-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.ranking-item {
    display: grid;
    grid-template-columns: 80px 1fr 150px 150px 150px;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
}

.rank-badge.gold { color: #FFD700; font-size: 36px; }
.rank-badge.silver { color: #C0C0C0; font-size: 34px; }
.rank-badge.bronze { color: #CD7F32; font-size: 32px; }
```

**4. 누적 랭킹 로직** (lines 2183-2289)
```javascript
async function loadCumulativeRanking() {
    const response = await API.getAllLearningRecords();
    const records = response.data?.records || [];

    // 학생별 점수 집계
    const studentScores = {};
    records.forEach(record => {
        const userId = record.userId || record.studentId;
        if (!studentScores[userId]) {
            studentScores[userId] = {
                userId, userName, userSchool, userGrade,
                totalScore: 0, totalCorrect: 0, totalWrong: 0, learningCount: 0
            };
        }
        studentScores[userId].totalScore += score;
        studentScores[userId].totalCorrect += (record.correctAnswers || 0);
        studentScores[userId].totalWrong += (record.wrongAnswers || 0);
        studentScores[userId].learningCount++;
    });

    // 학교급 필터 적용
    let rankings = Object.values(studentScores);
    if (currentSchoolLevel !== 'all') {
        rankings = rankings.filter(student => {
            const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
            return schoolLevel === currentSchoolLevel;
        });
    }

    // 점수순 정렬
    rankings.sort((a, b) => b.totalScore - a.totalScore);

    // HTML 생성 (🥇🥈🥉 메달 표시)
    rankings.forEach((student, index) => {
        const rank = index + 1;
        let rankBadge = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : rank;
        // ... 랭킹 아이템 생성
    });
}
```

**5. 주간 랭킹** (lines 2301-2428)
```javascript
async function loadWeeklyRanking() {
    // 이번 주 시작일(일요일)과 종료일(토요일) 계산
    const now = new Date();
    const dayOfWeek = now.getDay();
    const weekStart = new Date(now);
    weekStart.setDate(now.getDate() - dayOfWeek);
    weekStart.setHours(0, 0, 0, 0);
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    weekEnd.setHours(23, 59, 59, 999);

    // 이번 주 기록만 필터링
    const weekRecords = records.filter(record => {
        const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
        return recordDate >= weekStart && recordDate <= weekEnd;
    });

    // 나머지는 누적 랭킹과 동일
}
```

**6. 월간 랭킹** (lines 2434-2557)
```javascript
async function loadMonthlyRanking() {
    // 이번 달 1일 ~ 말일 계산
    const now = new Date();
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);

    // 이번 달 기록만 필터링
    const monthRecords = records.filter(record => {
        const recordDate = new Date(record.createdAt || record.completedAt || record.endTime);
        return recordDate >= monthStart && recordDate <= monthEnd;
    });

    // 나머지는 누적 랭킹과 동일
}
```

---

### ✅ 5단계: 컨텐츠별 랭킹 추가

**1. 학습 기록 테이블에 랭킹 버튼 추가** (lines 1216, 1234)
```html
<table>
    <thead>
        <tr>
            <th>콘텐츠</th>
            <th>학습 날짜</th>
            <th>점수</th>
            <th>정답률</th>
            <th>학습 시간</th>
            <th>상세</th>
            <th>랭킹</th>  <!-- 새로 추가 -->
        </tr>
    </thead>
    <tbody>
        ${records.map(record => `
            <tr>
                ...
                <td><button class="btn-content-ranking" onclick="event.stopPropagation(); showContentRanking('${record.contentId}', '${record.contentTitle}')">🏆 랭킹</button></td>
            </tr>
        `).join('')}
    </tbody>
</table>
```

**2. 컨텐츠별 랭킹 버튼 스타일** (lines 501-511)
```css
.btn-content-ranking {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    font-weight: 600;
}

.btn-content-ranking:hover {
    transform: scale(1.05);
    background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
    box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
}
```

**3. 컨텐츠별 랭킹 모달** (lines 879-885, 2562-2684)
```javascript
async function showContentRanking(contentId, contentTitle) {
    const modal = document.getElementById('contentRankingModal');

    // 해당 컨텐츠 기록만 필터링
    const contentRecords = records.filter(record => record.contentId === contentId);

    // 학생별 누적 점수 계산
    const studentScores = {};
    contentRecords.forEach(record => {
        studentScores[userId].totalScore += score;
        studentScores[userId].bestScore = Math.max(studentScores[userId].bestScore, score);
        studentScores[userId].learningCount++;
    });

    // 누적 점수순 정렬
    const rankings = Object.values(studentScores).sort((a, b) => b.totalScore - a.totalScore);

    // 랭킹 HTML 생성 (누적 점수, 평균 점수, 학습 횟수 표시)
}
```

---

### ✅ 6단계: 학교급별 랭킹 필터

**1. 학년 → 학교급 변환 함수** (lines 2095-2125)
```javascript
function getSchoolLevelFromGrade(grade) {
    let gradeNum = 0;

    if (typeof grade === 'string') {
        if (grade.includes('초')) {
            const match = grade.match(/\d+/);
            gradeNum = match ? parseInt(match[0]) : 0;
        } else if (grade.includes('중')) {
            const match = grade.match(/\d+/);
            gradeNum = match ? parseInt(match[0]) + 6 : 0;  // 중1 = 7
        } else if (grade.includes('고')) {
            const match = grade.match(/\d+/);
            gradeNum = match ? parseInt(match[0]) + 9 : 0;  // 고1 = 10
        } else {
            const match = grade.match(/\d+/);
            gradeNum = match ? parseInt(match[0]) : 0;
        }
    } else {
        gradeNum = parseInt(grade);
    }

    if (gradeNum >= 1 && gradeNum <= 6) return 'elementary';
    if (gradeNum >= 7 && gradeNum <= 9) return 'middle';
    if (gradeNum >= 10 && gradeNum <= 12) return 'high';

    return 'unknown';
}
```

**지원 형식**:
- "초5", "중1", "고2" 형식
- "5학년" 형식
- 숫자 1-12

**2. 필터 적용 함수** (lines 2127-2149)
```javascript
function filterBySchoolLevel(level) {
    currentSchoolLevel = level;

    // 버튼 활성화 상태 변경
    document.querySelectorAll('.level-filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // 현재 활성화된 탭의 랭킹 다시 로드
    const activeTabs = document.querySelectorAll('.ranking-tab.active');
    if (activeTabs.length > 0) {
        const activeTab = activeTabs[0].textContent;
        if (activeTab.includes('누적')) loadCumulativeRanking();
        else if (activeTab.includes('주간')) loadWeeklyRanking();
        else if (activeTab.includes('월간')) loadMonthlyRanking();
    }
}
```

**3. 랭킹 함수에 필터링 로직 적용**

누적 랭킹 (lines 2221-2230):
```javascript
// 배열로 변환
let rankings = Object.values(studentScores);

// 학교급 필터 적용
if (currentSchoolLevel !== 'all') {
    rankings = rankings.filter(student => {
        const schoolLevel = getSchoolLevelFromGrade(student.userGrade);
        return schoolLevel === currentSchoolLevel;
    });
}

// 점수순 정렬
rankings.sort((a, b) => b.totalScore - a.totalScore);
```

동일 로직이 주간 랭킹(lines 2358-2367), 월간 랭킹(lines 2486-2495)에도 적용됨

**4. 컨텐츠별 랭킹에 학년 표시** (line 2653)
```html
<div class="student-school">${student.userSchool}${student.userGrade ? ' · ' + student.userGrade : ''}</div>
```

---

### 📊 작업 결과

#### 수정된 파일
1. **contents/차마설 내신 대비 워크북.html**
   - 5단계 correctParts 수정 (10문제)
   - 진행률 계산 수정 (+46 문제)

2. **contents/250902 의류건조기의 원리 워크북.html**
   - 진행률 계산 수정 (+63 문제)

3. **contents/내신 대비 워크북.html**
   - 진행률 계산 수정 (+9 문제)

4. **contents/선우휘 불꽃 내신 대비 워크북.html**
   - 진행률 계산 수정 (+66 문제)

5. **contents/전상국 동행 내신 대비 워크북.html**
   - 진행률 계산 수정 (+45 문제)

6. **contents/현진건 고향 내신 대비 워크북.html**
   - 진행률 계산 수정 (+87 문제)

7. **contents/흥부전 내신 대비 워크북.html**
   - 진행률 계산 수정 (+44 문제)

8. **student-dashboard.html**
   - 인쇄 기능 추가 (버튼, CSS, 함수)
   - 랭킹 섹션 추가 (HTML, CSS, JavaScript)
   - 컨텐츠별 랭킹 버튼 추가
   - 학교급 필터 추가

#### 추가된 기능
1. ✅ 5단계 서술형 문제 표준화 (3개 카드)
2. ✅ 8개 워크북 진행률 정확도 개선 (+360 문제)
3. ✅ 학습 결과 인쇄 기능
4. ✅ 틀린 문제 인쇄 기능
5. ✅ 누적 랭킹 (전체 기간)
6. ✅ 주간 랭킹 (일요일~토요일)
7. ✅ 월간 랭킹 (매월 1일~말일)
8. ✅ 컨텐츠별 랭킹 모달
9. ✅ 학교급별 필터 (전체/초등부/중등부/고등부)
10. ✅ 🥇🥈🥉 메달 표시 (1-3위)

#### 성능 개선
- 진행률 계산 정확도: 60개 → 106개 (차마설 기준 +76.7%)
- 총 추가된 문제 수: 360개 (8개 워크북)

#### UX 개선
- 5단계 UI 명확화 (보라색 안내 박스)
- 인쇄 최적화 CSS (불필요한 요소 숨김, 색상 유지)
- 랭킹 시각화 (메달, 아바타, 그라디언트)
- 학교급별 세분화 (초/중/고 분리 경쟁)

---

### 🔧 기술적 세부사항

#### 데이터 집계 알고리즘
```javascript
// 학생별 점수 집계
const studentScores = {};
records.forEach(record => {
    if (!studentScores[userId]) {
        studentScores[userId] = {
            totalScore: 0,
            totalCorrect: 0,
            totalWrong: 0,
            learningCount: 0
        };
    }
    studentScores[userId].totalScore += score;
    studentScores[userId].totalCorrect += correct;
    studentScores[userId].totalWrong += wrong;
    studentScores[userId].learningCount++;
});
```

#### 날짜 필터링
```javascript
// 주간: 일요일(0) ~ 토요일(6)
const weekStart = new Date(now);
weekStart.setDate(now.getDate() - now.getDay());
weekStart.setHours(0, 0, 0, 0);

// 월간: 1일 ~ 말일
const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
```

#### 학년 정규표현식
```javascript
// "중1", "고2", "5학년" 등 다양한 형식 지원
const match = grade.match(/\d+/);
gradeNum = match ? parseInt(match[0]) : 0;

// 학교급 판별
if (gradeNum >= 1 && gradeNum <= 6) return 'elementary';   // 초등
if (gradeNum >= 7 && gradeNum <= 9) return 'middle';       // 중등
if (gradeNum >= 10 && gradeNum <= 12) return 'high';       // 고등
```

---

### 📝 참고사항

1. **진행률 계산 공식**
   ```
   진행률 = (정답수 + 오답수) / 전체문제수 × 100
   ```

2. **랭킹 정렬 기준**
   - 1차: 총점 내림차순
   - 동점 시: 입력 순서 유지

3. **학교급 분류**
   - 초등부: 1-6학년
   - 중등부: 7-9학년 (중1-중3)
   - 고등부: 10-12학년 (고1-고3)

4. **인쇄 최적화**
   - A4 용지 기준
   - 색상 유지 모드
   - 페이지 구분 방지

---
